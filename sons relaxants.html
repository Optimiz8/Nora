<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="stylesheet" href="nora-common.css">
    <title>TSA App - Sons relaxants</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        /* Animation visuelle */
        .visual-container {
            width: 100%;
            max-width: 400px;
            height: 200px;
            margin: 20px auto;
            background: radial-gradient(circle at center, rgba(247, 184, 156, 0.2), transparent);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .visual-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(247, 184, 156, 0.7), rgba(247, 184, 156, 0.3));
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* Timer et contr√¥les */
        .controls-section {
            text-align: center;
            margin-bottom: 24px;
        }

        .timer {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-button {
            background-color: var(--accent);
            color: var(--dark);
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-button:active {
            transform: scale(0.95);
        }

        .control-button.secondary {
            background-color: rgba(245, 228, 204, 0.2);
            color: var(--light);
        }

        /* Timer settings */
        .timer-settings {
            background-color: #2E3A59;
            border-radius: 12px;
            padding: 16px;
            max-width: 300px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .timer-label {
            font-size: 15px;
        }

        .timer-input {
            background-color: rgba(245, 228, 204, 0.1);
            border: 2px solid rgba(245, 228, 204, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--light);
            font-size: 16px;
            width: 80px;
            text-align: center;
        }

        /* Sons disponibles */
        .sounds-section {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .sounds-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent);
            text-align: center;
        }

        .sounds-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .sound-card {
            background-color: rgba(245, 228, 204, 0.15);
            border: 2px solid rgba(245, 228, 204, 0.3);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .sound-card:active {
            transform: scale(0.95);
        }

        .sound-card.active {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .sound-card.active .sound-icon,
        .sound-card.active .sound-name {
            color: var(--dark);
        }

        .sound-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .sound-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--light);
        }

        .instructions {
            text-align: center;
            color: var(--light);
            opacity: 0.7;
            font-size: 15px;
            margin-top: 20px;
            line-height: 1.5;
        }

        @media (max-width: 360px) {
            .timer {
                font-size: 40px;
            }
            .sounds-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <button class="back-button" onclick="goBack()">‚¨ÖÔ∏è</button>
        <h1 class="page-title">Sons relaxants</h1>
    </header>

    <main class="main-content">
        <!-- Animation visuelle -->
        <div class="visual-container">
            <div class="visual-circle" id="visualCircle"></div>
        </div>

        <!-- Timer et contr√¥les -->
        <div class="controls-section">
            <div class="timer" id="timer">--:--</div>
            <div class="controls">
                <button class="control-button" id="playButton" onclick="togglePlay()">
                    ‚ñ∂Ô∏è D√©marrer
                </button>
                <button class="control-button secondary" onclick="stopSounds()">
                    ‚èπÔ∏è Arr√™ter
                </button>
            </div>
        </div>

        <!-- R√©glage dur√©e -->
        <div class="timer-settings">
            <span class="timer-label">Dur√©e (min)</span>
            <input type="number" class="timer-input" id="durationInput" value="10" min="1" max="60">
        </div>

        <!-- Sons disponibles -->
        <div class="sounds-section">
            <h2 class="sounds-title">Choisissez vos sons (mixables)</h2>
            <div class="sounds-grid">
                <div class="sound-card" onclick="toggleSound('waves')">
                    <div class="sound-icon">üåä</div>
                    <div class="sound-name">Vagues</div>
                </div>
                <div class="sound-card" onclick="toggleSound('fire')">
                    <div class="sound-icon">üî•</div>
                    <div class="sound-name">Feu</div>
                </div>
                <div class="sound-card" onclick="toggleSound('rain')">
                    <div class="sound-icon">üåßÔ∏è</div>
                    <div class="sound-name">Pluie</div>
                </div>
                <div class="sound-card" onclick="toggleSound('bowl')">
                    <div class="sound-icon">üîî</div>
                    <div class="sound-name">Bols tib√©tains</div>
                </div>
                <div class="sound-card" onclick="toggleSound('train')">
                    <div class="sound-icon">üöÇ</div>
                    <div class="sound-name">Train</div>
                </div>
                <div class="sound-card" onclick="toggleSound('fan')">
                    <div class="sound-icon">üåÄ</div>
                    <div class="sound-name">Ventilateur</div>
                </div>
                <div class="sound-card" onclick="toggleSound('wind')">
                    <div class="sound-icon">üçÉ</div>
                    <div class="sound-name">Vent</div>
                </div>
                <div class="sound-card" onclick="toggleSound('thunder')">
                    <div class="sound-icon">‚õàÔ∏è</div>
                    <div class="sound-name">Orage lointain</div>
                </div>
                <div class="sound-card" onclick="toggleSound('cat')">
                    <div class="sound-icon">üê±</div>
                    <div class="sound-name">Ronronnement</div>
                </div>
                <div class="sound-card" onclick="toggleSound('stream')">
                    <div class="sound-icon">üíß</div>
                    <div class="sound-name">Ruisseau</div>
                </div>
            </div>
        </div>

        <div class="instructions">
            S√©lectionnez un ou plusieurs sons √† mixer.<br>
            Ils tourneront en boucle pendant la dur√©e choisie. üéß
        </div>
    </main>

    <script>
        let activeSounds = new Set();
        let audioContext = null;
        let soundGenerators = {};
        let isPlaying = false;
        let timerInterval = null;
        let remainingTime = 0;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function toggleSound(soundId) {
            const card = event.target.closest('.sound-card');

            if (activeSounds.has(soundId)) {
                activeSounds.delete(soundId);
                card.classList.remove('active');
                if (isPlaying && soundGenerators[soundId]) {
                    stopSoundGenerator(soundId);
                }
            } else {
                activeSounds.add(soundId);
                card.classList.add('active');
                if (isPlaying) {
                    startSoundGenerator(soundId);
                }
            }
        }

        function generateSound(soundId) {
            initAudio();

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();

            oscillator.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Configuration selon le type de son
            switch(soundId) {
                case 'waves':
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 80;
                    filter.type = 'lowpass';
                    filter.frequency.value = 300;
                    gainNode.gain.value = 0.03;
                    // Modulation lente
                    const lfo = audioContext.createOscillator();
                    const lfoGain = audioContext.createGain();
                    lfo.frequency.value = 0.2;
                    lfoGain.gain.value = 20;
                    lfo.connect(lfoGain);
                    lfoGain.connect(oscillator.frequency);
                    lfo.start();
                    soundGenerators[soundId].lfo = lfo;
                    break;

                case 'fire':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.value = 100 + Math.random() * 50;
                    filter.type = 'bandpass';
                    filter.frequency.value = 1000;
                    filter.Q.value = 0.5;
                    gainNode.gain.value = 0.02;
                    break;

                case 'rain':
                    oscillator.type = 'white';
                    filter.type = 'highpass';
                    filter.frequency.value = 2000;
                    gainNode.gain.value = 0.015;
                    break;

                case 'bowl':
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 432;
                    gainNode.gain.value = 0.025;
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 8);
                    break;

                case 'train':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.value = 60;
                    filter.type = 'lowpass';
                    filter.frequency.value = 200;
                    gainNode.gain.value = 0.02;
                    break;

                case 'fan':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.value = 120;
                    filter.type = 'bandpass';
                    filter.frequency.value = 500;
                    gainNode.gain.value = 0.02;
                    break;

                case 'wind':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.value = 100;
                    filter.type = 'lowpass';
                    filter.frequency.value = 600;
                    gainNode.gain.value = 0.015;
                    break;

                case 'thunder':
                    oscillator.type = 'triangle';
                    oscillator.frequency.value = 40;
                    filter.type = 'lowpass';
                    filter.frequency.value = 150;
                    gainNode.gain.value = 0.01;
                    break;

                case 'cat':
                    oscillator.type = 'triangle';
                    oscillator.frequency.value = 25;
                    filter.type = 'lowpass';
                    filter.frequency.value = 100;
                    gainNode.gain.value = 0.03;
                    break;

                case 'stream':
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 200;
                    filter.type = 'bandpass';
                    filter.frequency.value = 1500;
                    gainNode.gain.value = 0.02;
                    break;
            }

            oscillator.start();

            soundGenerators[soundId] = {
                oscillator,
                gainNode,
                filter
            };
        }

        function startSoundGenerator(soundId) {
            if (soundGenerators[soundId]) {
                stopSoundGenerator(soundId);
            }
            generateSound(soundId);
        }

        function stopSoundGenerator(soundId) {
            if (soundGenerators[soundId]) {
                try {
                    soundGenerators[soundId].oscillator.stop();
                    if (soundGenerators[soundId].lfo) {
                        soundGenerators[soundId].lfo.stop();
                    }
                } catch (e) {}
                delete soundGenerators[soundId];
            }
        }

        function togglePlay() {
            if (activeSounds.size === 0) {
                alert('Veuillez d\'abord s√©lectionner au moins un son !');
                return;
            }

            if (isPlaying) {
                pause();
            } else {
                play();
            }
        }

        function play() {
            isPlaying = true;
            document.getElementById('playButton').textContent = '‚è∏Ô∏è Pause';

            // D√©marrer les sons
            activeSounds.forEach(soundId => {
                startSoundGenerator(soundId);
            });

            // D√©marrer le timer
            const duration = parseInt(document.getElementById('durationInput').value);
            remainingTime = duration * 60;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    stopSounds();
                    alert('Session termin√©e ! üå∏');
                }
            }, 1000);
        }

        function pause() {
            isPlaying = false;
            document.getElementById('playButton').textContent = '‚ñ∂Ô∏è Reprendre';

            // Arr√™ter les sons
            activeSounds.forEach(soundId => {
                stopSoundGenerator(soundId);
            });

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function stopSounds() {
            isPlaying = false;
            document.getElementById('playButton').textContent = '‚ñ∂Ô∏è D√©marrer';

            // Arr√™ter tous les sons
            Object.keys(soundGenerators).forEach(soundId => {
                stopSoundGenerator(soundId);
            });

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // R√©initialiser le timer
            remainingTime = 0;
            document.getElementById('timer').textContent = '--:--';
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function goBack() {
            if (isPlaying && !confirm('Voulez-vous vraiment quitter ?\nLes sons en cours seront arr√™t√©s.')) {
                return;
            }
            stopSounds();
            window.location.href = 'index.html';
        }
    </script>
    <script src="nora-scroll.js"></script>
</body>
</html>