<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="assets/images/favicone.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
<link rel="stylesheet" href="nora-common.css">
<script src="nora-data.js"></script>
<title>Nora ‚Äì Capacit√©s</title>

<style>
body{
  padding-bottom:100px;
}

.header-context-name{font-size:18px;font-weight:600}

.main-content{padding:10px 20px}

.page-title{
  font-size:22px;
  margin-bottom:2px;
}

.instruction-text{
  color:var(--accent);
  font-size:15px;
  margin-bottom:8px;
  margin-top:2px;
}

.title-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

.reset-btn{
  background:rgba(245,228,204,.15);
  border:1px solid rgba(245,228,204,.2);
  color:var(--accent);
  border-radius:10px;
  padding:6px 10px;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
  line-height:1;
}
.reset-btn .reset-icon{font-size:18px}
.reset-btn .reset-label{font-size:10px;opacity:0.8}
.reset-btn:active{background:rgba(245,228,204,.3)}

.capacity-item{
  background:var(--light);
  color:var(--dark);
  border-radius:14px;
  padding:14px;
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom:10px;
  user-select:none;
  transition:.15s;
}

.capacity-item:active{transform:scale(.97)}

/* Couleurs subtiles selon l'√©tat */
.capacity-item[data-state="possible"]{
  background:linear-gradient(to right, rgba(76, 175, 80, 0.15), var(--light));
}

.capacity-item[data-state="difficult"]{
  background:linear-gradient(to right, rgba(255, 152, 0, 0.15), var(--light));
}

.capacity-item[data-state="impossible"]{
  background:linear-gradient(to right, rgba(244, 67, 54, 0.15), var(--light));
}

.capacity-item[data-state="unknown"]{
  background:linear-gradient(to right, rgba(158, 158, 158, 0.15), var(--light));
}

.capacity-state{font-size:24px;min-width:32px;text-align:center}
.capacity-icon{font-size:24px}
.capacity-text{flex:1;font-size:16px}

.more-toggle{
  margin:22px 0;
  background:none;
  border:none;
  color:var(--accent);
  font-size:16px;
  cursor:pointer;
}

.confirm-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

.confirm-overlay.show{display:flex}

.confirm-dialog{
  background:var(--light);
  padding:24px;
  border-radius:16px;
  width:300px;
  color:var(--dark);
}

.confirm-buttons{
  display:flex;
  gap:12px;
  margin-top:20px;
}

.confirm-btn{
  flex:1;
  padding:12px;
  border-radius:8px;
  border:none;
  font-weight:600;
  cursor:pointer;
}

.confirm{background:var(--accent)}
.cancel{background:#ddd}
</style>
</head>

<body>

<header class="header">
  <h1 class="header-context-name" id="headerContextName" style="flex:1">Contexte</h1>
  <button onclick="window.location.href='index.html'" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px;">üè†</button>
</header>

<main class="main-content">

<div class="title-row">
  <div>
    <h2 class="page-title">Mes capacit√©s actuelles</h2>
    <p class="instruction-text">Appuyez pour changer l'√©tat.<br>Appui long pour remettre √† z√©ro.</p>
  </div>
  <button class="reset-btn" onclick="resetAllCapacities()" aria-label="R√©initialiser">
    <span class="reset-icon">‚Üª</span>
    <span class="reset-label">R√©init.</span>
  </button>
</div>

<div id="capacitiesContainer">
<!-- G√©n√©r√© dynamiquement -->
</div>

</main>

<footer class="footer">
  <button class="footer-button icon" onclick="goBack()" aria-label="Pr√©c√©dent">‚¨ÖÔ∏è</button>
  <button class="footer-button center" onclick="finish()">Voir le r√©capitulatif</button>
  <button class="footer-button icon" onclick="goNext()" aria-label="Suivant">‚û°Ô∏è</button>
</footer>

<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-dialog">
    <h2>R√©initialiser ?</h2>
    <p>Toutes les capacit√©s seront effac√©es.</p>
    <div class="confirm-buttons">
      <button class="confirm-btn cancel" onclick="hideConfirm()">Annuler</button>
      <button class="confirm-btn confirm" onclick="confirmReset()">OK</button>
    </div>
  </div>
</div>

<script>
const STATES={
  empty:{emoji:'',next:'possible'},
  possible:{emoji:'‚úÖ',next:'difficult'},
  difficult:{emoji:'‚ö†Ô∏è',next:'impossible'},
  impossible:{emoji:'‚õî',next:'unknown'},
  unknown:{emoji:'‚ùì',next:'empty'}
};

let longPressTimer,isLongPress=false;
let profileConfig = null;

function cycleState(el){
  if(isLongPress){isLongPress=false;return}
  const n=STATES[el.dataset.state].next;
  el.dataset.state=n;
  el.querySelector('.capacity-state').textContent=STATES[n].emoji;
  saveCapacities();
}

function attachLongPress(items){
  items.forEach(i=>{
    i.addEventListener('mousedown',()=>startLong(i));
    i.addEventListener('mouseup',clear);
    i.addEventListener('mouseleave',clear);
    i.addEventListener('touchstart',()=>startLong(i));
    i.addEventListener('touchend',clear);
  });
}

function startLong(i){
  isLongPress=false;
  longPressTimer=setTimeout(()=>{
    isLongPress=true;
    i.dataset.state='empty';
    i.querySelector('.capacity-state').textContent='';
    saveCapacities();
  },600);
}

function clear(){clearTimeout(longPressTimer)}

function resetAllCapacities(){
  document.getElementById('confirmOverlay').classList.add('show');
}

function hideConfirm(){
  document.getElementById('confirmOverlay').classList.remove('show');
}

function confirmReset(){
  document.querySelectorAll('.capacity-item').forEach(i=>{
    i.dataset.state='empty';
    i.querySelector('.capacity-state').textContent='';
  });
  saveCapacities();
  hideConfirm();
}

function buildCapacityItems(){
  const container = document.getElementById('capacitiesContainer');
  const config = profileConfig;
  const visibles = config.capacites.visibles || [];
  const personnalisees = config.capacites.personnalisees || [];

  // Filtrer les items standards visibles
  const allItems = [...CAPACITES, ...personnalisees];
  const visibleItems = allItems.filter(item => visibles.includes(item.id));

  container.innerHTML = visibleItems.map(item =>
    `<div class="capacity-item" data-state="empty" data-label="${item.nom}" onclick="cycleState(this)">
      <div class="capacity-state"></div>
      <div class="capacity-icon">${item.emoji}</div>
      <div class="capacity-text">${item.nom}</div>
    </div>`
  ).join('');

  attachLongPress(container.querySelectorAll('.capacity-item'));
}

function saveCapacities(){
  const capacites = { impossible: [], difficile: [], possible: [], incertain: [] };
  document.querySelectorAll('.capacity-item').forEach(item => {
    const state = item.dataset.state;
    const label = item.dataset.label || item.querySelector('.capacity-text').textContent;
    if(state === 'impossible') capacites.impossible.push(label);
    else if(state === 'difficult') capacites.difficile.push(label);
    else if(state === 'possible') capacites.possible.push(label);
    else if(state === 'unknown') capacites.incertain.push(label);
  });
  localStorage.setItem('currentCapacites', JSON.stringify(capacites));
}

function loadCapacities(){
  try {
    const saved = localStorage.getItem('currentCapacites');
    if(!saved) return;
    const capacites = JSON.parse(saved);
    document.querySelectorAll('.capacity-item').forEach(item => {
      const label = item.dataset.label || item.querySelector('.capacity-text').textContent;
      if(capacites.impossible.includes(label)){
        item.dataset.state = 'impossible';
        item.querySelector('.capacity-state').textContent = '‚õî';
      } else if(capacites.difficile.includes(label)){
        item.dataset.state = 'difficult';
        item.querySelector('.capacity-state').textContent = '‚ö†Ô∏è';
      } else if(capacites.possible.includes(label)){
        item.dataset.state = 'possible';
        item.querySelector('.capacity-state').textContent = '‚úÖ';
      } else if(capacites.incertain.includes(label)){
        item.dataset.state = 'unknown';
        item.querySelector('.capacity-state').textContent = '‚ùì';
      }
    });
  } catch(e) {
    console.error('Erreur chargement capacit√©s:', e);
  }
}

function goBack(){
  saveCapacities();
  location.href = getPrevPage('capacites.html', profileConfig);
}

function goNext(){
  saveCapacities();
  location.href = getNextPage('capacites.html', profileConfig);
}

function finish(){
  saveCapacities();
  location.href='recap.html';
}

document.addEventListener('DOMContentLoaded', function() {
  const profilId = localStorage.getItem('profilActuel') || 'maison';
  profileConfig = getProfileConfig(profilId);

  // Header dynamique
  const info = getContexteInfo(profilId);
  document.getElementById('headerContextName').textContent = info.emoji + ' ' + info.nom;

  // Construire les items filtr√©s
  buildCapacityItems();
  loadCapacities();

  if (!localStorage.getItem('crisisStartTime')) {
    localStorage.setItem('crisisStartTime', Date.now().toString());
  }
});
</script>

    <script src="nora-scroll.js"></script>
</body>
</html>