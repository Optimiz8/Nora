<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="color-scheme" content="only light">
  <meta name="theme-color" content="#384657">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/images/favicone.png" type="image/png">
  <link rel="apple-touch-icon" href="assets/images/logo.png">
  <link rel="stylesheet" href="nora-common.css">
  <title>Nora ‚Äì Timer visuel</title>
  <style>
    /* ---------- LAYOUT ---------- */
    body {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg);
    }

    .timer-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 12px 80px;
      gap: 20px;
    }

    /* ---------- CERCLE SVG (style 1) ---------- */
    .circle-wrap {
      position: relative;
      width: min(300px, 82vw);
      aspect-ratio: 1;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .circle-wrap svg { width: 100%; height: 100%; }

    .track {
      fill: none;
      stroke: rgba(245, 228, 204, 0.12);
      stroke-width: 8;
    }

    .progress {
      fill: none;
      stroke: var(--accent);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.9s linear;
    }

    .circle-wrap.paused .progress {
      stroke: rgba(247, 184, 156, 0.4);
    }

    .circle-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      pointer-events: none;
    }

    .time-display {
      font-size: clamp(2.4rem, 12vw, 3.4rem);
      font-weight: 300;
      color: var(--light);
      letter-spacing: 2px;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      pointer-events: auto;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .time-hint {
      font-size: 0.65rem;
      color: rgba(245, 228, 204, 0.4);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      min-height: 1em;
      pointer-events: none;
    }

    /* ---------- CONTR√îLES CENTRAUX ---------- */
    .timer-controls {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-top: 14px;
    }

    .ctrl-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      -webkit-appearance: none;
      appearance: none;
      -webkit-tap-highlight-color: transparent;
    }

    .ctrl-btn.play-btn {
      background: var(--accent);
      color: var(--dark);
    }

    .ctrl-btn.reset-btn {
      background: rgba(245, 228, 204, 0.12);
      color: var(--light);
      border: 1px solid rgba(245, 228, 204, 0.15);
    }

    .ctrl-btn:disabled { opacity: 0.3; pointer-events: none; }

    .ctrl-icon { font-size: 26px; line-height: 1; }

    .ctrl-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ---------- FOOTER 3 BOUTONS ---------- */
    .timer-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      gap: 8px;
      padding: 0 12px;
      background: var(--dark);
      height: var(--footer-height);
      align-items: center;
      z-index: 200;
    }

    .t-btn {
      flex: 1;
      height: 50px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      background: rgba(245, 228, 204, 0.15);
      color: var(--light);
      border: 1px solid rgba(245, 228, 204, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.1;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      gap: 1px;
    }

    .t-btn.active {
      background: rgba(247, 184, 156, 0.22);
      border-color: rgba(247, 184, 156, 0.3);
    }

    .btn-cat {
      font-size: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: rgba(245, 228, 204, 0.45);
    }

    .t-btn > .btn-icon { font-size: 17px; display: block; }
    .t-btn > small { font-weight: 800; text-transform: uppercase; }

    /* ---------- TOAST ---------- */
    .timer-toast {
      position: fixed;
      bottom: calc(var(--footer-height) + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(46, 58, 89, 0.97);
      color: var(--light);
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      box-shadow: 0 4px 14px rgba(0,0,0,0.4);
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 300;
      pointer-events: none;
      text-align: center;
      max-width: 90%;
      white-space: nowrap;
    }

    .timer-toast.visible { opacity: 1; }

    /* ---------- BOTTOM-SHEET ---------- */
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: flex-end;
      z-index: 500;
    }

    .sheet-backdrop.visible { display: flex; }

    .sheet-box {
      background: #020617;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 20px 20px 40px;
      position: relative;
    }

    .sheet-handle {
      width: 40px;
      height: 4px;
      background: rgba(255,255,255,0.15);
      border-radius: 2px;
      margin: 0 auto 18px;
    }

    .sheet-close {
      position: absolute;
      top: 14px;
      right: 18px;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      color: rgba(245, 228, 204, 0.5);
    }

    .sheet-title {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      color: var(--light);
      margin-bottom: 16px;
    }

    /* ---------- CAROUSEL hh:mm:ss ---------- */
    .carousel-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      margin-bottom: 16px;
      user-select: none;
    }

    .carousel-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .carousel-col label {
      font-size: 0.62rem;
      color: rgba(245, 228, 204, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .carousel-drum {
      position: relative;
      width: 72px;
      height: 120px;
      overflow: hidden;
      cursor: ns-resize;
      -webkit-tap-highlight-color: transparent;
    }

    .carousel-drum::before,
    .carousel-drum::after {
      content: '';
      position: absolute;
      left: 0; right: 0;
      height: 36px;
      z-index: 2;
      pointer-events: none;
    }
    .carousel-drum::before { top: 0; background: linear-gradient(to bottom, #020617 0%, transparent 100%); }
    .carousel-drum::after  { bottom: 0; background: linear-gradient(to top, #020617 0%, transparent 100%); }

    .carousel-track {
      position: absolute;
      top: 0; left: 0; right: 0;
      transition: transform 0.15s ease;
    }

    .carousel-item {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.9rem;
      font-weight: 300;
      color: rgba(245, 228, 204, 0.3);
      font-variant-numeric: tabular-nums;
    }

    .carousel-item.selected {
      color: var(--light);
      font-size: 2.2rem;
    }

    .carousel-sep {
      font-size: 2rem;
      font-weight: 300;
      color: rgba(245, 228, 204, 0.4);
      padding-bottom: 4px;
      align-self: center;
    }

    .carousel-highlight {
      position: absolute;
      top: 40px;
      left: 6px; right: 6px;
      height: 40px;
      background: rgba(247, 184, 156, 0.1);
      border-radius: 10px;
      pointer-events: none;
      z-index: 1;
    }

    /* ---------- AJUSTEURS ---------- */
    .sheet-adjusters {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 7px;
      margin-bottom: 20px;
    }

    .sheet-adjusters button {
      padding: 10px 4px;
      background: rgba(245, 228, 204, 0.07);
      color: var(--light);
      border: none;
      border-radius: 10px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      text-align: center;
    }

    .sheet-adjusters button:active { background: rgba(245, 228, 204, 0.18); }

    .sheet-start {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: var(--dark);
      border: none;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .sheet-start:active { opacity: 0.88; }

    /* ---------- ALARME ---------- */
    .alarm-overlay {
      position: fixed;
      inset: 0;
      background: var(--dark);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 900;
      padding: 32px 24px;
    }

    .alarm-overlay.visible { display: flex; }

    .alarm-overlay.flashing { animation: alarmFlash 0.9s ease-in-out infinite; }

    @keyframes alarmFlash {
      0%, 100% { background: var(--dark); }
      50%       { background: var(--light); }
    }

    .alarm-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      background: rgba(46, 58, 89, 0.92);
      border-radius: 28px;
      padding: 36px 28px;
      width: 100%;
      max-width: 320px;
    }

    .alarm-icon { font-size: 3.5rem; animation: alarmPulse 0.9s ease-in-out infinite; }

    @keyframes alarmPulse {
      0%, 100% { transform: scale(1); }
      50%       { transform: scale(1.2); }
    }

    .alarm-text { font-size: 1.6rem; font-weight: 600; color: var(--light); text-align: center; }
    .alarm-actions { display: flex; flex-direction: column; gap: 12px; width: 100%; }

    .alarm-btn {
      padding: 16px;
      border: none;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      text-align: center;
    }

    .alarm-btn.primary   { background: var(--accent); color: var(--dark); }
    .alarm-btn.secondary { background: rgba(245, 228, 204, 0.15); color: var(--light); }

    #snoozeSheet { z-index: 1000; }

    /* ---------- STYLE SHEET ---------- */
    .style-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .style-btn {
      aspect-ratio: 1;
      border-radius: 16px;
      border: 2px solid transparent;
      background: rgba(245, 228, 204, 0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px;
      -webkit-tap-highlight-color: transparent;
    }

    .style-btn.active {
      border-color: var(--accent);
      background: rgba(247, 184, 156, 0.1);
    }

    .style-btn > .style-preview { font-size: 28px; line-height: 1; }

    .style-btn > .style-name {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--light);
      text-align: center;
    }

    /* ---------- STYLE 2 ‚Äî BARRE ---------- */
    .bar-wrap {
      display: none;
      position: relative;
      width: min(160px, 44vw);
      height: min(430px, 82vh);
      background: rgba(80, 100, 200, 0.1);
      border: 1px solid rgba(100, 130, 220, 0.15);
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .bar-fill {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, var(--dark), rgba(90, 120, 210, 0.85));
      border-radius: 0 0 20px 20px;
      transition: height 0.9s linear;
    }

    .bar-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      pointer-events: none;
    }

    /* ---------- STYLE 3 ‚Äî SEGMENTS ---------- */
    .segments-wrap {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      width: min(340px, 92vw);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .seg-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      pointer-events: none;
    }

    .seg-pills {
      display: flex;
      gap: 5px;
      height: 42px;
      width: 100%;
    }

    .seg-pill {
      flex: 1;
      border-radius: 8px;
      background: rgba(245, 228, 204, 0.1);
      transition: background 0.5s ease;
    }

    .seg-pill.active { background: var(--accent); }

    /* ---------- STYLE 4 ‚Äî PIXELS ---------- */
    .pixels-wrap {
      display: none;
      position: relative;
      width: min(310px, 88vw);
      aspect-ratio: 1;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .pixels-canvas { width: 100%; height: 100%; border-radius: 20px; }

    .pixels-time {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      margin-top: 8px;
    }

    /* ---------- STYLE 5 ‚Äî KAWAII ---------- */
    .kawaii-wrap {
      display: none;
      position: relative;
      width: min(300px, 82vw);
      aspect-ratio: 1;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      border-radius: 50%;
      overflow: hidden;
    }

    .kawaii-bg { position: absolute; inset: 0; border-radius: 50%; }

    .kawaii-stickers {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: 50%;
    }

    .kawaii-sticker {
      position: absolute;
      font-size: 18px;
      opacity: 0.55;
      transform: translate(-50%, -50%);
    }

    .kawaii-arc { position: absolute; inset: 4px; border-radius: 50%; }
    .kawaii-arc svg { width: 100%; height: 100%; }

    .kawaii-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      pointer-events: none;
    }

    /* ---------- STYLE 6 ‚Äî ESPACE ---------- */
    .space-wrap {
      display: none;
      position: relative;
      width: min(300px, 82vw);
      aspect-ratio: 1;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      border-radius: 50%;
      overflow: hidden;
      background: #060b1a;
    }

    .space-stars {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      pointer-events: none;
    }

    .space-nebula {
      position: absolute;
      inset: -10%;
      border-radius: 50%;
      pointer-events: none;
      opacity: 0.35;
      background: radial-gradient(circle at 30% 40%, #7c3aed 0%, transparent 50%),
                  radial-gradient(circle at 70% 60%, #0ea5e9 0%, transparent 50%),
                  radial-gradient(circle at 50% 50%, #6d28d9 0%, transparent 70%);
      transition: transform 0.9s linear;
    }

    @keyframes nebulaRotate {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .space-arc { position: absolute; inset: 4px; border-radius: 50%; }
    .space-arc svg { width: 100%; height: 100%; }

    .space-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      pointer-events: none;
    }

    /* ---------- PLUIE DE PAILLETTES (fond kawaii) ---------- */
    #kawaiiBgRain {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
      display: none;
    }

    .bg-sparkle {
      position: absolute;
      top: -40px;
      animation: bgSparkleFall linear infinite;
      font-size: 18px;
      opacity: 0.7;
    }

    @keyframes bgSparkleFall {
      0%   { transform: translateY(0) rotate(0deg); opacity: 0.7; }
      90%  { opacity: 0.5; }
      100% { transform: translateY(105vh) rotate(360deg); opacity: 0; }
    }

    /* ---------- FOND DE PAGE TH√àME ---------- */

    #pageBg {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      display: none;
      opacity: 0.3;
    }

    #pageBgCanvas {
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
      display: none;
    }

    #pageBgNebula {
      position: fixed;
      inset: -10%;
      z-index: -2;
      pointer-events: none;
      display: none;
      opacity: 0.22;
      background: radial-gradient(circle at 30% 40%, #7c3aed 0%, transparent 50%),
                  radial-gradient(circle at 70% 60%, #a78bfa 0%, transparent 50%),
                  radial-gradient(circle at 50% 50%, #6d28d9 0%, transparent 70%);
    }

    /* ---------- ALARME TH√àME ---------- */

    .alarm-overlay.theme-kawaii {
      background: var(--dark);
      overflow: hidden;
    }

    .alarm-overlay.theme-kawaii .alarm-icon { display: none; }

    .kawaii-alarm-video {
      display: none;
      width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 16px;
    }

    .alarm-overlay.theme-kawaii .kawaii-alarm-video { display: block; }

    .alarm-sparkles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .sparkle-particle {
      position: absolute;
      top: -50px;
      animation: sparkleFall linear infinite;
    }

    @keyframes sparkleFall {
      0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
      80%  { opacity: 0.8; }
      100% { transform: translateY(110vh) rotate(540deg); opacity: 0; }
    }

    .alarm-overlay.theme-espace {
      background: #060b1a;
      overflow: hidden;
    }

    .alarm-overlay.theme-espace::before {
      content: '';
      position: absolute;
      inset: -20%;
      background: radial-gradient(circle at 35% 40%, rgba(124,58,237,0.45) 0%, transparent 55%),
                  radial-gradient(circle at 65% 60%, rgba(14,165,233,0.2) 0%, transparent 55%),
                  radial-gradient(circle at 50% 50%, rgba(109,40,217,0.3) 0%, transparent 65%);
      pointer-events: none;
    }

    #alarmStarsCanvas {
      display: none;
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .alarm-overlay.theme-espace #alarmStarsCanvas { display: block; }

    .alarm-overlay.theme-espace .alarm-icon { display: none; }

    .alarm-lottie {
      display: none;
      width: 150px;
      height: 150px;
      border-radius: 4px;
    }

    .alarm-overlay.theme-espace .alarm-lottie {
      display: block;
      animation: spaceFloat 1.8s ease-in-out infinite;
    }

    @keyframes spaceFloat {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50%       { transform: translateY(-24px) rotate(10deg); }
    }

    .glitter-bg {
      display: none;
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.45;
    }

    /* ---------- FOOTER TIMER (override) ---------- */

    .timer-footer {
      height: 72px !important;
    }

    .t-btn {
      height: 56px;
    }

    .t-btn.active {
      background: rgba(245, 228, 204, 0.15);
      border-color: rgba(245, 228, 204, 0.1);
    }

    .btn-cat {
      font-size: 10px;
    }

    .t-btn > .btn-icon { font-size: 18px; }

    .t-btn > small {
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
    }
  </style>
</head>
<body>

  <div id="pageBg"></div>
  <canvas id="pageBgCanvas"></canvas>
  <div id="pageBgNebula"></div>

  <header class="header">
    <button class="back-button" onclick="onBack()" aria-label="Retour">‚¨ÖÔ∏è</button>
    <h1 class="page-title">Timer visuel</h1>
  </header>

  <main class="timer-main">

    <!-- Style 1 : Cercle -->
    <div class="circle-wrap" id="circleWrap" onclick="onCircleTap()" role="button">
      <svg viewBox="0 0 100 100" aria-hidden="true">
        <circle class="track" cx="50" cy="50" r="42"/>
        <circle class="progress" id="progressArc" cx="50" cy="50" r="42"
          stroke-dasharray="263.89" stroke-dashoffset="0"
          transform="rotate(-90 50 50)"/>
      </svg>
      <div class="circle-center">
        <div class="time-display" id="timeDisplay1" onclick="onTimeTap(event)">15:00</div>
        <div class="time-hint" id="timeHint1">Appuie pour r√©gler</div>
      </div>
    </div>

    <!-- Style 2 : Barre -->
    <div class="bar-wrap" id="barWrap" onclick="onCircleTap()">
      <div class="bar-fill" id="barFill" style="height:0%"></div>
      <div class="bar-center">
        <div class="time-display" id="timeDisplay2" onclick="onTimeTap(event)" style="text-shadow:0 0 12px rgba(0,0,0,0.7)">15:00</div>
        <div class="time-hint" id="timeHint2">Appuie pour r√©gler</div>
      </div>
    </div>

    <!-- Style 3 : Segments -->
    <div class="segments-wrap" id="segmentsWrap" onclick="onCircleTap()">
      <div class="seg-center">
        <div class="time-display" id="timeDisplay3" onclick="onTimeTap(event)">15:00</div>
        <div class="time-hint" id="timeHint3">Appuie pour r√©gler</div>
      </div>
      <div class="seg-pills" id="segPills"></div>
    </div>

    <!-- Style 4 : Pixels -->
    <div class="pixels-wrap" id="pixelsWrap" onclick="onCircleTap()">
      <canvas class="pixels-canvas" id="pixelsCanvas"></canvas>
    </div>
    <div class="pixels-time" id="pixelsTimeRow">
      <div class="time-display" id="timeDisplay4" onclick="onTimeTap(event)" style="text-shadow:0 0 16px rgba(0,0,0,0.8)">15:00</div>
      <div class="time-hint" id="timeHint4">Appuie pour r√©gler</div>
    </div>

    <!-- Style 5 : Kawaii -->
    <div class="kawaii-wrap" id="kawaiiWrap" onclick="onCircleTap()">
      <div class="kawaii-bg" id="kawaiiBg"></div>
      <div class="kawaii-stickers" id="kawaiiStickers"></div>
      <div class="kawaii-arc">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="7"/>
          <circle id="kawaiiArc" cx="50" cy="50" r="42" fill="none"
            stroke-width="7" stroke-linecap="round"
            stroke-dasharray="263.89" stroke-dashoffset="0"
            transform="rotate(-90 50 50)"/>
        </svg>
      </div>
      <div class="kawaii-center">
        <div class="time-display" id="timeDisplay5" onclick="onTimeTap(event)" style="color:#fff;text-shadow:0 0 12px rgba(255,100,200,0.6)">15:00</div>
        <div class="time-hint" id="timeHint5" style="color:rgba(255,255,255,0.5)">Appuie pour r√©gler</div>
      </div>
    </div>

    <!-- Style 6 : Espace -->
    <div class="space-wrap" id="spaceWrap" onclick="onCircleTap()">
      <div class="space-nebula"></div>
      <canvas class="space-stars" id="spaceStarsCanvas" width="270" height="270"></canvas>
      <div class="space-arc">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(100,150,255,0.15)" stroke-width="7"/>
          <circle id="spaceArc" cx="50" cy="50" r="42" fill="none"
            stroke-width="7" stroke-linecap="round"
            stroke-dasharray="263.89" stroke-dashoffset="0"
            transform="rotate(-90 50 50)"/>
        </svg>
      </div>
      <div class="space-center">
        <div class="time-display" id="timeDisplay6" onclick="onTimeTap(event)" style="color:#c4d8ff;text-shadow:0 0 16px rgba(100,150,255,0.7)">15:00</div>
        <div class="time-hint" id="timeHint6" style="color:rgba(180,210,255,0.45)">Appuie pour r√©gler</div>
      </div>
    </div>

    <!-- Contr√¥les Play/Reset -->
    <div class="timer-controls">
      <button class="ctrl-btn reset-btn" id="btnReset" onclick="resetTimer()">
        <span class="ctrl-icon">‚Ü∫</span>
        <span class="ctrl-label">Reset</span>
      </button>
      <button class="ctrl-btn play-btn" id="btnPlay" onclick="togglePause()">
        <span class="ctrl-icon" id="playIcon">‚ñ∂</span>
      </button>
    </div>

  </main>

  <!-- Footer 3 boutons -->
  <footer class="timer-footer">
    <button class="t-btn active" id="btnSon" onclick="cycleSon()">
      <span class="btn-cat">Alertes</span>
      <span class="btn-icon" id="sonIcon">üîî</span>
      <small id="sonLabel">BIP</small>
    </button>
    <button class="t-btn active" id="btnFin" onclick="cycleFin()">
      <span class="btn-cat">Fin du timer</span>
      <span class="btn-icon" id="finIcon">‚ö°</span>
      <small id="finLabel">FLASH</small>
    </button>
    <button class="t-btn" id="btnStyle" onclick="openStyleSheet()">
      <span class="btn-cat">Visuel</span>
      <span class="btn-icon" id="styleIcon">üîµ</span>
      <small id="styleLabel">CERCLE</small>
    </button>
  </footer>

  <!-- Toast -->
  <div class="timer-toast" id="timerToast"></div>

  <!-- Duration picker -->
  <div class="sheet-backdrop" id="durationSheet" onclick="onBackdropClick(event,'durationSheet')">
    <div class="sheet-box">
      <div class="sheet-handle"></div>
      <div class="sheet-close" onclick="closeDurationSheet()">‚úï</div>
      <strong class="sheet-title">Dur√©e du timer</strong>

      <div class="carousel-wrap">
        <div class="carousel-col">
          <label>heures</label>
          <div class="carousel-drum" id="drumH">
            <div class="carousel-highlight"></div>
            <div class="carousel-track" id="trackH"></div>
          </div>
        </div>
        <div class="carousel-sep">:</div>
        <div class="carousel-col">
          <label>minutes</label>
          <div class="carousel-drum" id="drumM">
            <div class="carousel-highlight"></div>
            <div class="carousel-track" id="trackM"></div>
          </div>
        </div>
        <div class="carousel-sep">:</div>
        <div class="carousel-col">
          <label>secondes</label>
          <div class="carousel-drum" id="drumS">
            <div class="carousel-highlight"></div>
            <div class="carousel-track" id="trackS"></div>
          </div>
        </div>
      </div>

      <div class="sheet-adjusters">
        <button onclick="adjustDuration(-600)">‚àí10 min</button>
        <button onclick="adjustDuration(-60)">‚àí1 min</button>
        <button onclick="adjustDuration(60)">+1 min</button>
        <button onclick="adjustDuration(120)">+2 min</button>
        <button onclick="adjustDuration(300)">+5 min</button>
        <button onclick="adjustDuration(600)">+10 min</button>
        <button onclick="adjustDuration(1800)">+30 min</button>
        <button onclick="adjustDuration(3600)">+1 h</button>
      </div>

      <button class="sheet-start" onclick="startFromSheet()">‚ñ∂ Commencer</button>
    </div>
  </div>

  <!-- Fond pluie de paillettes kawaii -->
  <div id="kawaiiBgRain"></div>

  <!-- Alarm overlay -->
  <div class="alarm-overlay" id="alarmOverlay">
    <canvas id="alarmStarsCanvas"></canvas>
    <video class="glitter-bg" id="glitterBg" loop muted playsinline>
      <source src="assets/Glitter-Star.webm" type="video/webm">
    </video>
    <div class="alarm-sparkles" id="alarmSparkles"></div>
    <div class="alarm-content">
      <div class="alarm-icon">‚è∞</div>
      <video id="kawaiiAlarmVideo" class="kawaii-alarm-video" loop muted playsinline>
        <source src="assets/Glitter-Star.webm" type="video/webm">
      </video>
      <video id="spaceManVideo" class="alarm-lottie" loop muted playsinline>
        <source src="assets/Space-Man.webm" type="video/webm">
      </video>
      <div class="alarm-text" id="alarmText">Temps √©coul√© !</div>
      <div class="alarm-actions">
        <button class="alarm-btn primary" onclick="openSnoozeSheet()">Prolonger</button>
        <button class="alarm-btn secondary" onclick="stopAlarm()">Arr√™ter</button>
      </div>
    </div>
  </div>

  <!-- Snooze sheet -->
  <div class="sheet-backdrop" id="snoozeSheet" onclick="onBackdropClick(event,'snoozeSheet')">
    <div class="sheet-box">
      <div class="sheet-handle"></div>
      <div class="sheet-close" onclick="closeSnoozeSheet()">‚úï</div>
      <strong class="sheet-title">Prolonger de‚Ä¶</strong>

      <div class="carousel-wrap">
        <div class="carousel-col">
          <label>heures</label>
          <div class="carousel-drum" id="snoozeDrumH">
            <div class="carousel-highlight"></div>
            <div class="carousel-track" id="snoozeTrackH"></div>
          </div>
        </div>
        <div class="carousel-sep">:</div>
        <div class="carousel-col">
          <label>minutes</label>
          <div class="carousel-drum" id="snoozeDrumM">
            <div class="carousel-highlight"></div>
            <div class="carousel-track" id="snoozeTrackM"></div>
          </div>
        </div>
        <div class="carousel-sep">:</div>
        <div class="carousel-col">
          <label>secondes</label>
          <div class="carousel-drum" id="snoozeDrumS">
            <div class="carousel-highlight"></div>
            <div class="carousel-track" id="snoozeTrackS"></div>
          </div>
        </div>
      </div>

      <div class="sheet-adjusters" style="margin-bottom:14px">
        <button onclick="snoozeQuick(60)">+1 min</button>
        <button onclick="snoozeQuick(300)">+5 min</button>
        <button onclick="snoozeQuick(900)">+15 min</button>
        <button onclick="snoozeQuick(1800)">+30 min</button>
      </div>

      <button class="sheet-start" onclick="snoozeFromCarousel()">‚ñ∂ Prolonger</button>
      <button class="alarm-btn secondary" style="width:100%;margin-top:10px;" onclick="stopAlarm()">Arr√™ter compl√®tement</button>
    </div>
  </div>

  <!-- Style sheet -->
  <div class="sheet-backdrop" id="styleSheet" onclick="onBackdropClick(event,'styleSheet')">
    <div class="sheet-box">
      <div class="sheet-handle"></div>
      <div class="sheet-close" onclick="closeStyleSheet()">‚úï</div>
      <strong class="sheet-title">Style visuel</strong>
      <div class="style-grid">
        <button class="style-btn" id="styleBtn-cercle" onclick="setStyle('cercle')">
          <span class="style-preview">‚≠ï</span>
          <span class="style-name">Cercle</span>
        </button>
        <button class="style-btn" id="styleBtn-barre" onclick="setStyle('barre')">
          <span class="style-preview">‚ñÆ</span>
          <span class="style-name">Barre</span>
        </button>
        <button class="style-btn" id="styleBtn-segments" onclick="setStyle('segments')">
          <span class="style-preview">üîÜ</span>
          <span class="style-name">Segments</span>
        </button>
        <button class="style-btn" id="styleBtn-pixels" onclick="setStyle('pixels')">
          <span class="style-preview">‚¨õ</span>
          <span class="style-name">Pixels</span>
        </button>
        <button class="style-btn" id="styleBtn-kawaii" onclick="setStyle('kawaii')">
          <span class="style-preview">üåà</span>
          <span class="style-name">Kawaii</span>
        </button>
        <button class="style-btn" id="styleBtn-espace" onclick="setStyle('espace')">
          <span class="style-preview">üåå</span>
          <span class="style-name">Espace</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- CONSTANTES ---------- */
    const CIRCUMFERENCE = 2 * Math.PI * 42;

    const THRESHOLDS = [3600, 1800, 900, 120];
    const THRESHOLD_MSGS = {
      3600: 'Il reste une heure',
      1800: 'Il reste trente minutes',
      900:  'Il reste quinze minutes',
      120:  'Il reste deux minutes'
    };

    const THRESHOLD_MSGS_KAWAII = {
      3600: 'Encore une heure de paillettes',
      1800: 'Encore trente minutes de paillettes',
      900:  'Encore quinze minutes de paillettes',
      120:  'Encore deux minutes de paillettes'
    };

    const THRESHOLD_MSGS_ESPACE = {
      3600: 'Fin de la mission orbitale dans une heure',
      1800: 'Fin de la mission orbitale dans trente minutes',
      900:  'Fin de la mission orbitale dans quinze minutes',
      120:  'Fin de la mission orbitale dans deux minutes'
    };

    const SON_CYCLE  = ['bip', 'voix', 'vibration', 'mute'];
    const SON_ICONS  = { bip: 'üîî', voix: 'üó£Ô∏è', vibration: 'üì≥', mute: 'üîá' };
    const SON_LABELS = { bip: 'BIP', voix: 'VOIX', vibration: 'VIB', mute: 'MUET' };
    const SON_TOASTS = {
      bip:       'Bip sonore aux seuils : 1 h, 30 min, 15 min et 2 min',
      voix:      'Annonces vocales aux seuils : 1 h, 30 min, 15 min et 2 min',
      vibration: 'Vibrations aux seuils : 1 h, 30 min, 15 min et 2 min',
      mute:      'Alertes d√©sactiv√©es'
    };

    const FIN_CYCLE  = ['flash', 'voix', 'vibration', 'rien'];
    const FIN_ICONS  = { flash: '‚ö°', voix: 'üó£Ô∏è', vibration: 'üì≥', rien: 'üîï' };
    const FIN_LABELS = { flash: 'FLASH', voix: 'VOIX', vibration: 'VIB', rien: 'RIEN' };
    const FIN_TOASTS = {
      flash:     'Fin : √©cran clignotant jusqu\'√† arr√™t',
      voix:      'Fin : message vocal r√©p√©t√© jusqu\'√† arr√™t',
      vibration: 'Fin : vibrations r√©p√©t√©es jusqu\'√† arr√™t',
      rien:      'Fin silencieuse ‚Äî seul l\'√©cran s\'affiche'
    };

    const STYLE_LABELS = { cercle:'CERCLE', barre:'BARRE', segments:'SEGMENTS', pixels:'PIXELS', kawaii:'KAWAII', espace:'ESPACE' };
    const STYLE_ICONS  = { cercle:'üîµ', barre:'‚ñÆ', segments:'üîÜ', pixels:'‚¨õ', kawaii:'üåà', espace:'üåå' };

    /* ---------- √âTAT ---------- */
    let totalDuration  = parseInt(localStorage.getItem('timerLastDuration') || '900');
    let timeRemaining  = totalDuration;
    let state          = 'idle';
    let endTimestamp   = null;
    let timerInterval  = null;
    let alarmInterval  = null;
    let announcedSet   = new Set();
    let wakeLock       = null;
    let audioCtx       = null;
    let toastTimeout   = null;

    let sonMode    = localStorage.getItem('timerSonMode')  || 'bip';
    let finMode    = localStorage.getItem('timerFinMode')  || 'flash';
    let timerStyle = localStorage.getItem('timerStyle')    || 'cercle';

    let kawaiiAnimFrame = null;
    const kawaiiParticles = [];

    /* ---------- INIT ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      buildCarousel('trackH',       'drumH',       0, 23);
      buildCarousel('trackM',       'drumM',       0, 59);
      buildCarousel('trackS',       'drumS',       0, 59);
      buildCarousel('snoozeTrackH', 'snoozeDrumH', 0, 23);
      buildCarousel('snoozeTrackM', 'snoozeDrumM', 0, 59);
      buildCarousel('snoozeTrackS', 'snoozeDrumS', 0, 59);
      buildSegmentsSvg();
      initPixels();
      initKawaii();
      initSpace();
      applyStyle(timerStyle);
      updateSonBtn();
      updateFinBtn();
      updateDisplay();
      restoreRunningState();
    });

    /* ---------- PERSISTANCE ---------- */
    function saveRunningState() {
      if (state !== 'running') { localStorage.removeItem('timerRunningState'); return; }
      localStorage.setItem('timerRunningState', JSON.stringify({
        endTimestamp, totalDuration,
        announcedSet: [...announcedSet],
        sonMode, finMode
      }));
    }

    function restoreRunningState() {
      const raw = localStorage.getItem('timerRunningState');
      if (!raw) return;
      try {
        const s = JSON.parse(raw);
        sonMode = s.sonMode || sonMode;
        finMode = s.finMode || finMode;
        const remaining = Math.floor((s.endTimestamp - Date.now()) / 1000);
        if (remaining <= 0) {
          localStorage.removeItem('timerRunningState');
          totalDuration = s.totalDuration;
          timeRemaining = 0;
          triggerAlarm();
          return;
        }
        totalDuration = s.totalDuration;
        timeRemaining = remaining;
        endTimestamp  = s.endTimestamp;
        announcedSet  = new Set(s.announcedSet || []);
        state         = 'running';
        startInterval();
        requestWakeLock();
        updateSonBtn();
        updateFinBtn();
        updateUI();
      } catch(e) {
        localStorage.removeItem('timerRunningState');
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState !== 'visible' || state !== 'running') return;
      if (endTimestamp) {
        timeRemaining = Math.max(0, Math.floor((endTimestamp - Date.now()) / 1000));
        updateDisplay();
        if (timeRemaining <= 0) { clearInterval(timerInterval); triggerAlarm(); }
        else requestWakeLock();
      }
    });

    /* ---------- WAKE LOCK ---------- */
    async function requestWakeLock() {
      if (!('wakeLock' in navigator)) return;
      try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    }

    function releaseWakeLock() {
      if (wakeLock) { wakeLock.release().catch(() => {}); wakeLock = null; }
    }

    /* ---------- LOGIQUE TIMER ---------- */
    function startTimer() {
      announcedSet = new Set();
      endTimestamp = Date.now() + timeRemaining * 1000;
      state        = 'running';
      startInterval();
      saveRunningState();
      requestWakeLock();
      unlockAudio();
      updateUI();
    }

    function startFromSheet() {
      const h = getCarouselVal('trackH');
      const m = getCarouselVal('trackM');
      const s = getCarouselVal('trackS');
      const total = h * 3600 + m * 60 + s;
      if (total < 1) return;
      timeRemaining = total;
      totalDuration = total;
      localStorage.setItem('timerLastDuration', total);
      closeDurationSheet();
      startTimer();
    }

    function startInterval() {
      clearTimeout(timerInterval);
      function tick() {
        if (!endTimestamp) return;
        const ms = endTimestamp - Date.now();
        timeRemaining = Math.max(0, Math.ceil(ms / 1000));
        checkAnnouncements();
        updateDisplay();
        if (timeRemaining <= 0) {
          localStorage.removeItem('timerRunningState');
          triggerAlarm();
          return;
        }
        const delay = ms % 1000;
        timerInterval = setTimeout(tick, delay > 0 ? delay : 1000);
      }
      tick();
    }

    function onCircleTap() {
      if (state === 'alarm') return;
      togglePause();
    }

    /* Tap sur le temps = auto-pause + ouverture sheet */
    function onTimeTap(e) {
      e.stopPropagation();
      if (state === 'alarm') return;
      if (state === 'running') {
        clearInterval(timerInterval);
        releaseWakeLock();
        localStorage.removeItem('timerRunningState');
        state = 'paused';
        updateUI();
      }
      openDurationSheet();
    }

    function togglePause() {
      if (state === 'idle') { startTimer(); return; }
      if (state === 'running') {
        clearInterval(timerInterval);
        releaseWakeLock();
        localStorage.removeItem('timerRunningState');
        state = 'paused';
      } else if (state === 'paused') {
        endTimestamp = Date.now() + timeRemaining * 1000;
        state = 'running';
        startInterval();
        saveRunningState();
        requestWakeLock();
      }
      updateUI();
    }

    function resetTimer() {
      clearInterval(timerInterval);
      stopAlarmEffects();
      releaseWakeLock();
      localStorage.removeItem('timerRunningState');
      state         = 'idle';
      timeRemaining = totalDuration;
      endTimestamp  = null;
      announcedSet  = new Set();
      stopSparkles();
      var kawaiiVideo = document.getElementById('kawaiiAlarmVideo');
      kawaiiVideo.pause(); kawaiiVideo.currentTime = 0;
      const resetOverlay = document.getElementById('alarmOverlay');
      resetOverlay.classList.remove('visible', 'flashing', 'theme-kawaii', 'theme-espace');
      resetOverlay.style.background = '';
      document.querySelector('#alarmOverlay .alarm-icon').textContent = '‚è∞';
      document.getElementById('alarmText').textContent = 'Temps √©coul√© !';
      updateUI();
    }

    /* ---------- ALARME ---------- */
    function triggerAlarm() {
      state = 'alarm';
      releaseWakeLock();
      updateUI();
      const overlay = document.getElementById('alarmOverlay');
      overlay.classList.add('visible');
      if (timerStyle === 'kawaii') {
        document.getElementById('alarmText').textContent = 'Pluie de paillettes termin√©e !';
        overlay.classList.add('theme-kawaii');
        const progress = totalDuration > 0 ? (1 - timeRemaining / totalDuration) : 1;
        const hue = Math.round(progress * 300);
        overlay.style.background = `conic-gradient(from ${hue}deg, ${RAINBOW.join(',')}, ${RAINBOW[0]})`;
        document.getElementById('kawaiiAlarmVideo').play().catch(function() {});
      } else if (timerStyle === 'espace') {
        document.querySelector('#alarmOverlay .alarm-icon').textContent = 'üë®‚ÄçüöÄ';
        document.getElementById('alarmText').textContent = 'Houston, le temps est √©coul√©.';
        overlay.classList.add('theme-espace');
        drawAlarmStars();
        var spaceVideo = document.getElementById('spaceManVideo');
        spaceVideo.play().catch(function() {});
      } else if (finMode === 'flash') {
        overlay.classList.add('flashing');
      }
      if (finMode === 'voix')      startAlarmVoice();
      if (finMode === 'vibration') startAlarmVibration();
    }

    function startAlarmVoice() {
      let text = 'Le temps est √©coul√©';
      if (timerStyle === 'kawaii') text = 'Pluie de paillettes termin√©e';
      else if (timerStyle === 'espace') text = 'Houston, le temps est √©coul√©';
      const say = () => {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'fr-FR';
        speechSynthesis.speak(u);
      };
      say();
      alarmInterval = setInterval(say, 4500);
    }

    function startAlarmVibration() {
      const p = [800, 300, 800, 300, 800];
      navigator.vibrate && navigator.vibrate(p);
      alarmInterval = setInterval(() => navigator.vibrate && navigator.vibrate(p), 4000);
    }

    function stopAlarmEffects() {
      clearInterval(alarmInterval);
      alarmInterval = null;
      speechSynthesis.cancel();
      navigator.vibrate && navigator.vibrate(0);
    }

    function startSparkles() {
      const container = document.getElementById('alarmSparkles');
      container.innerHTML = '';
      const emojis = ['‚ú®', '‚≠ê', 'üåü', 'üí´'];
      for (let i = 0; i < 10; i++) {
        const p = document.createElement('span');
        p.className = 'sparkle-particle';
        p.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        p.style.left = (Math.random() * 100) + '%';
        p.style.animationDelay = (Math.random() * 2.5) + 's';
        p.style.animationDuration = (1.8 + Math.random() * 2.2) + 's';
        p.style.fontSize = (14 + Math.floor(Math.random() * 18)) + 'px';
        container.appendChild(p);
      }
    }

    function stopSparkles() {
      document.getElementById('alarmSparkles').innerHTML = '';
    }

    function startGlitter() {
      var v = document.getElementById('glitterBg');
      v.play().catch(function() {});
    }

    function stopGlitter() {
      var v = document.getElementById('glitterBg');
      v.pause();
      v.currentTime = 0;
    }

    function stopAlarm() {
      stopAlarmEffects();
      stopSparkles();
      stopGlitter();
      var spaceVideo = document.getElementById('spaceManVideo');
      spaceVideo.pause(); spaceVideo.currentTime = 0;
      var kawaiiVideo = document.getElementById('kawaiiAlarmVideo');
      kawaiiVideo.pause(); kawaiiVideo.currentTime = 0;
      const overlay = document.getElementById('alarmOverlay');
      overlay.classList.remove('visible', 'flashing', 'theme-kawaii', 'theme-espace');
      overlay.style.background = '';
      document.querySelector('#alarmOverlay .alarm-icon').textContent = '‚è∞';
      document.getElementById('alarmText').textContent = 'Temps √©coul√© !';
      closeSnoozeSheet();
      state         = 'idle';
      timeRemaining = totalDuration;
      updateUI();
    }

    function snoozeQuick(seconds) { doSnooze(seconds); }

    function snoozeFromCarousel() {
      const h = getCarouselVal('snoozeTrackH');
      const m = getCarouselVal('snoozeTrackM');
      const s = getCarouselVal('snoozeTrackS');
      const total = h * 3600 + m * 60 + s;
      if (total < 1) return;
      doSnooze(total);
    }

    function doSnooze(seconds) {
      stopAlarmEffects();
      stopSparkles();
      stopGlitter();
      var spaceVideo = document.getElementById('spaceManVideo');
      spaceVideo.pause(); spaceVideo.currentTime = 0;
      var kawaiiVideo = document.getElementById('kawaiiAlarmVideo');
      kawaiiVideo.pause(); kawaiiVideo.currentTime = 0;
      const snoozeOverlay = document.getElementById('alarmOverlay');
      snoozeOverlay.classList.remove('visible', 'flashing', 'theme-kawaii', 'theme-espace');
      snoozeOverlay.style.background = '';
      document.querySelector('#alarmOverlay .alarm-icon').textContent = '‚è∞';
      document.getElementById('alarmText').textContent = 'Temps √©coul√© !';
      closeSnoozeSheet();
      totalDuration = seconds;
      timeRemaining = seconds;
      announcedSet  = new Set();
      endTimestamp  = Date.now() + seconds * 1000;
      state         = 'running';
      startInterval();
      saveRunningState();
      requestWakeLock();
      updateUI();
    }

    /* ---------- ALERTES INTERM√âDIAIRES ---------- */
    function checkAnnouncements() {
      if (sonMode === 'mute') return;
      for (const t of THRESHOLDS) {
        if (timeRemaining <= t && t < totalDuration && !announcedSet.has(t)) {
          announcedSet.add(t);
          if (sonMode === 'voix') {
            speechSynthesis.cancel();
            const msgs = timerStyle === 'kawaii' ? THRESHOLD_MSGS_KAWAII
                       : timerStyle === 'espace' ? THRESHOLD_MSGS_ESPACE
                       : THRESHOLD_MSGS;
            const u = new SpeechSynthesisUtterance(msgs[t]);
            u.lang = 'fr-FR';
            speechSynthesis.speak(u);
          } else if (sonMode === 'vibration') {
            navigator.vibrate && navigator.vibrate([200, 100, 200, 100, 200]);
          } else {
            playThresholdBip();
          }
        }
      }
    }

    function playThresholdBip() {
      const ctx = getAudioCtx();
      if (!ctx) return;
      const play = () => {
        try {
          [660, 880].forEach((freq, i) => {
            setTimeout(() => {
              const o = ctx.createOscillator(), g = ctx.createGain();
              o.type = 'sine';
              o.frequency.value = freq;
              g.gain.setValueAtTime(0.35, ctx.currentTime);
              g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.55);
              o.connect(g); g.connect(ctx.destination);
              o.start(); o.stop(ctx.currentTime + 0.55);
            }, i * 200);
          });
        } catch(e) {}
      };
      if (ctx.state === 'running') play();
      else ctx.resume().then(play).catch(() => {});
    }

    /* ---------- AUDIO ---------- */
    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    function unlockAudio() {
      const ctx = getAudioCtx();
      if (!ctx) return;
      ctx.resume().then(() => {
        const buf = ctx.createBuffer(1, 1, 22050);
        const src = ctx.createBufferSource();
        src.buffer = buf; src.connect(ctx.destination); src.start(0);
      }).catch(() => {});
    }

    /* ---------- TOAST ---------- */
    function showToast(text) {
      const toast = document.getElementById('timerToast');
      toast.textContent = text;
      toast.classList.add('visible');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toast.classList.remove('visible'), 3200);
    }

    /* ---------- MISE √Ä JOUR UI ---------- */
    function updateUI() {
      updateDisplay();
      updatePlayBtn();
      document.getElementById('circleWrap').classList.toggle('paused', state === 'paused');
    }

    function updateDisplay() {
      const t = formatTime(timeRemaining);
      for (let i = 1; i <= 6; i++) {
        const d = document.getElementById('timeDisplay' + i);
        const h = document.getElementById('timeHint' + i);
        if (d) d.textContent = t;
        if (h) h.textContent = { idle: 'Appuie pour r√©gler', running: '', paused: 'En pause ¬∑ reprendre ?', alarm: '' }[state] || '';
      }
      const progress = totalDuration > 0 ? (1 - timeRemaining / totalDuration) : 0;
      document.getElementById('progressArc').style.strokeDashoffset = CIRCUMFERENCE * progress;
      document.getElementById('barFill').style.height = (progress * 100) + '%';
      updateSegments(progress);
      updatePixels(progress);
      document.getElementById('kawaiiArc').style.strokeDashoffset = CIRCUMFERENCE * progress;
      updateKawaiiColors(progress);
      document.getElementById('spaceArc').style.strokeDashoffset = CIRCUMFERENCE * progress;
      updateSpaceArc(progress);
    }

    function updatePlayBtn() {
      const btn  = document.getElementById('btnPlay');
      const icon = document.getElementById('playIcon');
      const cfg = {
        idle:    { i: '‚ñ∂', bg: 'var(--accent)',          color: 'var(--dark)',  disabled: false },
        running: { i: '‚è∏', bg: 'rgba(245,228,204,0.2)',  color: 'var(--light)', disabled: false },
        paused:  { i: '‚ñ∂', bg: 'var(--accent)',          color: 'var(--dark)',  disabled: false },
        alarm:   { i: '‚è∏', bg: 'rgba(245,228,204,0.1)',  color: 'var(--light)', disabled: true  }
      }[state];
      icon.textContent     = cfg.i;
      btn.style.background = cfg.bg;
      btn.style.color      = cfg.color;
      btn.disabled         = cfg.disabled;
    }

    function updateSonBtn() {
      document.getElementById('sonIcon').textContent  = SON_ICONS[sonMode];
      document.getElementById('sonLabel').textContent = SON_LABELS[sonMode];
      document.getElementById('btnSon').classList.toggle('active', sonMode !== 'mute');
    }

    function updateFinBtn() {
      document.getElementById('finIcon').textContent  = FIN_ICONS[finMode];
      document.getElementById('finLabel').textContent = FIN_LABELS[finMode];
      document.getElementById('btnFin').classList.toggle('active', finMode !== 'rien');
    }

    /* ---------- CYCLE BOUTONS ---------- */
    function cycleSon() {
      sonMode = SON_CYCLE[(SON_CYCLE.indexOf(sonMode) + 1) % SON_CYCLE.length];
      localStorage.setItem('timerSonMode', sonMode);
      updateSonBtn();
      showToast(SON_TOASTS[sonMode]);
    }

    function cycleFin() {
      finMode = FIN_CYCLE[(FIN_CYCLE.indexOf(finMode) + 1) % FIN_CYCLE.length];
      localStorage.setItem('timerFinMode', finMode);
      updateFinBtn();
      showToast(FIN_TOASTS[finMode]);
    }

    /* ---------- DURATION SHEET ---------- */
    function openDurationSheet() {
      syncCarouselToTime(timeRemaining, 'trackH', 'trackM', 'trackS');
      document.getElementById('durationSheet').classList.add('visible');
    }

    function closeDurationSheet() {
      document.getElementById('durationSheet').classList.remove('visible');
    }

    function adjustDuration(delta) {
      const h = getCarouselVal('trackH');
      const m = getCarouselVal('trackM');
      const s = getCarouselVal('trackS');
      const next = Math.max(10, h * 3600 + m * 60 + s + delta);
      syncCarouselToTime(next, 'trackH', 'trackM', 'trackS');
    }

    /* ---------- SNOOZE SHEET ---------- */
    function openSnoozeSheet() {
      syncCarouselToTime(300, 'snoozeTrackH', 'snoozeTrackM', 'snoozeTrackS');
      document.getElementById('snoozeSheet').classList.add('visible');
    }

    function closeSnoozeSheet() {
      document.getElementById('snoozeSheet').classList.remove('visible');
    }

    function onBackdropClick(e, sheetId) {
      if (e.target === document.getElementById(sheetId))
        document.getElementById(sheetId).classList.remove('visible');
    }

    /* ---------- STYLE SHEET ---------- */
    function openStyleSheet() {
      document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
      const active = document.getElementById('styleBtn-' + timerStyle);
      if (active) active.classList.add('active');
      document.getElementById('styleSheet').classList.add('visible');
    }

    function closeStyleSheet() {
      document.getElementById('styleSheet').classList.remove('visible');
    }

    function setStyle(s) {
      timerStyle = s;
      localStorage.setItem('timerStyle', s);
      applyStyle(s);
      closeStyleSheet();
    }

    function applyStyle(s) {
      const map = { cercle:'circleWrap', barre:'barWrap', segments:'segmentsWrap', pixels:'pixelsWrap', kawaii:'kawaiiWrap', espace:'spaceWrap' };
      Object.values(map).forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; });
      const el = document.getElementById(map[s]);
      if (el) el.style.display = s === 'segments' ? 'flex' : 'block';
      const pixelsTimeRow = document.getElementById('pixelsTimeRow');
      if (pixelsTimeRow) pixelsTimeRow.style.display = s === 'pixels' ? 'flex' : 'none';
      document.getElementById('styleIcon').textContent  = STYLE_ICONS[s];
      document.getElementById('styleLabel').textContent = STYLE_LABELS[s];
      if (s === 'pixels')   { initPixels(); updatePixels(totalDuration > 0 ? (1 - timeRemaining / totalDuration) : 0); }
      if (s === 'segments') buildSegmentsSvg();

      if (s !== 'kawaii') { stopKawaiiAnim(); stopBgRain(); }
      else {
        if (!kawaiiAnimFrame && kawaiiParticles.length > 0) {
          kawaiiAnimFrame = requestAnimationFrame(animateKawaii);
        }
        startBgRain();
      }

      /* Fond de page */
      const pageBg       = document.getElementById('pageBg');
      const pageBgCanvas = document.getElementById('pageBgCanvas');
      const pageBgNebula = document.getElementById('pageBgNebula');
      pageBg.style.display = pageBgCanvas.style.display = pageBgNebula.style.display = 'none';
      document.body.style.backgroundColor = '';

      if (s === 'espace') {
        pageBgCanvas.style.display = 'block';
        pageBgNebula.style.display = 'block';
        document.body.style.backgroundColor = 'transparent';
        drawFullPageStars();
        drawSpaceStars();
      } else if (s === 'kawaii') {
        pageBg.style.display = 'block';
        updateKawaiiColors(totalDuration > 0 ? (1 - timeRemaining / totalDuration) : 0);
      }
    }

    /* ---------- RETOUR ---------- */
    function onBack() {
      if (state === 'running') saveRunningState();
      location.href = 'index.html';
    }

    /* ---------- UTILS ---------- */
    function formatTime(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
      return `${pad(m)}:${pad(s)}`;
    }

    function pad(n) { return String(n).padStart(2, '0'); }

    /* =====================================================
       CAROUSEL hh:mm:ss
    ===================================================== */
    const ITEM_H = 40;

    function buildCarousel(trackId, drumId, min, max) {
      const track = document.getElementById(trackId);
      track.innerHTML = '';
      const ghost = document.createElement('div');
      ghost.className = 'carousel-item';
      track.appendChild(ghost.cloneNode());
      for (let v = min; v <= max; v++) {
        const item = document.createElement('div');
        item.className = 'carousel-item';
        item.textContent = pad(v);
        item.dataset.value = v;
        track.appendChild(item);
      }
      track.appendChild(ghost.cloneNode());
      setCarouselByIdx(trackId, 0);
      addDrumListeners(trackId, drumId, min, max);
    }

    function addDrumListeners(trackId, drumId, min, max) {
      const drum  = document.getElementById(drumId);
      const track = document.getElementById(trackId);
      let startY = 0, startOffset = 0, isDragging = false;

      function getOffset() {
        const match = track.style.transform && track.style.transform.match(/translateY\((.+)px\)/);
        return match ? parseFloat(match[1]) : 0;
      }

      function onStart(y) {
        isDragging = true;
        startY = y;
        startOffset = getOffset();
        track.style.transition = 'none';
      }

      function onMove(y) {
        if (!isDragging) return;
        const minOff = -(max - min) * ITEM_H;
        const delta = startOffset + (y - startY);
        const next = Math.max(minOff - ITEM_H, Math.min(ITEM_H, delta));
        track.style.transform = `translateY(${next}px)`;
      }

      function onEnd() {
        if (!isDragging) return;
        isDragging = false;
        snapTo(trackId, drumId, Math.round(-getOffset() / ITEM_H), min, max);
      }

      drum.addEventListener('touchstart', e => { e.preventDefault(); onStart(e.touches[0].clientY); }, { passive: false });
      drum.addEventListener('touchmove',  e => { e.preventDefault(); onMove(e.touches[0].clientY); }, { passive: false });
      drum.addEventListener('touchend',   () => onEnd());
      drum.addEventListener('mousedown',  e => onStart(e.clientY));
      // Listeners globaux stock√©s pour √©viter les doublons sur document
      drum._onMouseMove = e => { if(isDragging) onMove(e.clientY); };
      drum._onMouseUp   = () => { if(isDragging) onEnd(); };
      document.addEventListener('mousemove', drum._onMouseMove);
      document.addEventListener('mouseup',   drum._onMouseUp);
    }

    function snapTo(trackId, drumId, idx, min, max) {
      const range = max - min + 1;
      idx = ((idx % range) + range) % range;
      const track = document.getElementById(trackId);
      track.style.transition = 'transform 0.18s ease';
      track.style.transform  = `translateY(${-idx * ITEM_H}px)`;
      updateCarouselSelection(trackId, idx);
    }

    function setCarouselByIdx(trackId, idx) {
      const track = document.getElementById(trackId);
      track.style.transition = 'none';
      track.style.transform  = `translateY(${-idx * ITEM_H}px)`;
      updateCarouselSelection(trackId, idx);
    }

    function updateCarouselSelection(trackId, idx) {
      const items = document.getElementById(trackId).querySelectorAll('.carousel-item[data-value]');
      items.forEach((item, i) => item.classList.toggle('selected', i === idx));
    }

    function getCarouselVal(trackId) {
      const selected = document.getElementById(trackId).querySelector('.carousel-item.selected');
      return selected ? parseInt(selected.dataset.value) : 0;
    }

    function setCarouselValue(trackId, value) {
      const items = document.getElementById(trackId).querySelectorAll('.carousel-item[data-value]');
      let idx = 0;
      items.forEach((item, i) => { if (parseInt(item.dataset.value) === value) idx = i; });
      setCarouselByIdx(trackId, idx);
    }

    function syncCarouselToTime(seconds, tH, tM, tS) {
      setCarouselValue(tH, Math.floor(seconds / 3600));
      setCarouselValue(tM, Math.floor((seconds % 3600) / 60));
      setCarouselValue(tS, seconds % 60);
    }

    /* =====================================================
       STYLE 3 ‚Äî SEGMENTS (pilules horizontales)
    ===================================================== */
    const N_SEGMENTS = 20;

    function buildSegmentsSvg() {
      const container = document.getElementById('segPills');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < N_SEGMENTS; i++) {
        const pill = document.createElement('div');
        pill.className = 'seg-pill';
        container.appendChild(pill);
      }
      updateSegments(totalDuration > 0 ? (1 - timeRemaining / totalDuration) : 0);
    }

    function updateSegments(progress) {
      const elapsed = Math.round(progress * N_SEGMENTS);
      document.querySelectorAll('#segPills .seg-pill').forEach((pill, i) => {
        pill.classList.toggle('active', i < elapsed);
      });
    }

    /* =====================================================
       STYLE 4 ‚Äî PIXELS
    ===================================================== */
    const COLS = 10, ROWS = 20;
    let pixelGrid = [];

    function initPixels() {
      pixelGrid = Array.from({ length: ROWS }, () => Array(COLS).fill(false));
      const canvas = document.getElementById('pixelsCanvas');
      const size   = document.getElementById('pixelsWrap').offsetWidth || 270;
      canvas.width = canvas.height = size;
      drawPixels();
    }

    function updatePixels(progress) {
      const target  = Math.round(progress * COLS * ROWS);
      const current = pixelGrid.flat().filter(Boolean).length;
      const diff    = target - current;
      if (diff > 0)  for (let k = 0; k < diff;  k++) addPixel();
      if (diff < 0)  for (let k = 0; k < -diff; k++) removeTopPixel();
      drawPixels();
    }

    function addPixel() {
      const free = [];
      for (let c = 0; c < COLS; c++) { if (!pixelGrid[0][c]) free.push(c); }
      if (!free.length) return;
      const col = free[Math.floor(Math.random() * free.length)];
      for (let r = ROWS - 1; r >= 0; r--) {
        if (!pixelGrid[r][col]) { pixelGrid[r][col] = true; return; }
      }
    }

    function removeTopPixel() {
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (pixelGrid[r][c]) { pixelGrid[r][c] = false; return; }
        }
      }
    }

    function rrect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.arcTo(x + w, y,     x + w, y + r,     r);
      ctx.lineTo(x + w, y + h - r);
      ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
      ctx.lineTo(x + r, y + h);
      ctx.arcTo(x,     y + h, x,     y + h - r, r);
      ctx.lineTo(x,     y + r);
      ctx.arcTo(x,     y,     x + r, y,         r);
      ctx.closePath();
    }

    function drawPixels() {
      const canvas = document.getElementById('pixelsCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;
      const cw = W / COLS, ch = H / ROWS;
      const p = 2;
      ctx.clearRect(0, 0, W, H);
      ctx.fillStyle = 'rgba(245,228,204,0.04)';
      rrect(ctx, 0, 0, W, H, 20); ctx.fill();
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          ctx.fillStyle = pixelGrid[r][c] ? '#F7B89C' : 'rgba(245,228,204,0.06)';
          rrect(ctx, c * cw + p, r * ch + p, cw - p*2, ch - p*2, 3);
          ctx.fill();
        }
      }
    }

    /* =====================================================
       STYLE 5 ‚Äî KAWAII
    ===================================================== */
    const KAWAII_STICKERS = ['üå∏','‚ú®','üíñ','üéÄ','üç≠','üåô','‚≠ê','ü¶Ñ','üç¨','üí´','üåà','üéµ'];
    const RAINBOW = ['#ff6b9d','#ff9a6c','#ffd93d','#6bceff','#a29bfe','#fd79a8'];

    function initKawaii() {
      const container = document.getElementById('kawaiiStickers');
      container.innerHTML = '';
      kawaiiParticles.length = 0;
      KAWAII_STICKERS.forEach(s => {
        const el = document.createElement('span');
        el.className = 'kawaii-sticker';
        el.textContent = s;
        container.appendChild(el);
        const angle = Math.random() * Math.PI * 2;
        const dist  = Math.random() * 0.65;
        const x = 50 + dist * 38 * Math.cos(angle);
        const y = 50 + dist * 38 * Math.sin(angle);
        const speed  = 0.06 + Math.random() * 0.08;
        const vAngle = Math.random() * Math.PI * 2;
        kawaiiParticles.push({ el, x, y, vx: speed * Math.cos(vAngle), vy: speed * Math.sin(vAngle) });
        el.style.left = x + '%';
        el.style.top  = y + '%';
      });
      updateKawaiiColors(0);
      if (kawaiiAnimFrame) cancelAnimationFrame(kawaiiAnimFrame);
      kawaiiAnimFrame = requestAnimationFrame(animateKawaii);
    }

    function animateKawaii() {
      kawaiiParticles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        const dx   = p.x - 50;
        const dy   = p.y - 50;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const maxD = 37;
        if (dist > maxD) {
          const nx  = dx / dist, ny = dy / dist;
          const dot = p.vx * nx + p.vy * ny;
          p.vx -= 2 * dot * nx;
          p.vy -= 2 * dot * ny;
          p.x = 50 + nx * (maxD - 0.5);
          p.y = 50 + ny * (maxD - 0.5);
        }
        p.vx += (Math.random() - 0.5) * 0.01;
        p.vy += (Math.random() - 0.5) * 0.01;
        const spd = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
        if (spd > 0.18) { p.vx *= 0.18 / spd; p.vy *= 0.18 / spd; }
        if (spd < 0.03) { p.vx += (Math.random() - 0.5) * 0.03; p.vy += (Math.random() - 0.5) * 0.03; }
        p.el.style.left = p.x + '%';
        p.el.style.top  = p.y + '%';
      });
      kawaiiAnimFrame = requestAnimationFrame(animateKawaii);
    }

    function stopKawaiiAnim() {
      if (kawaiiAnimFrame) { cancelAnimationFrame(kawaiiAnimFrame); kawaiiAnimFrame = null; }
    }

    const BG_RAIN_EMOJIS = ['‚ú®','‚≠ê','üí´','üåü','üéÄ','üíñ','üç≠','üå∏'];

    function startBgRain() {
      const container = document.getElementById('kawaiiBgRain');
      container.innerHTML = '';
      container.style.display = 'block';
      for (let i = 0; i < 18; i++) {
        const p = document.createElement('span');
        p.className = 'bg-sparkle';
        p.textContent = BG_RAIN_EMOJIS[Math.floor(Math.random() * BG_RAIN_EMOJIS.length)];
        p.style.left = (Math.random() * 100) + '%';
        p.style.fontSize = (12 + Math.floor(Math.random() * 14)) + 'px';
        p.style.animationDuration = (4 + Math.random() * 6) + 's';
        p.style.animationDelay = (-Math.random() * 10) + 's';
        container.appendChild(p);
      }
    }

    function stopBgRain() {
      const container = document.getElementById('kawaiiBgRain');
      container.style.display = 'none';
      container.innerHTML = '';
    }

    function updateKawaiiColors(progress) {
      const hue = Math.round(progress * 300);
      const gradient = `conic-gradient(from ${hue}deg, ${RAINBOW.join(',')}, ${RAINBOW[0]})`;
      const bg  = document.getElementById('kawaiiBg');
      if (bg) { bg.style.background = gradient; bg.style.opacity = '0.55'; }
      const arc = document.getElementById('kawaiiArc');
      if (arc) arc.style.stroke = `hsl(${(hue + 180) % 360}, 90%, 65%)`;
      if (timerStyle === 'kawaii') {
        const pageBg = document.getElementById('pageBg');
        if (pageBg && pageBg.style.display !== 'none') pageBg.style.background = gradient;
      }
    }

    /* =====================================================
       STYLE 6 ‚Äî ESPACE
    ===================================================== */
    function initSpace() { drawSpaceStars(); }

    function drawSpaceStars() {
      const canvas = document.getElementById('spaceStarsCanvas');
      if (!canvas) return;
      const size = document.getElementById('spaceWrap').offsetWidth || 270;
      canvas.width = canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, size, size);
      for (let i = 0; i < 80; i++) {
        const x = Math.random() * size, y = Math.random() * size;
        const r = Math.random() * 1.5, a = 0.3 + Math.random() * 0.7;
        ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(200,220,255,${a})`; ctx.fill();
      }
    }

    function updateSpaceArc(progress) {
      const arc = document.getElementById('spaceArc');
      if (arc) arc.style.stroke = 'hsl(265, 85%, 72%)';
      const spaceWrap = document.getElementById('spaceWrap');
      if (spaceWrap) {
        const nebula = spaceWrap.querySelector('.space-nebula');
        if (nebula) nebula.style.transform = `rotate(${-progress * 360}deg)`;
      }
    }

    function drawAlarmStars() {
      const canvas = document.getElementById('alarmStarsCanvas');
      if (!canvas) return;
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      const ctx = canvas.getContext('2d');
      for (let i = 0; i < 160; i++) {
        const x = Math.random() * canvas.width, y = Math.random() * canvas.height;
        const r = Math.random() * 1.8, a = 0.3 + Math.random() * 0.7;
        ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(200,220,255,${a})`; ctx.fill();
      }
    }

    function drawFullPageStars() {
      const canvas = document.getElementById('pageBgCanvas');
      if (!canvas) return;
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#060b1a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < 180; i++) {
        const x = Math.random() * canvas.width, y = Math.random() * canvas.height;
        const r = Math.random() * 1.8, a = 0.3 + Math.random() * 0.7;
        ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(200,220,255,${a})`; ctx.fill();
      }
    }
  </script>
  <script src="nora-scroll.js"></script>
</body>
</html>
