<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="color-scheme" content="only light">
  <meta name="theme-color" content="#384657">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/images/favicone.png" type="image/png">
  <link rel="apple-touch-icon" href="assets/images/logo.png">
  <link rel="stylesheet" href="nora-common.css">
  <title>Nora ‚Äì Timer visuel</title>
  <style>
    /* ---------- LAYOUT ---------- */
    body {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg);
    }

    .timer-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }

    /* ---------- CERCLE SVG ---------- */
    .circle-wrap {
      position: relative;
      width: min(310px, 80vw);
      aspect-ratio: 1;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .circle-wrap svg {
      width: 100%;
      height: 100%;
    }

    .track {
      fill: none;
      stroke: rgba(245, 228, 204, 0.12);
      stroke-width: 8;
    }

    .progress {
      fill: none;
      stroke: var(--accent);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.9s linear;
    }

    .circle-wrap.paused .progress {
      stroke: rgba(247, 184, 156, 0.4);
    }

    /* Contenu au centre du cercle ‚Äî pointer-events off sauf time-display */
    .circle-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      pointer-events: none;
    }

    .time-display {
      font-size: clamp(2.6rem, 13vw, 3.8rem);
      font-weight: 300;
      color: var(--light);
      letter-spacing: 2px;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      pointer-events: auto;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .time-hint {
      font-size: 0.7rem;
      color: rgba(245, 228, 204, 0.4);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      min-height: 1em;
    }

    /* ---------- FOOTER BUTTONS (style Pop-it) ---------- */
    .timer-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      gap: 8px;
      padding: 0 12px;
      background: var(--dark);
      height: var(--footer-height);
      align-items: center;
      z-index: 200;
    }

    .t-btn {
      flex: 1;
      height: 50px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      background: rgba(245, 228, 204, 0.15);
      color: var(--light);
      border: 1px solid rgba(245, 228, 204, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.1;
      cursor: pointer;
      -webkit-appearance: none;
      gap: 2px;
    }

    .t-btn.active {
      background: var(--accent);
      color: var(--dark);
      border: none;
    }

    .t-btn:disabled {
      opacity: 0.3;
      pointer-events: none;
    }

    .t-btn > span {
      font-size: 18px;
      display: block;
      pointer-events: none;
    }

    .t-btn > small {
      font-weight: 800;
      text-transform: uppercase;
      pointer-events: none;
    }

    /* ---------- TOAST ---------- */
    .timer-toast {
      position: fixed;
      bottom: calc(var(--footer-height) + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(46, 58, 89, 0.97);
      color: var(--light);
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      box-shadow: 0 4px 14px rgba(0,0,0,0.4);
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 300;
      pointer-events: none;
      text-align: center;
      max-width: 90%;
      white-space: nowrap;
    }

    .timer-toast.visible { opacity: 1; }

    /* ---------- BOTTOM-SHEET ---------- */
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: flex-end;
      z-index: 500;
    }

    .sheet-backdrop.visible { display: flex; }

    .sheet-box {
      background: #020617;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 20px 20px 40px;
      position: relative;
    }

    .sheet-handle {
      width: 40px;
      height: 4px;
      background: rgba(255,255,255,0.15);
      border-radius: 2px;
      margin: 0 auto 18px;
    }

    .sheet-close {
      position: absolute;
      top: 14px;
      right: 18px;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      color: rgba(245, 228, 204, 0.5);
    }

    .sheet-title {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      color: var(--light);
      margin-bottom: 14px;
    }

    /* Dur√©e affich√©e ‚Äî cliquable pour saisie manuelle */
    .sheet-duration-val {
      text-align: center;
      font-size: 2.8rem;
      font-weight: 300;
      color: var(--light);
      letter-spacing: 4px;
      font-variant-numeric: tabular-nums;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .sheet-duration-hint {
      text-align: center;
      font-size: 0.68rem;
      color: rgba(245, 228, 204, 0.35);
      letter-spacing: 0.5px;
      margin-top: 2px;
      margin-bottom: 14px;
    }

    /* Input saisie manuelle */
    .sheet-duration-input {
      display: none;
      width: 100%;
      box-sizing: border-box;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(247,184,156,0.35);
      border-radius: 12px;
      padding: 12px;
      color: var(--light);
      font-size: 1.5rem;
      font-family: inherit;
      text-align: center;
      margin-bottom: 14px;
      outline: none;
    }

    .sheet-duration-input:focus { border-color: var(--accent); }

    .sheet-presets {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .sheet-presets button {
      flex: 1;
      padding: 12px 6px;
      background: rgba(245, 228, 204, 0.1);
      color: var(--light);
      border: none;
      border-radius: 12px;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .sheet-presets button:active { background: rgba(245, 228, 204, 0.2); }

    .sheet-adjusters {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      margin-bottom: 20px;
    }

    .sheet-adjusters button {
      flex: 1 1 calc(25% - 7px);
      padding: 9px 4px;
      background: rgba(245, 228, 204, 0.07);
      color: var(--light);
      border: none;
      border-radius: 10px;
      font-size: 0.76rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      text-align: center;
    }

    .sheet-adjusters button:active { background: rgba(245, 228, 204, 0.16); }

    .sheet-start {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: var(--dark);
      border: none;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .sheet-start:active { opacity: 0.88; }

    /* ---------- ALARME (z-index 900) ---------- */
    .alarm-overlay {
      position: fixed;
      inset: 0;
      background: var(--dark);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 900;
      padding: 32px 24px;
    }

    .alarm-overlay.visible { display: flex; }

    .alarm-overlay.flashing {
      animation: alarmFlash 0.9s ease-in-out infinite;
    }

    @keyframes alarmFlash {
      0%, 100% { background: var(--dark); }
      50% { background: var(--light); }
    }

    .alarm-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      background: rgba(46, 58, 89, 0.92);
      border-radius: 28px;
      padding: 36px 28px;
      width: 100%;
      max-width: 320px;
    }

    .alarm-icon {
      font-size: 3.5rem;
      animation: alarmPulse 0.9s ease-in-out infinite;
    }

    @keyframes alarmPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .alarm-text {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--light);
      text-align: center;
    }

    .alarm-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
    }

    .alarm-btn {
      padding: 16px;
      border: none;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      text-align: center;
    }

    .alarm-btn.primary {
      background: var(--accent);
      color: var(--dark);
    }

    .alarm-btn.secondary {
      background: rgba(245, 228, 204, 0.15);
      color: var(--light);
    }

    /* Snooze sheet : z-index 1000 > alarm-overlay 900 */
    #snoozeSheet { z-index: 1000; }
  </style>
</head>
<body>

  <header class="header">
    <button class="back-button" onclick="onBack()" aria-label="Retour">‚¨ÖÔ∏è</button>
    <h1 class="page-title">Timer visuel</h1>
  </header>

  <main class="timer-main">
    <!-- Cercle : tap partout = play/pause ‚Äî tap sur le temps = changer dur√©e -->
    <div class="circle-wrap" id="circleWrap" onclick="onCircleTap()" role="button" aria-label="D√©marrer ou mettre en pause">
      <!-- r=42 ‚Üí circumference = 2œÄ√ó42 ‚âà 263.89 -->
      <svg viewBox="0 0 100 100" aria-hidden="true">
        <circle class="track" cx="50" cy="50" r="42"/>
        <circle class="progress" id="progressArc" cx="50" cy="50" r="42"
          stroke-dasharray="263.89" stroke-dashoffset="0"
          transform="rotate(-90 50 50)"/>
      </svg>
      <div class="circle-center">
        <div class="time-display" id="timeDisplay" onclick="onTimeTap(event)" role="button" aria-label="Modifier la dur√©e">30:00</div>
        <div class="time-hint" id="timeHint">Appuie pour r√©gler</div>
      </div>
    </div>
  </main>

  <!-- Footer controls -->
  <footer class="timer-footer">
    <button class="t-btn active" id="btnSon" onclick="cycleSon()">
      <span id="sonIcon">üîî</span>
      <small id="sonLabel">BIP</small>
    </button>
    <button class="t-btn active" id="btnFin" onclick="cycleFin()">
      <span id="finIcon">‚ö°</span>
      <small id="finLabel">FLASH</small>
    </button>
    <button class="t-btn" id="btnPause" onclick="togglePause()">
      <span id="pauseIcon">‚ñ∂</span>
      <small id="pauseLabel">START</small>
    </button>
    <button class="t-btn" id="btnReset" onclick="resetTimer()">
      <span>‚Ü∫</span>
      <small>RESET</small>
    </button>
  </footer>

  <!-- Toast -->
  <div class="timer-toast" id="timerToast"></div>

  <!-- Duration picker -->
  <div class="sheet-backdrop" id="durationSheet" onclick="onBackdropClick(event,'durationSheet')">
    <div class="sheet-box">
      <div class="sheet-handle"></div>
      <div class="sheet-close" onclick="closeDurationSheet()">‚úï</div>
      <strong class="sheet-title">Dur√©e du timer</strong>

      <!-- Valeur affich√©e : tap ‚Üí saisie manuelle -->
      <div class="sheet-duration-val" id="sheetDurationVal" onclick="startManualInput()">30:00</div>
      <div class="sheet-duration-hint" id="sheetDurationHint">Appuie sur le temps pour saisir manuellement</div>
      <input class="sheet-duration-input" id="sheetDurationInput" type="number"
        min="1" max="600" placeholder="Minutes"
        onblur="confirmManualInput()"
        onkeydown="if(event.key==='Enter')confirmManualInput();if(event.key==='Escape')cancelManualInput()">

      <div class="sheet-presets">
        <button onclick="setDuration(900)">15 min</button>
        <button onclick="setDuration(1800)">30 min</button>
        <button onclick="setDuration(3600)">1 h</button>
      </div>
      <div class="sheet-adjusters">
        <button onclick="adjustDuration(-600)">‚àí10 min</button>
        <button onclick="adjustDuration(-300)">‚àí5 min</button>
        <button onclick="adjustDuration(-60)">‚àí1 min</button>
        <button onclick="adjustDuration(60)">+1 min</button>
        <button onclick="adjustDuration(300)">+5 min</button>
        <button onclick="adjustDuration(600)">+10 min</button>
        <button onclick="adjustDuration(1800)">+30 min</button>
      </div>
      <button class="sheet-start" onclick="startTimer()">‚ñ∂ Commencer</button>
    </div>
  </div>

  <!-- Alarm overlay (z-index 900) -->
  <div class="alarm-overlay" id="alarmOverlay">
    <div class="alarm-content">
      <div class="alarm-icon">‚è∞</div>
      <div class="alarm-text">Temps √©coul√© !</div>
      <div class="alarm-actions">
        <button class="alarm-btn primary" onclick="openSnoozeSheet()">Prolonger</button>
        <button class="alarm-btn secondary" onclick="stopAlarm()">Arr√™ter</button>
      </div>
    </div>
  </div>

  <!-- Snooze sheet (z-index 1000 > alarm) -->
  <div class="sheet-backdrop" id="snoozeSheet" onclick="onBackdropClick(event,'snoozeSheet')">
    <div class="sheet-box">
      <div class="sheet-handle"></div>
      <div class="sheet-close" onclick="closeSnoozeSheet()">‚úï</div>
      <strong class="sheet-title">Prolonger de‚Ä¶</strong>
      <div class="sheet-presets">
        <button onclick="snooze(60)">+1 min</button>
        <button onclick="snooze(300)">+5 min</button>
        <button onclick="snooze(900)">+15 min</button>
        <button onclick="snooze(1800)">+30 min</button>
      </div>
      <button class="alarm-btn secondary" style="width:100%;margin-top:14px;" onclick="stopAlarm()">Arr√™ter compl√®tement</button>
    </div>
  </div>

  <script>
    /* ---------- CONSTANTES ---------- */
    const CIRCUMFERENCE = 2 * Math.PI * 42; // ‚âà 263.89

    const THRESHOLDS = [3600, 1800, 900, 120];
    const THRESHOLD_MSGS = {
      3600: 'Il reste une heure',
      1800: 'Il reste trente minutes',
      900:  'Il reste quinze minutes',
      120:  'Il reste deux minutes'
    };

    const SON_CYCLE  = ['bip', 'voix', 'mute'];
    const SON_ICONS  = { bip: 'üîî', voix: 'üó£Ô∏è', mute: 'üîá' };
    const SON_LABELS = { bip: 'BIP', voix: 'VOIX', mute: 'MUET' };
    const SON_TOASTS = {
      bip:  'Bip sonore aux seuils : 1 h, 30 min, 15 min et 2 min',
      voix: 'Annonces vocales aux seuils : 1 h, 30 min, 15 min et 2 min',
      mute: 'Alertes sonores d√©sactiv√©es'
    };

    const FIN_CYCLE  = ['flash', 'voix', 'vibration', 'rien'];
    const FIN_ICONS  = { flash: '‚ö°', voix: 'üó£Ô∏è', vibration: 'üì≥', rien: 'üîï' };
    const FIN_LABELS = { flash: 'FLASH', voix: 'VOIX', vibration: 'VIB', rien: 'RIEN' };
    const FIN_TOASTS = {
      flash:     'Fin : √©cran clignotant jusqu\'√† arr√™t',
      voix:      'Fin : message vocal r√©p√©t√© jusqu\'√† arr√™t',
      vibration: 'Fin : vibrations r√©p√©t√©es jusqu\'√† arr√™t',
      rien:      'Fin silencieuse ‚Äî seul l\'√©cran s\'affiche'
    };

    /* ---------- √âTAT ---------- */
    let totalDuration = parseInt(localStorage.getItem('timerLastDuration') || '1800');
    let timeRemaining = totalDuration;
    let state         = 'idle'; // idle | running | paused | alarm
    let endTimestamp  = null;
    let timerInterval = null;
    let alarmInterval = null;
    let announcedSet  = new Set();
    let wakeLock      = null;
    let audioCtx      = null;
    let toastTimeout  = null;

    let sonMode = localStorage.getItem('timerSonMode') || 'bip';
    let finMode = localStorage.getItem('timerFinMode') || 'flash';

    /* ---------- INIT ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      updateSonBtn();
      updateFinBtn();
      updateDisplay();
      restoreRunningState();
    });

    /* ---------- PERSISTANCE ---------- */
    function saveRunningState() {
      if (state !== 'running') { localStorage.removeItem('timerRunningState'); return; }
      localStorage.setItem('timerRunningState', JSON.stringify({
        endTimestamp, totalDuration,
        announcedSet: [...announcedSet],
        sonMode, finMode
      }));
    }

    function restoreRunningState() {
      const raw = localStorage.getItem('timerRunningState');
      if (!raw) return;
      try {
        const s = JSON.parse(raw);
        sonMode = s.sonMode || sonMode;
        finMode = s.finMode || finMode;
        const remaining = Math.floor((s.endTimestamp - Date.now()) / 1000);
        if (remaining <= 0) {
          localStorage.removeItem('timerRunningState');
          totalDuration = s.totalDuration;
          timeRemaining = 0;
          triggerAlarm();
          return;
        }
        totalDuration  = s.totalDuration;
        timeRemaining  = remaining;
        endTimestamp   = s.endTimestamp;
        announcedSet   = new Set(s.announcedSet || []);
        state          = 'running';
        startInterval();
        requestWakeLock();
        updateSonBtn();
        updateFinBtn();
        updateUI();
      } catch(e) {
        localStorage.removeItem('timerRunningState');
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState !== 'visible' || state !== 'running') return;
      if (endTimestamp) {
        timeRemaining = Math.max(0, Math.floor((endTimestamp - Date.now()) / 1000));
        updateDisplay();
        if (timeRemaining <= 0) { clearInterval(timerInterval); triggerAlarm(); }
        else requestWakeLock();
      }
    });

    /* ---------- WAKE LOCK ---------- */
    async function requestWakeLock() {
      if (!('wakeLock' in navigator)) return;
      try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    }

    function releaseWakeLock() {
      if (wakeLock) { wakeLock.release().catch(() => {}); wakeLock = null; }
    }

    /* ---------- LOGIQUE TIMER ---------- */
    function startTimer() {
      closeDurationSheet();
      announcedSet  = new Set();
      endTimestamp  = Date.now() + timeRemaining * 1000;
      state         = 'running';
      startInterval();
      saveRunningState();
      requestWakeLock();
      unlockAudio();
      updateUI();
    }

    function startInterval() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (!endTimestamp) return;
        timeRemaining = Math.max(0, Math.floor((endTimestamp - Date.now()) / 1000));
        checkAnnouncements();
        updateDisplay();
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          localStorage.removeItem('timerRunningState');
          triggerAlarm();
        }
      }, 500);
    }

    // Tap sur le cercle = play/pause
    function onCircleTap() {
      if (state === 'alarm') return;
      togglePause();
    }

    // Tap sur les chiffres = modifier la dur√©e (si pas en cours)
    function onTimeTap(e) {
      e.stopPropagation();
      if (state === 'running' || state === 'alarm') return;
      openDurationSheet();
    }

    function togglePause() {
      if (state === 'idle') {
        // D√©marre directement avec la dur√©e actuelle
        startTimer();
        return;
      }
      if (state === 'running') {
        clearInterval(timerInterval);
        releaseWakeLock();
        localStorage.removeItem('timerRunningState');
        state = 'paused';
      } else if (state === 'paused') {
        endTimestamp = Date.now() + timeRemaining * 1000;
        state = 'running';
        startInterval();
        saveRunningState();
        requestWakeLock();
      }
      updateUI();
    }

    function resetTimer() {
      clearInterval(timerInterval);
      stopAlarmEffects();
      releaseWakeLock();
      localStorage.removeItem('timerRunningState');
      state         = 'idle';
      timeRemaining = totalDuration;
      endTimestamp  = null;
      announcedSet  = new Set();
      document.getElementById('alarmOverlay').classList.remove('visible', 'flashing');
      updateUI();
    }

    /* ---------- ALARME ---------- */
    function triggerAlarm() {
      state = 'alarm';
      releaseWakeLock();
      updateUI();
      const overlay = document.getElementById('alarmOverlay');
      overlay.classList.add('visible');
      if (finMode === 'flash')     overlay.classList.add('flashing');
      if (finMode === 'voix')      startAlarmVoice();
      if (finMode === 'vibration') startAlarmVibration();
    }

    function startAlarmVoice() {
      const say = () => {
        const u = new SpeechSynthesisUtterance('Le temps est √©coul√©');
        u.lang = 'fr-FR';
        speechSynthesis.speak(u);
      };
      say();
      alarmInterval = setInterval(say, 4500);
    }

    function startAlarmVibration() {
      const p = [800, 300, 800, 300, 800];
      navigator.vibrate && navigator.vibrate(p);
      alarmInterval = setInterval(() => navigator.vibrate && navigator.vibrate(p), 4000);
    }

    function stopAlarmEffects() {
      clearInterval(alarmInterval);
      alarmInterval = null;
      speechSynthesis.cancel();
      navigator.vibrate && navigator.vibrate(0);
    }

    function stopAlarm() {
      stopAlarmEffects();
      document.getElementById('alarmOverlay').classList.remove('visible', 'flashing');
      closeSnoozeSheet();
      state         = 'idle';
      timeRemaining = totalDuration;
      updateUI();
    }

    function snooze(seconds) {
      stopAlarmEffects();
      document.getElementById('alarmOverlay').classList.remove('visible', 'flashing');
      closeSnoozeSheet();
      timeRemaining = seconds;
      announcedSet  = new Set();
      endTimestamp  = Date.now() + seconds * 1000;
      state         = 'running';
      startInterval();
      saveRunningState();
      requestWakeLock();
      updateUI();
    }

    /* ---------- ALERTES INTERM√âDIAIRES ---------- */
    function checkAnnouncements() {
      if (sonMode === 'mute') return;
      for (const t of THRESHOLDS) {
        if (timeRemaining <= t && t < totalDuration && !announcedSet.has(t)) {
          announcedSet.add(t);
          if (sonMode === 'voix') {
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(THRESHOLD_MSGS[t]);
            u.lang = 'fr-FR';
            speechSynthesis.speak(u);
          } else {
            playThresholdBip();
          }
        }
      }
    }

    function playThresholdBip() {
      const ctx = getAudioCtx();
      if (!ctx) return;
      const play = () => {
        try {
          [660, 880].forEach((freq, i) => {
            setTimeout(() => {
              const o = ctx.createOscillator();
              const g = ctx.createGain();
              o.type = 'sine';
              o.frequency.value = freq;
              g.gain.setValueAtTime(0.35, ctx.currentTime);
              g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.55);
              o.connect(g); g.connect(ctx.destination);
              o.start(); o.stop(ctx.currentTime + 0.55);
            }, i * 200);
          });
        } catch(e) {}
      };
      // Attendre que le contexte soit actif avant de jouer
      if (ctx.state === 'running') {
        play();
      } else {
        ctx.resume().then(play).catch(() => {});
      }
    }

    /* ---------- AUDIO ---------- */
    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    function unlockAudio() {
      const ctx = getAudioCtx();
      if (!ctx) return;
      // Jouer un son silencieux pour d√©bloquer le contexte audio (pattern standard)
      ctx.resume().then(() => {
        const buf = ctx.createBuffer(1, 1, 22050);
        const src = ctx.createBufferSource();
        src.buffer = buf;
        src.connect(ctx.destination);
        src.start(0);
      }).catch(() => {});
    }

    /* ---------- TOAST ---------- */
    function showToast(text) {
      const toast = document.getElementById('timerToast');
      toast.textContent = text;
      toast.classList.add('visible');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toast.classList.remove('visible'), 3200);
    }

    /* ---------- MISE √Ä JOUR UI ---------- */
    function updateUI() {
      updateDisplay();
      updatePauseBtn();
      document.getElementById('circleWrap').classList.toggle('paused', state === 'paused');
    }

    function updateDisplay() {
      document.getElementById('timeDisplay').textContent = formatTime(timeRemaining);
      const hints = { idle: 'Appuie pour r√©gler la dur√©e', running: '', paused: 'En pause ¬∑ appuie pour reprendre', alarm: '' };
      document.getElementById('timeHint').textContent = hints[state] || '';
      const progress = totalDuration > 0 ? (1 - timeRemaining / totalDuration) : 0;
      document.getElementById('progressArc').style.strokeDashoffset = CIRCUMFERENCE * progress;
    }

    function updatePauseBtn() {
      const btn   = document.getElementById('btnPause');
      const icon  = document.getElementById('pauseIcon');
      const label = document.getElementById('pauseLabel');
      const cfg = {
        idle:    { i: '‚ñ∂', l: 'START',    active: false, disabled: false },
        running: { i: '‚è∏', l: 'PAUSE',    active: true,  disabled: false },
        paused:  { i: '‚ñ∂', l: 'REPRENDRE',active: false, disabled: false },
        alarm:   { i: '‚è∏', l: 'PAUSE',    active: false, disabled: true  }
      }[state];
      icon.textContent = cfg.i;
      label.textContent = cfg.l;
      btn.classList.toggle('active', cfg.active);
      btn.disabled = cfg.disabled;
    }

    function updateSonBtn() {
      document.getElementById('sonIcon').textContent  = SON_ICONS[sonMode];
      document.getElementById('sonLabel').textContent = SON_LABELS[sonMode];
      document.getElementById('btnSon').classList.toggle('active', sonMode !== 'mute');
    }

    function updateFinBtn() {
      document.getElementById('finIcon').textContent  = FIN_ICONS[finMode];
      document.getElementById('finLabel').textContent = FIN_LABELS[finMode];
      document.getElementById('btnFin').classList.toggle('active', finMode !== 'rien');
    }

    /* ---------- CYCLE BOUTONS ---------- */
    function cycleSon() {
      const i = SON_CYCLE.indexOf(sonMode);
      sonMode = SON_CYCLE[(i + 1) % SON_CYCLE.length];
      localStorage.setItem('timerSonMode', sonMode);
      updateSonBtn();
      showToast(SON_TOASTS[sonMode]);
    }

    function cycleFin() {
      const i = FIN_CYCLE.indexOf(finMode);
      finMode = FIN_CYCLE[(i + 1) % FIN_CYCLE.length];
      localStorage.setItem('timerFinMode', finMode);
      updateFinBtn();
      showToast(FIN_TOASTS[finMode]);
    }

    /* ---------- DURATION SHEET ---------- */
    function openDurationSheet() {
      syncSheetDisplay();
      document.getElementById('durationSheet').classList.add('visible');
    }

    function closeDurationSheet() {
      cancelManualInput();
      document.getElementById('durationSheet').classList.remove('visible');
    }

    function syncSheetDisplay() {
      document.getElementById('sheetDurationVal').textContent = formatTime(timeRemaining);
      document.getElementById('sheetDurationVal').style.display = '';
      document.getElementById('sheetDurationHint').style.display = '';
      document.getElementById('sheetDurationInput').style.display = 'none';
    }

    function setDuration(sec) {
      timeRemaining = sec;
      totalDuration = sec;
      localStorage.setItem('timerLastDuration', sec);
      syncSheetDisplay();
      updateDisplay();
    }

    function adjustDuration(delta) {
      const v = Math.max(60, timeRemaining + delta);
      timeRemaining = v;
      totalDuration = v;
      localStorage.setItem('timerLastDuration', v);
      syncSheetDisplay();
      updateDisplay();
    }

    /* Saisie manuelle ‚Äî tap sur le temps affich√© */
    function startManualInput() {
      const input = document.getElementById('sheetDurationInput');
      document.getElementById('sheetDurationVal').style.display = 'none';
      document.getElementById('sheetDurationHint').style.display = 'none';
      input.value = Math.max(1, Math.round(timeRemaining / 60));
      input.style.display = 'block';
      setTimeout(() => input.focus(), 50);
    }

    function confirmManualInput() {
      const input = document.getElementById('sheetDurationInput');
      const minutes = parseInt(input.value);
      if (minutes >= 1 && minutes <= 600) {
        setDuration(minutes * 60);
      } else {
        syncSheetDisplay();
      }
    }

    function cancelManualInput() {
      syncSheetDisplay();
    }

    function onBackdropClick(e, sheetId) {
      if (e.target === document.getElementById(sheetId)) {
        document.getElementById(sheetId).classList.remove('visible');
        if (sheetId === 'durationSheet') cancelManualInput();
      }
    }

    /* ---------- SNOOZE SHEET ---------- */
    function openSnoozeSheet() {
      document.getElementById('snoozeSheet').classList.add('visible');
    }

    function closeSnoozeSheet() {
      document.getElementById('snoozeSheet').classList.remove('visible');
    }

    /* ---------- RETOUR ---------- */
    function onBack() {
      if (state === 'running') saveRunningState();
      location.href = 'index.html';
    }

    /* ---------- UTILS ---------- */
    function formatTime(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
      return `${pad(m)}:${pad(s)}`;
    }

    function pad(n) { return String(n).padStart(2, '0'); }
  </script>
  <script src="nora-scroll.js"></script>
</body>
</html>
