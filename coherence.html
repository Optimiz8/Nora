<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cohérence cardiaque</title>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, Inter, sans-serif;
  background: #384657;
  color: #F5E4CC;
  overflow-x: hidden;
}

/* ===== HEADER ===== */
.header {
  background-color: #384657;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 1px solid rgba(245, 228, 204, 0.1);
}

.back-button {
  background: rgba(245, 228, 204, 0.1);
  border: none;
  cursor: pointer;
  padding: 10px;
  border-radius: 8px;
  font-size: 20px;
  width: 44px;
  height: 44px;
  color: #F5E4CC;
}

.back-button:active {
  background-color: rgba(245, 228, 204, 0.2);
  transform: scale(0.95);
}

.page-title {
  font-size: 20px;
  font-weight: 600;
}

.main {
  height: calc(100vh - 76px);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  overflow-y: auto;
}

h2 {
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: #F7B89C;
  margin: 0 0 8px 0;
  text-align: center;
}

/* ---------- CAROUSEL ---------- */
.carousel-section {
  width: 100%;
  flex-shrink: 0;
}

.carousel-wrapper {
  width: 100%;
  overflow: hidden;
  position: relative;
}

.carousel {
  display: flex;
  gap: 12px;
  overflow-x: scroll;
  scroll-snap-type: x mandatory;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  padding: 12px 0;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.carousel::-webkit-scrollbar { display: none; }

.carousel-spacer {
  flex: 0 0 calc(50vw - 65px);
  min-width: calc(50vw - 65px);
}

.item {
  flex: 0 0 auto;
  min-width: 120px;
  padding: 14px 10px;
  text-align: center;
  border-radius: 14px;
  background: #F5E4CC;
  color: #2E3A59;
  scroll-snap-align: center;
  transition: transform 0.2s ease, opacity 0.2s ease;
  cursor: pointer;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  font-weight: 500;
  line-height: 1.3;
  opacity: 0.5;
  font-size: 14px;
}

.item.active {
  opacity: 1;
  transform: scale(1.1);
  font-weight: 600;
}

.item.small { 
  min-width: 70px;
  font-size: 15px;
}

.item .edit-btn {
  display: block;
  margin-top: 6px;
  font-size: 11px;
  color: #F7B89C;
  text-decoration: underline;
}

/* ---------- PREVIEW ANIMATION ---------- */
.preview-container {
  height: 80px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 8px;
}

.preview-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .05em;
  opacity: 0.6;
  margin-bottom: 8px;
  text-align: center;
}

.preview-circle {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(247,184,156,.8), rgba(247,184,156,.3));
  animation: previewPulse 3s ease-in-out infinite;
}

@keyframes previewPulse {
  0%, 100% { transform: scale(0.8); }
  50% { transform: scale(1.2); }
}

.preview-oval {
  width: 60px;
  height: 80px;
  border-radius: 30px;
  border: 1px solid rgba(245,228,204,.3);
  background: rgba(245,228,204,.05);
  overflow: hidden;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  position: relative;
}

.preview-bubble {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(to top, rgba(247,184,156,.3), rgba(247,184,156,.6));
  animation: previewFloat 3s ease-in-out infinite;
  position: absolute;
  bottom: 0;
}

@keyframes previewFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

/* ---------- BUTTON ---------- */
button {
  padding: 14px 28px;
  border-radius: 16px;
  border: none;
  background: #F7B89C;
  color: #2E3A59;
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(247,184,156,0.3);
  transition: all 0.2s;
  flex-shrink: 0;
}

button:active {
  transform: translateY(1px);
}

/* ---------- MODALE PERSONNALISATION ---------- */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.modal-overlay.visible {
  display: flex;
}

.modal-content {
  background: #2E3A59;
  border-radius: 20px;
  padding: 24px;
  width: 90%;
  max-width: 350px;
  position: relative;
}

.modal-close {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 24px;
  cursor: pointer;
  color: #F5E4CC;
}

.modal-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 20px;
  text-align: center;
  color: #F7B89C;
}

.modal-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-label {
  font-size: 14px;
  color: #F5E4CC;
}

.form-select {
  padding: 12px;
  border-radius: 10px;
  border: 2px solid rgba(245,228,204,0.2);
  background: rgba(245,228,204,0.1);
  color: #F5E4CC;
  font-size: 15px;
  font-family: inherit;
}

.form-select:focus {
  outline: none;
  border-color: #F7B89C;
}

.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}

.modal-btn {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: none;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.modal-btn-primary {
  background: #F7B89C;
  color: #2E3A59;
}

.modal-btn-secondary {
  background: rgba(245,228,204,0.2);
  color: #F5E4CC;
}

/* ---------- BREATHING ---------- */
#breathing { display: none; }

.container {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding-top: 40px;
  gap: 40px;
  width: 100%;
}

.visual {
  width: 300px;
  height: 400px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.circle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(247,184,156,.9), rgba(247,184,156,.4));
  box-shadow: 0 0 40px rgba(247,184,156,0.4);
}

.oval {
  width: 160px;
  height: 400px;
  border-radius: 80px;
  border: 1px solid rgba(245,228,204,.25);
  background: rgba(245,228,204,.06);
  overflow: hidden;
  display: flex;
  align-items: flex-end;
  justify-content: center;
}

.bubble {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  background: linear-gradient(to top, rgba(247,184,156,.35), rgba(247,184,156,.75));
}

.text {
  font-size: 26px;
  font-weight: 700;
  color: #F7B89C;
  text-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.progress-bar {
  width: 80%;
  height: 6px;
  background: rgba(245,228,204,.25);
  border-radius: 3px;
  overflow: hidden;
}
.progress {
  height: 100%;
  width: 0%;
  background: #F7B89C;
  transition: none;
}

.back-btn {
  margin-top: 10px;
}
</style>
</head>

<body>

<header class="header">
  <button class="back-button" onclick="window.location.href='index.html'">⬅️</button>
  <h1 class="page-title">Cohérence cardiaque</h1>
</header>

<div class="main" id="setup">

  <div class="carousel-section">
    <h2>Programme</h2>
    <div class="carousel-wrapper">
      <div class="carousel" id="program">
        <div class="carousel-spacer"></div>
        <div class="item active" data-in="5" data-out="5">Équilibre<br>5s / 5s</div>
        <div class="item" data-in="4" data-out="8">Apaisement<br>4s / 8s</div>
        <div class="item" data-in="custom" data-out="custom" id="customProgram">
          <span id="customLabel">Personnalisé</span>
          <span class="edit-btn">Modifier</span>
        </div>
        <div class="carousel-spacer"></div>
      </div>
    </div>
  </div>

  <div class="carousel-section">
    <h2>Animation</h2>
    <div class="preview-label">Prévisualisation</div>
    <div class="preview-container" id="previewContainer">
      <div class="preview-circle" id="previewCircle"></div>
    </div>
    <div class="carousel-wrapper">
      <div class="carousel" id="animation">
        <div class="carousel-spacer"></div>
        <div class="item active" data-type="circle">Cercle qui gonfle</div>
        <div class="item" data-type="oval">Bulle dans l'ovale</div>
        <div class="carousel-spacer"></div>
      </div>
    </div>
  </div>

  <div class="carousel-section">
    <h2>Son</h2>
    <div class="carousel-wrapper">
      <div class="carousel" id="sound">
        <div class="carousel-spacer"></div>
        <div class="item active" data-sound="on">Avec son</div>
        <div class="item" data-sound="off">Sans son</div>
        <div class="carousel-spacer"></div>
      </div>
    </div>
  </div>

  <div class="carousel-section">
    <h2>Durée (minutes)</h2>
    <div class="carousel-wrapper">
      <div class="carousel" id="duration">
        <div class="carousel-spacer"></div>
        <div class="item small active" data-min="2">2</div>
        <div class="item small" data-min="3">3</div>
        <div class="item small" data-min="4">4</div>
        <div class="item small" data-min="5">5</div>
        <div class="carousel-spacer"></div>
      </div>
    </div>
  </div>

  <button onclick="start()">Commencer</button>
</div>

<div class="main" id="breathing">
  <div class="container">
    <div class="visual" id="visual"></div>
    <div class="text" id="label">Prêt</div>
    <div class="progress-bar"><div class="progress" id="progress"></div></div>
    <button class="back-btn" onclick="back()">⬅️ Retour</button>
  </div>
</div>

<!-- MODALE PERSONNALISATION -->
<div class="modal-overlay" id="customModal">
  <div class="modal-content">
    <div class="modal-close" onclick="closeCustomModal()">✕</div>
    <div class="modal-title">Programme personnalisé</div>
    <div class="modal-form">
      <div class="form-group">
        <label class="form-label">Inspiration (secondes)</label>
        <select class="form-select" id="customInhale">
          <option value="3">3</option>
          <option value="3.5">3,5</option>
          <option value="4">4</option>
          <option value="4.5">4,5</option>
          <option value="5" selected>5</option>
          <option value="5.5">5,5</option>
          <option value="6">6</option>
          <option value="6.5">6,5</option>
          <option value="7">7</option>
          <option value="7.5">7,5</option>
          <option value="8">8</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Expiration (secondes)</label>
        <select class="form-select" id="customExhale">
          <option value="3">3</option>
          <option value="3.5">3,5</option>
          <option value="4">4</option>
          <option value="4.5">4,5</option>
          <option value="5" selected>5</option>
          <option value="5.5">5,5</option>
          <option value="6">6</option>
          <option value="6.5">6,5</option>
          <option value="7">7</option>
          <option value="7.5">7,5</option>
          <option value="8">8</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-primary" onclick="saveCustomProgram()">Valider</button>
        <button class="modal-btn modal-btn-secondary" onclick="closeCustomModal()">Annuler</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- STATE ---------- */
let inhale = 5;
let exhale = 5;
let minutes = 2;
let animation = 'circle';
let soundOn = true;
let currentProgram = 'equilibre';

let audioContext = null;

// Durées disponibles selon le programme
const durationsByProgram = {
  equilibre: [2, 3, 4, 5],
  apaisement: [3, 4, 5, 6, 7, 8, 9, 10, 15, 20],
  custom: [3, 4, 5, 6, 7, 8, 9, 10, 15, 20]
};

// Charger le programme personnalisé
function loadCustomProgram() {
  const savedIn = localStorage.getItem('customInhale');
  const savedOut = localStorage.getItem('customExhale');
  
  if (savedIn && savedOut) {
    const inVal = parseFloat(savedIn);
    const outVal = parseFloat(savedOut);
    document.getElementById('customLabel').innerHTML = 
      `Personnalisé<br>${inVal}s / ${outVal}s`;
    return { in: inVal, out: outVal };
  }
  return null;
}

// Initialiser le programme personnalisé au chargement
loadCustomProgram();

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playDing() {
  if (!soundOn || !audioContext) return;
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain);
  gain.connect(audioContext.destination);
  osc.frequency.value = 800;
  gain.gain.value = 0.1;
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
  osc.stop(audioContext.currentTime + 0.3);
}

function playDong() {
  if (!soundOn || !audioContext) return;
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain);
  gain.connect(audioContext.destination);
  osc.frequency.value = 400;
  gain.gain.value = 0.1;
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
  osc.stop(audioContext.currentTime + 0.4);
}

/* ---------- PREVIEW ANIMATION ---------- */
function updatePreview() {
  const container = document.getElementById('previewContainer');
  container.innerHTML = '';
  
  if (animation === 'circle') {
    const circle = document.createElement('div');
    circle.className = 'preview-circle';
    container.appendChild(circle);
  } else {
    const oval = document.createElement('div');
    oval.className = 'preview-oval';
    const bubble = document.createElement('div');
    bubble.className = 'preview-bubble';
    oval.appendChild(bubble);
    container.appendChild(oval);
  }
}

/* ---------- DURÉES DYNAMIQUES ---------- */
function updateDurations(program) {
  const durationCarousel = document.getElementById('duration');
  const items = durationCarousel.querySelectorAll('.item');
  
  items.forEach(item => {
    if (!item.classList.contains('carousel-spacer')) {
      item.remove();
    }
  });
  
  const durations = durationsByProgram[program] || [2, 3, 4, 5];
  const spacers = durationCarousel.querySelectorAll('.carousel-spacer');
  
  durations.forEach((min, index) => {
    const item = document.createElement('div');
    item.className = 'item small';
    if (index === 0) item.classList.add('active');
    item.dataset.min = min;
    item.textContent = min;
    item.addEventListener('click', (e) => {
      e.preventDefault();
      durationCarousel.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      minutes = parseInt(item.dataset.min);
    });
    spacers[0].after(item);
  });
  
  minutes = durations[0];
  
  setTimeout(() => {
    const active = durationCarousel.querySelector('.item.active');
    if (active) {
      active.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
    }
  }, 100);
}

/* ---------- CAROUSEL ---------- */
function setupCarousel(id, onChange) {
  const carousel = document.getElementById(id);
  const items = Array.from(carousel.querySelectorAll('.item'));

  if (items.length === 0) return;

  setTimeout(() => {
    const active = carousel.querySelector('.item.active');
    if (active) {
      active.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
    }
  }, 100);

  function findCenteredItem() {
    const carouselRect = carousel.getBoundingClientRect();
    const centerX = carouselRect.left + carouselRect.width / 2;

    let closest = null;
    let minDist = Infinity;

    items.forEach(item => {
      const itemRect = item.getBoundingClientRect();
      const itemCenterX = itemRect.left + itemRect.width / 2;
      const dist = Math.abs(centerX - itemCenterX);

      if (dist < minDist) {
        minDist = dist;
        closest = item;
      }
    });

    return closest;
  }

  function activateCentered() {
    const centered = findCenteredItem();
    if (centered && !centered.classList.contains('active')) {
      items.forEach(i => i.classList.remove('active'));
      centered.classList.add('active');
      onChange(centered);
    }
  }

  let scrollTimeout;
  carousel.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(activateCentered, 100);
  }, { passive: true });

  items.forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      items.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      onChange(item);
    });
  });
}

// Gestion du clic sur "Modifier"
document.getElementById('customProgram').addEventListener('click', (e) => {
  if (e.target.classList.contains('edit-btn') || e.target.closest('.edit-btn')) {
    e.stopPropagation();
    openCustomModal();
  }
});

function openCustomModal() {
  const savedIn = localStorage.getItem('customInhale') || '5';
  const savedOut = localStorage.getItem('customExhale') || '5';
  document.getElementById('customInhale').value = savedIn;
  document.getElementById('customExhale').value = savedOut;
  document.getElementById('customModal').classList.add('visible');
}

function closeCustomModal() {
  document.getElementById('customModal').classList.remove('visible');
}

function saveCustomProgram() {
  const inVal = document.getElementById('customInhale').value;
  const outVal = document.getElementById('customExhale').value;
  
  localStorage.setItem('customInhale', inVal);
  localStorage.setItem('customExhale', outVal);
  
  const inFloat = parseFloat(inVal);
  const outFloat = parseFloat(outVal);
  
  document.getElementById('customLabel').innerHTML = 
    `Personnalisé<br>${inFloat}s / ${outFloat}s`;
  
  closeCustomModal();
}

// Initialiser les carousels
setupCarousel('program', el => {
  if (el.dataset.in === 'custom') {
    const custom = loadCustomProgram();
    if (custom) {
      inhale = custom.in;
      exhale = custom.out;
    } else {
      inhale = 5;
      exhale = 5;
    }
    currentProgram = 'custom';
    updateDurations('custom');
  } else {
    inhale = parseFloat(el.dataset.in);
    exhale = parseFloat(el.dataset.out);
    
    if (el.textContent.includes('Équilibre')) {
      currentProgram = 'equilibre';
      updateDurations('equilibre');
    } else if (el.textContent.includes('Apaisement')) {
      currentProgram = 'apaisement';
      updateDurations('apaisement');
    }
  }
});

setupCarousel('animation', el => {
  animation = el.dataset.type;
  updatePreview();
});

setupCarousel('sound', el => {
  soundOn = el.dataset.sound === 'on';
});

updateDurations('equilibre');

// Durées dans le carousel
const durationCarousel = document.getElementById('duration');
durationCarousel.querySelectorAll('.item').forEach(item => {
  item.addEventListener('click', () => {
    minutes = parseInt(item.dataset.min);
  });
});

/* ---------- BREATHING ---------- */
let remaining, timer, startTime, isPlaying;

function start() {
  initAudio();
  document.getElementById('setup').style.display = 'none';
  document.getElementById('breathing').style.display = 'flex';

  remaining = minutes * 60;
  startTime = Date.now();
  isPlaying = true;

  buildVisual();

  setTimeout(() => {
    breathe('in');
    updateProgressContinuous();
  }, 500);
}

function buildVisual() {
  const v = document.getElementById('visual');
  v.innerHTML = '';

  if (animation === 'circle') {
    const c = document.createElement('div');
    c.className = 'circle';
    c.id = 'animElement';
    c.style.transform = 'scale(1)';
    v.appendChild(c);
  } else {
    const o = document.createElement('div');
    o.className = 'oval';
    const b = document.createElement('div');
    b.className = 'bubble';
    b.id = 'animElement';
    b.style.transform = 'translateY(0)';
    o.appendChild(b);
    v.appendChild(o);
  }
}

function breathe(type) {
  if (remaining <= 0) {
    document.getElementById('label').textContent = 'Terminé';
    isPlaying = false;
    return;
  }

  const label = document.getElementById('label');
  const el = document.getElementById('animElement');
  const duration = type === 'in' ? inhale : exhale;

  label.textContent = type === 'in' ? 'Inspirez' : 'Expirez';

  if (type === 'in') playDing();
  else playDong();

  if (animation === 'circle') {
    el.style.transition = `transform ${duration}s linear`;
    el.style.transform = type === 'in' ? 'scale(2)' : 'scale(1)';
  } else {
    el.style.transition = `transform ${duration}s linear`;
    el.style.transform = type === 'in' ? 'translateY(-240px)' : 'translateY(0)';
  }

  timer = setTimeout(() => {
    remaining -= duration;
    breathe(type === 'in' ? 'out' : 'in');
  }, duration * 1000);
}

function updateProgressContinuous() {
  if (!isPlaying) return;

  const total = minutes * 60;
  const elapsed = (Date.now() - startTime) / 1000;
  const percent = Math.min(100, (elapsed / total) * 100);

  document.getElementById('progress').style.width = percent + '%';

  if (elapsed < total) {
    requestAnimationFrame(updateProgressContinuous);
  } else {
    document.getElementById('progress').style.width = '100%';
  }
}

function back() {
  clearTimeout(timer);
  isPlaying = false;
  document.getElementById('breathing').style.display = 'none';
  document.getElementById('setup').style.display = 'flex';
}

document.getElementById('breathing').addEventListener('click', (e) => {
  if (e.target.tagName === 'BUTTON') return;

  if (isPlaying) {
    clearTimeout(timer);
    isPlaying = false;
    document.getElementById('label').textContent = 'Pause';
  } else {
    if (remaining > 0) {
      const elapsed = (minutes * 60 - remaining);
      startTime = Date.now() - (elapsed * 1000);
      isPlaying = true;

      const label = document.getElementById('label');
      const currentPhase = label.textContent === 'Expirez' ? 'out' : 'in';
      breathe(currentPhase);
      updateProgressContinuous();
    }
  }
});

// Initialiser la prévisualisation
updatePreview();
</script>

</body>
</html>