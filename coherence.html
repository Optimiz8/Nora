<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="assets/images/favicone.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
<title>Exercice de respiration</title>
<link rel="stylesheet" href="nora-common.css">

<style>
/* ===== PAGE-SPECIFIC: BREATHING ===== */

.main {
  height: calc(100vh - var(--header-height));
  padding: 14px 16px 20px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  overflow-y: auto;
}

/* ---------- SECTION TITLES ---------- */
h2 {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: .10em;
  color: var(--accent);
  margin: 0 0 8px 2px;
  text-align: left;
}

/* ---------- PROGRAMME GRID ---------- */
.prog-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.prog-btn {
  padding: 12px 8px;
  border-radius: 14px;
  background: rgba(245,228,204,0.07);
  border: 1.5px solid rgba(245,228,204,0.12);
  color: rgba(245,228,204,0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  font-family: inherit;
  font-size: 15px;
  font-weight: 500;
  text-align: center;
  line-height: 1.4;
  transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.prog-btn.active {
  background: var(--light);
  border-color: var(--light);
  color: var(--dark);
  font-weight: 700;
}

.prog-sub {
  font-size: 12px;
  opacity: 0.6;
  font-weight: 400;
}

.prog-btn.active .prog-sub {
  opacity: 0.5;
}

.edit-link {
  display: block;
  margin-top: 4px;
  font-size: 10px;
  color: var(--accent);
  text-decoration: underline;
  cursor: pointer;
}

.prog-btn.active .edit-link {
  color: rgba(46,58,89,0.55);
}

/* ---------- TWO-COL SECTION ---------- */
.two-col-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.toggle-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.toggle-btn {
  padding: 11px 12px;
  border-radius: 12px;
  background: rgba(245,228,204,0.07);
  border: 1.5px solid rgba(245,228,204,0.12);
  color: rgba(245,228,204,0.6);
  font-family: inherit;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  text-align: left;
  width: 100%;
  transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.toggle-btn.active {
  background: var(--light);
  border-color: var(--light);
  color: var(--dark);
  font-weight: 700;
}

/* ---------- PREVIEW ---------- */
.preview-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.preview-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: rgba(245,228,204,0.35);
  text-align: center;
}

.preview-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 88px;
}

.preview-circle {
  width: 58px;
  height: 58px;
  border-radius: 50%;
  background: radial-gradient(circle at 35% 30%, rgba(247,184,156,.9), rgba(247,184,156,.3));
  box-shadow: 0 0 28px rgba(247,184,156,0.35);
  animation: previewPulse 3s ease-in-out infinite;
}

@keyframes previewPulse {
  0%, 100% { transform: scale(0.72); }
  50% { transform: scale(1.08); }
}

.preview-oval {
  width: 34px;
  height: 74px;
  border-radius: 9999px;
  border: 2px solid rgba(245,228,204,.2);
  background: rgba(245,228,204,.05);
  overflow: hidden;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  position: relative;
}

.preview-bubble {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 50%;
  background: linear-gradient(to top, rgba(247,184,156,.4), rgba(247,184,156,.75));
  animation: previewFloat 3s ease-in-out infinite;
  position: absolute;
  bottom: 0;
}

@keyframes previewFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-46px); }
}

/* ---------- DURATION CAROUSEL ---------- */
.carousel-section {
  width: 100%;
  flex-shrink: 0;
}

.carousel-wrapper {
  width: 100%;
  overflow: hidden;
}

.carousel {
  display: flex;
  gap: 10px;
  overflow-x: scroll;
  scroll-snap-type: x mandatory;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  padding: 4px 0 10px;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.carousel::-webkit-scrollbar { display: none; }

.carousel-spacer {
  flex: 0 0 calc(50% - 34px);
  min-width: calc(50% - 34px);
}

.item {
  flex: 0 0 auto;
  min-width: 56px;
  padding: 12px 8px;
  text-align: center;
  border-radius: 16px;
  background: rgba(245,228,204,0.07);
  border: 1.5px solid rgba(245,228,204,0.12);
  color: rgba(245,228,204,0.5);
  scroll-snap-align: center;
  transition: all 0.2s ease;
  cursor: pointer;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  font-weight: 600;
  font-size: 17px;
}

.item.active {
  background: var(--light);
  border-color: var(--light);
  color: var(--dark);
  font-weight: 700;
}

/* ---------- START BUTTON ---------- */
.main > button {
  padding: 18px;
  border-radius: 20px;
  border: none;
  background: linear-gradient(135deg, var(--accent) 0%, rgba(247,184,156,0.75) 100%);
  color: var(--dark);
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(247,184,156,0.3);
  transition: all 0.2s;
  flex-shrink: 0;
  width: 100%;
  letter-spacing: 0.01em;
}

.main > button:active {
  transform: translateY(2px);
  box-shadow: 0 2px 8px rgba(247,184,156,0.2);
}

/* ---------- MODAL ---------- */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  backdrop-filter: blur(4px);
}

.modal-overlay.visible {
  display: flex;
}

.modal-content {
  background: var(--dark);
  border-radius: 24px;
  padding: 28px 24px;
  width: 90%;
  max-width: 340px;
  position: relative;
  border: 1px solid rgba(245,228,204,.08);
  box-shadow: 0 24px 60px rgba(0,0,0,0.5);
}

.modal-close {
  position: absolute;
  top: 14px;
  right: 18px;
  font-size: 22px;
  cursor: pointer;
  color: rgba(245,228,204,0.5);
}

.modal-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 22px;
  text-align: center;
  color: var(--accent);
}

.modal-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-label {
  font-size: 14px;
  color: rgba(245,228,204,0.7);
}

.form-select {
  padding: 12px 14px;
  border-radius: 12px;
  border: 2px solid rgba(245,228,204,0.15);
  background: rgba(245,228,204,0.08);
  color: var(--light);
  font-size: 15px;
  font-family: inherit;
}

.form-select:focus {
  outline: none;
  border-color: var(--accent);
}

.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}

.modal-btn {
  flex: 1;
  padding: 13px;
  border-radius: 14px;
  border: none;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: opacity 0.2s;
}

.modal-btn:active { opacity: 0.8; }

.modal-btn-primary {
  background: var(--accent);
  color: var(--dark);
}

.modal-btn-secondary {
  background: rgba(245,228,204,0.12);
  color: var(--light);
  border: 2px solid rgba(245,228,204,0.15);
}

/* ---------- BREATHING SCREEN ---------- */
#breathing { display: none; }

.container {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  gap: 28px;
  width: 100%;
}

.visual {
  width: min(280px, 82vw);
  height: min(360px, 52vh);
  display: flex;
  justify-content: center;
  align-items: center;
}

.circle {
  width: min(160px, 44vw);
  height: min(160px, 44vw);
  border-radius: 50%;
  background: radial-gradient(circle at 35% 30%, rgba(247,184,156,1), rgba(247,184,156,.35));
  box-shadow: 0 0 60px rgba(247,184,156,0.4), 0 0 120px rgba(247,184,156,0.12);
}

.oval {
  width: min(130px, 38vw);
  height: min(340px, 50vh);
  border-radius: 9999px;
  border: 2px solid rgba(245,228,204,.18);
  background: rgba(245,228,204,.05);
  overflow: hidden;
  display: flex;
  align-items: flex-end;
  justify-content: center;
}

.bubble {
  width: min(130px, 38vw);
  height: min(130px, 38vw);
  border-radius: 50%;
  background: linear-gradient(to top, rgba(247,184,156,.4), rgba(247,184,156,.85));
  box-shadow: 0 0 40px rgba(247,184,156,0.3);
}

.text {
  font-size: 30px;
  font-weight: 700;
  color: var(--accent);
  text-shadow: 0 2px 12px rgba(0,0,0,0.35);
  letter-spacing: 0.02em;
  min-height: 44px;
  display: flex;
  align-items: center;
}

.progress-bar {
  width: 80%;
  max-width: 220px;
  height: 4px;
  background: rgba(245,228,204,.12);
  border-radius: 2px;
  overflow: hidden;
}
.progress {
  height: 100%;
  width: 0%;
  background: linear-gradient(to right, var(--accent), rgba(247,184,156,0.6));
  transition: none;
}

.back-btn {
  padding: 14px 36px;
  border-radius: 20px;
  border: 2px solid rgba(245,228,204,.15);
  background: rgba(245, 228, 204, 0.08);
  color: rgba(245,228,204,0.8);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: auto;
}

.back-btn:active {
  background: rgba(245, 228, 204, 0.18);
}
</style>
</head>

<body>

<header class="header">
  <button class="back-button" onclick="if(localStorage.getItem('calmSource')==='recap'){localStorage.removeItem('calmSource');location.href='recap.html'}else{location.href='index.html#calm'}" aria-label="Retour">‚¨ÖÔ∏è</button>
  <h1 class="page-title">Exercices de respiration</h1>
  <button class="header-icon" onclick="location.href='index.html'" style="margin-left: auto;" aria-label="Accueil">üè†</button>
</header>

<div class="main" id="setup">

  <!-- Programme -->
  <div>
    <h2>Programme</h2>
    <div class="prog-grid">
      <button class="prog-btn active" id="progCoherence">
        <span>Coh√©rence<br>cardiaque</span>
        <span class="prog-sub">5s / 5s</span>
      </button>
      <button class="prog-btn" id="progApaisement">
        <span>Apaisement</span>
        <span class="prog-sub">4s / 8s</span>
      </button>
      <button class="prog-btn" id="progCustom">
        <span id="customLabel">Personnalis√©</span>
        <span class="prog-sub" id="customSub">5s / 5s</span>
        <span class="edit-link" id="editLink">Modifier</span>
      </button>
    </div>
  </div>

  <!-- Animation + Son -->
  <div class="two-col-section">
    <div>
      <h2>Animation</h2>
      <div class="toggle-group">
        <button class="toggle-btn active" id="animCircle">Cercle</button>
        <button class="toggle-btn" id="animOval">Bulle</button>
      </div>
    </div>
    <div>
      <h2>Son</h2>
      <div class="toggle-group">
        <button class="toggle-btn active" id="btnSoundOn">Avec son</button>
        <button class="toggle-btn" id="btnSoundOff">Sans son</button>
      </div>
    </div>
  </div>

  <!-- Preview -->
  <div class="preview-section">
    <div class="preview-label">Pr√©visualisation</div>
    <div class="preview-container" id="previewContainer">
      <div class="preview-circle"></div>
    </div>
  </div>

  <!-- Dur√©e -->
  <div class="carousel-section">
    <h2>Dur√©e (minutes)</h2>
    <div class="carousel-wrapper">
      <div class="carousel" id="duration">
        <div class="carousel-spacer"></div>
        <div class="carousel-spacer"></div>
      </div>
    </div>
  </div>

  <button onclick="start()">Commencer</button>
</div>

<div class="main" id="breathing">
  <div class="container">
    <div class="visual" id="visual"></div>
    <div class="text" id="label">Pr√™t</div>
    <div class="progress-bar"><div class="progress" id="progress"></div></div>
    <button class="back-btn" onclick="back()">‚¨ÖÔ∏è Retour</button>
  </div>
</div>

<!-- MODAL PERSONNALISATION -->
<div class="modal-overlay" id="customModal" role="dialog" aria-modal="true" aria-label="Programme personnalis√©">
  <div class="modal-content">
    <div class="modal-close" onclick="closeCustomModal()" role="button" aria-label="Fermer">‚úï</div>
    <div class="modal-title">Programme personnalis√©</div>
    <div class="modal-form">
      <div class="form-group">
        <label class="form-label">Inspiration (secondes)</label>
        <select class="form-select" id="customInhale">
          <option value="3">3</option>
          <option value="3.5">3,5</option>
          <option value="4">4</option>
          <option value="4.5">4,5</option>
          <option value="5" selected>5</option>
          <option value="5.5">5,5</option>
          <option value="6">6</option>
          <option value="6.5">6,5</option>
          <option value="7">7</option>
          <option value="7.5">7,5</option>
          <option value="8">8</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Expiration (secondes)</label>
        <select class="form-select" id="customExhale">
          <option value="3">3</option>
          <option value="3.5">3,5</option>
          <option value="4">4</option>
          <option value="4.5">4,5</option>
          <option value="5" selected>5</option>
          <option value="5.5">5,5</option>
          <option value="6">6</option>
          <option value="6.5">6,5</option>
          <option value="7">7</option>
          <option value="7.5">7,5</option>
          <option value="8">8</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-primary" onclick="saveCustomProgram()">Valider</button>
        <button class="modal-btn modal-btn-secondary" onclick="closeCustomModal()">Annuler</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- STATE ---------- */
let inhale = 5;
let exhale = 5;
let minutes = 2;
let animation = 'circle';
let soundOn = true;
let currentProgram = 'coherence';

let audioContext = null;

const durationsByProgram = {
  coherence:  [2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 15, 20],
  apaisement: [2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 15, 20],
  custom:     [2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 15, 20]
};

/* ---------- CUSTOM PROGRAM ---------- */
function loadCustomProgram() {
  const savedIn = localStorage.getItem('customInhale');
  const savedOut = localStorage.getItem('customExhale');
  if (savedIn && savedOut) {
    const inVal = parseFloat(savedIn);
    const outVal = parseFloat(savedOut);
    document.getElementById('customSub').textContent = `${inVal}s / ${outVal}s`;
    return { in: inVal, out: outVal };
  }
  return null;
}

loadCustomProgram();

/* ---------- AUDIO ---------- */
function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playDing() {
  if (!soundOn || !audioContext) return;
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain);
  gain.connect(audioContext.destination);
  osc.frequency.value = 800;
  gain.gain.value = 0.1;
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
  osc.stop(audioContext.currentTime + 0.3);
}

function playDong() {
  if (!soundOn || !audioContext) return;
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain);
  gain.connect(audioContext.destination);
  osc.frequency.value = 400;
  gain.gain.value = 0.1;
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
  osc.stop(audioContext.currentTime + 0.4);
}

/* ---------- PREVIEW ---------- */
function updatePreview() {
  const container = document.getElementById('previewContainer');
  container.innerHTML = '';
  if (animation === 'circle') {
    const circle = document.createElement('div');
    circle.className = 'preview-circle';
    container.appendChild(circle);
  } else {
    const oval = document.createElement('div');
    oval.className = 'preview-oval';
    const bubble = document.createElement('div');
    bubble.className = 'preview-bubble';
    oval.appendChild(bubble);
    container.appendChild(oval);
  }
}

/* ---------- DURATION CAROUSEL ---------- */
function updateDurations(program) {
  const carousel = document.getElementById('duration');
  Array.from(carousel.querySelectorAll('.item')).forEach(el => el.remove());

  const durations = durationsByProgram[program] || [2, 3, 4, 5];
  const lastSpacer = carousel.querySelectorAll('.carousel-spacer')[1];

  durations.forEach((min, index) => {
    const item = document.createElement('div');
    item.className = 'item';
    if (index === 0) item.classList.add('active');
    item.dataset.min = min;
    item.textContent = min;
    item.addEventListener('click', () => {
      carousel.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      minutes = parseFloat(item.dataset.min);
    });
    lastSpacer.before(item);
  });

  minutes = durations[0];

  setTimeout(() => {
    const active = carousel.querySelector('.item.active');
    if (active) active.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
  }, 100);
}

// Scroll-snap listener for duration carousel
(function() {
  const carousel = document.getElementById('duration');
  let scrollTimeout;
  carousel.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const items = Array.from(carousel.querySelectorAll('.item'));
      const rect = carousel.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      let closest = null, minDist = Infinity;
      items.forEach(item => {
        const r = item.getBoundingClientRect();
        const dist = Math.abs(r.left + r.width / 2 - centerX);
        if (dist < minDist) { minDist = dist; closest = item; }
      });
      if (closest && !closest.classList.contains('active')) {
        items.forEach(i => i.classList.remove('active'));
        closest.classList.add('active');
        minutes = parseFloat(closest.dataset.min);
      }
    }, 100);
  }, { passive: true });
})();

/* ---------- PROGRAMME BUTTONS ---------- */
function setActiveProg(id) {
  ['progCoherence', 'progApaisement', 'progCustom'].forEach(bid => {
    document.getElementById(bid).classList.toggle('active', bid === id);
  });
}

document.getElementById('progCoherence').addEventListener('click', () => {
  setActiveProg('progCoherence');
  inhale = 5; exhale = 5;
  currentProgram = 'coherence';
  updateDurations('coherence');
});

document.getElementById('progApaisement').addEventListener('click', () => {
  setActiveProg('progApaisement');
  inhale = 4; exhale = 8;
  currentProgram = 'apaisement';
  updateDurations('apaisement');
});

document.getElementById('progCustom').addEventListener('click', (e) => {
  if (e.target.id === 'editLink') return;
  setActiveProg('progCustom');
  const custom = loadCustomProgram();
  inhale = custom ? custom.in : 5;
  exhale = custom ? custom.out : 5;
  currentProgram = 'custom';
  updateDurations('custom');
});

document.getElementById('editLink').addEventListener('click', (e) => {
  e.stopPropagation();
  openCustomModal();
});

/* ---------- ANIMATION BUTTONS ---------- */
document.getElementById('animCircle').addEventListener('click', () => {
  document.getElementById('animCircle').classList.add('active');
  document.getElementById('animOval').classList.remove('active');
  animation = 'circle';
  updatePreview();
});

document.getElementById('animOval').addEventListener('click', () => {
  document.getElementById('animOval').classList.add('active');
  document.getElementById('animCircle').classList.remove('active');
  animation = 'oval';
  updatePreview();
});

/* ---------- SOUND BUTTONS ---------- */
document.getElementById('btnSoundOn').addEventListener('click', () => {
  document.getElementById('btnSoundOn').classList.add('active');
  document.getElementById('btnSoundOff').classList.remove('active');
  soundOn = true;
});

document.getElementById('btnSoundOff').addEventListener('click', () => {
  document.getElementById('btnSoundOff').classList.add('active');
  document.getElementById('btnSoundOn').classList.remove('active');
  soundOn = false;
});

/* ---------- CUSTOM MODAL ---------- */
function openCustomModal() {
  document.getElementById('customInhale').value = localStorage.getItem('customInhale') || '5';
  document.getElementById('customExhale').value = localStorage.getItem('customExhale') || '5';
  document.getElementById('customModal').classList.add('visible');
}

function closeCustomModal() {
  document.getElementById('customModal').classList.remove('visible');
}

function saveCustomProgram() {
  const inVal = document.getElementById('customInhale').value;
  const outVal = document.getElementById('customExhale').value;
  localStorage.setItem('customInhale', inVal);
  localStorage.setItem('customExhale', outVal);
  document.getElementById('customSub').textContent = `${parseFloat(inVal)}s / ${parseFloat(outVal)}s`;
  if (currentProgram === 'custom') {
    inhale = parseFloat(inVal);
    exhale = parseFloat(outVal);
  }
  closeCustomModal();
}

/* ---------- INIT ---------- */
updateDurations('coherence');
updatePreview();

/* ---------- BREATHING ---------- */
let remaining, timer, startTime, isPlaying;

function start() {
  initAudio();
  document.getElementById('setup').style.display = 'none';
  document.getElementById('breathing').style.display = 'flex';
  remaining = minutes * 60;
  startTime = Date.now();
  isPlaying = true;
  buildVisual();
  setTimeout(() => {
    breathe('in');
    updateProgressContinuous();
  }, 500);
}

function buildVisual() {
  const v = document.getElementById('visual');
  v.innerHTML = '';
  if (animation === 'circle') {
    const c = document.createElement('div');
    c.className = 'circle';
    c.id = 'animElement';
    c.style.transform = 'scale(1)';
    v.appendChild(c);
  } else {
    const o = document.createElement('div');
    o.className = 'oval';
    const b = document.createElement('div');
    b.className = 'bubble';
    b.id = 'animElement';
    b.style.transform = 'translateY(0)';
    o.appendChild(b);
    v.appendChild(o);
  }
}

function breathe(type) {
  if (remaining <= 0) {
    document.getElementById('label').textContent = 'Termin√©';
    isPlaying = false;
    return;
  }
  const label = document.getElementById('label');
  const el = document.getElementById('animElement');
  const duration = type === 'in' ? inhale : exhale;

  label.textContent = type === 'in' ? 'Inspirez' : 'Expirez';
  if (type === 'in') playDing(); else playDong();

  if (animation === 'circle') {
    el.style.transition = `transform ${duration}s linear`;
    el.style.transform = type === 'in' ? 'scale(2)' : 'scale(1)';
  } else {
    const oval = el.parentElement;
    const maxY = -(oval.offsetHeight - el.offsetHeight);
    el.style.transition = `transform ${duration}s linear`;
    el.style.transform = type === 'in' ? `translateY(${maxY}px)` : 'translateY(0)';
  }

  timer = setTimeout(() => {
    remaining -= duration;
    breathe(type === 'in' ? 'out' : 'in');
  }, duration * 1000);
}

function updateProgressContinuous() {
  if (!isPlaying) return;
  const total = minutes * 60;
  const elapsed = (Date.now() - startTime) / 1000;
  const percent = Math.min(100, (elapsed / total) * 100);
  document.getElementById('progress').style.width = percent + '%';
  if (elapsed < total) {
    requestAnimationFrame(updateProgressContinuous);
  } else {
    document.getElementById('progress').style.width = '100%';
  }
}

function back() {
  clearTimeout(timer);
  isPlaying = false;
  document.getElementById('breathing').style.display = 'none';
  document.getElementById('setup').style.display = 'flex';
}

document.getElementById('breathing').addEventListener('click', (e) => {
  if (e.target.tagName === 'BUTTON') return;
  if (isPlaying) {
    clearTimeout(timer);
    isPlaying = false;
    document.getElementById('label').textContent = 'Pause';
  } else {
    if (remaining > 0) {
      const elapsed = (minutes * 60 - remaining);
      startTime = Date.now() - (elapsed * 1000);
      isPlaying = true;
      const label = document.getElementById('label');
      breathe(label.textContent === 'Expirez' ? 'out' : 'in');
      updateProgressContinuous();
    }
  }
});
</script>

    <script>document.addEventListener("keydown", e => { if (e.key === "Escape") closeCustomModal(); });</script>
    <script src="nora-scroll.js"></script>
</body>
</html>
