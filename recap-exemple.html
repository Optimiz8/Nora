<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="stylesheet" href="nora-common.css">
    <script src="nora-data.js"></script>
    <title>Aper√ßu - TSA App</title>
    <style>
        body {
            color: var(--dark);
            line-height: 1.4;
            padding-bottom: 80px;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* BANDEAU EXEMPLE */
        .exemple-banner {
            background: linear-gradient(135deg, var(--accent) 0%, #f5a584 100%);
            color: var(--dark);
            padding: 16px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header {
            background-color: var(--dark);
            display: flex;
            justify-content: flex-end;
            padding: 8px 12px;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--light);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
        }

        .content {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .alert-block {
            background-color: var(--light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
        }

        .alert-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 8px;
            text-align: center;
        }

        .intro-text {
            margin-top: 0;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .intro-text p {
            margin-bottom: 8px;
            line-height: 1.4;
            color: var(--dark);
        }

        .intro-text strong {
            display: block;
            margin-top: 12px;
            margin-bottom: 6px;
            color: var(--dark);
        }

        .highlight-box {
            padding: 0;
            margin: 6px 0;
        }

        .highlight-box p {
            margin-bottom: 2px;
            line-height: 1.4;
            padding-left: 16px;
            position: relative;
            color: var(--dark);
        }

        .highlight-box p:before {
            content: "‚Ä¢";
            position: absolute;
            left: 4px;
            font-weight: bold;
            color: var(--dark);
        }

        .info-important {
            background-color: rgba(245, 228, 204, 0.5);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0 6px 0;
        }

        .info-important h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 700;
        }

        .info-important ul {
            list-style: none;
            padding-left: 0;
        }

        .info-important li {
            margin-bottom: 4px;
            padding-left: 20px;
            position: relative;
            line-height: 1.4;
            color: var(--dark);
        }

        .info-important li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 8px;
            color: var(--dark);
        }

        .collapsible-section {
            background-color: var(--light);
            border-radius: 12px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .section-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light);
            border: none;
            width: 100%;
            text-align: left;
            font-size: 17px;
            font-weight: 600;
            color: var(--dark);
        }

        .section-header:active {
            background-color: #eed9b8;
        }

        .chevron {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 20px;
        }

        .chevron.open {
            transform: rotate(180deg);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section-content.open {
            max-height: 2000px;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section-inner {
            padding: 0 16px 12px 16px;
        }

        .capacity-item, .need-item, .state-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 0;
        }

        .capacity-group {
            margin-bottom: 10px;
        }

        .capacity-group:last-child {
            margin-bottom: 0;
        }

        .capacity-group-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1.4;
        }

        .capacity-inline-list {
            margin: 0;
            padding-left: 32px;
            line-height: 1.4;
        }

        .item-icon {
            font-size: 20px;
            width: 28px;
            text-align: center;
        }

        .item-status {
            font-size: 18px;
        }

        .contact-buttons {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .contact-btn {
            flex: 1;
            background-color: var(--accent);
            border: none;
            color: var(--dark);
            padding: 14px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .contact-btn:active {
            background-color: #f5a585;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--dark);
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            gap: 12px;
            z-index: 100;
        }

        .footer-btn {
            background-color: var(--light);
            border: none;
            color: var(--dark);
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            max-width: 300px;
        }

        .footer-btn:active {
            background-color: #eed9b8;
        }

        .hidden {
            display: none !important;
        }

        /* Fix couleur texte en dark mode */
        .alert-block, .alert-block p, .alert-block li, .intro-text,
        .collapsible-section .section-inner,
        .collapsible-section .section-inner p,
        .collapsible-section .section-inner span,
        .collapsible-section .section-inner li,
        .collapsible-section .section-inner div,
        .collapsible-section .section-header,
        .section-header span,
        .capacity-group-title,
        .capacity-inline-list,
        .need-item,
        .state-item {
            color: #2E3A59 !important;
        }
    </style>
</head>
<body>
    <!-- BANDEAU EXEMPLE -->
    <div class="exemple-banner">
        üëÅÔ∏è APER√áU - Ceci est un exemple (pas une vraie crise)
    </div>

    <div class="header">
        <button class="back-btn" onclick="fermerApercu()">
            <span>√ó</span>
            <span>Fermer l'aper√ßu</span>
        </button>
    </div>

    <div class="content">
        <div class="alert-block" id="presentationSection">
            <div class="alert-title">
                üö® JE SUIS EN CRISE AUTISTIQUE
            </div>

            <div class="intro-text" id="presentationText">
                <!-- Sera rempli par JS -->
            </div>
        </div>

        <!-- Section Capacit√©s -->
        <div class="collapsible-section" id="capacitesSection">
            <button class="section-header" onclick="toggleSection(this)">
                <span>Mes capacit√©s actuelles</span>
                <span class="chevron">‚ñº</span>
            </button>
            <div class="section-content">
                <div class="section-inner" id="capacitesContent">
                    <p style="color: #2E3A59; opacity: 0.6;">Chargement...</p>
                </div>
            </div>
        </div>

        <!-- Section Besoins -->
        <div class="collapsible-section" id="besoinsSection">
            <button class="section-header" onclick="toggleSection(this)">
                <span>Ce qui va m'aider</span>
                <span class="chevron">‚ñº</span>
            </button>
            <div class="section-content">
                <div class="section-inner" id="besoinsContent">
                    <p style="color: #2E3A59; opacity: 0.6;">Chargement...</p>
                </div>
            </div>
        </div>

        <!-- Section √âtats -->
        <div class="collapsible-section" id="etatsSection">
            <button class="section-header" onclick="toggleSection(this)">
                <span>Comment je me sens</span>
                <span class="chevron">‚ñº</span>
            </button>
            <div class="section-content">
                <div class="section-inner" id="etatsContent">
                    <p style="color: #2E3A59; opacity: 0.6;">Chargement...</p>
                </div>
            </div>
        </div>

        <!-- Section Contact d'urgence -->
        <div class="collapsible-section" id="contactSection">
            <button class="section-header" onclick="toggleSection(this)">
                <span>üìû Contact d'urgence</span>
                <span class="chevron">‚ñº</span>
            </button>
            <div class="section-content">
                <div class="section-inner" id="contactContent">
                    <p style="color: #2E3A59; opacity: 0.6;">Chargement...</p>
                </div>
            </div>
        </div>

        <!-- Section Informations m√©dicales -->
        <div class="collapsible-section" id="medicalSection">
            <button class="section-header" onclick="toggleSection(this)">
                <span>üöë Informations m√©dicales (pour les secours)</span>
                <span class="chevron">‚ñº</span>
            </button>
            <div class="section-content">
                <div class="section-inner" id="medicalContent">
                    <p style="color: #2E3A59; opacity: 0.6;">Chargement...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer simplifi√© -->
    <div class="footer">
        <button class="footer-btn" onclick="fermerApercu()">
            ‚úì Fermer l'aper√ßu
        </button>
    </div>

    <script>
        function toggleSection(button) {
            const content = button.nextElementSibling;
            const chevron = button.querySelector('.chevron');
            
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        function fermerApercu() {
            window.close();
        }

        function loadExempleData() {
            const exempleDonnees = localStorage.getItem('exempleCrise');
            
            if (!exempleDonnees) {
                alert('‚ùå Aucune donn√©e d\'exemple trouv√©e');
                return;
            }

            try {
                const data = JSON.parse(exempleDonnees);
                
                // Charger pr√©sentation
                loadPresentation(data);
                
                // Charger capacit√©s
                loadCapacites(data.capacites);
                
                // Charger besoins
                loadBesoins(data.besoins);
                
                // Charger √©tats
                loadEtats(data.etats);
                
                // Charger contacts
                loadContacts(data.contacts);

                // Charger m√©dical
                loadMedical(data.inclureMedical, data.medical);

                // Masquer sections vides
                hideEmptySections(data);
                
            } catch (error) {
                console.error('Erreur chargement exemple:', error);
                alert('‚ùå Erreur lors du chargement de l\'exemple');
            }
        }

        function loadPresentation(data) {
            const container = document.getElementById('presentationText');
            const texte = data.textePresentation || '';

            if (texte.trim()) {
                // Texte personnalis√© : on le convertit en paragraphes
                const paragraphs = texte.split('\n').filter(l => l.trim()).map(l => `<p>${l}</p>`).join('');
                container.innerHTML = paragraphs;
            } else {
                // Texte par d√©faut avec identit√©
                container.innerHTML = `
                    <p style="font-size: 17px; margin-bottom: 12px;">${getIdentiteLine()}</p>

                    <p>Si vous voyez ce message, je suis actuellement en difficult√© ou en crise autistique.
                    Dans cet √©tat, je peux √™tre dans l'incapacit√© de parler ou de r√©agir normalement.</p>

                    <div class="highlight-box">
                        <p>Ce n'est pas volontaire.</p>
                        <p>Ce n'est pas dangereux.</p>
                        <p>Ce n'est pas un malaise m√©dical classique.</p>
                    </div>

                    <div class="info-important">
                        <h2>‚ÑπÔ∏è Ce que vous devez savoir (important)</h2>
                        <ul>
                            <li>Mon √©tat est involontaire et li√© √† une surcharge du syst√®me nerveux.</li>
                            <li>Il peut fluctuer : je peux aller un peu mieux puis moins bien.</li>
                            <li>Une crise peut durer de quelques dizaines de minutes √† plusieurs heures.</li>
                        </ul>

                        <p style="margin-top: 12px;">Je peux pleurer, trembler, crier, me figer, avoir des mouvements involontaires ou de r√©assurance (stim)...</p>
                        <p style="margin-top: 6px; font-weight: 600;">üëâ N'essayez pas de m'emp√™cher de bouger, cela m'aide √† me r√©guler.</p>
                    </div>`;
            }
        }

        function loadCapacites(capacites) {
            const container = document.getElementById('capacitesContent');
            if (!capacites) {
                container.innerHTML = '<p style="color: #2E3A59; opacity: 0.6;">Aucune capacit√© configur√©e</p>';
                return;
            }

            const categories = [
                { key: 'impossible', emoji: '‚õî', label: 'Ce qui m\'est impossible actuellement' },
                { key: 'difficile', emoji: '‚ö†Ô∏è', label: 'Ce qui m\'est difficile actuellement' },
                { key: 'possible', emoji: '‚úÖ', label: 'Ce qui m\'est actuellement possible' },
                { key: 'incertain', emoji: '‚ùì', label: 'Ce que je ne sais pas si je suis en capacit√©' }
            ];

            let html = '';

            // Afficher les 4 cat√©gories avec placeholder
            categories.forEach(cat => {
                const items = capacites[cat.key] || [];
                html += `
                    <div class="capacity-group">
                        <p class="capacity-group-title">
                            <span class="item-status">${cat.emoji}</span> ${cat.label} :
                        </p>
                        <p class="capacity-inline-list" style="${items.length === 0 ? 'opacity: 0.5; font-style: italic;' : ''}">
                            ${items.length > 0 ? items.join(', ') : '(Les capacit√©s class√©es ici appara√Ætront lors d\'une crise)'}
                        </p>
                    </div>`;
            });

            // Liste des capacit√©s visibles pour ce profil
            const visibleNames = capacites._visibleNames || [];
            if (visibleNames.length > 0) {
                html += `
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(46,58,89,0.15);">
                        <p style="font-weight: 600; margin-bottom: 6px;">Capacit√©s √† choisir lors d'une crise :</p>
                        <p style="opacity: 0.7; font-size: 15px;">${visibleNames.join(', ')}</p>
                    </div>`;
            }

            container.innerHTML = html;
        }

        function loadBesoins(besoins) {
            const container = document.getElementById('besoinsContent');

            if (!besoins || besoins.length === 0) {
                container.innerHTML = '<p style="color: #2E3A59; opacity: 0.6; font-style: italic;">Les besoins s√©lectionn√©s lors d\'une crise appara√Ætront ici (ex: boire, manger, r√©duire le bruit, m\'isoler, etc.). Vous pourrez les choisir lors de la personnalisation de votre r√©capitulatif de crise.</p>';
                return;
            }
            
            let html = '';
            besoins.forEach(besoin => {
                html += `
                    <div class="need-item">
                        <span class="item-icon">${besoin.icon || '‚Ä¢'}</span>
                        <span>${besoin.label || besoin}</span>
                    </div>`;
            });
            
            container.innerHTML = html;
        }

        function loadEtats(etats) {
            const container = document.getElementById('etatsContent');

            if (!etats || etats.length === 0) {
                container.innerHTML = '<p style="color: #2E3A59; opacity: 0.6; font-style: italic;">Les √©tats et ressentis s√©lectionn√©s lors d\'une crise appara√Ætront ici (ex: anxi√©t√©, surcharge sensorielle, fatigue, etc.). Vous pourrez les choisir lors de la personnalisation de votre r√©capitulatif de crise.</p>';
                return;
            }
            
            let html = '';
            etats.forEach(etat => {
                html += `
                    <div class="state-item">
                        <span class="item-icon">${etat.icon || 'üòî'}</span>
                        <span>${etat.label || etat}</span>
                    </div>`;
            });
            
            container.innerHTML = html;
        }

        function loadContacts(contacts) {
            const container = document.getElementById('contactContent');

            if (!contacts || contacts.length === 0) {
                container.innerHTML = '<p style="color: #2E3A59; opacity: 0.6;">Aucun contact configur√© ou s√©lectionn√© pour ce contexte.</p>';
                return;
            }

            let html = '';
            contacts.forEach(contact => {
                const lien = contact.lien ? ` (${contact.lien})` : '';
                const remarque = contact.remarque ? `<p style="margin-bottom: 4px; font-style: italic; opacity: 0.6; font-size: 15px; color: var(--dark);">${contact.remarque}</p>` : '';
                html += `
                    <div style="margin-bottom: 20px;">
                        <p style="margin-bottom: 4px; font-size: 16px; color: var(--dark);"><strong>${contact.nom}</strong>${lien}</p>
                        ${remarque}
                        ${contact.telephone ? `<p style="margin-bottom: 12px; color: #2E3A59;">üìû ${contact.telephone}</p>` : ''}
                        <div class="contact-buttons">
                            <button class="contact-btn" onclick="alert('Fonction d√©sactiv√©e en mode aper√ßu')">
                                <span>üìû</span>
                                <span>Appeler</span>
                            </button>
                            <button class="contact-btn" onclick="alert('Fonction d√©sactiv√©e en mode aper√ßu')">
                                <span>üí¨</span>
                                <span>Message</span>
                            </button>
                        </div>
                    </div>
                `;
            });

            if (html === '') {
                html = '<p style="color: #2E3A59; opacity: 0.6;">Aucun contact s√©lectionn√© pour ce contexte.</p>';
            }

            container.innerHTML = html;
        }

        function loadMedical(afficher, infosMed) {
            const section = document.getElementById('medicalSection');
            const container = document.getElementById('medicalContent');

            if (afficher === false) {
                section.style.display = 'none';
                return;
            }

            // Si les donn√©es m√©dicales ne sont pas pass√©es, les lire depuis localStorage
            if (!infosMed || Object.keys(infosMed).length === 0) {
                infosMed = JSON.parse(localStorage.getItem('infosMedicales') || '{}');
            }

            let html = '';

            if (infosMed.groupeSanguin) {
                html += `<p style="margin-bottom: 8px;"><strong>Groupe sanguin :</strong></p>
                         <p style="margin-bottom: 16px;">${infosMed.groupeSanguin}</p>`;
            }

            if (infosMed.traitements) {
                html += `<p style="margin-bottom: 8px;"><strong>Traitements en cours :</strong></p>
                         <p style="margin-bottom: 16px;">${infosMed.traitements}</p>`;
            }

            const allergies = [];
            if (infosMed.allergiesMedic) allergies.push(infosMed.allergiesMedic);
            if (infosMed.autresAllergies) allergies.push(infosMed.autresAllergies);
            if (allergies.length > 0) {
                html += `<p style="margin-bottom: 8px;"><strong>Allergies :</strong></p>
                         <p style="margin-bottom: 16px;">${allergies.join(', ')}</p>`;
            }

            if (infosMed.antecedents) {
                html += `<p style="margin-bottom: 8px;"><strong>Ant√©c√©dents :</strong></p>
                         <p style="margin-bottom: 16px;">${infosMed.antecedents}</p>`;
            }

            if (infosMed.autresInfos) {
                html += `<p style="margin-bottom: 8px;"><strong>Informations utiles :</strong></p>
                         <p>${infosMed.autresInfos}</p>`;
            }

            if (!html) {
                html = '<p style="color: #2E3A59; opacity: 0.6;">Aucune information m√©dicale configur√©e</p>';
            }

            container.innerHTML = html;
        }

        function hideEmptySections(data) {
            // Masquer les sections d√©sactiv√©es
            if (data.inclurePresentation === false) {
                const el = document.getElementById('presentationSection');
                if (el) el.style.display = 'none';
            }

            if (data.inclureCapacites === false) {
                document.getElementById('capacitesSection').style.display = 'none';
            }

            if (data.inclureBesoins === false) {
                document.getElementById('besoinsSection').style.display = 'none';
            }

            if (data.inclureEtats === false) {
                document.getElementById('etatsSection').style.display = 'none';
            }

            if (data.inclureContacts === false) {
                document.getElementById('contactSection').style.display = 'none';
            }

            if (data.inclureMedical === false) {
                document.getElementById('medicalSection').style.display = 'none';
            }
        }

        // Chargement au d√©marrage
        document.addEventListener('DOMContentLoaded', loadExempleData);
    </script>
    <script src="nora-scroll.js"></script>
</body>
</html>