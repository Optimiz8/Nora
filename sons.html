<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sons relaxants</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="assets/images/favicone.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
<link rel="stylesheet" href="nora-common.css">

<style>
/* ===== BOUTON MIXEUR ===== */
.mix-cta {
  margin: 16px;
  padding: 14px 18px;
  background: var(--dark);
  border-radius: 16px;
  cursor: pointer;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 14px;
  border: 1px solid rgba(247, 184, 156, 0.25);
}

.mix-cta:active {
  background: #3d4a66;
}

.mix-cta-icon {
  font-size: 28px;
  flex-shrink: 0;
}

.mix-cta-text {
  flex: 1;
}

.mix-cta strong {
  display: block;
  font-size: 0.95rem;
  margin-bottom: 3px;
}

.mix-cta span {
  font-size: 0.8rem;
  opacity: 0.7;
}

.mix-cta-arrow {
  font-size: 22px;
  opacity: 0.5;
  flex-shrink: 0;
}

/* ===== EN-T√äTE SECTION SONS ===== */
.section-header {
  padding: 8px 16px 4px;
}

.section-label {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--light);
  margin-bottom: 2px;
}

.section-sublabel {
  font-size: 0.8rem;
  color: rgba(245, 228, 204, 0.6);
}

/* ===== PR√âR√âGLAGES MIXEUR ===== */
.presets-section {
  margin: 8px 16px 12px;
  padding: 12px 14px;
  background: rgba(255,255,255,0.04);
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.06);
}

.presets-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.presets-label {
  font-size: 0.8rem;
  opacity: 0.65;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.save-preset-btn {
  background: rgba(247, 184, 156, 0.15);
  border: 1px solid rgba(247, 184, 156, 0.35);
  color: var(--light);
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: background 0.2s;
}

.save-preset-btn:active {
  background: rgba(247, 184, 156, 0.25);
}

.save-preset-btn:disabled {
  opacity: 0.35;
  pointer-events: none;
}

.presets-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.preset-chip {
  display: flex;
  align-items: center;
  gap: 0;
  background: #1e293b;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid transparent;
  transition: border-color 0.2s;
  max-width: 180px;
}

.preset-chip.active {
  border-color: var(--accent);
}

.preset-chip-name {
  padding: 8px 10px;
  font-size: 0.85rem;
  cursor: pointer;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.preset-chip-delete {
  padding: 8px 10px;
  font-size: 0.8rem;
  opacity: 0.5;
  cursor: pointer;
  border-left: 1px solid rgba(255,255,255,0.08);
  flex-shrink: 0;
  line-height: 1;
}

.preset-chip-delete:active {
  opacity: 1;
  background: rgba(255,80,80,0.2);
}

.presets-empty {
  font-size: 0.8rem;
  opacity: 0.45;
  font-style: italic;
  text-align: center;
  padding: 4px 0;
}

/* ===== MODALE NOMMAGE PR√âR√âGLAGE ===== */
.preset-name-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1300;
  padding: 20px;
}

.preset-name-modal.active {
  display: flex;
}

.preset-name-box {
  background: #020617;
  border-radius: 16px;
  padding: 24px 20px;
  width: 100%;
  max-width: 360px;
}

.preset-name-title {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 14px;
  text-align: center;
  color: var(--light);
}

.preset-name-box input {
  width: 100%;
  box-sizing: border-box;
  background: #1e293b;
  border: 1px solid rgba(247, 184, 156, 0.3);
  border-radius: 10px;
  padding: 12px;
  color: var(--light);
  font-size: 0.95rem;
  font-family: inherit;
  margin-bottom: 14px;
  outline: none;
}

.preset-name-box input:focus {
  border-color: var(--accent);
}

.preset-name-actions {
  display: flex;
  gap: 10px;
}

.preset-name-actions button {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

.preset-name-actions button.cancel-btn {
  background: #1e293b;
  color: var(--light);
}

.preset-name-actions button.confirm-btn {
  background: var(--accent);
  color: var(--dark);
}

/* ===== GRID DES SONS ===== */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 14px;
  padding: 14px;
}

.card {
  background: #020617;
  border-radius: 14px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s;
}

.card:active {
  transform: scale(0.98);
}

.card img {
  width: 100%;
  height: 100px;
  object-fit: cover;
}

.card-title {
  padding: 8px;
  font-size: 0.85rem;
  text-align: center;
}

/* ===== MODALE LECTEUR SIMPLE ===== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: #020617;
  width: 90%;
  max-width: 380px;
  border-radius: 20px;
  padding-top: 40px;
  position: relative;
}

.close {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 1.4rem;
  cursor: pointer;
  padding: 4px 8px;
}

.modal img {
  width: 100%;
  height: 220px;
  object-fit: cover;
  border-radius: 20px;
  padding: 0 16px;
}

.player {
  padding: 16px;
  text-align: center;
}

.player h2 {
  font-size: 1rem;
  font-weight: 400;
  margin: 8px 0;
}

.controls {
  font-size: 2rem;
  cursor: pointer;
  padding: 8px;
  display: inline-block;
}

.timer {
  margin-top: 10px;
  font-size: 0.9rem;
  opacity: 0.85;
  cursor: pointer;
  padding: 8px;
  display: inline-block;
}

/* ===== MINI MODALE TIMER ===== */
.timer-modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: flex-end;
  z-index: 1200;
  background: rgba(0, 0, 0, 0.5);
}

.timer-modal.active {
  display: flex;
}

.timer-box {
  background: #020617;
  width: 100%;
  border-radius: 20px 20px 0 0;
  padding: 20px;
  position: relative;
}

.timer-close {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 1.3rem;
  cursor: pointer;
  padding: 4px 8px;
}

.timer-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 16px;
}

.timer-buttons button {
  flex: 1 1 30%;
  padding: 10px;
  background: #1e293b;
  color: #e5e7eb;
  border: none;
  border-radius: 12px;
  font-size: 0.9rem;
  cursor: pointer;
}

.timer-buttons button:active {
  background: #334155;
}

/* ===== MODALE MIXEUR ===== */
.mixer-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  z-index: 1100;
}

.mixer-modal.active {
  display: block;
}

.mixer-box {
  background: #020617;
  height: 100%;
  padding: 16px;
  overflow-y: auto;
}

.mixer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.mixer-header span {
  font-size: 1.4rem;
  cursor: pointer;
  padding: 4px 8px;
}

.mixer-center {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin: 8px 16px 16px;
  padding: 10px 16px;
  background: #1e293b;
  border-radius: 16px;
}

.mixer-center button {
  font-size: 40px;
  background: none;
  border: none;
  color: #e5e7eb;
  cursor: pointer;
  padding: 8px;
  line-height: 1;
}

.mixer-time {
  font-size: 1.2rem;
  opacity: 0.85;
  cursor: pointer;
  padding: 8px;
}

.mixer-item {
  display: flex;
  align-items: center;
  gap: 14px;
  margin: 10px 0;
  padding: 2px 0;
}

.mixer-item img {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.mixer-item-content {
  flex: 1;
  min-width: 0;
}

.mixer-item-name {
  font-size: 0.95rem;
  margin-bottom: 6px;
}

input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  background: #1e293b;
  border-radius: 6px;
  outline: none;
}

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
}

input[type=range]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: none;
}
</style>
</head>

<body>

<header class="header">
  <button class="back-button" onclick="if(localStorage.getItem('calmSource')==='recap'){localStorage.removeItem('calmSource');location.href='recap.html'}else{location.href='index.html#calm'}" aria-label="Retour">‚¨ÖÔ∏è</button>
  <h1 class="page-title">Sons relaxants</h1>
  <button class="header-icon" onclick="location.href='index.html'" style="margin-left: auto;" aria-label="Accueil">üè†</button>
</header>

<div class="mix-cta" id="openMixer">
  <span class="mix-cta-icon">üéõÔ∏è</span>
  <div class="mix-cta-text">
    <strong>Cr√©er mon ambiance sonore</strong>
    <span>M√©lange plusieurs sons √† ton rythme</span>
  </div>
  <span class="mix-cta-arrow">‚Ä∫</span>
</div>

<div class="section-header">
  <div class="section-label">üéµ Sons disponibles</div>
  <div class="section-sublabel">Appuie sur un son pour l'√©couter seul</div>
</div>

<div class="grid" id="content"></div>

<!-- ===== MODALE LECTEUR SIMPLE ===== -->
<div class="modal" id="playerModal" role="dialog" aria-modal="true" aria-label="Lecteur audio">
  <div class="modal-content">
    <div class="close" id="closePlayer" role="button" aria-label="Fermer">‚úï</div>
    <img id="playerImage" alt="">
    <div class="player">
      <h2 id="playerTitle"></h2>
      <div class="controls" id="playPause">‚è∏</div>
      <div class="timer" id="timerDisplay">‚è±Ô∏è 10:00</div>
    </div>
  </div>
</div>

<!-- ===== MINI MODALE TIMER ===== -->
<div class="timer-modal" id="timerModal" role="dialog" aria-modal="true" aria-label="Minuterie">
  <div class="timer-box">
    <div class="timer-close" id="closeTimer" role="button" aria-label="Fermer">‚úï</div>
    <strong>Minuterie</strong>
    <div class="timer-buttons">
      <button id="addTime5">+5 min</button>
      <button id="addTime10">+10 min</button>
      <button id="addTime15">+15 min</button>
      <button id="addTime30">+30 min</button>
      <button id="removeTime10">-10 min</button>
      <button id="resetTimerBtn">R√©initialiser</button>
    </div>
  </div>
</div>

<!-- ===== AUDIO LECTEUR SIMPLE ===== -->
<audio id="audio"></audio>

<!-- ===== MODALE MIXEUR ===== -->
<div class="mixer-modal" id="mixerModal" role="dialog" aria-modal="true" aria-label="Mixeur de sons">
  <div class="mixer-box">
    <div class="mixer-header">
      <strong>Ambiance personnalis√©e</strong>
      <span id="closeMixer" role="button" aria-label="Fermer">‚úï</span>
    </div>
    <div class="mixer-center">
      <div class="mixer-time" id="mixTime">‚è±Ô∏è 10:00</div>
      <button id="mixPlay">‚è∏</button>
      <button id="mixReset" style="font-size: 32px;">‚Üª</button>
    </div>

    <!-- PR√âR√âGLAGES -->
    <div class="presets-section">
      <div class="presets-header">
        <span class="presets-label">Mes pr√©r√©glages</span>
        <button class="save-preset-btn" id="savePresetBtn" onclick="openSavePresetModal()">üíæ Enregistrer ce mix</button>
      </div>
      <div class="presets-chips" id="presetsChips"></div>
    </div>

    <div id="mixerList"></div>
  </div>
</div>

<!-- MODALE NOMMAGE PR√âR√âGLAGE -->
<div class="preset-name-modal" id="presetNameModal">
  <div class="preset-name-box">
    <div class="preset-name-title">Nommer ce mix</div>
    <input type="text" id="presetNameInput" maxlength="24" placeholder="Ex : Soir√©e calme...">
    <div class="preset-name-actions">
      <button class="cancel-btn" onclick="cancelSavePreset()">Annuler</button>
      <button class="confirm-btn" onclick="confirmSavePreset()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<script>
// ===== DONN√âES ET VARIABLES GLOBALES =====
const soundsData = [
  "pluie sur la fen√™tre",
  "feu de chemin√©e",
  "chant nocturne",
  "ruisseau",
  "arriv√©e au refuge",
  "sur le rivage",
  "chant des oiseaux",
  "vers les √©toiles",
  "underwater",
  "relaxation l√©g√®re",
  "balade au bord du ruisseau",
  "bruits de bouche",
  "chant des baleines",
  "chant des grillons",
  "doux ronronnements",
  "√©crire son histoire",
  "gouttes du ciel",
  "l'appel de la for√™t",
  "l'appel lointain",
  "libre comme l'air",
  "mar√©e basse",
  "nuit d'√©t√©",
  "orage",
  "paisibles flottements",
  "pluie",
  "promenade en bord de mer",
  "train",
  "voyage interieur"
];

const mixSounds = [
  "pluie sur la fen√™tre",
  "feu de chemin√©e",
  "chant nocturne",
  "ruisseau",
  "arriv√©e au refuge",
  "sur le rivage",
  "chant des oiseaux",
  "vers les √©toiles",
  "underwater",
  "bruits de bouche",
  "relaxation l√©g√®re",
  "√©crire son histoire",
  "nuit d'√©t√©",
  "orage",
  "pluie",
  "train",
  "balade au bord du ruisseau",
  "chant des baleines",
  "chant des grillons",
  "doux ronronnements",
  "gouttes du ciel",
  "l'appel de la for√™t",
  "l'appel lointain",
  "libre comme l'air",
  "mar√©e basse",
  "paisibles flottements",
  "promenade en bord de mer",
  "voyage interieur"
];

// √âl√©ments DOM
const content = document.getElementById("content");
const audio = document.getElementById("audio");
const playerModal = document.getElementById("playerModal");
const timerModal = document.getElementById("timerModal");
const mixerModal = document.getElementById("mixerModal");
const playPauseBtn = document.getElementById("playPause");
const timerDisplay = document.getElementById("timerDisplay");
const mixTime = document.getElementById("mixTime");
const mixPlayBtn = document.getElementById("mixPlay");
const mixerList = document.getElementById("mixerList");

// Variables de timer
let remaining = 600; // 10 minutes en secondes
let timerInterval = null;
let currentMode = 'simple'; // 'simple' ou 'mixer'

// Variables mixeur
const audioMap = {};
let mixerPlaying = true;
let mixerTimerStarted = false;

// ===== FONCTIONS UTILITAIRES =====
function formatTime(seconds) {
  const m = String(Math.floor(seconds / 60)).padStart(2, '0');
  const s = String(seconds % 60).padStart(2, '0');
  return `${m}:${s}`;
}

function updateTimerDisplay() {
  const timeStr = `‚è±Ô∏è ${formatTime(remaining)}`;
  timerDisplay.textContent = timeStr;
  mixTime.textContent = timeStr;
}

function startTimer(mode) {
  currentMode = mode;
  clearInterval(timerInterval);
  
  // R√©initialiser √† 10 minutes pour chaque nouveau son
  remaining = 600;
  
  updateTimerDisplay();
  
  timerInterval = setInterval(() => {
    remaining--;
    updateTimerDisplay();
    
    if (remaining <= 0) {
      clearInterval(timerInterval);
      
      if (currentMode === 'simple') {
        audio.pause();
        playPauseBtn.textContent = "‚ñ∂Ô∏è";
      } else if (currentMode === 'mixer') {
        Object.values(audioMap).forEach(a => a.pause());
        mixerPlaying = false;
        mixPlayBtn.textContent = "‚ñ∂Ô∏è";
      }
    }
  }, 1000);
}

function pauseTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

function resumeTimer() {
  if (timerInterval) return; // D√©j√† en cours
  
  timerInterval = setInterval(() => {
    remaining--;
    updateTimerDisplay();
    
    if (remaining <= 0) {
      clearInterval(timerInterval);
      
      if (currentMode === 'simple') {
        audio.pause();
        playPauseBtn.textContent = "‚ñ∂Ô∏è";
      } else if (currentMode === 'mixer') {
        Object.values(audioMap).forEach(a => a.pause());
        mixerPlaying = false;
        mixPlayBtn.textContent = "‚ñ∂Ô∏è";
      }
    }
  }, 1000);
}

function addTime(minutes) {
  remaining = Math.max(0, remaining + minutes * 60);
  updateTimerDisplay();
}

function resetTimer() {
  remaining = 600;
  updateTimerDisplay();
}

// ===== GESTION DES PR√âR√âGLAGES =====
const MAX_PRESETS = 4;

function getPresets() {
  return JSON.parse(localStorage.getItem('mixerPresets') || '[]');
}

function setPresets(presets) {
  localStorage.setItem('mixerPresets', JSON.stringify(presets));
}

function renderPresets() {
  const presets = getPresets();
  const container = document.getElementById('presetsChips');
  const saveBtn = document.getElementById('savePresetBtn');

  if (presets.length === 0) {
    container.innerHTML = '<div class="presets-empty">Aucun pr√©r√©glage ‚Äî r√®gle les curseurs puis enregistre ton mix</div>';
  } else {
    container.innerHTML = presets.map(p => `
      <div class="preset-chip" data-id="${p.id}">
        <span class="preset-chip-name" onclick="loadPreset('${p.id}')">${p.name}</span>
        <span class="preset-chip-delete" onclick="deletePreset('${p.id}')">‚úï</span>
      </div>
    `).join('');
  }

  saveBtn.disabled = presets.length >= MAX_PRESETS;
}

function loadPreset(id) {
  const presets = getPresets();
  const preset = presets.find(p => p.id === id);
  if (!preset) return;

  const sliders = mixerList.querySelectorAll('input[type=range]');
  mixSounds.forEach((name, i) => {
    const vol = preset.volumes[name] || 0;
    const a = audioMap[name];
    if (!a) return;
    a.volume = vol / 100;
    if (sliders[i]) sliders[i].value = vol;
    localStorage.setItem(`mixer_${name.toLowerCase()}`, String(vol));
    if (vol > 0) {
      if (!mixerTimerStarted) { mixerTimerStarted = true; startTimer('mixer'); }
      if (mixerPlaying) a.play().catch(() => {});
    } else {
      a.pause();
    }
  });

  // Marquer le pr√©r√©glage actif
  document.querySelectorAll('.preset-chip').forEach(chip => {
    chip.classList.toggle('active', chip.dataset.id === id);
  });
}

function deletePreset(id) {
  setPresets(getPresets().filter(p => p.id !== id));
  renderPresets();
}

function openSavePresetModal() {
  const hasSound = Object.values(audioMap).some(a => a.volume > 0);
  if (!hasSound) {
    // Rien √† enregistrer ‚Äî on pourrait ajouter un toast ici
    return;
  }
  document.getElementById('presetNameInput').value = '';
  document.getElementById('presetNameModal').classList.add('active');
  setTimeout(() => document.getElementById('presetNameInput').focus(), 100);
}

function cancelSavePreset() {
  document.getElementById('presetNameModal').classList.remove('active');
}

function confirmSavePreset() {
  const name = document.getElementById('presetNameInput').value.trim();
  if (!name) return;
  const presets = getPresets();
  if (presets.length >= MAX_PRESETS) return;

  const volumes = {};
  mixSounds.forEach(n => {
    const a = audioMap[n];
    if (a) volumes[n] = Math.round(a.volume * 100);
  });

  presets.push({ id: Date.now().toString(), name, volumes });
  setPresets(presets);
  renderPresets();
  document.getElementById('presetNameModal').classList.remove('active');
}

// Valider avec Entr√©e dans le champ nom
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('presetNameInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') confirmSavePreset();
    if (e.key === 'Escape') cancelSavePreset();
  });
});

// ===== CR√âATION DES CARTES DE SONS =====
soundsData.forEach(name => {
  const card = document.createElement("div");
  card.className = "card";
  
  // Les fichiers sont en minuscules avec espaces remplac√©s par tirets
  const fileName = name.toLowerCase().replace(/\s+/g, ' ');
  
  // Pour l'affichage, on capitalise la premi√®re lettre de chaque mot
  let displayName = name
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
  
  // Renommage sp√©cial pour underwater
  if (fileName === 'underwater') {
    displayName = 'Plonger en eau profonde';
  }
  
  card.innerHTML = `
    <img src="assets/images/${fileName}.jpg" alt="${displayName}">
    <div class="card-title">${displayName}</div>
  `;
  
  card.onclick = () => openPlayer(fileName, displayName);
  content.appendChild(card);
});

// ===== LECTEUR SIMPLE =====
function openPlayer(fileName, displayName) {
  // Arr√™ter le mixeur si actif
  if (currentMode === 'mixer') {
    Object.values(audioMap).forEach(a => a.pause());
    mixerModal.classList.remove("active");
  }
  
  document.getElementById("playerImage").src = `assets/images/${fileName}.jpg`;
  document.getElementById("playerTitle").textContent = displayName;
  
  audio.src = `assets/audio/${fileName}.mp3`;
  audio.loop = true;
  audio.play();
  
  playPauseBtn.textContent = "‚è∏";
  playerModal.classList.add("active");
  
  startTimer('simple');
}

function closePlayer() {
  audio.pause();
  pauseTimer();
  playerModal.classList.remove("active");
}

// Bouton play/pause
playPauseBtn.onclick = () => {
  if (audio.paused) {
    audio.play();
    playPauseBtn.textContent = "‚è∏";
    resumeTimer();
  } else {
    audio.pause();
    playPauseBtn.textContent = "‚ñ∂Ô∏è";
    pauseTimer();
  }
};

// Ouvrir mini-modale timer depuis lecteur simple
timerDisplay.onclick = () => {
  timerModal.classList.add("active");
};

// Fermer lecteur simple
document.getElementById("closePlayer").onclick = (e) => {
  e.stopPropagation();
  closePlayer();
};

// ===== MIXEUR =====
function initMixer() {
  mixSounds.forEach((name, index) => {
    // Les fichiers sont en minuscules avec espaces
    const fileName = name.toLowerCase();
    
    // Pour l'affichage, on capitalise
    let displayName = name
      .split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
    
    // Renommage sp√©cial pour underwater
    if (fileName === 'underwater') {
      displayName = 'Plonger en eau profonde';
    }
    
    // Cr√©er l'√©l√©ment audio
    const a = new Audio(`assets/audio/${fileName}.mp3`);
    a.loop = true;
    a.volume = 0;
    audioMap[name] = a;
    
    // Charger la valeur sauvegard√©e
    const savedVolume = localStorage.getItem(`mixer_${fileName}`) || '0';
    const initialVolume = parseInt(savedVolume);
    
    // Cr√©er l'√©l√©ment visuel
    const div = document.createElement("div");
    div.className = "mixer-item";
    div.innerHTML = `
      <img src="assets/images/${fileName}.jpg" alt="${displayName}">
      <div class="mixer-item-content">
        <div class="mixer-item-name">${displayName}</div>
        <input type="range" min="0" max="100" value="${initialVolume}">
      </div>
    `;
    
    const slider = div.querySelector("input");

    // Appliquer le volume initial
    if (initialVolume > 0) {
      a.volume = initialVolume / 100;
    }

    // D√©tection de geste pour √©viter les changements accidentels lors du scroll
    let touchStartY = 0;
    let touchStartX = 0;
    let isScrolling = null;

    slider.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
      touchStartX = e.touches[0].clientX;
      isScrolling = null;
    }, { passive: true });

    slider.addEventListener('touchmove', (e) => {
      if (isScrolling === null) {
        const touchY = e.touches[0].clientY;
        const touchX = e.touches[0].clientX;
        const deltaY = Math.abs(touchY - touchStartY);
        const deltaX = Math.abs(touchX - touchStartX);

        // Si le mouvement vertical est plus important que l'horizontal, c'est un scroll
        isScrolling = deltaY > deltaX;
      }

      // Si c'est un scroll vertical, emp√™cher le slider de bouger
      if (isScrolling) {
        e.preventDefault();
        return false;
      }
    }, { passive: false });

    slider.oninput = (e) => {
      // Ne rien faire si c'est un scroll
      if (isScrolling) return;

      const volume = e.target.value / 100;
      a.volume = volume;

      // Sauvegarder dans localStorage
      localStorage.setItem(`mixer_${fileName}`, e.target.value);

      if (volume > 0) {
        if (!mixerTimerStarted) {
          mixerTimerStarted = true;
          startTimer('mixer');
        }
        if (mixerPlaying) {
          a.play().catch(() => {});
        }
      } else {
        a.pause();
        // V√©rifier si tous les curseurs sont √† z√©ro
        checkAllSlidersZero();
      }
    };

    mixerList.appendChild(div);
  });
}

function checkAllSlidersZero() {
  const allZero = Object.values(audioMap).every(a => a.volume === 0);
  if (allZero && mixerTimerStarted) {
    pauseTimer();
  }
}

function resetAllSliders() {
  // Arr√™ter tous les sons
  Object.values(audioMap).forEach(a => {
    a.pause();
    a.volume = 0;
  });
  
  // Remettre tous les curseurs √† z√©ro
  const sliders = mixerList.querySelectorAll('input[type=range]');
  sliders.forEach(slider => {
    slider.value = 0;
  });
  
  // Effacer toutes les sauvegardes
  mixSounds.forEach(name => {
    const fileName = name.toLowerCase();
    localStorage.removeItem(`mixer_${fileName}`);
  });
  
  // R√©initialiser le timer
  pauseTimer();
  remaining = 600;
  updateTimerDisplay();
  mixerTimerStarted = false;
  mixerPlaying = true;
  mixPlayBtn.textContent = "‚è∏";
}

function openMixer() {
  // Arr√™ter le lecteur simple si actif
  if (currentMode === 'simple') {
    audio.pause();
    playerModal.classList.remove("active");
  }

  mixerModal.classList.add("active");
  currentMode = 'mixer';
  renderPresets();

  if (!mixerTimerStarted) {
    updateTimerDisplay();
  }
}

function closeMixer() {
  Object.values(audioMap).forEach(a => a.pause());
  mixerModal.classList.remove("active");
  pauseTimer();
  mixerTimerStarted = false;
  mixerPlaying = true;
}

// Bouton play/pause mixeur
mixPlayBtn.onclick = () => {
  if (mixerPlaying) {
    mixerPlaying = false;
    mixPlayBtn.textContent = "‚ñ∂Ô∏è";
    Object.values(audioMap).forEach(a => a.pause());
    pauseTimer();
  } else {
    mixerPlaying = true;
    mixPlayBtn.textContent = "‚è∏";
    let hasSound = false;
    Object.values(audioMap).forEach(a => {
      if (a.volume > 0) {
        a.play().catch(() => {});
        hasSound = true;
      }
    });
    if (hasSound) {
      resumeTimer();
    }
  }
};

// Ouvrir mini-modale timer depuis mixeur
mixTime.onclick = () => {
  timerModal.classList.add("active");
};

// Fermer mixeur
document.getElementById("closeMixer").onclick = (e) => {
  e.stopPropagation();
  closeMixer();
};

// Ouvrir mixeur
document.getElementById("openMixer").onclick = openMixer;

// Bouton reset mixeur
document.getElementById("mixReset").onclick = resetAllSliders;

// ===== MINI MODALE TIMER =====
document.getElementById("addTime5").onclick = () => addTime(5);
document.getElementById("addTime10").onclick = () => addTime(10);
document.getElementById("addTime15").onclick = () => addTime(15);
document.getElementById("addTime30").onclick = () => addTime(30);
document.getElementById("removeTime10").onclick = () => addTime(-10);
document.getElementById("resetTimerBtn").onclick = resetTimer;

document.getElementById("closeTimer").onclick = (e) => {
  e.stopPropagation();
  timerModal.classList.remove("active");
};

// ===== INITIALISATION =====
initMixer();
updateTimerDisplay();

// Fermer les modales en cliquant sur le fond
playerModal.onclick = (e) => {
  if (e.target === playerModal) {
    closePlayer();
  }
};

mixerModal.onclick = (e) => {
  if (e.target === mixerModal) {
    closeMixer();
  }
};

timerModal.onclick = (e) => {
  if (e.target === timerModal) {
    timerModal.classList.remove("active");
  }
};
</script>

    <script>document.addEventListener("keydown", e => { if (e.key === "Escape") { closePlayer(); closeMixer(); document.getElementById('timerModal').classList.remove('active'); cancelSavePreset(); } });</script>
    <script src="nora-scroll.js"></script>
</body>
</html>