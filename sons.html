<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sons relaxants</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="nora-common.css">

<style>
/* ===== BOUTON MIXEUR ===== */
.mix-cta {
  margin: 16px;
  padding: 18px;
  background: var(--dark);
  border-radius: 20px;
  text-align: center;
  cursor: pointer;
  transition: background 0.2s;
}

.mix-cta:active {
  background: #3d4a66;
}

.mix-cta strong {
  display: block;
  font-size: 1rem;
  margin-bottom: 4px;
}

.mix-cta span {
  font-size: 0.85rem;
  opacity: 0.75;
}

/* ===== GRID DES SONS ===== */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 14px;
  padding: 14px;
}

.card {
  background: #020617;
  border-radius: 14px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s;
}

.card:active {
  transform: scale(0.98);
}

.card img {
  width: 100%;
  height: 100px;
  object-fit: cover;
}

.card-title {
  padding: 8px;
  font-size: 0.85rem;
  text-align: center;
}

/* ===== MODALE LECTEUR SIMPLE ===== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: #020617;
  width: 90%;
  max-width: 380px;
  border-radius: 20px;
  padding-top: 40px;
  position: relative;
}

.close {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 1.4rem;
  cursor: pointer;
  padding: 4px 8px;
}

.modal img {
  width: 100%;
  height: 220px;
  object-fit: cover;
  border-radius: 20px;
  padding: 0 16px;
}

.player {
  padding: 16px;
  text-align: center;
}

.player h2 {
  font-size: 1rem;
  font-weight: 400;
  margin: 8px 0;
}

.controls {
  font-size: 2rem;
  cursor: pointer;
  padding: 8px;
  display: inline-block;
}

.timer {
  margin-top: 10px;
  font-size: 0.9rem;
  opacity: 0.85;
  cursor: pointer;
  padding: 8px;
  display: inline-block;
}

/* ===== MINI MODALE TIMER ===== */
.timer-modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: flex-end;
  z-index: 1200;
  background: rgba(0, 0, 0, 0.5);
}

.timer-modal.active {
  display: flex;
}

.timer-box {
  background: #020617;
  width: 100%;
  border-radius: 20px 20px 0 0;
  padding: 20px;
  position: relative;
}

.timer-close {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 1.3rem;
  cursor: pointer;
  padding: 4px 8px;
}

.timer-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 16px;
}

.timer-buttons button {
  flex: 1 1 30%;
  padding: 10px;
  background: #1e293b;
  color: #e5e7eb;
  border: none;
  border-radius: 12px;
  font-size: 0.9rem;
  cursor: pointer;
}

.timer-buttons button:active {
  background: #334155;
}

/* ===== MODALE MIXEUR ===== */
.mixer-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  z-index: 1100;
}

.mixer-modal.active {
  display: block;
}

.mixer-box {
  background: #020617;
  height: 100%;
  padding: 16px;
  overflow-y: auto;
}

.mixer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.mixer-header span {
  font-size: 1.4rem;
  cursor: pointer;
  padding: 4px 8px;
}

.mixer-center {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin: 8px 16px 16px;
  padding: 10px 16px;
  background: #1e293b;
  border-radius: 16px;
}

.mixer-center button {
  font-size: 40px;
  background: none;
  border: none;
  color: #e5e7eb;
  cursor: pointer;
  padding: 8px;
  line-height: 1;
}

.mixer-time {
  font-size: 1.2rem;
  opacity: 0.85;
  cursor: pointer;
  padding: 8px;
}

.mixer-item {
  display: flex;
  align-items: center;
  gap: 14px;
  margin: 10px 0;
  padding: 2px 0;
}

.mixer-item img {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.mixer-item-content {
  flex: 1;
  min-width: 0;
}

.mixer-item-name {
  font-size: 0.95rem;
  margin-bottom: 6px;
}

input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  background: #1e293b;
  border-radius: 6px;
  outline: none;
}

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
}

input[type=range]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: none;
}
</style>
</head>

<body>

<header class="header">
  <button class="back-button" onclick="window.location.href='index.html'">⬅️</button>
  <h1 class="page-title">Sons relaxants</h1>
</header>

<div class="mix-cta" id="openMixer">
  <strong>Créer mon ambiance sonore</strong>
  <span>Mélangez plusieurs sons à votre rythme</span>
</div>

<div class="grid" id="content"></div>

<!-- ===== MODALE LECTEUR SIMPLE ===== -->
<div class="modal" id="playerModal">
  <div class="modal-content">
    <div class="close" id="closePlayer">✕</div>
    <img id="playerImage" alt="">
    <div class="player">
      <h2 id="playerTitle"></h2>
      <div class="controls" id="playPause">⏸</div>
      <div class="timer" id="timerDisplay">⏱️ 10:00</div>
    </div>
  </div>
</div>

<!-- ===== MINI MODALE TIMER ===== -->
<div class="timer-modal" id="timerModal">
  <div class="timer-box">
    <div class="timer-close" id="closeTimer">✕</div>
    <strong>Minuterie</strong>
    <div class="timer-buttons">
      <button id="addTime5">+5 min</button>
      <button id="addTime10">+10 min</button>
      <button id="addTime15">+15 min</button>
      <button id="addTime30">+30 min</button>
      <button id="removeTime10">-10 min</button>
      <button id="resetTimerBtn">Réinitialiser</button>
    </div>
  </div>
</div>

<!-- ===== AUDIO LECTEUR SIMPLE ===== -->
<audio id="audio"></audio>

<!-- ===== MODALE MIXEUR ===== -->
<div class="mixer-modal" id="mixerModal">
  <div class="mixer-box">
    <div class="mixer-header">
      <strong>Ambiance personnalisée</strong>
      <span id="closeMixer">✕</span>
    </div>
    <div class="mixer-center">
      <div class="mixer-time" id="mixTime">⏱️ 10:00</div>
      <button id="mixPlay">⏸</button>
      <button id="mixReset" style="font-size: 32px;">↻</button>
    </div>
    <div id="mixerList"></div>
  </div>
</div>

<script>
// ===== DONNÉES ET VARIABLES GLOBALES =====
const soundsData = [
  "pluie sur la fenêtre",
  "feu de cheminée",
  "chant nocturne",
  "ruisseau",
  "arrivée au refuge",
  "sur le rivage",
  "chant des oiseaux",
  "vers les étoiles",
  "underwater",
  "relaxation légère",
  "balade au bord du ruisseau",
  "bruits de bouche",
  "chant des baleines",
  "chant des grillons",
  "doux ronronnements",
  "écrire son histoire",
  "gouttes du ciel",
  "l'appel de la forêt",
  "l'appel lointain",
  "libre comme l'air",
  "marée basse",
  "nuit d'été",
  "orage",
  "paisibles flottements",
  "pluie",
  "promenade en bord de mer",
  "train",
  "voyage interieur"
];

const mixSounds = [
  "pluie sur la fenêtre",
  "feu de cheminée",
  "chant nocturne",
  "ruisseau",
  "arrivée au refuge",
  "sur le rivage",
  "chant des oiseaux",
  "vers les étoiles",
  "underwater",
  "bruits de bouche",
  "relaxation légère",
  "écrire son histoire",
  "nuit d'été",
  "orage",
  "pluie",
  "train"
];

// Éléments DOM
const content = document.getElementById("content");
const audio = document.getElementById("audio");
const playerModal = document.getElementById("playerModal");
const timerModal = document.getElementById("timerModal");
const mixerModal = document.getElementById("mixerModal");
const playPauseBtn = document.getElementById("playPause");
const timerDisplay = document.getElementById("timerDisplay");
const mixTime = document.getElementById("mixTime");
const mixPlayBtn = document.getElementById("mixPlay");
const mixerList = document.getElementById("mixerList");

// Variables de timer
let remaining = 600; // 10 minutes en secondes
let timerInterval = null;
let currentMode = 'simple'; // 'simple' ou 'mixer'

// Variables mixeur
const audioMap = {};
let mixerPlaying = true;
let mixerTimerStarted = false;

// ===== FONCTIONS UTILITAIRES =====
function formatTime(seconds) {
  const m = String(Math.floor(seconds / 60)).padStart(2, '0');
  const s = String(seconds % 60).padStart(2, '0');
  return `${m}:${s}`;
}

function updateTimerDisplay() {
  const timeStr = `⏱️ ${formatTime(remaining)}`;
  timerDisplay.textContent = timeStr;
  mixTime.textContent = timeStr;
}

function startTimer(mode) {
  currentMode = mode;
  clearInterval(timerInterval);
  
  // Réinitialiser à 10 minutes pour chaque nouveau son
  remaining = 600;
  
  updateTimerDisplay();
  
  timerInterval = setInterval(() => {
    remaining--;
    updateTimerDisplay();
    
    if (remaining <= 0) {
      clearInterval(timerInterval);
      
      if (currentMode === 'simple') {
        audio.pause();
        playPauseBtn.textContent = "▶️";
      } else if (currentMode === 'mixer') {
        Object.values(audioMap).forEach(a => a.pause());
        mixerPlaying = false;
        mixPlayBtn.textContent = "▶️";
      }
    }
  }, 1000);
}

function pauseTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

function resumeTimer() {
  if (timerInterval) return; // Déjà en cours
  
  timerInterval = setInterval(() => {
    remaining--;
    updateTimerDisplay();
    
    if (remaining <= 0) {
      clearInterval(timerInterval);
      
      if (currentMode === 'simple') {
        audio.pause();
        playPauseBtn.textContent = "▶️";
      } else if (currentMode === 'mixer') {
        Object.values(audioMap).forEach(a => a.pause());
        mixerPlaying = false;
        mixPlayBtn.textContent = "▶️";
      }
    }
  }, 1000);
}

function addTime(minutes) {
  remaining = Math.max(0, remaining + minutes * 60);
  updateTimerDisplay();
}

function resetTimer() {
  remaining = 600;
  updateTimerDisplay();
}

// ===== CRÉATION DES CARTES DE SONS =====
soundsData.forEach(name => {
  const card = document.createElement("div");
  card.className = "card";
  
  // Les fichiers sont en minuscules avec espaces remplacés par tirets
  const fileName = name.toLowerCase().replace(/\s+/g, ' ');
  
  // Pour l'affichage, on capitalise la première lettre de chaque mot
  let displayName = name
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
  
  // Renommage spécial pour underwater
  if (fileName === 'underwater') {
    displayName = 'Plonger en eau profonde';
  }
  
  card.innerHTML = `
    <img src="assets/images/${fileName}.jpg" alt="${displayName}">
    <div class="card-title">${displayName}</div>
  `;
  
  card.onclick = () => openPlayer(fileName, displayName);
  content.appendChild(card);
});

// ===== LECTEUR SIMPLE =====
function openPlayer(fileName, displayName) {
  // Arrêter le mixeur si actif
  if (currentMode === 'mixer') {
    Object.values(audioMap).forEach(a => a.pause());
    mixerModal.classList.remove("active");
  }
  
  document.getElementById("playerImage").src = `assets/images/${fileName}.jpg`;
  document.getElementById("playerTitle").textContent = displayName;
  
  audio.src = `assets/audio/${fileName}.mp3`;
  audio.loop = true;
  audio.play();
  
  playPauseBtn.textContent = "⏸";
  playerModal.classList.add("active");
  
  startTimer('simple');
}

function closePlayer() {
  audio.pause();
  pauseTimer();
  playerModal.classList.remove("active");
}

// Bouton play/pause
playPauseBtn.onclick = () => {
  if (audio.paused) {
    audio.play();
    playPauseBtn.textContent = "⏸";
    resumeTimer();
  } else {
    audio.pause();
    playPauseBtn.textContent = "▶️";
    pauseTimer();
  }
};

// Ouvrir mini-modale timer depuis lecteur simple
timerDisplay.onclick = () => {
  timerModal.classList.add("active");
};

// Fermer lecteur simple
document.getElementById("closePlayer").onclick = (e) => {
  e.stopPropagation();
  closePlayer();
};

// ===== MIXEUR =====
function initMixer() {
  mixSounds.forEach((name, index) => {
    // Les fichiers sont en minuscules avec espaces
    const fileName = name.toLowerCase();
    
    // Pour l'affichage, on capitalise
    let displayName = name
      .split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
    
    // Renommage spécial pour underwater
    if (fileName === 'underwater') {
      displayName = 'Plonger en eau profonde';
    }
    
    // Créer l'élément audio
    const a = new Audio(`assets/audio/${fileName}.mp3`);
    a.loop = true;
    a.volume = 0;
    audioMap[name] = a;
    
    // Charger la valeur sauvegardée
    const savedVolume = localStorage.getItem(`mixer_${fileName}`) || '0';
    const initialVolume = parseInt(savedVolume);
    
    // Créer l'élément visuel
    const div = document.createElement("div");
    div.className = "mixer-item";
    div.innerHTML = `
      <img src="assets/images/${fileName}.jpg" alt="${displayName}">
      <div class="mixer-item-content">
        <div class="mixer-item-name">${displayName}</div>
        <input type="range" min="0" max="100" value="${initialVolume}">
      </div>
    `;
    
    const slider = div.querySelector("input");
    
    // Appliquer le volume initial
    if (initialVolume > 0) {
      a.volume = initialVolume / 100;
    }
    
    slider.oninput = (e) => {
      const volume = e.target.value / 100;
      a.volume = volume;
      
      // Sauvegarder dans localStorage
      localStorage.setItem(`mixer_${fileName}`, e.target.value);
      
      if (volume > 0) {
        if (!mixerTimerStarted) {
          mixerTimerStarted = true;
          startTimer('mixer');
        }
        if (mixerPlaying) {
          a.play().catch(err => console.log('Erreur lecture:', err));
        }
      } else {
        a.pause();
        // Vérifier si tous les curseurs sont à zéro
        checkAllSlidersZero();
      }
    };
    
    mixerList.appendChild(div);
  });
}

function checkAllSlidersZero() {
  const allZero = Object.values(audioMap).every(a => a.volume === 0);
  if (allZero && mixerTimerStarted) {
    pauseTimer();
  }
}

function resetAllSliders() {
  // Arrêter tous les sons
  Object.values(audioMap).forEach(a => {
    a.pause();
    a.volume = 0;
  });
  
  // Remettre tous les curseurs à zéro
  const sliders = mixerList.querySelectorAll('input[type=range]');
  sliders.forEach(slider => {
    slider.value = 0;
  });
  
  // Effacer toutes les sauvegardes
  mixSounds.forEach(name => {
    const fileName = name.toLowerCase();
    localStorage.removeItem(`mixer_${fileName}`);
  });
  
  // Réinitialiser le timer
  pauseTimer();
  remaining = 600;
  updateTimerDisplay();
  mixerTimerStarted = false;
  mixerPlaying = true;
  mixPlayBtn.textContent = "⏸";
}

function openMixer() {
  // Arrêter le lecteur simple si actif
  if (currentMode === 'simple') {
    audio.pause();
    playerModal.classList.remove("active");
  }
  
  mixerModal.classList.add("active");
  currentMode = 'mixer';
  
  if (!mixerTimerStarted) {
    updateTimerDisplay();
  }
}

function closeMixer() {
  Object.values(audioMap).forEach(a => a.pause());
  mixerModal.classList.remove("active");
  pauseTimer();
  mixerTimerStarted = false;
  mixerPlaying = true;
}

// Bouton play/pause mixeur
mixPlayBtn.onclick = () => {
  if (mixerPlaying) {
    mixerPlaying = false;
    mixPlayBtn.textContent = "▶️";
    Object.values(audioMap).forEach(a => a.pause());
    pauseTimer();
  } else {
    mixerPlaying = true;
    mixPlayBtn.textContent = "⏸";
    let hasSound = false;
    Object.values(audioMap).forEach(a => {
      if (a.volume > 0) {
        a.play().catch(err => console.log('Erreur lecture:', err));
        hasSound = true;
      }
    });
    if (hasSound) {
      resumeTimer();
    }
  }
};

// Ouvrir mini-modale timer depuis mixeur
mixTime.onclick = () => {
  timerModal.classList.add("active");
};

// Fermer mixeur
document.getElementById("closeMixer").onclick = (e) => {
  e.stopPropagation();
  closeMixer();
};

// Ouvrir mixeur
document.getElementById("openMixer").onclick = openMixer;

// Bouton reset mixeur
document.getElementById("mixReset").onclick = resetAllSliders;

// ===== MINI MODALE TIMER =====
document.getElementById("addTime5").onclick = () => addTime(5);
document.getElementById("addTime10").onclick = () => addTime(10);
document.getElementById("addTime15").onclick = () => addTime(15);
document.getElementById("addTime30").onclick = () => addTime(30);
document.getElementById("removeTime10").onclick = () => addTime(-10);
document.getElementById("resetTimerBtn").onclick = resetTimer;

document.getElementById("closeTimer").onclick = (e) => {
  e.stopPropagation();
  timerModal.classList.remove("active");
};

// ===== INITIALISATION =====
initMixer();
updateTimerDisplay();

// Fermer les modales en cliquant sur le fond
playerModal.onclick = (e) => {
  if (e.target === playerModal) {
    closePlayer();
  }
};

mixerModal.onclick = (e) => {
  if (e.target === mixerModal) {
    closeMixer();
  }
};

timerModal.onclick = (e) => {
  if (e.target === timerModal) {
    timerModal.classList.remove("active");
  }
};
</script>

</body>
</html>