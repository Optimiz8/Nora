<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="color-scheme" content="only light" />
    <link rel="stylesheet" href="nora-common.css" />
    <title>Nora - Pop-it Pro</title>
    <style>
      body {
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: var(--bg);
        touch-action: none;
        margin: 0;
      }

      .grid {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(6, 13%);
        /* Interligne vertical resserr√© √† 16px */
        gap: 16px 12px;
        /* On reste proche du header avec 5px */
        padding: 5px 15px 85px 15px;
        justify-content: center;
        align-content: start;
      }

      .bubble {
        width: 98%;
        aspect-ratio: 1;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.1s ease;
        box-shadow:
          inset -3px -3px 6px rgba(0, 0, 0, 0.3),
          0 3px 0 rgba(0, 0, 0, 0.2);
        -webkit-tap-highlight-color: transparent;
        justify-self: center;
        align-self: center;
        position: relative;
      }

      .bubble.pop {
        transform: scale(0.85);
        filter: brightness(0.6) saturate(1.3);
        box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.6);
      }

      .bubble.target {
        outline: 4px solid #fff;
        outline-offset: 2px;
        filter: brightness(1.6);
        transform: scale(1.05);
        z-index: 10;
        box-shadow: 0 0 15px #fff;
      }

      .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 8px;
        padding: 0 12px;
        background: var(--dark) !important;
        height: var(--footer-height);
        align-items: center;
        z-index: 200;
      }

      .footer-button.btn-f {
        flex: 1;
        height: 50px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        background: rgba(245, 228, 204, 0.15) !important;
        color: var(--light) !important;
        border: 1px solid rgba(245, 228, 204, 0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        line-height: 1.1;
        cursor: pointer;
        -webkit-appearance: none;
      }

      .footer-button.btn-f.active {
        background: var(--accent) !important;
        color: var(--dark) !important;
        border: none;
      }

      .footer-button span {
        font-size: 18px;
        margin-bottom: 2px;
        display: block;
      }

      small {
        font-weight: 800;
        text-transform: uppercase;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <button class="back-button" onclick="location.href = 'fidgets.html'">
        ‚Üê
      </button>
      <h1 class="page-title">Pop-it</h1>
    </header>

    <main class="grid" id="g"></main>

    <footer class="footer">
      <button id="sTgl" class="footer-button btn-f active" onclick="tglSound()">
        <span id="sIcon">üîä</span><small>SON</small>
      </button>
      <button id="mTgl" class="footer-button btn-f" onclick="cycleMode()">
        <span id="mIcon">üîÑ</span><small id="mText">MANUEL</small>
      </button>
      <button id="cTgl" class="footer-button btn-f" onclick="cycleTheme()">
        <span id="cIcon">‚òÄÔ∏è</span><small id="cText">JOUR</small>
      </button>
    </footer>

    <script>
      let isSound = true,
        playMode = 0;
      let themeIndex = 0,
        currentTarget = null;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();

      const themes = [
        { i: "‚òÄÔ∏è", l: "Jour" },
        { i: "üåá", l: "Cr√©puscule" },
        { i: "üåø", l: "For√™t" },
        { i: "‚ùÑÔ∏è", l: "Glacier" },
        { i: "üåå", l: "Aurore" },
        { i: "üåª", l: "√ât√©" },
        { i: "üåë", l: "Nuit" },
        { i: "‚ù§Ô∏è", l: "Amour" },
      ];

      const modes = [
        { i: "üîÑ", l: "Manuel" },
        { i: "‚è±Ô∏è", l: "Auto" },
        { i: "üéÆ", l: "Jeu" },
      ];

      function tglSound() {
        isSound = !isSound;
        document.getElementById("sTgl").classList.toggle("active", isSound);
        document.getElementById("sIcon").innerText = isSound ? "üîä" : "üîá";
      }

      function cycleMode() {
        playMode = (playMode + 1) % 3;
        resetPopit();
        const btn = document.getElementById("mTgl");
        btn.classList.toggle("active", playMode !== 0);
        document.getElementById("mIcon").innerText = modes[playMode].i;
        document.getElementById("mText").innerText = modes[playMode].l;
        if (playMode === 2) nextTarget();
      }

      function cycleTheme() {
        themeIndex = (themeIndex + 1) % themes.length;
        document.getElementById("cTgl").querySelector("span").innerText =
          themes[themeIndex].i;
        document.getElementById("cText").innerText = themes[themeIndex].l;
        applyTheme();
      }

      function applyTheme() {
        const bubbles = document.querySelectorAll(".bubble");
        bubbles.forEach((b, i) => {
          const row = Math.floor(i / 4);
          switch (themeIndex) {
            case 0:
              b.style.background = `hsl(${i * 15}, 70%, 60%)`;
              break;
            case 1:
              b.style.background = [
                "#1A237E",
                "#311B92",
                "#4A148C",
                "#880E4F",
                "#BF360C",
                "#3E2723",
              ][row];
              break;
            case 2:
              b.style.background = `hsl(${90 + i * 3}, 50%, ${30 + (i % 5) * 8}%)`;
              break;
            case 3:
              b.style.background = [
                "#E3F2FD",
                "#BBDEFB",
                "#90CAF9",
                "#64B5F6",
                "#42A5F5",
                "#1E88E5",
              ][row];
              break;
            case 4:
              b.style.background = `hsl(${[160, 180, 200, 260, 280, 300][row]}, 80%, 50%)`;
              break;
            case 5:
              b.style.background = [
                "#FFEB3B",
                "#FF4081",
                "#00BCD4",
                "#8BC34A",
                "#FF9800",
                "#FF5722",
              ][row];
              break;
            case 6:
              b.style.background = [
                "#22223b",
                "#4a4e69",
                "#9a8c98",
                "#2c3e50",
                "#34495e",
                "#1a1a2e",
              ][row];
              break;
            case 7:
              const loveCols = [
                "#b71c1c",
                "#d81b60",
                "#ad1457",
                "#f06292",
                "#ec407a",
                "#880e4f",
              ];
              b.style.background = loveCols[row];
              if ([9, 10, 13, 14].includes(i)) b.style.background = "#ffb2dd";
              break;
          }
        });
      }

      function nextTarget() {
        if (playMode !== 2) return;
        const available = [...document.querySelectorAll(".bubble:not(.pop)")];
        if (available.length === 0) {
          setTimeout(() => {
            resetPopit();
            nextTarget();
          }, 300);
          return;
        }
        currentTarget = available[Math.floor(Math.random() * available.length)];
        currentTarget.classList.add("target");
      }

      function resetPopit() {
        document.querySelectorAll(".bubble").forEach((b) => {
          b.classList.remove("pop", "target");
        });
      }

      function playSound(freqPlus = 0) {
        if (!isSound) return;
        if (ctx.state === "suspended") ctx.resume();
        const o = ctx.createOscillator(),
          g = ctx.createGain();
        o.frequency.setValueAtTime(
          450 + freqPlus + Math.random() * 100,
          ctx.currentTime,
        );
        o.frequency.exponentialRampToValueAtTime(10, ctx.currentTime + 0.08);
        g.gain.setValueAtTime(0.06, ctx.currentTime);
        g.connect(ctx.destination);
        o.connect(g);
        o.start();
        o.stop(ctx.currentTime + 0.08);
      }

      const g = document.getElementById("g");
      for (let i = 0; i < 24; i++) {
        const b = document.createElement("div");
        b.className = "bubble";
        g.appendChild(b);
        b.onpointerdown = (e) => {
          e.preventDefault();
          if (playMode === 2) {
            if (b === currentTarget) {
              b.classList.remove("target");
              b.classList.add("pop");
              playSound(200);
              nextTarget();
            }
          } else {
            if (b.classList.contains("pop")) {
              b.classList.remove("pop");
              if (playMode === 0) playSound(-100);
            } else {
              b.classList.add("pop");
              playSound();
              if (playMode === 1)
                setTimeout(() => {
                  if (playMode === 1) b.classList.remove("pop");
                }, 1800);
            }
          }
        };
      }
      applyTheme();
    </script>
      <script src="nora-scroll.js"></script>
</body>
</html>
