<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="stylesheet" href="nora-common.css">
    <script src="nora-data.js"></script>
    <title>TSA App ‚Äì Accueil</title>

    <style>
        /* HEADER ‚Äì override: right-aligned icons on this page */
        .header {
            justify-content: flex-end;
        }

        /* MAIN */
        .main {
            padding: 110px 24px 24px;
        }

        /* TITRE */
        .main-title {
            text-align: center;
            font-size: 22px;
            font-weight: 500;
        }

        /* ZONE DES BULLES */
        .choices {
            margin-top: 48px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* BOUTONS */
        .big-choice {
            background-color: var(--light);
            color: var(--dark);
            border-radius: 32px;
            height: 180px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 16px;
        }

        .big-choice:active { transform: scale(0.97); }

        .choice-icon { font-size: 38px; }
        .choice-text {
            font-size: 20px;
            font-weight: 600;
            line-height: 1.4;
        }

        /* MODALES */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
        }
        .modal.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* CONTENU MODALE */
        .modal-content {
            background: var(--bg);
            border-radius: 36px;
            padding: 24px 20px; /* R√©duit pour gagner de la place */
            width: 100%;
            max-width: 520px;
            position: relative;
        }

        /* CROIX */
        .modal-close {
            position: absolute;
            top: 18px;
            right: 20px;
            font-size: 26px;
            cursor: pointer;
        }

        /* TITRE MODALE */
        .modal-title {
            text-align: center;
            font-size: 19px; /* L√©g√®rement r√©duit */
            font-weight: 500;
            margin-bottom: 20px; /* R√©duit */
        }

        /* OPTIONS - Hauteur r√©duite ici */
        .modal-option {
            background: rgba(245,228,204,0.12);
            border: 2px solid rgba(247,184,156,0.5);
            border-radius: 22px;
            padding: 14px 12px; /* Hauteur r√©duite de 22px √† 14px */
            margin-bottom: 12px; /* Espace entre boutons r√©duit de 18px √† 12px */
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px; /* R√©duit */
        }

        .option-icon {
            font-size: 26px; /* L√©g√®rement r√©duit */
            color: var(--accent);
        }

        .option-text {
            font-size: 16px; /* L√©g√®rement r√©duit */
            font-weight: 400;
            line-height: 1.3;
        }

        .context-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px; /* R√©duit */
        }

        /* MODALE FIN DE CRISE */
        .crisis-modal-text {
            text-align: center;
            font-size: 17px;
            line-height: 1.5;
            margin-bottom: 24px;
            color: var(--light);
        }

        .crisis-modal-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .crisis-btn {
            border: none;
            border-radius: 16px;
            padding: 14px 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            line-height: 1.3;
        }

        .crisis-btn:active {
            transform: scale(0.97);
        }

        .crisis-btn.primary {
            background-color: var(--accent);
            color: var(--dark);
        }

        .crisis-btn.secondary {
            background-color: rgba(245, 228, 204, 0.15);
            color: var(--light);
        }

        .crisis-btn-desc {
            font-size: 13px;
            font-weight: 400;
            opacity: 0.7;
            margin-top: 2px;
        }
    </style>
</head>

<body>

    <header class="header">
        <button class="header-icon" id="btnJournal" aria-label="Journal">üìî</button>
        <button class="header-icon" id="btnSettings" aria-label="Param√®tres">‚öôÔ∏è</button>
    </header>

    <main class="main">
        <h1 class="main-title">De quoi as-tu besoin&nbsp;?</h1>

        <div class="choices">
            <div class="big-choice" id="btnHelp">
                <div class="choice-icon">üí¨</div>
                <div class="choice-text">J'ai besoin d'aide<br>et de communiquer</div>
            </div>

            <div class="big-choice" id="btnCalm">
                <div class="choice-icon">üå∏</div>
                <div class="choice-text">J'ai besoin de m'apaiser</div>
            </div>
        </div>
    </main>

    <div class="modal" id="helpModal" role="dialog" aria-modal="true" aria-label="Comment souhaites-tu communiquer">
        <div class="modal-content">
            <div class="modal-close" data-close="helpModal">√ó</div>
            <div class="modal-title">Comment souhaites-tu communiquer&nbsp;?</div>
            <div class="modal-option" id="btnEmergency">
                <div class="option-icon">ü™™</div>
                <div class="option-text">Afficher ma carte d'urgence</div>
            </div>
            <div class="modal-option" id="btnContext">
                <div class="option-icon">üß≠</div>
                <div class="option-text">Communiquer selon le contexte</div>
            </div>
        </div>
    </div>

    <div class="modal" id="contextModal" role="dialog" aria-modal="true" aria-label="Choix du contexte">
        <div class="modal-content">
            <div class="modal-close" data-close="contextModal">√ó</div>
            <div class="modal-title">O√π es-tu&nbsp;?</div>
            <div class="context-grid" id="contextGrid">
                <!-- G√©n√©r√© dynamiquement -->
            </div>
        </div>
    </div>

    <div class="modal" id="calmModal" role="dialog" aria-modal="true" aria-label="Me calmer">
        <div class="modal-content">
            <div class="modal-close" data-close="calmModal">√ó</div>
            <div class="modal-title">Comment veux-tu t'apaiser&nbsp;?</div>
            <div class="modal-option" id="btnConseils"><div class="option-icon">‚úì</div><div class="option-text">Conseils</div></div>
            <div class="modal-option" id="btnBreathing"><div class="option-icon">ü´Å</div><div class="option-text">Respiration apaisante</div></div>
            <div class="modal-option" id="btnSounds"><div class="option-icon">üéß</div><div class="option-text">Sons relaxants</div></div>
            <div class="modal-option" id="btnPlaylist"><div class="option-icon">üéµ</div><div class="option-text">Playlist</div></div>
            <div class="modal-option" id="btnFidget"><div class="option-icon">üß©</div><div class="option-text">Fidget</div></div>
            <div class="modal-option" id="btnLava"><div class="option-icon">‚òÅÔ∏è</div><div class="option-text">Harmonie visuelle</div></div>
        </div>
    </div>

    <!-- Modale fin de crise : √©tape 1 -->
    <div class="modal" id="crisisEndModal" role="dialog" aria-modal="true" aria-label="Fin de crise">
        <div class="modal-content">
            <div class="modal-close" data-close-crisis="crisisEndModal">√ó</div>
            <div class="modal-title">Fin de crise ?</div>
            <div class="crisis-modal-text">
                Une crise semble √™tre en cours.<br>Est-elle termin√©e ?
            </div>
            <div class="crisis-modal-actions">
                <button class="crisis-btn primary" onclick="crisisIsOver()">Oui, elle est termin√©e</button>
                <button class="crisis-btn secondary" onclick="crisisNotOver()">Non, pas encore</button>
            </div>
        </div>
    </div>

    <!-- Modale fin de crise : √©tape 2 (choix enregistrement) -->
    <div class="modal" id="crisisRegisterModal" role="dialog" aria-modal="true" aria-label="Enregistrer la crise">
        <div class="modal-content">
            <div class="modal-close" data-close-crisis="crisisRegisterModal">√ó</div>
            <div class="modal-title">Enregistrer la crise</div>
            <div class="crisis-modal-text">
                Souhaites-tu enregistrer cette crise dans ton journal ?
            </div>
            <div class="crisis-modal-actions">
                <button class="crisis-btn primary" onclick="registerCrisisNow()">
                    Enregistrer maintenant
                    <div class="crisis-btn-desc">Ajouter au journal avec les donn√©es de la crise</div>
                </button>
                <button class="crisis-btn secondary" onclick="registerCrisisLater()">
                    Plus tard
                    <div class="crisis-btn-desc">On te redemandera demain</div>
                </button>
                <button class="crisis-btn secondary" onclick="enableAutoRegister()">
                    Toujours enregistrer automatiquement
                    <div class="crisis-btn-desc">Les prochaines crises seront ajout√©es au journal sans demander</div>
                </button>
            </div>
        </div>
    </div>

    <script>
    function startCrisis(profilId) {
        localStorage.setItem('profilActuel', profilId);
        localStorage.setItem('criseEnCours', 'true');
        localStorage.setItem('crisisStartTime', Date.now().toString());
        // Nettoyer les donn√©es de crise pr√©c√©dente
        localStorage.removeItem('currentCapacites');
        localStorage.removeItem('currentBesoins');
        localStorage.removeItem('currentEtats');
        const config = getProfileConfig(profilId);
        const pages = getFlowPages(config);
        location.href = pages[0];
    }

    function buildContextGrid() {
        const grid = document.getElementById('contextGrid');
        const DEFAULT_CONTEXTES = [
            { id: 'maison', emoji: 'üè†', nom: 'Maison', default: true },
            { id: 'exterieur', emoji: 'üåç', nom: 'Ext√©rieur', default: true },
            { id: 'travail', emoji: 'üíº', nom: 'Travail / √âcole', default: true },
            { id: 'secours', emoji: 'üôè', nom: 'Secours', default: true }
        ];
        const contextes = JSON.parse(localStorage.getItem('contextes')) || DEFAULT_CONTEXTES;

        grid.innerHTML = contextes
            .filter(ctx => ctx.visible !== false)
            .map(ctx => `<div class="modal-option" data-profile="${ctx.id}"><div class="option-icon">${ctx.emoji}</div><div class="option-text">${ctx.nom}</div></div>`)
            .join('');

        grid.querySelectorAll('[data-profile]').forEach(el =>
            el.onclick = () => startCrisis(el.dataset.profile)
        );
    }

    // ===== LOGIQUE FIN DE CRISE =====
    function getTodayStr() {
        return new Date().toISOString().split('T')[0];
    }

    function checkCrisisEnd() {
        const criseEnCours = localStorage.getItem('criseEnCours') === 'true';
        if (!criseEnCours) return;

        const lastCheck = localStorage.getItem('lastCrisisCheck') || '';
        const today = getTodayStr();
        if (lastCheck === today) return;

        // Auto-register activ√© ?
        if (localStorage.getItem('autoRegisterCrise') === 'true') {
            createJournalEntry();
            cleanupCrisisData();
            return;
        }

        // Afficher la modale
        document.getElementById('crisisEndModal').classList.add('visible');
    }

    function crisisNotOver() {
        localStorage.setItem('lastCrisisCheck', getTodayStr());
        document.getElementById('crisisEndModal').classList.remove('visible');
    }

    function crisisIsOver() {
        document.getElementById('crisisEndModal').classList.remove('visible');
        document.getElementById('crisisRegisterModal').classList.add('visible');
    }

    function registerCrisisNow() {
        createJournalEntry();
        cleanupCrisisData();
        document.getElementById('crisisRegisterModal').classList.remove('visible');
        alert('‚úÖ Crise enregistr√©e dans le journal !');
    }

    function registerCrisisLater() {
        localStorage.setItem('lastCrisisCheck', getTodayStr());
        // Marquer comme "√† traiter" pour ne pas perdre les donn√©es
        localStorage.setItem('criseATraiter', 'true');
        document.getElementById('crisisRegisterModal').classList.remove('visible');
    }

    function enableAutoRegister() {
        localStorage.setItem('autoRegisterCrise', 'true');
        createJournalEntry();
        cleanupCrisisData();
        document.getElementById('crisisRegisterModal').classList.remove('visible');
        alert('‚úÖ Crise enregistr√©e ! Les prochaines seront enregistr√©es automatiquement.');
    }

    function createJournalEntry() {
        const profil = localStorage.getItem('profilActuel') || 'commun';
        const capacites = JSON.parse(localStorage.getItem('currentCapacites') || '{}');
        const besoins = JSON.parse(localStorage.getItem('currentBesoins') || '[]');
        const etats = JSON.parse(localStorage.getItem('currentEtats') || '[]');
        const startTime = localStorage.getItem('crisisStartTime');

        // Calculer la dur√©e si possible
        let duree = '';
        if (startTime) {
            const durationMs = Date.now() - parseInt(startTime);
            const minutes = Math.round(durationMs / 60000);
            if (minutes < 60) {
                duree = minutes + ' min';
            } else {
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                duree = m > 0 ? h + 'h' + (m < 10 ? '0' : '') + m : h + 'h';
            }
        }

        // Horodatage = moment du d√©but de crise si disponible, sinon maintenant
        const horodatage = startTime
            ? new Date(parseInt(startTime)).toISOString()
            : new Date().toISOString();

        const profilInfo = getContexteInfo(profil);

        const entry = {
            horodatage: horodatage,
            profil: profil,
            profilNom: profilInfo.nom,
            profilEmoji: profilInfo.emoji,
            capacites: capacites,
            besoins: besoins,
            etats: etats,
            typeCrise: '',
            intensite: '',
            duree: duree,
            declencheurs: [],
            remarques: '',
            manual: false
        };

        const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
        journal.push(entry);
        localStorage.setItem('journalCrises', JSON.stringify(journal));
    }

    function cleanupCrisisData() {
        localStorage.removeItem('criseEnCours');
        localStorage.removeItem('crisisStartTime');
        localStorage.removeItem('currentCapacites');
        localStorage.removeItem('currentBesoins');
        localStorage.removeItem('currentEtats');
        localStorage.removeItem('lastCrisisCheck');
        localStorage.removeItem('criseATraiter');
    }

    document.addEventListener('DOMContentLoaded', () => {

        const open = id => document.getElementById(id).classList.add('visible');
        const close = id => document.getElementById(id).classList.remove('visible');

        // Ouvrir automatiquement la modale si hash pr√©sent
        if (location.hash === '#calm') {
            open('calmModal');
            history.replaceState(null, '', location.pathname);
        }

        // Construire la grille de contextes dynamiquement
        buildContextGrid();

        btnHelp.onclick = () => open('helpModal');
        btnCalm.onclick = () => open('calmModal');

        btnContext.onclick = () => {
            close('helpModal');
            // Mode simplifi√© : skip la modale "O√π es-tu"
            if (localStorage.getItem('contexte_messageUnique') === 'true') {
                startCrisis('commun');
                return;
            }
            open('contextModal');
        };

        btnEmergency.onclick = () => location.href = 'carte.html';

        document.querySelectorAll('[data-close]').forEach(el =>
            el.onclick = () => close(el.dataset.close)
        );

        btnConseils.onclick = () => location.href='conseils.html';
        btnBreathing.onclick = () => location.href='coherence.html';
        btnSounds.onclick = () => location.href='sons.html';
        btnPlaylist.onclick = () => location.href='playlist.html';
        btnFidget.onclick = () => location.href='fidgets.html';
        btnLava.onclick = () => location.href='harmonie-visuelle.html';

        btnJournal.onclick = () => location.href='journal.html';
        btnSettings.onclick = () => location.href='parametres.html';

        // Fermeture des modales de crise
        document.querySelectorAll('[data-close-crisis]').forEach(el =>
            el.onclick = () => {
                const modalId = el.getAttribute('data-close-crisis');
                document.getElementById(modalId).classList.remove('visible');
                // Si on ferme sans r√©pondre, on repose la question demain
                localStorage.setItem('lastCrisisCheck', getTodayStr());
            }
        );

        // V√©rifier fin de crise apr√®s un court d√©lai (laisser la page se charger)
        setTimeout(checkCrisisEnd, 500);
    });
    </script>
        document.addEventListener("keydown", e => { if (e.key === "Escape") document.querySelectorAll(".modal.visible").forEach(m => m.classList.remove("visible")); });

    <script src="nora-scroll.js"></script>
</body>
</html>