<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="assets/images/favicone.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
    <link rel="stylesheet" href="nora-common.css">
    <title>Nora ‚Äì Statistiques</title>
    <style>
        body { padding-bottom: 40px; }

        /* ---------- P√âRIODE ---------- */

        .period-bar {
            display: flex;
            gap: 8px;
            padding: 0 16px;
        }

        .period-btn {
            flex: 1;
            background: rgba(245, 228, 204, 0.1);
            border: 2px solid rgba(245, 228, 204, 0.15);
            color: var(--light);
            font-size: 14px;
            font-weight: 600;
            padding: 10px 4px;
            border-radius: 10px;
            cursor: pointer;
        }

        .period-btn.active {
            background: var(--light);
            border-color: var(--light);
            color: var(--dark);
        }

        .period-btn:active { transform: scale(0.97); }

        /* ---------- PLAGE PERSONNALIS√âE ---------- */

        .date-range-panel {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 12px 16px;
        }

        .date-range-panel.visible { display: flex; }

        .date-range-row { display: flex; gap: 10px; align-items: center; }

        .date-range-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--light);
            width: 44px;
            flex-shrink: 0;
        }

        .date-range-input {
            flex: 1;
            background: rgba(245, 228, 204, 0.12);
            border: 2px solid rgba(245, 228, 204, 0.2);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 15px;
            font-family: inherit;
            color: var(--light);
            color-scheme: dark;
        }

        .date-range-input:focus { outline: none; border-color: var(--light); }

        .date-range-apply {
            background: var(--accent);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
        }

        .date-range-apply:active { transform: scale(0.98); }

        /* ---------- CONTENU ---------- */

        .main-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* ---------- TITRES DE SECTION ---------- */

        .section-tag {
            font-size: 15px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--accent);
            padding: 18px 2px 6px;
        }

        /* ---------- CARTE BLANCHE ---------- */

        .stat-card {
            background: var(--light);
            border-radius: 14px;
            overflow: hidden;
        }

        /* ---------- LIGNES LABEL / VALEUR ---------- */

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 16px;
            border-bottom: 1px solid rgba(46, 58, 89, 0.08);
            gap: 12px;
        }

        .stat-row:last-child { border-bottom: none; }

        .stat-label {
            font-size: 15px;
            color: var(--dark);
            opacity: 0.65;
            font-weight: 500;
            flex-shrink: 0;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            text-align: right;
        }

        .stat-value.large { font-size: 28px; }

        .stat-delta {
            font-size: 13px;
            font-weight: 600;
            margin-left: 6px;
            color: var(--dark);
            opacity: 0.55;
        }

        .stat-sub {
            font-size: 13px;
            font-weight: 400;
            color: var(--dark);
            opacity: 0.5;
            display: block;
            margin-top: 2px;
        }

        /* ---------- DERNI√àRE CRISE ---------- */

        .last-crisis-row {
            background: var(--light);
            border-radius: 14px;
            padding: 13px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .last-crisis-label { font-size: 15px; color: var(--dark); opacity: 0.65; }
        .last-crisis-value { font-size: 18px; font-weight: 700; color: var(--dark); }

        /* ---------- GRILLE MOMENTS ---------- */

        .moment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: rgba(46, 58, 89, 0.08);
            border-radius: 14px;
            overflow: hidden;
        }

        .moment-cell {
            background: var(--light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 14px 4px;
        }

        .moment-cell.highlight { background: var(--dark); }

        .moment-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.7;
        }

        .moment-range {
            font-size: 12px;
            color: var(--dark);
            opacity: 0.6;
        }

        .moment-count {
            font-size: 26px;
            font-weight: 700;
            color: var(--dark);
            margin-top: 2px;
        }

        .moment-cell.highlight .moment-name,
        .moment-cell.highlight .moment-range,
        .moment-cell.highlight .moment-count {
            color: var(--light);
            opacity: 1;
        }

        /* ---------- BARRES DE CLASSEMENT ---------- */

        .rank-item {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(46, 58, 89, 0.08);
        }

        .rank-item:last-child { border-bottom: none; }

        .rank-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 7px;
        }

        .rank-name { font-size: 16px; font-weight: 700; color: var(--dark); }

        .rank-meta { font-size: 14px; color: var(--dark); opacity: 0.55; }

        .rank-bar-bg {
            height: 7px;
            background: rgba(46, 58, 89, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .rank-bar-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
        }

        /* ---------- CAPACIT√âS ---------- */

        .cap-category {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--dark);
            opacity: 0.6;
            padding: 12px 16px 4px;
        }

        .cap-category.cap-sep {
            border-top: 2px solid rgba(46, 58, 89, 0.13);
            padding-top: 16px;
            margin-top: 6px;
        }

        /* ---------- BILAN TENDANCES ---------- */

        .bilan-comp-col-hd.col-current { opacity: 0.9; }

        .bilan-trend {
            display: block;
            font-size: 11px;
            font-weight: 600;
            opacity: 0.55;
            margin-top: 1px;
        }

        .bilan-minmax {
            padding: 8px 16px 12px;
            border-top: 1px solid rgba(46, 58, 89, 0.08);
            font-size: 12px;
            color: var(--dark);
            opacity: 0.55;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bilan-minmax strong { font-weight: 700; }

        /* ---------- EXPORT ---------- */

        .export-btn {
            background: rgba(245, 228, 204, 0.14);
            border: 2px solid rgba(245, 228, 204, 0.3);
            color: var(--light);
            font-size: 15px;
            font-weight: 600;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-btn:active { opacity: 0.8; transform: scale(0.98); }

        /* ---------- TOOLTIP D√âFINITION ---------- */

        #defTooltip {
            position: fixed;
            background: var(--dark);
            color: var(--light);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 0.82rem;
            line-height: 1.6;
            box-shadow: 0 4px 16px rgba(0,0,0,0.45);
            max-width: 240px;
            z-index: 500;
            display: none;
            border: 1px solid rgba(245,228,204,0.15);
        }

        .rank-name-def {
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
            cursor: pointer;
        }

        /* ---------- √âTAT VIDE ---------- */

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--light);
            opacity: 0.6;
        }

        .empty-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-text { font-size: 16px; line-height: 1.5; }

        /* ---------- BILAN COMPARAISON ---------- */

        .bilan-comp-header {
            display: flex;
            align-items: center;
            padding: 8px 16px 6px;
        }

        .bilan-comp-spacer { flex: 1; }

        .bilan-comp-col-hd {
            width: 72px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--dark);
            opacity: 0.45;
        }

        .bilan-comp-row {
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-top: 1px solid rgba(46, 58, 89, 0.08);
        }

        .bilan-comp-label {
            flex: 1;
            font-size: 14px;
            color: var(--dark);
            opacity: 0.65;
            font-weight: 500;
            padding: 14px 8px 14px 0;
        }

        .bilan-comp-current {
            width: 72px;
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
            padding: 14px 0;
        }

        .bilan-comp-prev {
            width: 72px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.45;
            padding: 14px 0;
        }

        .bilan-comp-trend {
            width: 28px;
            text-align: center;
            font-size: 15px;
            font-weight: 700;
            color: var(--dark);
            opacity: 0.7;
            padding: 14px 0 14px 4px;
        }

        /* ---------- NOTE CAPACIT√âS ---------- */

        .cap-note {
            font-size: 13px;
            color: var(--light);
            opacity: 0.5;
            font-style: italic;
            padding: 8px 4px 4px;
            line-height: 1.5;
        }

        /* ---------- ACTIONS D'EXPORT ---------- */

        .export-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .export-actions .export-btn { margin-top: 0; }

        .export-row { display: flex; gap: 8px; }
        .export-row .export-btn { flex: 1; }

        /* ---------- IMPRESSION ---------- */

        .print-header {
            display: none;
            font-size: 16px;
            font-weight: 700;
            color: #111;
            padding: 0 0 12px;
        }

        @media print {
            body { background: white !important; color: #111 !important; padding: 0 !important; }
            .header, .period-header, .period-bar, .date-range-panel, .export-actions { display: none !important; }
            .print-header { display: block !important; }
            .main-content { padding: 8px !important; }
            .section-tag { color: #333 !important; }
            .stat-card { background: #f5f5f5 !important; border: 1px solid #ddd !important; }
            .stat-label { color: #444 !important; opacity: 1 !important; }
            .stat-value { color: #111 !important; }
            .stat-sub, .stat-delta { color: #555 !important; opacity: 1 !important; }
            .last-crisis-row { background: #f5f5f5 !important; border: 1px solid #ddd !important; }
            .last-crisis-label { color: #444 !important; opacity: 1 !important; }
            .last-crisis-value { color: #111 !important; }
            .moment-grid { background: #ddd !important; }
            .moment-cell { background: #f5f5f5 !important; }
            .moment-cell.highlight { background: #2E3A59 !important; }
            .moment-name, .moment-range, .moment-count { color: #111 !important; opacity: 1 !important; }
            .moment-cell.highlight .moment-name,
            .moment-cell.highlight .moment-range,
            .moment-cell.highlight .moment-count { color: #F5E4CC !important; }
            .rank-name { color: #111 !important; }
            .rank-meta { color: #555 !important; opacity: 1 !important; }
            .rank-bar-bg { background: #e0e0e0 !important; }
            .rank-bar-fill { background: #888 !important; }
            .cap-category { color: #333 !important; opacity: 1 !important; }
            .bilan-trend { color: #333 !important; opacity: 0.6 !important; }
            .bilan-minmax { color: #333 !important; opacity: 1 !important; }
        }
    </style>
</head>
<body>
    <header class="header">
        <button class="back-button" onclick="window.location.href='journal.html'" aria-label="Retour au journal">‚¨ÖÔ∏è</button>
        <h1 class="page-title">Statistiques</h1>
    </header>

    <div class="period-header" style="font-size:15px;font-weight:800;text-transform:uppercase;letter-spacing:0.07em;color:var(--accent);padding:14px 16px 6px">P√©riode</div>
    <div class="period-bar">
        <button class="period-btn active" data-days="7" onclick="selectPeriod(7)">7 j</button>
        <button class="period-btn" data-days="30" onclick="selectPeriod(30)">30 j</button>
        <button class="period-btn" data-days="365" onclick="selectPeriod(365)">1 an</button>
        <button class="period-btn" data-days="0" onclick="selectPeriod(0)">Dates</button>
    </div>
    <div class="date-range-panel" id="dateRangePanel">
        <div class="date-range-row">
            <span class="date-range-label">D√©but</span>
            <input type="date" class="date-range-input" id="dateFrom">
        </div>
        <div class="date-range-row">
            <span class="date-range-label">Fin</span>
            <input type="date" class="date-range-input" id="dateTo">
        </div>
        <button class="date-range-apply" onclick="applyCustomRange()">Appliquer</button>
    </div>

    <div id="defTooltip"></div>
    <div id="printHeader" class="print-header"></div>
    <main class="main-content" id="mainContent"></main>

    <script>
        var currentDays = 7;
        var customFrom = null;
        var customTo = null;

        /* ---------- DONN√âES ---------- */

        function getJournal() {
            try { return JSON.parse(localStorage.getItem('journalCrises') || '[]'); }
            catch (e) { return []; }
        }

        function getProfileName(profileId) {
            var names = { commun: 'Profil commun', maison: 'Maison', exterieur: 'Ext√©rieur', travail: 'Travail', secours: 'Secours' };
            return names[profileId] || profileId || '‚Äî';
        }

        /* ---------- DUR√âE ---------- */

        function parseDuration(str) {
            if (!str) return null;
            str = str.toLowerCase().trim();
            var mins = 0, found = false;
            var hMatch = str.match(/(\d+)\s*h/);
            if (hMatch) { mins += parseInt(hMatch[1], 10) * 60; found = true; }
            var mMatch = str.match(/(\d+)\s*(min|mn|m\b)/);
            if (mMatch) { mins += parseInt(mMatch[1], 10); found = true; }
            if (!found) { var n = str.match(/^(\d+)$/); if (n) { mins = parseInt(n[1], 10); found = true; } }
            return (found && mins > 0) ? mins : null;
        }

        function formatMins(m) {
            m = Math.round(m);
            if (m < 60) return m + ' min';
            var h = Math.floor(m / 60), r = m % 60;
            return r > 0 ? h + 'h' + (r < 10 ? '0' : '') + r : h + 'h';
        }

        function formatDateFR(s) {
            return new Date(s).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
        }

        /* ---------- FR√âQUENCES ---------- */

        function countFreq(arr) {
            var freq = {};
            for (var i = 0; i < arr.length; i++) {
                if (arr[i]) freq[arr[i]] = (freq[arr[i]] || 0) + 1;
            }
            var result = [];
            for (var k in freq) result.push({ name: k, count: freq[k] });
            result.sort(function(a, b) { return b.count - a.count; });
            return result;
        }

        /* ---------- CALCUL STATS ---------- */

        function computeStats(days, from, to) {
            var journal = getJournal();
            var entries = [], prevEntries = [];

            if (days === 0 && from && to) {
                var start = new Date(from); start.setHours(0, 0, 0, 0);
                var end = new Date(to); end.setHours(23, 59, 59, 999);
                var span = end - start;
                for (var i = 0; i < journal.length; i++) {
                    var d = new Date(journal[i].horodatage);
                    if (d >= start && d <= end) entries.push(journal[i]);
                    else if (d >= new Date(start - span) && d < start) prevEntries.push(journal[i]);
                }
            } else {
                var now = new Date();
                var cutoff = new Date(now); cutoff.setDate(now.getDate() - days); cutoff.setHours(0, 0, 0, 0);
                var prevCut = new Date(now); prevCut.setDate(now.getDate() - days * 2); prevCut.setHours(0, 0, 0, 0);
                for (var j = 0; j < journal.length; j++) {
                    var dj = new Date(journal[j].horodatage);
                    if (dj >= cutoff) entries.push(journal[j]);
                    else if (dj >= prevCut) prevEntries.push(journal[j]);
                }
            }

            if (!entries.length) return null;

            var intensities = [], durations = [], profileArr = [], typeArr = [], triggerArr = [], besoinArr = [], capImpossArr = [], capDiffArr = [], etatsArr = [];

            for (var k = 0; k < entries.length; k++) {
                var e = entries[k];
                var iv = parseFloat(e.intensite); if (!isNaN(iv)) intensities.push(iv);
                var dv = parseDuration(e.duree); if (dv !== null) durations.push(dv);
                profileArr.push(e.profil || 'commun');
                if (e.typeCrise) typeArr.push(e.typeCrise);
                var decl = e.declencheurs || [];
                for (var d2 = 0; d2 < decl.length; d2++) { if (decl[d2]) triggerArr.push(decl[d2]); }
                var bess = e.besoins || [];
                for (var b = 0; b < bess.length; b++) {
                    var bl = bess[b] && bess[b].label ? bess[b].label : bess[b];
                    if (bl) besoinArr.push(bl);
                }
                var caps = e.capacites || {};
                var capImp = caps.impossible || [];
                for (var ci = 0; ci < capImp.length; ci++) { if (capImp[ci]) capImpossArr.push(capImp[ci]); }
                var capDif = caps.difficile || [];
                for (var cd = 0; cd < capDif.length; cd++) { if (capDif[cd]) capDiffArr.push(capDif[cd]); }
                var ets = e.etats || [];
                for (var et = 0; et < ets.length; et++) {
                    var etl = ets[et] && ets[et].label ? ets[et].label : ets[et];
                    if (etl) etatsArr.push(etl);
                }
            }

            var avgIntensity = null, minIntensity = null, maxIntensity = null;
            if (intensities.length) {
                var isum = 0; for (var s = 0; s < intensities.length; s++) isum += intensities[s];
                avgIntensity = parseFloat((isum / intensities.length).toFixed(1));
                minIntensity = Math.min.apply(null, intensities);
                maxIntensity = Math.max.apply(null, intensities);
            }

            var avgDuration = null, minDuration = null, maxDuration = null;
            if (durations.length) {
                var dsum = 0; for (var ds = 0; ds < durations.length; ds++) dsum += durations[ds];
                avgDuration = dsum / durations.length;
                minDuration = Math.min.apply(null, durations);
                maxDuration = Math.max.apply(null, durations);
            }

            var profileCounts = countFreq(profileArr);
            var profiles = [];
            for (var pi = 0; pi < profileCounts.length; pi++) {
                profiles.push({ name: getProfileName(profileCounts[pi].name), count: profileCounts[pi].count });
            }
            var typeCounts = countFreq(typeArr);
            var triggers = countFreq(triggerArr);
            var besoins = countFreq(besoinArr);
            var capacitesImposs = countFreq(capImpossArr);
            var capacitesDiff = countFreq(capDiffArr);
            var etats = countFreq(etatsArr);

            var hourSlots = [
                { name: 'Nuit',    range: '0‚Äì6h',   count: 0 },
                { name: 'Matin',   range: '6‚Äì12h',  count: 0 },
                { name: 'Apr√®s-m.',range: '12‚Äì18h', count: 0 },
                { name: 'Soir',    range: '18‚Äì24h', count: 0 }
            ];
            for (var he = 0; he < entries.length; he++) {
                var h = new Date(entries[he].horodatage).getHours();
                if (h < 6) hourSlots[0].count++;
                else if (h < 12) hourSlots[1].count++;
                else if (h < 18) hourSlots[2].count++;
                else hourSlots[3].count++;
            }

            var prevIntensities = [], prevDurations = [];
            for (var pk = 0; pk < prevEntries.length; pk++) {
                var pe = prevEntries[pk];
                var piv = parseFloat(pe.intensite); if (!isNaN(piv)) prevIntensities.push(piv);
                var pdv = parseDuration(pe.duree); if (pdv !== null) prevDurations.push(pdv);
            }
            var prevAvgIntensity = null, prevAvgDuration = null;
            if (prevIntensities.length) {
                var pisum = 0; for (var ps = 0; ps < prevIntensities.length; ps++) pisum += prevIntensities[ps];
                prevAvgIntensity = parseFloat((pisum / prevIntensities.length).toFixed(1));
            }
            if (prevDurations.length) {
                var pdsum = 0; for (var pds = 0; pds < prevDurations.length; pds++) pdsum += prevDurations[pds];
                prevAvgDuration = pdsum / prevDurations.length;
            }

            return {
                total: entries.length,
                prevCount: prevEntries.length,
                prevAvgIntensity: prevAvgIntensity,
                prevAvgDuration: prevAvgDuration,
                avgIntensity: avgIntensity,
                minIntensity: minIntensity,
                maxIntensity: maxIntensity,
                avgDuration: avgDuration,
                minDuration: minDuration,
                maxDuration: maxDuration,
                profiles: profiles,
                types: typeCounts,
                triggers: triggers,
                besoins: besoins,
                capacitesImposs: capacitesImposs,
                capacitesDiff: capacitesDiff,
                etats: etats,
                hourSlots: hourSlots
            };
        }

        /* ---------- DERNI√àRE CRISE ---------- */

        function sinceLastCrisis() {
            var journal = getJournal();
            if (!journal.length) return null;
            var latest = null;
            for (var i = 0; i < journal.length; i++) {
                var d = new Date(journal[i].horodatage);
                if (!latest || d > latest) latest = d;
            }
            var today = new Date(); today.setHours(0, 0, 0, 0);
            var latestDay = new Date(latest.getTime()); latestDay.setHours(0, 0, 0, 0);
            var diffDays = Math.round((today - latestDay) / 86400000);
            if (diffDays === 0) return "aujourd'hui";
            if (diffDays === 1) return 'hier';
            if (diffDays === 2) return 'avant-hier';
            var JOURS = ['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
            var MOIS = ['jan.','f√©v.','mar.','avr.','mai','juin','juil.','ao√ªt','sep.','oct.','nov.','d√©c.'];
            var label = JOURS[latest.getDay()] + ' ' + latest.getDate() + ' ' + MOIS[latest.getMonth()] + ' ' + String(latest.getFullYear()).slice(2);
            return label + ' (il y a ' + diffDays + ' j)';
        }

        /* ---------- RENDU ---------- */

        function trendHtml(cur, prev, formatFn) {
            if (cur === null || prev === null) return '';
            if (cur === prev) return '<span class="bilan-trend">=</span>';
            var sym = cur > prev ? '‚Üë' : '‚Üì';
            var diff = Math.abs(cur - prev);
            var diffStr = formatFn ? formatFn(diff) : diff;
            var sign = cur > prev ? '+' : '‚àí';
            return '<span class="bilan-trend">' + sym + sign + diffStr + '</span>';
        }

        var TYPE_DEFS = {
            'Anticipatoire': 'Crise survenant avant un √©v√©nement pr√©vu, li√©e √† l\'anticipation de celui-ci.',
            'R√©actionnelle': 'Crise survenant en r√©action directe √† un stimulus ou √©v√©nement en cours.',
            'Mixte': 'Crise combinant des √©l√©ments anticipatoires et r√©actionnels.'
        };

        var TRIGGER_DEFS = {
            'Auditif': 'Pr√©sence de bruits latents (bourdonnements, bruits de fond subtils) ou survenue de bruits soudains',
            'Visuel': 'Variations brusques de luminosit√© ou exposition √† des lumi√®res trop fortes',
            'Olfactif': 'Perception d\'odeurs d√©rangeantes',
            'Tactile': 'Contact physique (quelqu\'un qui nous touche) ou confrontation √† certaines textures alimentaires',
            'Proprioceptive': 'Difficult√©s √† se repr√©senter dans l\'espace ou ressenti d\'un inconfort spatio-temporel',
            'Surcharge √©motionnelle': 'Accumulation d\'√©motions intenses',
            'Instabilit√©': 'Arriv√©e d\'un changement, d\'un impr√©vu ou d\'une interaction impr√©visible',
            'Zone Secure': 'Modification de la zone secure ou obligation de s\'en √©loigner',
            'Perturbation de l\'organisation ou des routines personnelles': 'Rupture de structure habituelle',
            'Non-respect des r√®gles': 'Cadre : non respect√©, r√®gle enfreinte',
            'Injustice': 'Confrontation √† une situation ou un v√©cu injuste / non √©thique',
            'Intrusion': 'dans la zone secure / ton espace personnel',
            'Situations sociales': 'Participation √† des occasions sociales ou √† des conversations superficielles (small talk)',
            'Traitement social': 'Difficult√© √† lire les visages ou probl√®mes de compr√©hension dans les √©changes',
            'Barri√®re de communication': 'Difficult√© √† s\'exprimer ou √† traduire la pens√©e de l\'autre',
            'Gestion du temps': 'Difficult√© de planification et de projection (dans le temps ou dans des sc√©narios abstraits)',
            'Surcharge cognitive': 'Trop d\'informations ou de t√¢ches √† traiter simultan√©ment ou non',
            'Pression de r√©sultat': 'Exigence de pr√©cision, de perfection et de performance',
            'Besoin imp√©rieux de corriger les erreurs': 'R√©action cognitive face √† une erreur avec un besoin presque incontr√¥lable de corriger celle-ci. Peut entra√Æner des ruminations.'
        };

        function rankItems(list, maxCount, defs) {
            var html = '';
            for (var i = 0; i < list.length; i++) {
                var item = list[i];
                var pct = Math.round((item.count / maxCount) * 100);
                var meta = item.count + ' fois';
                if (item.avgIntensity != null) meta += ' ¬∑ ' + item.avgIntensity + '/10';
                var hasDef = defs && defs[item.name];
                var nameClass = hasDef ? 'rank-name rank-name-def' : 'rank-name';
                var defAttr = hasDef ? ' data-def="' + item.name.replace(/"/g, '&quot;') + '"' : '';
                html += '<div class="rank-item' + (hasDef ? ' has-def' : '') + '"' + defAttr + '>' +
                    '<div class="rank-header">' +
                    '<span class="' + nameClass + '">' + item.name + '</span>' +
                    '<span class="rank-meta">' + meta + '</span>' +
                    '</div>' +
                    '<div class="rank-bar-bg"><div class="rank-bar-fill" style="width:' + pct + '%"></div></div>' +
                    '</div>';
            }
            return html;
        }

        function render(days, from, to) {
            var stats = computeStats(days, from, to);
            var last = sinceLastCrisis();
            var main = document.getElementById('mainContent');

            var lastRow = last
                ? '<div class="last-crisis-row"><span class="last-crisis-label">Derni√®re crise</span><span class="last-crisis-value">' + last + '</span></div>'
                : '';

            if (!stats) {
                main.innerHTML = lastRow +
                    '<div class="empty-state"><div class="empty-icon">üìä</div>' +
                    '<div class="empty-text">Aucune crise enregistr√©e<br>sur cette p√©riode.</div></div>';
                return;
            }

            /* Bilan */
            var showComp = currentDays !== 0 && stats.prevCount > 0;
            var bilanHtml;

            if (showComp) {
                var prevIntStr = stats.prevAvgIntensity !== null ? stats.prevAvgIntensity + '/10' : '‚Äî';
                var prevDurStr = stats.prevAvgDuration !== null ? formatMins(stats.prevAvgDuration) : '‚Äî';
                var minmaxHtml = '';
                if (stats.minIntensity !== null && stats.maxIntensity !== null && stats.minIntensity !== stats.maxIntensity) {
                    minmaxHtml += '<div>Intensit√© : min <strong>' + stats.minIntensity + '/10</strong> ¬∑ max <strong>' + stats.maxIntensity + '/10</strong></div>';
                }
                if (stats.minDuration !== null && stats.maxDuration !== null && stats.minDuration !== stats.maxDuration) {
                    minmaxHtml += '<div>Dur√©e : min <strong>' + formatMins(stats.minDuration) + '</strong> ¬∑ max <strong>' + formatMins(stats.maxDuration) + '</strong></div>';
                }
                bilanHtml =
                    '<div class="bilan-comp-header">' +
                    '<span class="bilan-comp-spacer"></span>' +
                    '<span class="bilan-comp-col-hd col-current">Actuel</span>' +
                    '<span class="bilan-comp-col-hd">Pr√©c√©dent</span>' +
                    '</div>' +
                    '<div class="bilan-comp-row">' +
                    '<span class="bilan-comp-label">Crises</span>' +
                    '<span class="bilan-comp-current">' + stats.total + trendHtml(stats.total, stats.prevCount, function(d) { return d; }) + '</span>' +
                    '<span class="bilan-comp-prev">' + stats.prevCount + '</span>' +
                    '</div>' +
                    '<div class="bilan-comp-row">' +
                    '<span class="bilan-comp-label">Intensit√© moy.</span>' +
                    '<span class="bilan-comp-current">' + (stats.avgIntensity !== null ? stats.avgIntensity + '/10' : '‚Äî') + (stats.avgIntensity !== null ? trendHtml(stats.avgIntensity, stats.prevAvgIntensity, function(d) { return parseFloat(d.toFixed(1)) + '/10'; }) : '') + '</span>' +
                    '<span class="bilan-comp-prev">' + prevIntStr + '</span>' +
                    '</div>' +
                    '<div class="bilan-comp-row">' +
                    '<span class="bilan-comp-label">Dur√©e moy.</span>' +
                    '<span class="bilan-comp-current">' + (stats.avgDuration !== null ? formatMins(stats.avgDuration) : '‚Äî') + (stats.avgDuration !== null ? trendHtml(stats.avgDuration, stats.prevAvgDuration, function(d) { return formatMins(Math.round(d)); }) : '') + '</span>' +
                    '<span class="bilan-comp-prev">' + prevDurStr + '</span>' +
                    '</div>' +
                    (minmaxHtml ? '<div class="bilan-minmax">' + minmaxHtml + '</div>' : '');
            } else {
                var intensityHtml = stats.avgIntensity !== null ? stats.avgIntensity + '/10' : '‚Äî';
                var intensitySub = (stats.minIntensity !== null && stats.maxIntensity !== null && stats.minIntensity !== stats.maxIntensity)
                    ? '<span class="stat-sub">min ' + stats.minIntensity + '/10 ¬∑ max ' + stats.maxIntensity + '/10</span>'
                    : '';
                var durationHtml = stats.avgDuration !== null ? formatMins(stats.avgDuration) : '‚Äî';
                var durationSub = (stats.minDuration !== null && stats.maxDuration !== null && stats.minDuration !== stats.maxDuration)
                    ? '<span class="stat-sub">min ' + formatMins(stats.minDuration) + ' ¬∑ max ' + formatMins(stats.maxDuration) + '</span>'
                    : '';
                bilanHtml =
                    '<div class="stat-row"><span class="stat-label">Crises</span><span class="stat-value large">' + stats.total + '</span></div>' +
                    '<div class="stat-row"><span class="stat-label">Intensit√© moyenne</span><span class="stat-value">' + intensityHtml + intensitySub + '</span></div>' +
                    '<div class="stat-row"><span class="stat-label">Dur√©e moyenne</span><span class="stat-value">' + durationHtml + durationSub + '</span></div>';
            }

            /* Moments */
            var maxMoment = 0;
            for (var mi = 0; mi < stats.hourSlots.length; mi++) {
                if (stats.hourSlots[mi].count > maxMoment) maxMoment = stats.hourSlots[mi].count;
            }
            var momentHtml = '';
            for (var mo = 0; mo < stats.hourSlots.length; mo++) {
                var slot = stats.hourSlots[mo];
                var isTop = slot.count === maxMoment && slot.count > 0;
                momentHtml += '<div class="moment-cell' + (isTop ? ' highlight' : '') + '">' +
                    '<div class="moment-name">' + slot.name + '</div>' +
                    '<div class="moment-range">' + slot.range + '</div>' +
                    '<div class="moment-count">' + slot.count + '</div>' +
                    '</div>';
            }

            /* Contextes */
            var topContextes = stats.profiles.slice(0, 5);
            var maxP = topContextes.length ? topContextes[0].count : 1;
            var contextesHtml = topContextes.length
                ? rankItems(topContextes, maxP)
                : '<div style="padding:14px 16px;font-size:14px;color:var(--dark);opacity:0.45;font-style:italic">Aucun contexte enregistr√©</div>';

            /* Types de crise */
            var topTypes = stats.types.slice(0, 5);
            var maxTy = topTypes.length ? topTypes[0].count : 1;
            var typesHtml = topTypes.length
                ? rankItems(topTypes, maxTy, TYPE_DEFS)
                : '<div style="padding:14px 16px;font-size:14px;color:var(--dark);opacity:0.45;font-style:italic">Aucun type enregistr√©</div>';

            /* D√©clencheurs */
            var topTriggers = stats.triggers.slice(0, 5);
            var maxT = topTriggers.length ? topTriggers[0].count : 1;
            var triggersHtml = topTriggers.length
                ? rankItems(topTriggers, maxT, TRIGGER_DEFS)
                : '<div style="padding:14px 16px;font-size:14px;color:var(--dark);opacity:0.45;font-style:italic">Aucun d√©clencheur enregistr√©</div>';

            /* Besoins */
            var topBesoins = stats.besoins.slice(0, 5);
            var maxB = topBesoins.length ? topBesoins[0].count : 1;
            var besoinsHtml = topBesoins.length
                ? rankItems(topBesoins, maxB)
                : '<div style="padding:14px 16px;font-size:14px;color:var(--dark);opacity:0.45;font-style:italic">Aucun besoin enregistr√©</div>';

            /* √âtats */
            var topEtats = stats.etats.slice(0, 5);
            var maxE = topEtats.length ? topEtats[0].count : 1;
            var etatsHtml = topEtats.length
                ? rankItems(topEtats, maxE)
                : '<div style="padding:14px 16px;font-size:14px;color:var(--dark);opacity:0.45;font-style:italic">Aucun √©tat enregistr√©</div>';

            /* Capacit√©s */
            var topImposs = stats.capacitesImposs.slice(0, 5);
            var topDiff = stats.capacitesDiff.slice(0, 5);
            var capHtml = '';
            if (topImposs.length === 0 && topDiff.length === 0) {
                capHtml = '<div style="padding:14px 16px;font-size:14px;color:var(--dark);opacity:0.45;font-style:italic">Aucune capacit√© enregistr√©e</div>';
            } else {
                if (topImposs.length) {
                    capHtml += '<div class="cap-category">Impossible</div>' + rankItems(topImposs, topImposs[0].count);
                }
                if (topDiff.length) {
                    capHtml += '<div class="cap-category' + (topImposs.length ? ' cap-sep' : '') + '">Souvent difficile</div>' + rankItems(topDiff, topDiff[0].count);
                }
            }

            main.innerHTML =
                lastRow +
                '<div class="section-tag">Bilan</div>' +
                '<div class="stat-card">' + bilanHtml + '</div>' +
                '<div class="section-tag">Moment de la journ√©e</div>' +
                '<div class="moment-grid">' + momentHtml + '</div>' +
                '<div class="section-tag">Contextes</div>' +
                '<div class="stat-card">' + contextesHtml + '</div>' +
                '<div class="section-tag">Types de crise</div>' +
                '<div class="stat-card">' + typesHtml + '</div>' +
                '<div class="section-tag">D√©clencheurs</div>' +
                '<div class="stat-card">' + triggersHtml + '</div>' +
                '<div class="section-tag">Besoins</div>' +
                '<div class="stat-card">' + besoinsHtml + '</div>' +
                '<div class="section-tag">√âtats</div>' +
                '<div class="stat-card">' + etatsHtml + '</div>' +
                '<div class="section-tag">Capacit√©s</div>' +
                '<div class="stat-card">' + capHtml + '</div>' +
                '<div class="cap-note">Seules les capacit√©s souvent impossibles ou difficiles sont reprises ici. Ce qui reste possible n\'est pas list√©.</div>' +
                '<div class="export-actions">' +
                '<button class="export-btn" onclick="exportStats()">üìã Copier le r√©sum√©</button>' +
                '<div class="export-row">' +
                '<button class="export-btn" onclick="shareStats()">‚ÜóÔ∏è Partager</button>' +
                '<button class="export-btn" onclick="exportPDF()">üìÑ Exporter en PDF</button>' +
                '</div>' +
                '</div>';
        }

        /* ---------- EXPORT ---------- */

        function getPeriodLabel() {
            return currentDays === 7 ? '7 derniers jours'
                : currentDays === 30 ? '30 derniers jours'
                : currentDays === 365 ? 'derni√®re ann√©e'
                : 'du ' + customFrom + ' au ' + customTo;
        }

        function buildSummaryText(stats) {
            var periodLabel = getPeriodLabel();
            var text = '== Statistiques Nora ‚Äî ' + periodLabel + ' ==\n\n';
            text += 'Crises : ' + stats.total + '\n';
            if (stats.avgIntensity !== null) text += 'Intensit√© moyenne : ' + stats.avgIntensity + '/10\n';
            if (stats.avgDuration !== null) {
                text += 'Dur√©e moyenne : ' + formatMins(stats.avgDuration);
                if (stats.minDuration !== null && stats.maxDuration !== null) text += ' (min ' + formatMins(stats.minDuration) + ' / max ' + formatMins(stats.maxDuration) + ')';
                text += '\n';
            }
            if (stats.profiles.length) text += 'Contexte principal : ' + stats.profiles[0].name + '\n';
            if (stats.types.length) text += 'Type le plus fr√©quent : ' + stats.types[0].name + '\n';
            var last = sinceLastCrisis();
            if (last) text += 'Derni√®re crise : ' + last + '\n';
            if (stats.triggers.length) {
                text += '\nD√©clencheurs :\n';
                var top5t = stats.triggers.slice(0, 5);
                for (var ti = 0; ti < top5t.length; ti++) text += '  ' + (ti + 1) + '. ' + top5t[ti].name + ' (' + top5t[ti].count + ' fois)\n';
            }
            if (stats.besoins.length) {
                text += '\nBesoins :\n';
                var top5b = stats.besoins.slice(0, 5);
                for (var bi = 0; bi < top5b.length; bi++) text += '  ' + (bi + 1) + '. ' + top5b[bi].name + ' (' + top5b[bi].count + ' fois)\n';
            }
            if (stats.etats.length) {
                text += '\n√âtats :\n';
                var top5e = stats.etats.slice(0, 5);
                for (var ei = 0; ei < top5e.length; ei++) text += '  ' + (ei + 1) + '. ' + top5e[ei].name + ' (' + top5e[ei].count + ' fois)\n';
            }
            if (stats.capacitesImposs.length) {
                text += '\nImpossible :\n';
                var top5i = stats.capacitesImposs.slice(0, 5);
                for (var ii = 0; ii < top5i.length; ii++) text += '  ' + (ii + 1) + '. ' + top5i[ii].name + ' (' + top5i[ii].count + ' fois)\n';
            }
            if (stats.capacitesDiff.length) {
                text += '\nSouvent difficile :\n';
                var top5d = stats.capacitesDiff.slice(0, 5);
                for (var di2 = 0; di2 < top5d.length; di2++) text += '  ' + (di2 + 1) + '. ' + top5d[di2].name + ' (' + top5d[di2].count + ' fois)\n';
            }
            text += '\nExport du ' + new Date().toLocaleDateString('fr-FR') + ' ‚Äî Nora.';
            return text;
        }

        function exportStats() {
            var stats = computeStats(currentDays, customFrom, customTo);
            if (!stats) { alert('Aucune donn√©e √† exporter sur cette p√©riode.'); return; }
            var text = buildSummaryText(stats);
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(function() { alert('R√©sum√© copi√© !'); })
                    .catch(function() { downloadText(text); });
            } else { downloadText(text); }
        }

        function shareStats() {
            var stats = computeStats(currentDays, customFrom, customTo);
            if (!stats) { alert('Aucune donn√©e √† partager sur cette p√©riode.'); return; }
            var text = buildSummaryText(stats);
            if (navigator.share) {
                navigator.share({ title: 'Statistiques Nora ‚Äî ' + getPeriodLabel(), text: text })
                    .catch(function() {});
            } else if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() { alert('R√©sum√© copi√© dans le presse-papier.'); });
            } else { downloadText(text); }
        }

        function exportPDF() {
            var stats = computeStats(currentDays, customFrom, customTo);
            if (!stats) { alert('Aucune donn√©e √† exporter sur cette p√©riode.'); return; }
            var prenom = localStorage.getItem('userPrenom') || '';
            var nom = localStorage.getItem('userNom') || '';
            var nomComplet = [prenom, nom].filter(Boolean).join(' ');
            var titre = 'Statistiques Nora' + (nomComplet ? ' ‚Äî ' + nomComplet : '');
            titre += ' ‚Äî ' + getPeriodLabel() + ' ‚Äî ' + new Date().toLocaleDateString('fr-FR');
            document.getElementById('printHeader').textContent = titre;
            window.print();
        }

        function downloadText(text) {
            var blob = new Blob([text], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'stats-nora-' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        /* ---------- P√âRIODE ---------- */

        function selectPeriod(days) {
            currentDays = days;
            var btns = document.querySelectorAll('.period-btn');
            for (var i = 0; i < btns.length; i++) {
                btns[i].classList.toggle('active', parseInt(btns[i].getAttribute('data-days'), 10) === days);
            }
            var panel = document.getElementById('dateRangePanel');
            if (days === 0) panel.classList.add('visible');
            else { panel.classList.remove('visible'); renderCurrent(); }
        }

        function applyCustomRange() {
            var from = document.getElementById('dateFrom').value;
            var to = document.getElementById('dateTo').value;
            if (!from || !to) { alert('Choisis une date de d√©but et une date de fin.'); return; }
            if (from > to) { alert('La date de d√©but doit √™tre avant la date de fin.'); return; }
            customFrom = from; customTo = to;
            renderCurrent();
        }

        /* ---------- TOOLTIP D√âFINITION ---------- */

        var _defTimer = null;

        function showDefTooltip(event, name, itemEl) {
            var def = TYPE_DEFS[name] || TRIGGER_DEFS[name];
            if (!def) return;
            var tooltip = document.getElementById('defTooltip');
            tooltip.innerHTML = '<strong>' + name + '</strong><br>' + def;
            tooltip.style.display = 'block';
            var rect = itemEl.getBoundingClientRect();
            var left = rect.left + 8;
            var top = rect.bottom + 6;
            if (left + 244 > window.innerWidth - 6) left = window.innerWidth - 250;
            if (left < 6) left = 6;
            if (top + tooltip.offsetHeight > window.innerHeight - 6) top = rect.top - tooltip.offsetHeight - 6;
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            clearTimeout(_defTimer);
            _defTimer = setTimeout(function() { tooltip.style.display = 'none'; }, 5000);
        }

        document.addEventListener('click', function(e) {
            var item = e.target.closest('.rank-item.has-def');
            if (item) {
                showDefTooltip(e, item.getAttribute('data-def'), item);
            } else if (!e.target.closest('#defTooltip')) {
                document.getElementById('defTooltip').style.display = 'none';
            }
        });

        function renderCurrent() {
            try { render(currentDays, customFrom, customTo); }
            catch (err) {
                document.getElementById('mainContent').innerHTML =
                    '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Erreur de chargement.<br>R√©essaie.</div></div>';
            }
        }

        renderCurrent();
    </script>
    <script src="nora-scroll.js"></script>
</body>
</html>
