<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="assets/images/favicone.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
    <link rel="stylesheet" href="nora-common.css">
    <title>Nora ‚Äì Statistiques</title>
    <style>
        body { padding-bottom: 32px; }

        /* ---------- LABEL DE SECTION ---------- */

        .section-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--light);
            opacity: 0.45;
            padding: 16px 16px 4px;
        }

        /* ---------- P√âRIODE ---------- */

        .period-bar {
            display: flex;
            gap: 8px;
            padding: 0 16px;
        }

        .period-btn {
            flex: 1;
            background: rgba(245, 228, 204, 0.1);
            border: 2px solid rgba(245, 228, 204, 0.15);
            color: var(--light);
            font-size: 15px;
            font-weight: 600;
            padding: 10px 4px;
            border-radius: 10px;
            cursor: pointer;
        }

        .period-btn.active {
            background: var(--light);
            border-color: var(--light);
            color: var(--dark);
        }

        .period-btn:active { transform: scale(0.97); }

        /* ---------- PLAGE PERSONNALIS√âE ---------- */

        .date-range-panel {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 12px 16px;
        }

        .date-range-panel.visible { display: flex; }

        .date-range-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-range-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--light);
            white-space: nowrap;
            width: 44px;
            flex-shrink: 0;
        }

        .date-range-input {
            flex: 1;
            background: rgba(245, 228, 204, 0.12);
            border: 2px solid rgba(245, 228, 204, 0.2);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 15px;
            font-family: inherit;
            color: var(--light);
            color-scheme: dark;
        }

        .date-range-input:focus {
            outline: none;
            border-color: var(--light);
        }

        .date-range-apply {
            background: var(--accent);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
        }

        .date-range-apply:active { transform: scale(0.98); }

        /* ---------- CONTENU ---------- */

        .main-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* ---------- R√âSUM√â NARRATIF ---------- */

        .narrative-card {
            background: var(--light);
            border-radius: 14px;
            padding: 16px;
            font-size: 15px;
            line-height: 1.65;
            color: var(--dark);
        }

        .narrative-card strong { font-weight: 700; }

        /* ---------- CARTES M√âTRIQUES ---------- */

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .metric-card {
            background: var(--light);
            border-radius: 14px;
            padding: 13px 12px 11px;
        }

        .metric-card.wide { grid-column: 1 / -1; }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .metric-icon { font-size: 15px; line-height: 1; }

        .metric-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.55;
        }

        .metric-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--dark);
            line-height: 1.1;
        }

        .metric-value.small { font-size: 18px; }

        .metric-sub {
            font-size: 11px;
            color: var(--dark);
            opacity: 0.45;
            margin-top: 3px;
        }

        .metric-delta {
            font-size: 11px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.45;
            margin-top: 2px;
        }

        /* ---------- SECTIONS ---------- */

        .section {
            background: var(--light);
            border-radius: 14px;
            padding: 14px 14px 8px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 12px;
        }

        .subsection-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--dark);
            opacity: 0.5;
            margin-bottom: 8px;
            margin-top: 12px;
        }

        /* ---------- TOGGLE RAPIDE / D√âTAIL ---------- */

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .view-toggle {
            display: flex;
            background: rgba(46, 58, 89, 0.08);
            border-radius: 8px;
            padding: 3px;
            gap: 2px;
        }

        .view-toggle-btn {
            background: none;
            border: none;
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.5;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .view-toggle-btn.active {
            background: var(--dark);
            color: var(--light);
            opacity: 1;
        }

        /* ---------- VUE RAPIDE (pills) ---------- */

        .pills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 7px;
            padding-bottom: 8px;
        }

        .pill {
            background: rgba(46, 58, 89, 0.08);
            color: var(--dark);
            font-size: 13px;
            font-weight: 600;
            padding: 6px 11px;
            border-radius: 20px;
        }

        /* ---------- VUE D√âTAIL (barres) ---------- */

        .rank-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .rank-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rank-number {
            width: 22px;
            height: 22px;
            background: var(--dark);
            color: var(--light);
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .rank-number.secondary {
            background: rgba(46, 58, 89, 0.3);
            font-size: 11px;
        }

        .rank-bar-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .rank-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
        }

        .rank-bar-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rank-bar-bg {
            flex: 1;
            height: 6px;
            background: rgba(46, 58, 89, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .rank-bar-fill {
            height: 100%;
            background: var(--dark);
            border-radius: 3px;
        }

        .rank-count {
            font-size: 12px;
            color: var(--dark);
            opacity: 0.55;
            white-space: nowrap;
            font-weight: 600;
        }

        .intensity-tag {
            font-size: 11px;
            color: var(--dark);
            opacity: 0.45;
            white-space: nowrap;
        }

        .intensity-legend {
            font-size: 11px;
            color: var(--dark);
            opacity: 0.4;
            font-style: italic;
            padding: 2px 0 6px;
        }

        /* ---------- ACCORD√âON ---------- */

        .accordion-toggle {
            width: 100%;
            background: none;
            border: none;
            border-top: 1px solid rgba(46, 58, 89, 0.1);
            padding: 9px 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion-toggle:active { opacity: 1; }

        .accordion-body { display: none; padding-bottom: 6px; }
        .accordion-body.open { display: block; }

        .all-rank-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-top: 8px;
        }

        /* ---------- JOURS / HEURES ---------- */

        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 12px;
        }

        .day-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 2px;
            border-radius: 8px;
            background: rgba(46, 58, 89, 0.06);
        }

        .day-cell.top-day { background: var(--dark); }

        .day-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.55;
        }

        .day-count {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
        }

        .day-cell.top-day .day-name,
        .day-cell.top-day .day-count {
            color: var(--light);
            opacity: 1;
        }

        .hour-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .hour-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 4px;
            border-radius: 8px;
            background: rgba(46, 58, 89, 0.06);
        }

        .hour-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.7;
        }

        .hour-range {
            font-size: 10px;
            color: var(--dark);
            opacity: 0.4;
        }

        .hour-count {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        /* ---------- EXPORT ---------- */

        .export-stats-btn {
            background: rgba(245, 228, 204, 0.08);
            border: 2px solid rgba(245, 228, 204, 0.16);
            color: var(--light);
            font-size: 15px;
            font-weight: 600;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-stats-btn:active {
            background: rgba(245, 228, 204, 0.14);
            transform: scale(0.98);
        }

        /* ---------- √âTAT VIDE ---------- */

        .empty-state {
            text-align: center;
            padding: 50px 20px 20px;
            color: var(--light);
            opacity: 0.6;
        }

        .empty-icon { font-size: 52px; margin-bottom: 12px; }
        .empty-text { font-size: 16px; }

        .no-data {
            font-size: 13px;
            color: var(--dark);
            opacity: 0.4;
            font-style: italic;
            padding: 2px 0 8px;
        }

        .last-crisis-card {
            background: var(--light);
            border-radius: 14px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: var(--dark);
        }

        .last-crisis-value { font-weight: 700; }
    </style>
</head>
<body>
    <header class="header">
        <button class="back-button" onclick="window.location.href='journal.html'" aria-label="Retour au journal">‚¨ÖÔ∏è</button>
        <h1 class="page-title">Statistiques</h1>
    </header>

    <div class="section-label">P√©riode</div>
    <div class="period-bar">
        <button class="period-btn active" data-days="7" onclick="selectPeriod(7)">7 j</button>
        <button class="period-btn" data-days="30" onclick="selectPeriod(30)">30 j</button>
        <button class="period-btn" data-days="365" onclick="selectPeriod(365)">1 an</button>
        <button class="period-btn" data-days="0" onclick="selectPeriod(0)">Dates</button>
    </div>
    <div class="date-range-panel" id="dateRangePanel">
        <div class="date-range-row">
            <span class="date-range-label">D√©but</span>
            <input type="date" class="date-range-input" id="dateFrom">
        </div>
        <div class="date-range-row">
            <span class="date-range-label">Fin</span>
            <input type="date" class="date-range-input" id="dateTo">
        </div>
        <button class="date-range-apply" onclick="applyCustomRange()">Appliquer</button>
    </div>

    <main class="main-content" id="mainContent"></main>

    <script>
        var currentDays = 7;
        var customFrom = null;
        var customTo = null;
        var viewModes = { triggers: 'detail', besoins: 'detail' };

        /* ---------- DONN√âES ---------- */

        function getJournal() {
            try {
                return JSON.parse(localStorage.getItem('journalCrises') || '[]');
            } catch (e) {
                return [];
            }
        }

        function getProfileName(profileId) {
            var names = {
                commun: 'Profil commun',
                maison: 'Maison',
                exterieur: 'Ext√©rieur',
                travail: 'Travail',
                secours: 'Secours'
            };
            var icons = {
                commun: 'üåê', maison: 'üè†', exterieur: 'üåç', travail: 'üíº', secours: 'üöë'
            };
            return {
                name: names[profileId] || profileId || 'Inconnu',
                icon: icons[profileId] || 'üìç'
            };
        }

        /* ---------- DUR√âE ---------- */

        function parseDuration(str) {
            if (!str) return null;
            str = str.toLowerCase().trim();
            var mins = 0;
            var found = false;
            var hMatch = str.match(/(\d+)\s*h/);
            if (hMatch) { mins += parseInt(hMatch[1], 10) * 60; found = true; }
            var mMatch = str.match(/(\d+)\s*(min|mn|m\b)/);
            if (mMatch) { mins += parseInt(mMatch[1], 10); found = true; }
            if (!found) {
                var numMatch = str.match(/^(\d+)$/);
                if (numMatch) { mins = parseInt(numMatch[1], 10); found = true; }
            }
            return (found && mins > 0) ? mins : null;
        }

        function formatMins(m) {
            m = Math.round(m);
            if (m < 60) return m + ' min';
            var h = Math.floor(m / 60);
            var r = m % 60;
            return r > 0 ? h + 'h' + (r < 10 ? '0' : '') + r : h + 'h';
        }

        function formatDateFR(dateStr) {
            return new Date(dateStr).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
        }

        /* ---------- FR√âQUENCES ---------- */

        function countFreq(arr) {
            var freq = {};
            for (var i = 0; i < arr.length; i++) {
                var val = arr[i];
                if (val) freq[val] = (freq[val] || 0) + 1;
            }
            var result = [];
            for (var key in freq) {
                result.push({ name: key, count: freq[key] });
            }
            result.sort(function(a, b) { return b.count - a.count; });
            return result;
        }

        /* ---------- CALCUL STATS ---------- */

        function computeStats(days, from, to) {
            var journal = getJournal();
            var entries = [];
            var prevEntries = [];

            if (days === 0 && from && to) {
                var start = new Date(from); start.setHours(0, 0, 0, 0);
                var end = new Date(to); end.setHours(23, 59, 59, 999);
                var periodMs = end - start;
                for (var i = 0; i < journal.length; i++) {
                    var d = new Date(journal[i].horodatage);
                    if (d >= start && d <= end) entries.push(journal[i]);
                    else if (d >= new Date(start - periodMs) && d < start) prevEntries.push(journal[i]);
                }
            } else {
                var now = new Date();
                var cutoff = new Date(now); cutoff.setDate(now.getDate() - days); cutoff.setHours(0, 0, 0, 0);
                var prevCutoff = new Date(now); prevCutoff.setDate(now.getDate() - days * 2); prevCutoff.setHours(0, 0, 0, 0);
                for (var j = 0; j < journal.length; j++) {
                    var dj = new Date(journal[j].horodatage);
                    if (dj >= cutoff) entries.push(journal[j]);
                    else if (dj >= prevCutoff) prevEntries.push(journal[j]);
                }
            }

            if (!entries.length) return null;

            var intensities = [];
            var durations = [];
            var profileArr = [];
            var typeArr = [];
            var triggerFreq = {};
            var besoinArr = [];

            for (var k = 0; k < entries.length; k++) {
                var e = entries[k];
                var ints = parseFloat(e.intensite);
                if (!isNaN(ints)) intensities.push(ints);
                var dur = parseDuration(e.duree);
                if (dur !== null) durations.push(dur);
                profileArr.push(e.profil || 'commun');
                if (e.typeCrise) typeArr.push(e.typeCrise);
                var decl = e.declencheurs || [];
                for (var d2 = 0; d2 < decl.length; d2++) {
                    if (decl[d2]) triggerFreq[decl[d2]] = (triggerFreq[decl[d2]] || 0) + 1;
                }
                var bess = e.besoins || [];
                for (var b = 0; b < bess.length; b++) {
                    var bl = bess[b] && bess[b].label ? bess[b].label : bess[b];
                    if (bl) besoinArr.push(bl);
                }
            }

            var avgIntensity = null;
            if (intensities.length) {
                var sum = 0; for (var s = 0; s < intensities.length; s++) sum += intensities[s];
                avgIntensity = parseFloat((sum / intensities.length).toFixed(1));
            }

            var avgDuration = null, minDuration = null, maxDuration = null;
            if (durations.length) {
                var dsum = 0; for (var ds = 0; ds < durations.length; ds++) dsum += durations[ds];
                avgDuration = dsum / durations.length;
                minDuration = Math.min.apply(null, durations);
                maxDuration = Math.max.apply(null, durations);
            }

            var profileCounts = countFreq(profileArr);
            var topProfileData = profileCounts.length ? profileCounts[0] : null;
            var topProfile = null;
            if (topProfileData) {
                var pInfo = getProfileName(topProfileData.name);
                topProfile = { name: pInfo.name, icon: pInfo.icon, count: topProfileData.count };
            }

            var typeCounts = countFreq(typeArr);
            var topType = typeCounts.length ? typeCounts[0] : null;

            var triggerStats = [];
            for (var tkey in triggerFreq) {
                var tcnt = triggerFreq[tkey];
                var tInts = [];
                for (var te = 0; te < entries.length; te++) {
                    var td = entries[te].declencheurs || [];
                    var hasT = false;
                    for (var td2 = 0; td2 < td.length; td2++) { if (td[td2] === tkey) { hasT = true; break; } }
                    if (hasT) {
                        var ti = parseFloat(entries[te].intensite);
                        if (!isNaN(ti)) tInts.push(ti);
                    }
                }
                var avgInt = null;
                if (tInts.length >= 2) {
                    var tsum = 0; for (var ts2 = 0; ts2 < tInts.length; ts2++) tsum += tInts[ts2];
                    avgInt = parseFloat((tsum / tInts.length).toFixed(1));
                }
                triggerStats.push({ name: tkey, count: tcnt, avgIntensity: avgInt });
            }
            triggerStats.sort(function(a, b) { return b.count - a.count; });

            var besoinCounts = countFreq(besoinArr);

            var DAY_NAMES = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            var dayFreq = [0, 0, 0, 0, 0, 0, 0];
            for (var de = 0; de < entries.length; de++) {
                dayFreq[new Date(entries[de].horodatage).getDay()]++;
            }
            var dayOfWeek = [1, 2, 3, 4, 5, 6, 0].map(function(i) {
                return { name: DAY_NAMES[i], count: dayFreq[i] };
            });

            var hourSlots = [
                { name: 'Nuit', range: '0‚Äì6h', count: 0 },
                { name: 'Matin', range: '6‚Äì12h', count: 0 },
                { name: 'Apr√®s-m.', range: '12‚Äì18h', count: 0 },
                { name: 'Soir', range: '18‚Äì24h', count: 0 }
            ];
            for (var he = 0; he < entries.length; he++) {
                var h = new Date(entries[he].horodatage).getHours();
                if (h < 6) hourSlots[0].count++;
                else if (h < 12) hourSlots[1].count++;
                else if (h < 18) hourSlots[2].count++;
                else hourSlots[3].count++;
            }

            return {
                total: entries.length,
                prevCount: prevEntries.length,
                avgIntensity: avgIntensity,
                avgDuration: avgDuration,
                minDuration: minDuration,
                maxDuration: maxDuration,
                topProfile: topProfile,
                topType: topType,
                triggerStats: triggerStats,
                besoinCounts: besoinCounts,
                dayOfWeek: dayOfWeek,
                hourSlots: hourSlots
            };
        }

        /* ---------- DERNI√àRE CRISE ---------- */

        function sinceLastCrisis() {
            var journal = getJournal();
            if (!journal.length) return null;
            var latest = null;
            for (var i = 0; i < journal.length; i++) {
                var d = new Date(journal[i].horodatage);
                if (!latest || d > latest) latest = d;
            }
            var diff = Math.floor((Date.now() - latest) / 86400000);
            if (diff === 0) return "aujourd'hui";
            if (diff === 1) return 'hier';
            return 'il y a ' + diff + ' j';
        }

        /* ---------- NARRATIF ---------- */

        function buildNarrative(stats, days, from, to) {
            var periodLabel = days === 7 ? 'ces 7 derniers jours'
                : days === 30 ? 'ces 30 derniers jours'
                : days === 365 ? 'cette derni√®re ann√©e'
                : 'du ' + formatDateFR(from) + ' au ' + formatDateFR(to);

            var n = stats.total;
            var pl = n > 1;
            var parts = [];

            var s1 = 'Sur ' + periodLabel + ', tu as travers√© <strong>' + n + ' crise' + (pl ? 's' : '') + '</strong>';
            if (stats.avgIntensity !== null) s1 += ' avec une intensit√© moyenne de <strong>' + stats.avgIntensity + '/10</strong>';
            if (stats.avgDuration !== null) {
                s1 += ' et une dur√©e d\'environ <strong>' + formatMins(stats.avgDuration) + '</strong>';
                if (stats.minDuration !== null && stats.maxDuration !== null && stats.minDuration !== stats.maxDuration) {
                    s1 += ' (de ' + formatMins(stats.minDuration) + ' √† ' + formatMins(stats.maxDuration) + ')';
                }
            }
            parts.push(s1 + '.');

            var ctxParts = [];
            if (stats.topProfile) {
                var preps = { 'Maison': '√† la maison', 'Ext√©rieur': 'en ext√©rieur', 'Travail': 'au travail',
                    'Secours': 'en contexte secours', 'Profil commun': 'en contexte commun' };
                var prep = preps[stats.topProfile.name] || 'en contexte ' + stats.topProfile.name;
                ctxParts.push('surtout <strong>' + prep + '</strong>');
            }
            if (stats.topType) {
                var adj = { 'Anticipatoire': 'anticipatoires', 'R√©actionnelle': 'r√©actionnelles', 'Mixte': 'mixtes' };
                var typeAdj = adj[stats.topType.name] || stats.topType.name.toLowerCase();
                ctxParts.push('majoritairement de type <strong>' + typeAdj + '</strong>');
            }
            if (ctxParts.length) {
                parts.push((pl ? 'Elles se sont pass√©es ' : 'Elle s\'est pass√©e ') + ctxParts.join(', ') + '.');
            }

            var topDay = null;
            for (var di = 0; di < stats.dayOfWeek.length; di++) {
                if (!topDay || stats.dayOfWeek[di].count > topDay.count) topDay = stats.dayOfWeek[di];
            }
            var topHour = null;
            for (var hi = 0; hi < stats.hourSlots.length; hi++) {
                if (!topHour || stats.hourSlots[hi].count > topHour.count) topHour = stats.hourSlots[hi];
            }
            if (topDay && topDay.count > 0) {
                var hourLabels = { 'Nuit': 'la nuit', 'Matin': 'le matin', 'Apr√®s-m.': "l'apr√®s-midi", 'Soir': 'le soir' };
                var s3 = 'Le jour o√π tu en as le plus : <strong>' + topDay.name + '</strong>';
                if (topHour && topHour.count > 0) s3 += ', souvent <strong>' + (hourLabels[topHour.name] || topHour.name) + '</strong>';
                parts.push(s3 + '.');
            }

            if (stats.triggerStats.length > 0) {
                var top3t = stats.triggerStats.slice(0, 3);
                var tnames = top3t.map(function(t) { return '<strong>' + t.name + '</strong>'; }).join(', ');
                var tnb = top3t.length;
                parts.push((pl ? 'Tes' : 'Ton') + ' principal' + (tnb > 1 ? 'aux' : '') + ' d√©clencheur' + (tnb > 1 ? 's' : '') + ' : ' + tnames + '.');
                var withInt = stats.triggerStats.filter(function(t) { return t.avgIntensity !== null; });
                if (withInt.length > 0) {
                    var wt = withInt[0];
                    parts.push((pl ? 'Les crises les plus intenses sont associ√©es' : 'La crise la plus intense est associ√©e') + ' √† <strong>' + wt.name + '</strong> (' + wt.avgIntensity + '/10 en moyenne).');
                }
            }

            if (stats.besoinCounts.length > 0) {
                var top3b = stats.besoinCounts.slice(0, 3);
                var bnames = top3b.map(function(b) { return '<strong>' + b.name + '</strong>'; }).join(', ');
                var bnb = top3b.length;
                parts.push((pl ? 'Tes' : 'Ton') + ' principal' + (bnb > 1 ? 'aux' : '') + ' besoin' + (bnb > 1 ? 's' : '') + ' : ' + bnames + '.');
            }

            return parts.join(' ');
        }

        /* ---------- RENDU : LIGNE DE CLASSEMENT ---------- */

        function rankRow(item, num, maxCount) {
            var pct = Math.round((item.count / maxCount) * 100);
            var numEl = (num > 0)
                ? '<div class="rank-number">' + num + '</div>'
                : '<div class="rank-number secondary">¬∑</div>';
            var intTag = (item.avgIntensity != null)
                ? '<span class="intensity-tag">¬∑ ' + item.avgIntensity + '/10</span>'
                : '';
            return '<div class="rank-item">' + numEl +
                '<div class="rank-bar-wrap">' +
                '<div class="rank-name">' + item.name + '</div>' +
                '<div class="rank-bar-row">' +
                '<div class="rank-bar-bg"><div class="rank-bar-fill" style="width:' + pct + '%"></div></div>' +
                '<div class="rank-count">' + item.count + '√ó</div>' +
                intTag +
                '</div></div></div>';
        }

        /* ---------- RENDU : SECTION AVEC TOGGLE ---------- */

        function renderToggleSection(id, title, items, viewMode) {
            var isDetail = viewMode === 'detail';
            var maxCount = items.length ? items[0].count : 1;
            var inner = '';

            if (!items.length) {
                inner = '<div class="no-data">Aucune donn√©e</div>';
            } else if (!isDetail) {
                inner = '<div class="pills-list">';
                for (var i = 0; i < items.length; i++) {
                    inner += '<span class="pill">' + items[i].name + '</span>';
                }
                inner += '</div>';
            } else {
                var top = items.slice(0, 3);
                var rest = items.slice(3);
                var hasIntensity = false;
                for (var hi = 0; hi < items.length; hi++) {
                    if (items[hi].avgIntensity != null) { hasIntensity = true; break; }
                }

                inner = '<div class="rank-list">';
                for (var ti = 0; ti < top.length; ti++) {
                    inner += rankRow(top[ti], ti + 1, maxCount);
                }
                inner += '</div>';

                if (rest.length > 0) {
                    var accId = 'acc_' + id;
                    inner += '<button class="accordion-toggle" onclick="toggleAccordion(\'' + accId + '\', this)">';
                    inner += '<span>Voir les ' + rest.length + ' autre' + (rest.length > 1 ? 's' : '') + '</span>';
                    inner += '<span id="arr_' + accId + '">‚ñæ</span></button>';
                    inner += '<div class="accordion-body" id="' + accId + '"><div class="all-rank-list">';
                    for (var ri = 0; ri < rest.length; ri++) {
                        inner += rankRow(rest[ri], 0, maxCount);
                    }
                    inner += '</div></div>';
                }

                if (hasIntensity) {
                    inner += '<div class="intensity-legend">Le chiffre apr√®s ¬∑ = intensit√© moy. lors des crises avec ce d√©clencheur</div>';
                }
            }

            return '<div class="section">' +
                '<div class="section-header">' +
                '<div class="section-title">' + title + '</div>' +
                '<div class="view-toggle">' +
                '<button class="view-toggle-btn ' + (!isDetail ? 'active' : '') + '" onclick="setView(\'' + id + '\', \'rapide\')">Rapide</button>' +
                '<button class="view-toggle-btn ' + (isDetail ? 'active' : '') + '" onclick="setView(\'' + id + '\', \'detail\')">D√©tail</button>' +
                '</div></div>' +
                inner +
                '</div>';
        }

        function setView(id, mode) {
            viewModes[id] = mode;
            renderCurrent();
        }

        function toggleAccordion(id, btn) {
            var body = document.getElementById(id);
            var arrow = document.getElementById('arr_' + id);
            var isOpen = body.classList.toggle('open');
            if (arrow) arrow.textContent = isOpen ? '‚ñ¥' : '‚ñæ';
        }

        /* ---------- RENDU PRINCIPAL ---------- */

        function render(days, from, to) {
            var stats = computeStats(days, from, to);
            var last = sinceLastCrisis();
            var main = document.getElementById('mainContent');

            var lastCard = last
                ? '<div class="last-crisis-card"><span style="font-size:18px">‚åõ</span>Derni√®re crise : <span class="last-crisis-value">' + last + '</span></div>'
                : '';

            if (!stats) {
                main.innerHTML = lastCard +
                    '<div class="empty-state"><div class="empty-icon">üìä</div>' +
                    '<div class="empty-text">Aucune crise enregistr√©e<br>sur cette p√©riode</div></div>';
                return;
            }

            var intensityStr = stats.avgIntensity !== null
                ? stats.avgIntensity + '<span style="font-size:15px;font-weight:500;opacity:0.6">/10</span>'
                : '‚Äî';
            var durationStr = stats.avgDuration !== null ? '~' + formatMins(stats.avgDuration) : '‚Äî';
            var durationSub = (stats.minDuration !== null && stats.maxDuration !== null && stats.minDuration !== stats.maxDuration)
                ? 'min ' + formatMins(stats.minDuration) + ' ¬∑ max ' + formatMins(stats.maxDuration)
                : '';
            var profileStr = stats.topProfile ? stats.topProfile.icon + ' ' + stats.topProfile.name : '‚Äî';
            var typeStr = stats.topType ? stats.topType.name : '‚Äî';
            var typeSub = stats.topType ? stats.topType.count + ' fois' : '';

            var deltaStr = '';
            if (stats.prevCount > 0) {
                var d = stats.total - stats.prevCount;
                deltaStr = '<div class="metric-delta">' + (d > 0 ? '+' : '') + d + ' vs p√©riode pr√©c.</div>';
            }

            var maxDayCount = 0;
            for (var di = 0; di < stats.dayOfWeek.length; di++) {
                if (stats.dayOfWeek[di].count > maxDayCount) maxDayCount = stats.dayOfWeek[di].count;
            }
            if (maxDayCount === 0) maxDayCount = 1;

            var dayGridHtml = '';
            for (var dg = 0; dg < stats.dayOfWeek.length; dg++) {
                var day = stats.dayOfWeek[dg];
                var isTop = day.count === maxDayCount && day.count > 0;
                dayGridHtml += '<div class="day-cell' + (isTop ? ' top-day' : '') + '">' +
                    '<div class="day-name">' + day.name + '</div>' +
                    '<div class="day-count">' + day.count + '</div></div>';
            }

            var hourGridHtml = '';
            for (var hg = 0; hg < stats.hourSlots.length; hg++) {
                var slot = stats.hourSlots[hg];
                hourGridHtml += '<div class="hour-cell">' +
                    '<div class="hour-name">' + slot.name + '</div>' +
                    '<div class="hour-range">' + slot.range + '</div>' +
                    '<div class="hour-count">' + slot.count + '</div></div>';
            }

            main.innerHTML = lastCard +
                '<div class="narrative-card">' + buildNarrative(stats, days, from, to) + '</div>' +
                '<div class="metrics-grid">' +
                '<div class="metric-card">' +
                '<div class="metric-header"><span class="metric-icon">üî¥</span><span class="metric-label">Nombre de crises</span></div>' +
                '<div class="metric-value">' + stats.total + '</div>' + deltaStr + '</div>' +
                '<div class="metric-card">' +
                '<div class="metric-header"><span class="metric-icon">‚ö°</span><span class="metric-label">Intensit√© moyenne</span></div>' +
                '<div class="metric-value">' + intensityStr + '</div></div>' +
                '<div class="metric-card">' +
                '<div class="metric-header"><span class="metric-icon">‚è±</span><span class="metric-label">Dur√©e moyenne</span></div>' +
                '<div class="metric-value small">' + durationStr + '</div>' +
                (durationSub ? '<div class="metric-sub">' + durationSub + '</div>' : '') + '</div>' +
                '<div class="metric-card">' +
                '<div class="metric-header"><span class="metric-icon">üìç</span><span class="metric-label">Contexte principal</span></div>' +
                '<div class="metric-value small">' + profileStr + '</div></div>' +
                '<div class="metric-card wide">' +
                '<div class="metric-header"><span class="metric-icon">üß†</span><span class="metric-label">Type de crise le plus fr√©quent</span></div>' +
                '<div class="metric-value small">' + typeStr + '</div>' +
                (typeSub ? '<div class="metric-sub">' + typeSub + '</div>' : '') + '</div></div>' +
                '<div class="section">' +
                '<div class="section-title">üïê Quand surviennent tes crises ?</div>' +
                '<div class="subsection-title">Jour de la semaine</div>' +
                '<div class="day-grid">' + dayGridHtml + '</div>' +
                '<div class="subsection-title">Moment de la journ√©e</div>' +
                '<div class="hour-grid">' + hourGridHtml + '</div></div>' +
                renderToggleSection('triggers', 'üéØ D√©clencheurs', stats.triggerStats, viewModes.triggers) +
                renderToggleSection('besoins', 'ü§≤ Besoins exprim√©s', stats.besoinCounts, viewModes.besoins) +
                '<button class="export-stats-btn" onclick="exportStats()">üìã Copier le r√©sum√©</button>';
        }

        /* ---------- EXPORT ---------- */

        function exportStats() {
            var stats = computeStats(currentDays, customFrom, customTo);
            if (!stats) { alert('Aucune donn√©e √† exporter sur cette p√©riode.'); return; }

            var periodLabel = currentDays === 7 ? '7 derniers jours'
                : currentDays === 30 ? '30 derniers jours'
                : currentDays === 365 ? 'derni√®re ann√©e'
                : 'du ' + customFrom + ' au ' + customTo;

            var text = '== Statistiques Nora ‚Äî ' + periodLabel + ' ==\n\n';
            text += 'Crises : ' + stats.total;
            if (stats.prevCount > 0) {
                var d = stats.total - stats.prevCount;
                text += ' (' + (d >= 0 ? '+' : '') + d + ' vs p√©riode pr√©c.)';
            }
            text += '\n';
            if (stats.avgIntensity !== null) text += 'Intensit√© moyenne : ' + stats.avgIntensity + '/10\n';
            if (stats.avgDuration !== null) {
                text += 'Dur√©e moyenne : ~' + formatMins(stats.avgDuration);
                if (stats.minDuration !== null && stats.maxDuration !== null) {
                    text += ' (min ' + formatMins(stats.minDuration) + ' / max ' + formatMins(stats.maxDuration) + ')';
                }
                text += '\n';
            }
            if (stats.topProfile) text += 'Contexte principal : ' + stats.topProfile.name + '\n';
            if (stats.topType) text += 'Type le plus fr√©quent : ' + stats.topType.name + ' (' + stats.topType.count + ' fois)\n';
            var last = sinceLastCrisis();
            if (last) text += 'Derni√®re crise : ' + last + '\n';
            if (stats.triggerStats.length) {
                text += '\nD√©clencheurs :\n';
                var top5t = stats.triggerStats.slice(0, 5);
                for (var ti = 0; ti < top5t.length; ti++) {
                    var t = top5t[ti];
                    text += '  ' + (ti + 1) + '. ' + t.name + ' (' + t.count + 'x)';
                    if (t.avgIntensity !== null) text += ' ‚Äî ' + t.avgIntensity + '/10';
                    text += '\n';
                }
            }
            if (stats.besoinCounts.length) {
                text += '\nBesoins :\n';
                var top5b = stats.besoinCounts.slice(0, 5);
                for (var bi = 0; bi < top5b.length; bi++) {
                    text += '  ' + (bi + 1) + '. ' + top5b[bi].name + ' (' + top5b[bi].count + 'x)\n';
                }
            }
            text += '\nExport g√©n√©r√© le ' + new Date().toLocaleDateString('fr-FR') + ' depuis Nora.';

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(function() { alert('R√©sum√© copi√© !'); })
                    .catch(function() { downloadText(text); });
            } else {
                downloadText(text);
            }
        }

        function downloadText(text) {
            var blob = new Blob([text], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'stats-nora-' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        /* ---------- P√âRIODE ---------- */

        function selectPeriod(days) {
            currentDays = days;
            var btns = document.querySelectorAll('.period-btn');
            for (var i = 0; i < btns.length; i++) {
                btns[i].classList.toggle('active', parseInt(btns[i].getAttribute('data-days'), 10) === days);
            }
            var panel = document.getElementById('dateRangePanel');
            if (days === 0) panel.classList.add('visible');
            else { panel.classList.remove('visible'); renderCurrent(); }
        }

        function applyCustomRange() {
            var from = document.getElementById('dateFrom').value;
            var to = document.getElementById('dateTo').value;
            if (!from || !to) { alert('Choisis une date de d√©but et une date de fin.'); return; }
            if (from > to) { alert('La date de d√©but doit √™tre avant la date de fin.'); return; }
            customFrom = from;
            customTo = to;
            renderCurrent();
        }

        function renderCurrent() {
            try {
                render(currentDays, customFrom, customTo);
            } catch (err) {
                document.getElementById('mainContent').innerHTML =
                    '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div>' +
                    '<div class="empty-text">Erreur de chargement.<br>R√©essaie.</div></div>';
            }
        }

        renderCurrent();
    </script>
    <script src="nora-scroll.js"></script>
</body>
</html>
