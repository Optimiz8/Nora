<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="assets/images/favicone.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
    <link rel="stylesheet" href="nora-common.css">
    <title>Nora – Statistiques</title>
    <style>
        body { padding-bottom: 40px; }

        /* ---------- PÉRIODE ---------- */

        .period-bar {
            display: flex;
            gap: 8px;
            padding: 0 16px;
        }

        .period-btn {
            flex: 1;
            background: rgba(245, 228, 204, 0.1);
            border: 2px solid rgba(245, 228, 204, 0.15);
            color: var(--light);
            font-size: 14px;
            font-weight: 600;
            padding: 10px 4px;
            border-radius: 10px;
            cursor: pointer;
        }

        .period-btn.active {
            background: var(--light);
            border-color: var(--light);
            color: var(--dark);
        }

        .period-btn:active { transform: scale(0.97); }

        /* ---------- PLAGE PERSONNALISÉE ---------- */

        .date-range-panel {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 12px 16px;
        }

        .date-range-panel.visible { display: flex; }

        .date-range-row { display: flex; gap: 10px; align-items: center; }

        .date-range-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--light);
            width: 44px;
            flex-shrink: 0;
        }

        .date-range-input {
            flex: 1;
            background: rgba(245, 228, 204, 0.12);
            border: 2px solid rgba(245, 228, 204, 0.2);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 15px;
            font-family: inherit;
            color: var(--light);
            color-scheme: dark;
        }

        .date-range-input:focus { outline: none; border-color: var(--light); }

        .date-range-apply {
            background: var(--accent);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
        }

        .date-range-apply:active { transform: scale(0.98); }

        /* ---------- CONTENU ---------- */

        .main-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* ---------- TITRES DE SECTION ---------- */

        .section-tag {
            font-size: 15px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--accent);
            padding: 18px 2px 6px;
        }

        /* ---------- CARTE BLANCHE ---------- */

        .stat-card {
            background: var(--light);
            border-radius: 14px;
            overflow: hidden;
        }

        /* ---------- LIGNES LABEL / VALEUR ---------- */

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 16px;
            border-bottom: 1px solid rgba(46, 58, 89, 0.08);
            gap: 12px;
        }

        .stat-row:last-child { border-bottom: none; }

        .stat-label {
            font-size: 15px;
            color: var(--dark);
            opacity: 0.65;
            font-weight: 500;
            flex-shrink: 0;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            text-align: right;
        }

        .stat-value.large { font-size: 28px; }

        .stat-delta {
            font-size: 13px;
            font-weight: 600;
            margin-left: 6px;
            color: var(--dark);
            opacity: 0.55;
        }

        .stat-sub {
            font-size: 13px;
            font-weight: 400;
            color: var(--dark);
            opacity: 0.5;
            display: block;
            margin-top: 2px;
        }

        /* ---------- DERNIÈRE CRISE ---------- */

        .last-crisis-row {
            background: var(--light);
            border-radius: 14px;
            padding: 13px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .last-crisis-label { font-size: 15px; color: var(--dark); opacity: 0.65; }
        .last-crisis-value { font-size: 18px; font-weight: 700; color: var(--dark); }

        /* ---------- GRILLE MOMENTS ---------- */

        .moment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: rgba(46, 58, 89, 0.08);
            border-radius: 14px;
            overflow: hidden;
        }

        .moment-cell {
            background: var(--light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 14px 4px;
        }

        .view-toggle {
            display: flex;
            background: rgba(46, 58, 89, 0.08);
            border-radius: 8px;
            padding: 3px;
            gap: 2px;
        }

        .view-toggle-btn {
            background: none;
            border: none;
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.5;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .view-toggle-btn.active {
            background: var(--dark);
            color: var(--light);
            opacity: 1;
        }

        /* ---------- VUE RAPIDE (pills) ---------- */

        .pills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 7px;
            padding-bottom: 8px;
        }

        .pill {
            background: rgba(46, 58, 89, 0.08);
            color: var(--dark);
            font-size: 13px;
            font-weight: 600;
            padding: 6px 11px;
            border-radius: 20px;
        }

        /* ---------- VUE DÉTAIL (barres) ---------- */

        .rank-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .rank-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rank-number {
            width: 22px;
            height: 22px;
            background: var(--dark);
            color: var(--light);
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .rank-number.secondary {
            background: rgba(46, 58, 89, 0.3);
            font-size: 11px;
        }

        .rank-bar-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .rank-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 5px;
        }

        .rank-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }

        .rank-meta {
            font-size: 13px;
            color: var(--dark);
            opacity: 0.5;
        }

        .rank-bar-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rank-bar-bg {
            flex: 1;
            height: 6px;
            background: rgba(46, 58, 89, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .rank-bar-fill {
            height: 100%;
            background: var(--dark);
            border-radius: 3px;
        }

        .rank-count {
            font-size: 12px;
            color: var(--dark);
            opacity: 0.55;
            white-space: nowrap;
            font-weight: 600;
        }

        .intensity-tag {
            font-size: 11px;
            color: var(--dark);
            opacity: 0.45;
            white-space: nowrap;
        }

        .intensity-legend {
            font-size: 11px;
            color: var(--dark);
            opacity: 0.4;
            font-style: italic;
            padding: 2px 0 6px;
        }

        /* ---------- ACCORDÉON ---------- */

        .accordion-toggle {
            width: 100%;
            background: none;
            border: none;
            border-top: 1px solid rgba(46, 58, 89, 0.1);
            padding: 9px 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion-toggle:active { opacity: 1; }

        .accordion-body { display: none; padding-bottom: 6px; }
        .accordion-body.open { display: block; }

        .all-rank-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-top: 8px;
        }

        /* ---------- JOURS / HEURES ---------- */

        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 12px;
        }

        .day-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 2px;
            border-radius: 8px;
            background: rgba(46, 58, 89, 0.06);
        }

        .day-cell.top-day { background: var(--dark); }

        .day-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.55;
        }

        .day-count {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
        }

        .day-cell.top-day .day-name,
        .day-cell.top-day .day-count {
            color: var(--light);
            opacity: 1;
        }

        .hour-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .hour-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 4px;
            border-radius: 8px;
            background: rgba(46, 58, 89, 0.06);
        }

        .hour-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.7;
        }

        .hour-range {
            font-size: 10px;
            color: var(--dark);
            opacity: 0.4;
        }

        .hour-count {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        /* ---------- BILAN COMPARAISON ---------- */

        .bilan-comp-header {
            display: flex;
            align-items: center;
            padding: 8px 16px 6px;
        }

        .bilan-comp-spacer { flex: 1; }

        .bilan-comp-col-hd {
            width: 80px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--dark);
            opacity: 0.45;
        }

        .bilan-comp-col-hd.col-current { opacity: 0.9; }

        .bilan-comp-row {
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-top: 1px solid rgba(46, 58, 89, 0.08);
        }

        .bilan-comp-label {
            flex: 1;
            font-size: 14px;
            color: var(--dark);
            opacity: 0.65;
            font-weight: 500;
            padding: 12px 8px 12px 0;
        }

        .bilan-comp-current {
            width: 80px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            padding: 12px 0;
        }

        .bilan-comp-prev {
            width: 80px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.45;
            padding: 12px 0;
            line-height: 1.4;
        }

        /* ---------- BILAN ENRICHI ---------- */

        .bilan-unit {
            font-size: 12px;
            font-weight: 400;
            opacity: 0.55;
        }

        .bilan-prev-val {
            font-size: 12px;
            font-weight: 400;
            opacity: 0.55;
        }

        .bilan-minmax {
            padding: 4px 16px 10px;
            font-size: 12px;
            color: var(--dark);
            opacity: 0.55;
        }

        .bilan-minmax strong { font-weight: 700; }

        /* ---------- GRILLE JOURS ---------- */

        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(46, 58, 89, 0.08);
            overflow: hidden;
        }

        .day-cell {
            background: var(--light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 10px 2px;
        }

        .day-cell.top-day { background: var(--dark); }

        .day-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.7;
        }

        .day-count {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .day-cell.top-day .day-name,
        .day-cell.top-day .day-count {
            color: var(--light);
            opacity: 1;
        }

        /* ---------- EXPORT ---------- */

        .export-stats-btn {
            background: rgba(245, 228, 204, 0.08);
            border: 2px solid rgba(245, 228, 204, 0.16);
            color: var(--light);
            font-size: 15px;
            font-weight: 600;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-stats-btn:active {
            background: rgba(245, 228, 204, 0.14);
            transform: scale(0.98);
        }

        /* ---------- ÉTAT VIDE ---------- */

        .empty-state {
            text-align: center;
            padding: 50px 20px 20px;
            color: var(--light);
            opacity: 0.6;
        }

        .empty-icon { font-size: 52px; margin-bottom: 12px; }
        .empty-text { font-size: 16px; }

        .no-data {
            font-size: 13px;
            color: var(--dark);
            opacity: 0.4;
            font-style: italic;
            padding: 2px 0 8px;
        }

        .last-crisis-card {
            background: var(--light);
            border-radius: 14px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
        }

        .filter-apply {
            flex: 2;
            background: var(--accent);
            border: none;
            color: var(--dark);
        }

        .last-crisis-value { font-weight: 700; }

        /* ---------- FILTRES AVANCÉS ---------- */

        .filter-bar { padding: 6px 16px 10px; }

        .filter-btn {
            background: rgba(245, 228, 204, 0.1);
            border: 2px solid rgba(245, 228, 204, 0.15);
            color: var(--light);
            font-size: 14px;
            font-weight: 600;
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn.has-filters { border-color: var(--accent); color: var(--accent); }

        .filter-badge {
            background: var(--accent);
            color: var(--dark);
            font-size: 11px;
            font-weight: 800;
            border-radius: 10px;
            padding: 1px 6px;
        }

        .filter-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: none;
        }

        .filter-overlay.visible { display: block; }

        .filter-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--light);
            border-radius: 18px 18px 0 0;
            padding: 20px 16px 30px;
            z-index: 201;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .filter-panel.visible { transform: translateY(0); }

        .filter-panel-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 16px;
        }

        .filter-group {
            margin-bottom: 16px;
        }

        .filter-group-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--dark);
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-chip {
            background: rgba(46, 58, 89, 0.08);
            border: 2px solid transparent;
            color: var(--dark);
            font-size: 14px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
        }

        .filter-chip.selected {
            background: var(--dark);
            color: var(--light);
        }

        .filter-range-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-range-label {
            font-size: 14px;
            color: var(--dark);
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .filter-range-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(46, 58, 89, 0.15);
            outline: none;
        }

        .filter-range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: var(--dark);
            border-radius: 50%;
            cursor: pointer;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .filter-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            border: none;
        }

        .filter-reset-btn {
            background: rgba(46, 58, 89, 0.08);
            color: var(--dark);
        }

        .filter-apply-btn {
            background: var(--accent);
            color: var(--dark);
        }

        /* ---------- GRAPHIQUES SVG ---------- */

        .chart-container {
            background: var(--light);
            border-radius: 14px;
            padding: 14px;
            overflow: hidden;
        }

        .chart-container svg {
            width: 100%;
            display: block;
        }

        .chart-legend {
            display: flex;
            gap: 14px;
            padding: 8px 0 0;
            flex-wrap: wrap;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--dark);
            opacity: 0.7;
        }

        .chart-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chart-bar-label {
            font-size: 12px;
            color: var(--dark);
            opacity: 0.6;
            text-align: center;
        }

        /* ---------- ANALYSE APPROFONDIE ---------- */

        .analysis-gate {
            text-align: center;
            padding: 24px 16px;
            color: var(--light);
            opacity: 0.5;
            font-size: 14px;
            font-style: italic;
        }

        .cross-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            color: var(--dark);
        }

        .cross-table th {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            opacity: 0.5;
            padding: 8px 6px;
            text-align: center;
            border-bottom: 2px solid rgba(46, 58, 89, 0.12);
        }

        .cross-table th:first-child { text-align: left; }

        .cross-table td {
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid rgba(46, 58, 89, 0.06);
        }

        .cross-table td:first-child {
            text-align: left;
            font-weight: 600;
        }

        .cross-table .cell-highlight {
            font-weight: 700;
            color: var(--accent);
        }
    </style>
</head>
<body>
    <header class="header">
        <button class="back-button" onclick="window.location.href='journal.html'" aria-label="Retour au journal">⬅️</button>
        <h1 class="page-title">Statistiques</h1>
    </header>

    <div class="period-header" style="font-size:15px;font-weight:800;text-transform:uppercase;letter-spacing:0.07em;color:var(--accent);padding:14px 16px 6px">Période</div>
    <div class="period-bar">
        <button class="period-btn active" data-days="7" onclick="selectPeriod(7)">7 j</button>
        <button class="period-btn" data-days="30" onclick="selectPeriod(30)">30 j</button>
        <button class="period-btn" data-days="365" onclick="selectPeriod(365)">1 an</button>
        <button class="period-btn" data-days="0" onclick="selectPeriod(0)">Dates</button>
    </div>
    <div class="date-range-panel" id="dateRangePanel">
        <div class="date-range-row">
            <span class="date-range-label">Début</span>
            <input type="date" class="date-range-input" id="dateFrom">
        </div>
        <div class="date-range-row">
            <span class="date-range-label">Fin</span>
            <input type="date" class="date-range-input" id="dateTo">
        </div>
        <button class="date-range-apply" onclick="applyCustomRange()">Appliquer</button>
    </div>

    <div class="filter-bar">
        <button class="filter-btn" id="filterBtn" onclick="toggleFilterPanel()">
            ⚙️ Filtres <span class="filter-badge" id="filterBadge" style="display:none">0</span>
        </button>
    </div>

    <div class="filter-overlay" id="filterOverlay" onclick="closeFilterPanel()"></div>
    <div class="filter-panel" id="filterPanel">
        <div class="filter-panel-title">Filtres avancés</div>

        <div class="filter-group">
            <div class="filter-group-label">Contexte</div>
            <div class="filter-chips" id="filterContexte"></div>
        </div>

        <div class="filter-group">
            <div class="filter-group-label">Origine</div>
            <div class="filter-chips" id="filterOrigine">
                <button class="filter-chip" data-val="Anticipatoire" onclick="toggleFilterChip(this)">Anticipatoire</button>
                <button class="filter-chip" data-val="Réactionnelle" onclick="toggleFilterChip(this)">Réactionnelle</button>
                <button class="filter-chip" data-val="Mixte" onclick="toggleFilterChip(this)">Mixte</button>
            </div>
        </div>

        <div class="filter-group">
            <div class="filter-group-label">Type de crise</div>
            <div class="filter-chips" id="filterType">
                <button class="filter-chip" data-val="Meltdown" onclick="toggleFilterChip(this)">Meltdown</button>
                <button class="filter-chip" data-val="Shutdown" onclick="toggleFilterChip(this)">Shutdown</button>
                <button class="filter-chip" data-val="Mixte" onclick="toggleFilterChip(this)">Mixte</button>
            </div>
        </div>

        <div class="filter-group">
            <div class="filter-group-label">Intensité</div>
            <div class="filter-range-row">
                <span class="filter-range-label" id="filterIntMinLabel">1</span>
                <input type="range" class="filter-range-slider" id="filterIntMin" min="1" max="10" value="1" oninput="document.getElementById('filterIntMinLabel').textContent=this.value">
                <span style="color:var(--dark);opacity:0.4">à</span>
                <input type="range" class="filter-range-slider" id="filterIntMax" min="1" max="10" value="10" oninput="document.getElementById('filterIntMaxLabel').textContent=this.value">
                <span class="filter-range-label" id="filterIntMaxLabel">10</span>
            </div>
        </div>

        <div class="filter-group">
            <div class="filter-group-label">Moment de la journée</div>
            <div class="filter-chips" id="filterMoment">
                <button class="filter-chip" data-val="nuit" onclick="toggleFilterChip(this)">Nuit</button>
                <button class="filter-chip" data-val="matin" onclick="toggleFilterChip(this)">Matin</button>
                <button class="filter-chip" data-val="aprem" onclick="toggleFilterChip(this)">Après-midi</button>
                <button class="filter-chip" data-val="soir" onclick="toggleFilterChip(this)">Soir</button>
            </div>
        </div>

        <div class="filter-actions">
            <button class="filter-reset-btn" onclick="resetFilters()">Réinitialiser</button>
            <button class="filter-apply-btn" onclick="applyFilters()">Appliquer</button>
        </div>
    </div>

    <main class="main-content" id="mainContent"></main>

    <script>
        var currentDays = 7;
        var customFrom = null;
        var customTo = null;
        var viewModes = { triggers: 'detail', besoins: 'detail' };
        var activeFilters = { contexte: [], origine: [], type: [], moment: [], intMin: 1, intMax: 10 };

        /* ---------- DONNÉES ---------- */

        function getJournal() {
            try { return JSON.parse(localStorage.getItem('journalCrises') || '[]'); }
            catch (e) { return []; }
        }

        function getProfileName(profileId) {
            var names = { commun: 'Profil commun', maison: 'Maison', exterieur: 'Extérieur', travail: 'Travail', secours: 'Secours' };
            return names[profileId] || profileId || '—';
        }

        /* ---------- DURÉE ---------- */

        function parseDuration(str) {
            if (!str) return null;
            str = str.toLowerCase().trim();
            var mins = 0, found = false;
            var hMatch = str.match(/(\d+)\s*h/);
            if (hMatch) { mins += parseInt(hMatch[1], 10) * 60; found = true; }
            var mMatch = str.match(/(\d+)\s*(min|mn|m\b)/);
            if (mMatch) { mins += parseInt(mMatch[1], 10); found = true; }
            if (!found) { var n = str.match(/^(\d+)$/); if (n) { mins = parseInt(n[1], 10); found = true; } }
            return (found && mins > 0) ? mins : null;
        }

        function formatMins(m) {
            m = Math.round(m);
            if (m < 60) return m + ' min';
            var h = Math.floor(m / 60), r = m % 60;
            return r > 0 ? h + 'h' + (r < 10 ? '0' : '') + r : h + 'h';
        }

        function formatDateFR(s) {
            return new Date(s).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
        }

        /* ---------- FRÉQUENCES ---------- */

        function countFreq(arr) {
            var freq = {};
            for (var i = 0; i < arr.length; i++) {
                if (arr[i]) freq[arr[i]] = (freq[arr[i]] || 0) + 1;
            }
            var result = [];
            for (var k in freq) result.push({ name: k, count: freq[k] });
            result.sort(function(a, b) { return b.count - a.count; });
            return result;
        }

        /* ---------- CALCUL STATS ---------- */

        /* ---------- HELPERS STATS ---------- */

        function avgArr(arr) {
            if (!arr.length) return null;
            var s = 0; for (var i = 0; i < arr.length; i++) s += arr[i];
            return parseFloat((s / arr.length).toFixed(1));
        }

        function pct(part, total) {
            return total > 0 ? Math.round((part / total) * 100) : 0;
        }

        function getHourSlotIndex(h) {
            return h < 6 ? 0 : h < 12 ? 1 : h < 18 ? 2 : 3;
        }

        function extractLabel(item) {
            return item && item.label ? item.label : item;
        }

        function normDeclencheurs(arr) {
            if (!Array.isArray(arr)) return [];
            return arr.map(function(d) { return typeof d === 'string' ? { nom: d, intensite: null } : d; });
        }
        function normEnergie(entry) {
            if (entry.energie) return parseFloat(entry.energie);
            if (entry.precrisis && entry.precrisis.energie !== undefined) return Math.max(1, Math.min(10, Math.round(entry.precrisis.energie / 10)));
            return NaN;
        }
        function normChargeMentale(entry) {
            if (entry.chargeMentale) return parseFloat(entry.chargeMentale);
            if (entry.precrisis && entry.precrisis.chargeMentale !== undefined) return Math.max(1, Math.min(10, Math.round(entry.precrisis.chargeMentale / 10)));
            return NaN;
        }
        function normChargeSociale(entry) {
            if (entry.chargeSociale) return parseFloat(entry.chargeSociale);
            if (entry.precrisis && entry.precrisis.chargeSociale !== undefined) return Math.max(1, Math.min(10, Math.round(entry.precrisis.chargeSociale / 10)));
            return NaN;
        }
        function hasTrigger(entry, name) {
            var d = normDeclencheurs(entry.declencheurs);
            for (var i = 0; i < d.length; i++) { if (d[i].nom === name) return true; }
            return false;
        }

        function computePrevStats(prevEntries) {
            if (!prevEntries.length) return null;
            var ints = [], durs = [];
            for (var i = 0; i < prevEntries.length; i++) {
                var v = parseFloat(prevEntries[i].intensite);
                if (!isNaN(v)) ints.push(v);
                var d = parseDuration(prevEntries[i].duree);
                if (d !== null) durs.push(d);
            }
            var profileArr = [];
            for (var j = 0; j < prevEntries.length; j++) profileArr.push(prevEntries[j].profil || 'commun');
            var profileCounts = countFreq(profileArr);
            var topP = profileCounts.length ? profileCounts[0] : null;
            var topProfile = null;
            if (topP) {
                var pi = getProfileName(topP.name);
                topProfile = { name: pi.name, icon: pi.icon, count: topP.count };
            }
            return {
                count: prevEntries.length,
                avgIntensity: avgArr(ints),
                avgDuration: avgArr(durs),
                topProfile: topProfile
            };
        }

        /* ---------- CALCUL STATS ---------- */

        function computeStats(days, from, to) {
            var journal = getJournal();
            var entries = [], prevEntries = [];

            if (days === 0 && from && to) {
                var start = new Date(from); start.setHours(0, 0, 0, 0);
                var end = new Date(to); end.setHours(23, 59, 59, 999);
                var span = end - start;
                for (var i = 0; i < journal.length; i++) {
                    var d = new Date(journal[i].horodatage);
                    if (d >= start && d <= end) entries.push(journal[i]);
                    else if (d >= new Date(start - span) && d < start) prevEntries.push(journal[i]);
                }
            } else {
                var now = new Date();
                var cutoff = new Date(now); cutoff.setDate(now.getDate() - days); cutoff.setHours(0, 0, 0, 0);
                var prevCut = new Date(now); prevCut.setDate(now.getDate() - days * 2); prevCut.setHours(0, 0, 0, 0);
                for (var j = 0; j < journal.length; j++) {
                    var dj = new Date(journal[j].horodatage);
                    if (dj >= cutoff) entries.push(journal[j]);
                    else if (dj >= prevCut) prevEntries.push(journal[j]);
                }
            }

            var hasActiveFilters = activeFilters.contexte.length || activeFilters.origine.length ||
                activeFilters.type.length || activeFilters.moment.length ||
                activeFilters.intMin > 1 || activeFilters.intMax < 10;
            if (hasActiveFilters) {
                var filtered = [];
                for (var fi = 0; fi < entries.length; fi++) {
                    if (matchesFilters(entries[fi])) filtered.push(entries[fi]);
                }
                entries = filtered;
            }

            if (!entries.length) return null;

            var intensities = [], durations = [], energies = [], chargesMentales = [], chargesSociales = [];
            var profileArr = [], typeArr = [], origineArr = [];
            var triggerFreq = {}, besoinArr = [], etatArr = [];
            var capImpossible = [], capDifficile = [];
            var meltdownCount = 0, shutdownCount = 0, mixteTypeCount = 0;

            for (var k = 0; k < entries.length; k++) {
                var e = entries[k];
                var ints = parseFloat(e.intensite);
                if (!isNaN(ints)) intensities.push(ints);
                var dur = parseDuration(e.duree);
                if (dur !== null) durations.push(dur);
                var en = normEnergie(e);
                if (!isNaN(en)) energies.push(en);
                var cm = normChargeMentale(e);
                if (!isNaN(cm)) chargesMentales.push(cm);
                var cs = normChargeSociale(e);
                if (!isNaN(cs)) chargesSociales.push(cs);

                profileArr.push(e.profil || 'commun');
                if (e.typeCrise) {
                    origineArr.push(e.typeCrise);
                    if (e.typeCrise === 'Meltdown') meltdownCount++;
                    else if (e.typeCrise === 'Shutdown') shutdownCount++;
                    else if (e.typeCrise === 'Mixte') mixteTypeCount++;
                }
                var decl = normDeclencheurs(e.declencheurs);
                for (var d2 = 0; d2 < decl.length; d2++) {
                    if (decl[d2].nom) triggerFreq[decl[d2].nom] = (triggerFreq[decl[d2].nom] || 0) + 1;
                }
                var bess = e.besoins || [];
                for (var b = 0; b < bess.length; b++) {
                    var bl = extractLabel(bess[b]);
                    if (bl) besoinArr.push(bl);
                }
                var etats = e.etats || [];
                for (var et = 0; et < etats.length; et++) {
                    var el = extractLabel(etats[et]);
                    if (el) etatArr.push(el);
                }
                var caps = e.capacites || {};
                if (caps.impossible) for (var ci = 0; ci < caps.impossible.length; ci++) capImpossible.push(caps.impossible[ci]);
                if (caps.difficile) for (var cd = 0; cd < caps.difficile.length; cd++) capDifficile.push(caps.difficile[cd]);
            }

            var avgIntensity = avgArr(intensities);
            var minIntensity = intensities.length ? parseFloat(Math.min.apply(null, intensities).toFixed(1)) : null;
            var maxIntensity = intensities.length ? parseFloat(Math.max.apply(null, intensities).toFixed(1)) : null;
            var avgDuration = avgArr(durations);
            var minDuration = durations.length ? Math.min.apply(null, durations) : null;
            var maxDuration = durations.length ? Math.max.apply(null, durations) : null;
            var avgEnergie = avgArr(energies);
            var avgChargeMentale = avgArr(chargesMentales);
            var avgChargeSociale = avgArr(chargesSociales);

            var prev = computePrevStats(prevEntries);

            /* Profils / contextes */
            var profileCounts = countFreq(profileArr);
            var topProfileData = profileCounts.length ? profileCounts[0] : null;
            var topProfile = null;
            if (topProfileData) {
                var pInfo = getProfileName(topProfileData.name);
                topProfile = { name: pInfo.name, icon: pInfo.icon, count: topProfileData.count, id: topProfileData.name };
            }

            /* Origines */
            var origineCounts = countFreq(origineArr);

            /* Types meltdown/shutdown */
            var totalTyped = meltdownCount + shutdownCount + mixteTypeCount;
            var meltdownPct = pct(meltdownCount, totalTyped);
            var shutdownPct = pct(shutdownCount, totalTyped);

            /* Intensité/durée par type */
            var avgIntensityByType = {};
            var avgDurationByType = {};
            var typeNames = ['Meltdown', 'Shutdown', 'Mixte'];
            for (var tn = 0; tn < typeNames.length; tn++) {
                var tInts2 = [], tDurs = [];
                for (var te2 = 0; te2 < entries.length; te2++) {
                    if (entries[te2].typeCrise === typeNames[tn]) {
                        var tv = parseFloat(entries[te2].intensite);
                        if (!isNaN(tv)) tInts2.push(tv);
                        var td3 = parseDuration(entries[te2].duree);
                        if (td3 !== null) tDurs.push(td3);
                    }
                }
                if (tInts2.length) avgIntensityByType[typeNames[tn]] = avgArr(tInts2);
                if (tDurs.length) avgDurationByType[typeNames[tn]] = avgArr(tDurs);
            }

            /* Intensité moyenne par contexte + % type par contexte */
            var avgIntensityByContexte = {};
            var percentTypeByContexte = {};
            for (var pc = 0; pc < profileCounts.length; pc++) {
                var pName = profileCounts[pc].name;
                var pInts = [], pMelt = 0, pShut = 0;
                for (var pe = 0; pe < entries.length; pe++) {
                    if ((entries[pe].profil || 'commun') === pName) {
                        var pv = parseFloat(entries[pe].intensite);
                        if (!isNaN(pv)) pInts.push(pv);
                        if (entries[pe].typeCrise === 'Meltdown') pMelt++;
                        else if (entries[pe].typeCrise === 'Shutdown') pShut++;
                    }
                }
                var pTotal = pMelt + pShut;
                var pi2 = getProfileName(pName);
                avgIntensityByContexte[pi2.name] = avgArr(pInts);
                percentTypeByContexte[pi2.name] = { meltdown: pct(pMelt, pTotal), shutdown: pct(pShut, pTotal) };
            }

            /* Déclencheurs enrichis : intensité + % type */
            var triggerStats = [];
            for (var tkey in triggerFreq) {
                var tcnt = triggerFreq[tkey];
                var tInts = [], tMelt = 0, tShut = 0;
                for (var te = 0; te < entries.length; te++) {
                    if (hasTrigger(entries[te], tkey)) {
                        var ti = parseFloat(entries[te].intensite);
                        if (!isNaN(ti)) tInts.push(ti);
                        if (entries[te].typeCrise === 'Meltdown') tMelt++;
                        else if (entries[te].typeCrise === 'Shutdown') tShut++;
                    }
                }
                var tTyped = tMelt + tShut;
                triggerStats.push({
                    name: tkey, count: tcnt,
                    avgIntensity: avgArr(tInts),
                    meltdownPct: pct(tMelt, tTyped)
                });
            }
            triggerStats.sort(function(a, b) { return b.count - a.count; });

            /* Besoins enrichis : association type */
            var besoinCounts = countFreq(besoinArr);
            var besoinByType = {};
            for (var bi = 0; bi < besoinCounts.length; bi++) {
                var bn = besoinCounts[bi].name;
                var bMelt = 0, bShut = 0;
                for (var be = 0; be < entries.length; be++) {
                    var bList = entries[be].besoins || [];
                    var hasBesoin = false;
                    for (var bl2 = 0; bl2 < bList.length; bl2++) {
                        if (extractLabel(bList[bl2]) === bn) { hasBesoin = true; break; }
                    }
                    if (hasBesoin) {
                        if (entries[be].typeCrise === 'Meltdown') bMelt++;
                        else if (entries[be].typeCrise === 'Shutdown') bShut++;
                    }
                }
                besoinByType[bn] = { meltdown: bMelt, shutdown: bShut };
            }

            /* États enrichis : intensité moyenne par état */
            var etatCounts = countFreq(etatArr);
            var avgIntensityByEtat = {};
            for (var ei = 0; ei < etatCounts.length; ei++) {
                var en2 = etatCounts[ei].name;
                var eInts = [];
                for (var ee = 0; ee < entries.length; ee++) {
                    var eList = entries[ee].etats || [];
                    var hasEtat = false;
                    for (var el2 = 0; el2 < eList.length; el2++) {
                        if (extractLabel(eList[el2]) === en2) { hasEtat = true; break; }
                    }
                    if (hasEtat) {
                        var ev = parseFloat(entries[ee].intensite);
                        if (!isNaN(ev)) eInts.push(ev);
                    }
                }
                avgIntensityByEtat[en2] = avgArr(eInts);
            }

            /* Capacités par type */
            var capImpCounts = countFreq(capImpossible);
            var capDifCounts = countFreq(capDifficile);
            var capaciteByType = {};
            var allCaps = capImpCounts.concat(capDifCounts);
            for (var aci = 0; aci < allCaps.length; aci++) {
                var cn = allCaps[aci].name;
                if (capaciteByType[cn]) continue;
                var cMelt = 0, cShut = 0;
                for (var ce = 0; ce < entries.length; ce++) {
                    var caps2 = entries[ce].capacites || {};
                    var allC = (caps2.impossible || []).concat(caps2.difficile || []);
                    var hasCap = false;
                    for (var cc = 0; cc < allC.length; cc++) { if (allC[cc] === cn) { hasCap = true; break; } }
                    if (hasCap) {
                        if (entries[ce].typeCrise === 'Meltdown') cMelt++;
                        else if (entries[ce].typeCrise === 'Shutdown') cShut++;
                    }
                }
                var cTotal = cMelt + cShut;
                capaciteByType[cn] = { meltdown: pct(cMelt, cTotal), shutdown: pct(cShut, cTotal) };
            }

            /* Moments de la journée enrichis */
            var hourSlots = [
                { name: 'Nuit', range: '0–6h', count: 0, intensities: [], meltdown: 0, shutdown: 0 },
                { name: 'Matin', range: '6–12h', count: 0, intensities: [], meltdown: 0, shutdown: 0 },
                { name: 'Après-m.', range: '12–18h', count: 0, intensities: [], meltdown: 0, shutdown: 0 },
                { name: 'Soir', range: '18–24h', count: 0, intensities: [], meltdown: 0, shutdown: 0 }
            ];
            var DAY_NAMES = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            var dayFreq = [0, 0, 0, 0, 0, 0, 0];
            for (var he = 0; he < entries.length; he++) {
                var hd = new Date(entries[he].horodatage);
                var hh = hd.getHours();
                var si = getHourSlotIndex(hh);
                hourSlots[si].count++;
                var hv = parseFloat(entries[he].intensite);
                if (!isNaN(hv)) hourSlots[si].intensities.push(hv);
                if (entries[he].typeCrise === 'Meltdown') hourSlots[si].meltdown++;
                else if (entries[he].typeCrise === 'Shutdown') hourSlots[si].shutdown++;
                dayFreq[hd.getDay()]++;
            }
            for (var hs = 0; hs < hourSlots.length; hs++) {
                hourSlots[hs].avgIntensity = avgArr(hourSlots[hs].intensities);
                var hsTyped = hourSlots[hs].meltdown + hourSlots[hs].shutdown;
                hourSlots[hs].meltdownPct = pct(hourSlots[hs].meltdown, hsTyped);
                delete hourSlots[hs].intensities;
            }
            var dayOfWeek = [1, 2, 3, 4, 5, 6, 0].map(function(i) {
                return { name: DAY_NAMES[i], count: dayFreq[i] };
            });

            /* Seuils critiques : intensité moy par tranche énergie/charge */
            var thresholds = { energie: [{}, {}, {}], chargeMentale: [{}, {}, {}], chargeSociale: [{}, {}, {}] };
            var thresholdFields = ['energie', 'chargeMentale', 'chargeSociale'];
            var normFns = { energie: normEnergie, chargeMentale: normChargeMentale, chargeSociale: normChargeSociale };
            for (var tf = 0; tf < thresholdFields.length; tf++) {
                var field = thresholdFields[tf];
                var buckets = [[], [], []]; // 0-3, 4-6, 7-10
                for (var se = 0; se < entries.length; se++) {
                    var sv = normFns[field](entries[se]);
                    var si2 = parseFloat(entries[se].intensite);
                    if (isNaN(sv) || isNaN(si2)) continue;
                    var bIdx = sv <= 3 ? 0 : sv <= 6 ? 1 : 2;
                    buckets[bIdx].push(si2);
                }
                var labels = ['0–3', '4–6', '7–10'];
                for (var lb = 0; lb < 3; lb++) {
                    thresholds[field][lb] = { label: labels[lb], avgIntensity: avgArr(buckets[lb]), count: buckets[lb].length };
                }
            }

            /* Évolution temporelle (données brutes pour graphique) */
            var timelineEntries = [];
            for (var tl = 0; tl < entries.length; tl++) {
                var tlEn = normEnergie(entries[tl]);
                timelineEntries.push({
                    date: entries[tl].horodatage,
                    intensite: parseFloat(entries[tl].intensite) || null,
                    energie: isNaN(tlEn) ? null : tlEn
                });
            }

            var prevIntensities = [], prevDurations = [];
            for (var pk = 0; pk < prevEntries.length; pk++) {
                var pe = prevEntries[pk];
                var piv = parseFloat(pe.intensite); if (!isNaN(piv)) prevIntensities.push(piv);
                var pdv = parseDuration(pe.duree); if (pdv !== null) prevDurations.push(pdv);
            }
            var prevAvgIntensity = null, prevAvgDuration = null;
            if (prevIntensities.length) {
                var pisum = 0; for (var ps = 0; ps < prevIntensities.length; ps++) pisum += prevIntensities[ps];
                prevAvgIntensity = parseFloat((pisum / prevIntensities.length).toFixed(1));
            }
            if (prevDurations.length) {
                var pdsum = 0; for (var pds = 0; pds < prevDurations.length; pds++) pdsum += prevDurations[pds];
                prevAvgDuration = pdsum / prevDurations.length;
            }

            return {
                total: entries.length,
                entries: entries,
                prev: prev,
                avgIntensity: avgIntensity,
                minIntensity: minIntensity,
                maxIntensity: maxIntensity,
                minIntensity: minIntensity,
                maxIntensity: maxIntensity,
                avgDuration: avgDuration,
                minDuration: minDuration,
                maxDuration: maxDuration,
                avgEnergie: avgEnergie,
                avgChargeMentale: avgChargeMentale,
                avgChargeSociale: avgChargeSociale,
                meltdownCount: meltdownCount,
                shutdownCount: shutdownCount,
                meltdownPct: meltdownPct,
                shutdownPct: shutdownPct,
                topProfile: topProfile,
                profileCounts: profileCounts,
                origineCounts: origineCounts,
                avgIntensityByType: avgIntensityByType,
                avgDurationByType: avgDurationByType,
                avgIntensityByContexte: avgIntensityByContexte,
                percentTypeByContexte: percentTypeByContexte,
                triggerStats: triggerStats,
                besoinCounts: besoinCounts,
                besoinByType: besoinByType,
                etatCounts: etatCounts,
                avgIntensityByEtat: avgIntensityByEtat,
                capImpCounts: capImpCounts,
                capDifCounts: capDifCounts,
                capaciteByType: capaciteByType,
                dayOfWeek: dayOfWeek,
                hourSlots: hourSlots,
                thresholds: thresholds,
                timelineEntries: timelineEntries
            };
        }

        /* ---------- DERNIÈRE CRISE ---------- */

        function sinceLastCrisis() {
            var journal = getJournal();
            if (!journal.length) return null;
            var latest = null;
            for (var i = 0; i < journal.length; i++) {
                var d = new Date(journal[i].horodatage);
                if (!latest || d > latest) latest = d;
            }
            var diff = Math.floor((Date.now() - latest) / 86400000);
            if (diff === 0) return "aujourd'hui";
            if (diff === 1) return 'hier';
            return 'il y a ' + diff + ' j';
        }

        /* ---------- NARRATIF ---------- */

        function buildNarrative(stats, days, from, to) {
            var periodLabel = days === 7 ? 'ces 7 derniers jours'
                : days === 30 ? 'ces 30 derniers jours'
                : days === 365 ? 'cette dernière année'
                : 'du ' + formatDateFR(from) + ' au ' + formatDateFR(to);

            var n = stats.total;
            var pl = n > 1;
            var parts = [];

            var s1 = 'Sur ' + periodLabel + ', tu as traversé <strong>' + n + ' crise' + (pl ? 's' : '') + '</strong>';
            if (stats.avgIntensity !== null) s1 += ' avec une intensité moyenne de <strong>' + stats.avgIntensity + '/10</strong>';
            if (stats.avgDuration !== null) {
                s1 += ' et une durée d\'environ <strong>' + formatMins(stats.avgDuration) + '</strong>';
                if (stats.minDuration !== null && stats.maxDuration !== null && stats.minDuration !== stats.maxDuration) {
                    s1 += ' (de ' + formatMins(stats.minDuration) + ' à ' + formatMins(stats.maxDuration) + ')';
                }
            }
            parts.push(s1 + '.');

            var ctxParts = [];
            if (stats.topProfile) {
                var preps = { 'Maison': 'à la maison', 'Extérieur': 'en extérieur', 'Travail': 'au travail',
                    'Secours': 'en contexte secours', 'Profil commun': 'en contexte commun' };
                var prep = preps[stats.topProfile.name] || 'en contexte ' + stats.topProfile.name;
                ctxParts.push('surtout <strong>' + prep + '</strong>');
            }
            if (stats.origineCounts && stats.origineCounts.length) {
                var adj = { 'Anticipatoire': 'anticipatoires', 'Réactionnelle': 'réactionnelles', 'Mixte': 'mixtes' };
                var typeAdj = adj[stats.origineCounts[0].name] || stats.origineCounts[0].name.toLowerCase();
                ctxParts.push('majoritairement de type <strong>' + typeAdj + '</strong>');
            }
            if (ctxParts.length) {
                parts.push((pl ? 'Elles se sont passées ' : 'Elle s\'est passée ') + ctxParts.join(', ') + '.');
            }

            var topDay = null;
            for (var di = 0; di < stats.dayOfWeek.length; di++) {
                if (!topDay || stats.dayOfWeek[di].count > topDay.count) topDay = stats.dayOfWeek[di];
            }
            var topHour = null;
            for (var hi = 0; hi < stats.hourSlots.length; hi++) {
                if (!topHour || stats.hourSlots[hi].count > topHour.count) topHour = stats.hourSlots[hi];
            }
            if (topDay && topDay.count > 0) {
                var hourLabels = { 'Nuit': 'la nuit', 'Matin': 'le matin', 'Après-m.': "l'après-midi", 'Soir': 'le soir' };
                var s3 = 'Le jour où tu en as le plus : <strong>' + topDay.name + '</strong>';
                if (topHour && topHour.count > 0) s3 += ', souvent <strong>' + (hourLabels[topHour.name] || topHour.name) + '</strong>';
                parts.push(s3 + '.');
            }

            if (stats.triggerStats.length > 0) {
                var top3t = stats.triggerStats.slice(0, 3);
                var tnames = top3t.map(function(t) { return '<strong>' + t.name + '</strong>'; }).join(', ');
                var tnb = top3t.length;
                parts.push((pl ? 'Tes' : 'Ton') + ' principal' + (tnb > 1 ? 'aux' : '') + ' déclencheur' + (tnb > 1 ? 's' : '') + ' : ' + tnames + '.');
                var withInt = stats.triggerStats.filter(function(t) { return t.avgIntensity !== null; });
                if (withInt.length > 0) {
                    var wt = withInt[0];
                    parts.push((pl ? 'Les crises les plus intenses sont associées' : 'La crise la plus intense est associée') + ' à <strong>' + wt.name + '</strong> (' + wt.avgIntensity + '/10 en moyenne).');
                }
            }

            if (stats.besoinCounts.length > 0) {
                var top3b = stats.besoinCounts.slice(0, 3);
                var bnames = top3b.map(function(b) { return '<strong>' + b.name + '</strong>'; }).join(', ');
                var bnb = top3b.length;
                parts.push((pl ? 'Tes' : 'Ton') + ' principal' + (bnb > 1 ? 'aux' : '') + ' besoin' + (bnb > 1 ? 's' : '') + ' : ' + bnames + '.');
            }

            return parts.join(' ');
        }

        /* ---------- RENDU : LIGNE DE CLASSEMENT ---------- */

        function rankRow(item, num, maxCount) {
            var barPct = Math.round((item.count / maxCount) * 100);
            var numEl = (num > 0)
                ? '<div class="rank-number">' + num + '</div>'
                : '<div class="rank-number secondary">·</div>';
            var meta = item.count + '×';
            if (item.avgIntensity != null) meta += ' · ' + item.avgIntensity + '/10';
            if (item.meltdownPct != null && item.meltdownPct > 0) meta += ' · ' + item.meltdownPct + '% melt.';
            return '<div class="rank-item">' + numEl +
                '<div class="rank-bar-wrap">' +
                '<div class="rank-header"><div class="rank-name">' + item.name + '</div>' +
                '<div class="rank-meta">' + meta + '</div></div>' +
                '<div class="rank-bar-bg"><div class="rank-bar-fill" style="width:' + barPct + '%"></div></div>' +
                '</div></div>';
        }

        /* ---------- RENDU : SECTION AVEC TOGGLE ---------- */

        function renderToggleSection(id, title, items, viewMode) {
            var isDetail = viewMode === 'detail';
            var maxCount = items.length ? items[0].count : 1;
            var inner = '';

            if (!items.length) {
                inner = '<div class="no-data">Aucune donnée</div>';
            } else if (!isDetail) {
                inner = '<div class="pills-list">';
                for (var i = 0; i < items.length; i++) {
                    inner += '<span class="pill">' + items[i].name + '</span>';
                }
                inner += '</div>';
            } else {
                var top = items.slice(0, 3);
                var rest = items.slice(3);
                var hasIntensity = false;
                for (var hi = 0; hi < items.length; hi++) {
                    if (items[hi].avgIntensity != null) { hasIntensity = true; break; }
                }

                inner = '<div class="rank-list">';
                for (var ti = 0; ti < top.length; ti++) {
                    inner += rankRow(top[ti], ti + 1, maxCount);
                }
                inner += '</div>';

                if (rest.length > 0) {
                    var accId = 'acc_' + id;
                    inner += '<button class="accordion-toggle" onclick="toggleAccordion(\'' + accId + '\', this)">';
                    inner += '<span>Voir les ' + rest.length + ' autre' + (rest.length > 1 ? 's' : '') + '</span>';
                    inner += '<span id="arr_' + accId + '">▾</span></button>';
                    inner += '<div class="accordion-body" id="' + accId + '"><div class="all-rank-list">';
                    for (var ri = 0; ri < rest.length; ri++) {
                        inner += rankRow(rest[ri], 0, maxCount);
                    }
                    inner += '</div></div>';
                }

                if (hasIntensity) {
                    inner += '<div class="intensity-legend">Le chiffre après · = intensité moy. lors des crises avec ce déclencheur</div>';
                }
            }

            return '<div class="section-tag">' + title + '</div>' +
                '<div class="section">' +
                '<div class="section-header">' +
                '<div class="section-title"></div>' +
                '<div class="view-toggle">' +
                '<button class="view-toggle-btn ' + (!isDetail ? 'active' : '') + '" onclick="setView(\'' + id + '\', \'rapide\')">Rapide</button>' +
                '<button class="view-toggle-btn ' + (isDetail ? 'active' : '') + '" onclick="setView(\'' + id + '\', \'detail\')">Détail</button>' +
                '</div></div>' +
                inner +
                '</div>';
        }

        function setView(id, mode) {
            viewModes[id] = mode;
            renderCurrent();
        }

        function toggleAccordion(id, btn) {
            var body = document.getElementById(id);
            var arrow = document.getElementById('arr_' + id);
            var isOpen = body.classList.toggle('open');
            if (arrow) arrow.textContent = isOpen ? '▴' : '▾';
        }

        /* ---------- RENDU : LIGNE BILAN ---------- */

        /* ---------- GRAPHIQUE : ÉVOLUTION TEMPORELLE ---------- */

        function buildTimelineSVG(entries, days) {
            if (entries.length < 2) return '';
            var useWeeks = days < 60;
            var buckets = {};

            for (var i = 0; i < entries.length; i++) {
                var d = new Date(entries[i].date);
                var key;
                if (useWeeks) {
                    var dayOfYear = Math.floor((d - new Date(d.getFullYear(), 0, 1)) / 86400000);
                    var week = Math.floor(dayOfYear / 7);
                    key = d.getFullYear() + '-W' + week;
                } else {
                    key = d.getFullYear() + '-' + (d.getMonth() + 1);
                }
                if (!buckets[key]) buckets[key] = { count: 0, intensities: [], label: '' };
                buckets[key].count++;
                if (entries[i].intensite !== null) buckets[key].intensities.push(entries[i].intensite);

                if (useWeeks) {
                    var monday = new Date(d); monday.setDate(d.getDate() - d.getDay() + 1);
                    buckets[key].label = monday.getDate() + '/' + (monday.getMonth() + 1);
                } else {
                    var mois = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jui', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
                    buckets[key].label = mois[d.getMonth()];
                }
            }

            var keys = Object.keys(buckets).sort();
            var data = [];
            for (var ki = 0; ki < keys.length; ki++) {
                var b = buckets[keys[ki]];
                var avg = b.intensities.length ? avgArr(b.intensities) : null;
                data.push({ label: b.label, count: b.count, avgInt: avg });
            }

            if (data.length < 2) return '';

            var W = 320, H = 150, padL = 30, padR = 10, padT = 15, padB = 25;
            var chartW = W - padL - padR;
            var chartH = H - padT - padB;
            var maxCount = 0, maxInt = 10;
            for (var di = 0; di < data.length; di++) {
                if (data[di].count > maxCount) maxCount = data[di].count;
            }
            if (maxCount === 0) maxCount = 1;

            var step = chartW / (data.length - 1);
            var countLine = '', intLine = '', labels = '';
            var countDots = '', intDots = '';

            for (var pi = 0; pi < data.length; pi++) {
                var x = padL + pi * step;
                var yCount = padT + chartH - (data[pi].count / maxCount) * chartH;
                if (pi === 0) countLine = 'M' + x + ',' + yCount;
                else countLine += ' L' + x + ',' + yCount;
                countDots += '<circle cx="' + x + '" cy="' + yCount + '" r="3" fill="#F7B89C"/>';

                if (data[pi].avgInt !== null) {
                    var yInt = padT + chartH - (data[pi].avgInt / maxInt) * chartH;
                    if (intLine === '') intLine = 'M' + x + ',' + yInt;
                    else intLine += ' L' + x + ',' + yInt;
                    intDots += '<circle cx="' + x + '" cy="' + yInt + '" r="3" fill="#2E3A59"/>';
                }

                if (data.length <= 12 || pi % 2 === 0) {
                    labels += '<text x="' + x + '" y="' + (H - 4) + '" text-anchor="middle" font-size="10" fill="#2E3A59" opacity="0.5">' + data[pi].label + '</text>';
                }
            }

            var yAxis = '';
            for (var yl = 0; yl <= 4; yl++) {
                var yy = padT + (yl / 4) * chartH;
                var val = Math.round(maxCount * (1 - yl / 4));
                yAxis += '<line x1="' + padL + '" y1="' + yy + '" x2="' + (W - padR) + '" y2="' + yy + '" stroke="#2E3A59" stroke-opacity="0.06"/>';
                yAxis += '<text x="' + (padL - 4) + '" y="' + (yy + 3) + '" text-anchor="end" font-size="9" fill="#2E3A59" opacity="0.4">' + val + '</text>';
            }

            var svg = '<svg viewBox="0 0 ' + W + ' ' + H + '" xmlns="http://www.w3.org/2000/svg">' +
                yAxis + labels +
                '<path d="' + countLine + '" fill="none" stroke="#F7B89C" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>' +
                countDots;
            if (intLine) {
                svg += '<path d="' + intLine + '" fill="none" stroke="#2E3A59" stroke-width="2" stroke-dasharray="4,3" stroke-linecap="round" stroke-linejoin="round"/>' +
                    intDots;
            }
            svg += '</svg>';

            return '<div class="chart-container">' + svg +
                '<div class="chart-legend">' +
                '<div class="chart-legend-item"><div class="chart-legend-dot" style="background:#F7B89C"></div>Crises</div>' +
                '<div class="chart-legend-item"><div class="chart-legend-dot" style="background:#2E3A59"></div>Intensité moy.</div>' +
                '</div></div>';
        }

        /* ---------- GRAPHIQUE : SEUILS CRITIQUES ---------- */

        function buildThresholdsSVG(thresholds) {
            var fields = [
                { key: 'energie', label: 'Énergie avant crise' },
                { key: 'chargeMentale', label: 'Charge mentale' },
                { key: 'chargeSociale', label: 'Charge sociale' }
            ];
            var html = '';
            var hasAny = false;

            for (var f = 0; f < fields.length; f++) {
                var buckets = thresholds[fields[f].key];
                var anyData = false;
                for (var b = 0; b < 3; b++) {
                    if (buckets[b].count > 0) { anyData = true; break; }
                }
                if (!anyData) continue;
                hasAny = true;

                var W = 280, H = 100, padL = 5, padB = 22, padT = 10;
                var barW = 60, gap = 30;
                var totalBarW = 3 * barW + 2 * gap;
                var startX = (W - totalBarW) / 2;
                var chartH = H - padT - padB;
                var maxVal = 10;

                var bars = '';
                var colors = ['#a8d5ba', '#f7d98e', '#f5a5a5'];
                var labels2 = ['0–3', '4–6', '7–10'];

                for (var bi = 0; bi < 3; bi++) {
                    var x = startX + bi * (barW + gap);
                    var val = buckets[bi].avgIntensity || 0;
                    var barH = (val / maxVal) * chartH;
                    var y = padT + chartH - barH;

                    bars += '<rect x="' + x + '" y="' + y + '" width="' + barW + '" height="' + barH + '" rx="4" fill="' + colors[bi] + '"/>';
                    if (val > 0) {
                        bars += '<text x="' + (x + barW / 2) + '" y="' + (y - 4) + '" text-anchor="middle" font-size="12" font-weight="700" fill="#2E3A59">' + val + '</text>';
                    }
                    bars += '<text x="' + (x + barW / 2) + '" y="' + (H - 4) + '" text-anchor="middle" font-size="10" fill="#2E3A59" opacity="0.5">' + labels2[bi] + '</text>';
                    bars += '<text x="' + (x + barW / 2) + '" y="' + (H - 14) + '" text-anchor="middle" font-size="9" fill="#2E3A59" opacity="0.35">(' + buckets[bi].count + ')</text>';
                }

                html += '<div style="margin-bottom:8px">' +
                    '<div style="font-size:13px;font-weight:600;color:var(--dark);opacity:0.7;margin-bottom:4px;padding:0 4px">' + fields[f].label + '</div>' +
                    '<svg viewBox="0 0 ' + W + ' ' + H + '" xmlns="http://www.w3.org/2000/svg">' +
                    '<line x1="' + padL + '" y1="' + (padT + chartH) + '" x2="' + (W - padL) + '" y2="' + (padT + chartH) + '" stroke="#2E3A59" stroke-opacity="0.1"/>' +
                    bars + '</svg></div>';
            }

            if (!hasAny) return '';
            return '<div class="chart-container">' + html + '</div>';
        }

        /* ---------- ANALYSE APPROFONDIE ---------- */

        function buildAnalysis(stats) {
            if (stats.total < 10) {
                return '<div class="analysis-gate">Données insuffisantes pour l\'analyse avancée (minimum 10 crises)</div>';
            }

            var html = '';

            /* 1. Déclencheur × Contexte */
            if (stats.triggerStats.length && stats.profileCounts.length > 1) {
                var topTriggers = stats.triggerStats.slice(0, 5);
                var contextes = [];
                for (var pc = 0; pc < stats.profileCounts.length; pc++) {
                    contextes.push(stats.profileCounts[pc].name);
                }

                var matrix = {};
                for (var ti = 0; ti < topTriggers.length; ti++) {
                    var tn = topTriggers[ti].name;
                    matrix[tn] = {};
                    for (var ci = 0; ci < contextes.length; ci++) matrix[tn][contextes[ci]] = 0;
                }
                for (var ei = 0; ei < stats.entries.length; ei++) {
                    var e = stats.entries[ei];
                    var prof = e.profil || 'commun';
                    var decl = normDeclencheurs(e.declencheurs);
                    for (var di = 0; di < decl.length; di++) {
                        var dn = decl[di].nom;
                        if (matrix[dn] !== undefined && matrix[dn][prof] !== undefined) {
                            matrix[dn][prof]++;
                        }
                    }
                }

                var tbl = '<table class="cross-table"><tr><th></th>';
                for (var ch = 0; ch < contextes.length; ch++) {
                    var cInfo = getProfileName(contextes[ch]);
                    tbl += '<th>' + cInfo.icon + '</th>';
                }
                tbl += '</tr>';
                for (var tr = 0; tr < topTriggers.length; tr++) {
                    tbl += '<tr><td>' + topTriggers[tr].name + '</td>';
                    var maxInRow = 0;
                    for (var cc = 0; cc < contextes.length; cc++) {
                        if (matrix[topTriggers[tr].name][contextes[cc]] > maxInRow) maxInRow = matrix[topTriggers[tr].name][contextes[cc]];
                    }
                    for (var cc2 = 0; cc2 < contextes.length; cc2++) {
                        var val = matrix[topTriggers[tr].name][contextes[cc2]];
                        tbl += '<td' + (val === maxInRow && val > 0 ? ' class="cell-highlight"' : '') + '>' + val + '</td>';
                    }
                    tbl += '</tr>';
                }
                tbl += '</table>';

                html += '<div class="stat-card" style="padding:12px">' +
                    '<div style="font-size:14px;font-weight:700;color:var(--dark);margin-bottom:8px">Déclencheur × Contexte</div>' +
                    tbl + '</div>';
            }

            /* 2. Déclencheur × Type de crise */
            if (stats.triggerStats.length && (stats.meltdownCount > 0 || stats.shutdownCount > 0)) {
                var topT = stats.triggerStats.slice(0, 5);
                var tbl2 = '<table class="cross-table"><tr><th></th><th>% Melt.</th><th>% Shut.</th></tr>';
                for (var t2 = 0; t2 < topT.length; t2++) {
                    var mPct = topT[t2].meltdownPct || 0;
                    tbl2 += '<tr><td>' + topT[t2].name + '</td>' +
                        '<td' + (mPct > 60 ? ' class="cell-highlight"' : '') + '>' + mPct + '%</td>' +
                        '<td' + (mPct < 40 ? ' class="cell-highlight"' : '') + '>' + (100 - mPct) + '%</td></tr>';
                }
                tbl2 += '</table>';

                html += '<div class="stat-card" style="padding:12px;margin-top:6px">' +
                    '<div style="font-size:14px;font-weight:700;color:var(--dark);margin-bottom:8px">Déclencheur × Type de crise</div>' +
                    tbl2 + '</div>';
            }

            /* 3. État × Intensité */
            if (stats.etatCounts.length) {
                var topE = stats.etatCounts.slice(0, 7);
                var tbl3 = '<table class="cross-table"><tr><th>État</th><th>Fréq.</th><th>Int. moy.</th></tr>';
                for (var e3 = 0; e3 < topE.length; e3++) {
                    var eAvg = stats.avgIntensityByEtat[topE[e3].name];
                    var isHigh = eAvg !== null && eAvg >= 7;
                    tbl3 += '<tr><td>' + topE[e3].name + '</td>' +
                        '<td>' + topE[e3].count + '×</td>' +
                        '<td' + (isHigh ? ' class="cell-highlight"' : '') + '>' + (eAvg !== null ? eAvg : '—') + '</td></tr>';
                }
                tbl3 += '</table>';

                html += '<div class="stat-card" style="padding:12px;margin-top:6px">' +
                    '<div style="font-size:14px;font-weight:700;color:var(--dark);margin-bottom:8px">État × Intensité</div>' +
                    tbl3 + '</div>';
            }

            /* 4. Capacités × Type */
            if (stats.capImpCounts.length && (stats.meltdownCount > 0 || stats.shutdownCount > 0)) {
                var topCap = stats.capImpCounts.slice(0, 7);
                var tbl4 = '<table class="cross-table"><tr><th>Capacité</th><th>% Melt.</th><th>% Shut.</th></tr>';
                for (var c4 = 0; c4 < topCap.length; c4++) {
                    var ct = stats.capaciteByType[topCap[c4].name];
                    if (!ct) continue;
                    tbl4 += '<tr><td>' + topCap[c4].name + '</td>' +
                        '<td>' + ct.meltdown + '%</td>' +
                        '<td>' + ct.shutdown + '%</td></tr>';
                }
                tbl4 += '</table>';

                html += '<div class="stat-card" style="padding:12px;margin-top:6px">' +
                    '<div style="font-size:14px;font-weight:700;color:var(--dark);margin-bottom:8px">Capacités × Type de crise</div>' +
                    tbl4 + '</div>';
            }

            /* 5. Distribution par intensité */
            var intRanges = [
                { label: '1–4', min: 1, max: 4 },
                { label: '5–7', min: 5, max: 7 },
                { label: '8–10', min: 8, max: 10 }
            ];
            var intDist = [];
            for (var ir = 0; ir < intRanges.length; ir++) {
                var cnt = 0, triggers5 = {}, contextes5 = {};
                for (var ie = 0; ie < stats.entries.length; ie++) {
                    var iv = parseFloat(stats.entries[ie].intensite);
                    if (isNaN(iv) || iv < intRanges[ir].min || iv > intRanges[ir].max) continue;
                    cnt++;
                    var prof5 = stats.entries[ie].profil || 'commun';
                    contextes5[prof5] = (contextes5[prof5] || 0) + 1;
                    var decl5 = normDeclencheurs(stats.entries[ie].declencheurs);
                    for (var d5 = 0; d5 < decl5.length; d5++) {
                        if (decl5[d5].nom) triggers5[decl5[d5].nom] = (triggers5[decl5[d5].nom] || 0) + 1;
                    }
                }
                var topTrig = null, topCtx = null;
                for (var tk in triggers5) { if (!topTrig || triggers5[tk] > topTrig.count) topTrig = { name: tk, count: triggers5[tk] }; }
                for (var ck in contextes5) { if (!topCtx || contextes5[ck] > topCtx.count) topCtx = { name: ck, count: contextes5[ck] }; }
                intDist.push({ label: intRanges[ir].label, count: cnt, topTrigger: topTrig, topContexte: topCtx });
            }

            if (intDist.some(function(d) { return d.count > 0; })) {
                var tbl5 = '<table class="cross-table"><tr><th>Int.</th><th>Nb</th><th>Déclencheur</th><th>Contexte</th></tr>';
                for (var id5 = 0; id5 < intDist.length; id5++) {
                    var row = intDist[id5];
                    if (row.count === 0) continue;
                    var trigLabel = row.topTrigger ? row.topTrigger.name : '—';
                    var ctxLabel = row.topContexte ? getProfileName(row.topContexte.name).name : '—';
                    tbl5 += '<tr><td>' + row.label + '</td><td>' + row.count + '</td>' +
                        '<td>' + trigLabel + '</td><td>' + ctxLabel + '</td></tr>';
                }
                tbl5 += '</table>';

                html += '<div class="stat-card" style="padding:12px;margin-top:6px">' +
                    '<div style="font-size:14px;font-weight:700;color:var(--dark);margin-bottom:8px">Distribution par intensité</div>' +
                    tbl5 + '</div>';
            }

            return html;
        }

        /* ---------- RENDU : LIGNE BILAN ---------- */

        function bilanRow(label, value, delta, sub) {
            return '<div class="bilan-comp-row">' +
                '<div class="bilan-comp-label">' + label + '</div>' +
                '<div class="bilan-comp-current">' + value + '</div>' +
                '<div class="bilan-comp-prev">' + (delta || '') + '</div>' +
                '</div>' +
                (sub ? '<div class="bilan-minmax">' + sub + '</div>' : '');
        }

        function deltaText(current, prev, unit, invert) {
            if (prev === null || current === null) return '';
            var diff = current - prev;
            if (diff === 0) return '= ' + prev + (unit || '');
            var arrow = diff > 0 ? '↑' : '↓';
            var sign = diff > 0 ? '+' : '';
            return arrow + ' ' + sign + (typeof diff === 'number' ? parseFloat(diff.toFixed(1)) : diff) + (unit || '');
        }

        function deltaPct(current, prev) {
            if (prev === null || current === null || prev === 0) return '';
            var pctDiff = ((current - prev) / prev) * 100;
            var sign = pctDiff > 0 ? '+' : '';
            var arrow = pctDiff > 0 ? '↑' : pctDiff < 0 ? '↓' : '=';
            return arrow + ' ' + sign + Math.round(pctDiff) + '%';
        }

        /* ---------- RENDU PRINCIPAL ---------- */

        function render(days, from, to) {
            var stats = computeStats(days, from, to);
            var last = sinceLastCrisis();
            var main = document.getElementById('mainContent');

            var lastRow = last
                ? '<div class="last-crisis-row"><span class="last-crisis-label">Dernière crise</span><span class="last-crisis-value">' + last + '</span></div>'
                : '';

            if (!stats) {
                main.innerHTML = lastRow +
                    '<div class="empty-state"><div class="empty-icon">📊</div>' +
                    '<div class="empty-text">Aucune crise enregistrée<br>sur cette période.</div></div>';
                return;
            }

            var html = lastRow;

            /* ========== PARTIE 1 — BILAN ========== */
            html += '<div class="section-tag">Bilan</div>';
            html += '<div class="stat-card">';
            html += '<div class="bilan-comp-header"><div class="bilan-comp-spacer"></div>' +
                '<div class="bilan-comp-col-hd col-current">Actuel</div>' +
                '<div class="bilan-comp-col-hd">Évolution</div></div>';

            var prevInt = stats.prev ? stats.prev.avgIntensity : null;
            var prevDur = stats.prev ? stats.prev.avgDuration : null;
            var prevCount = stats.prev ? stats.prev.count : null;

            html += bilanRow('Nombre de crises', '<strong>' + stats.total + '</strong>',
                prevCount !== null ? deltaText(stats.total, prevCount, ' crises') : '');

            html += bilanRow('Intensité moyenne <span class="bilan-unit">(sur 10)</span>',
                stats.avgIntensity !== null ? '<strong>' + stats.avgIntensity + '</strong>' : '—',
                prevInt !== null ? deltaPct(stats.avgIntensity, prevInt) + '<br><span class="bilan-prev-val">(' + prevInt + ')</span>' : '',
                stats.minIntensity !== null && stats.maxIntensity !== null && stats.minIntensity !== stats.maxIntensity
                    ? 'min <strong>' + stats.minIntensity + '</strong> · max <strong>' + stats.maxIntensity + '</strong>' : '');

            html += bilanRow('Durée moyenne',
                stats.avgDuration !== null ? '<strong>' + formatMins(stats.avgDuration) + '</strong>' : '—',
                prevDur !== null ? deltaText(Math.round(stats.avgDuration), Math.round(prevDur), ' min') : '',
                stats.minDuration !== null && stats.maxDuration !== null && stats.minDuration !== stats.maxDuration
                    ? 'min <strong>' + formatMins(stats.minDuration) + '</strong> · max <strong>' + formatMins(stats.maxDuration) + '</strong>' : '');

            var totalTyped = stats.meltdownCount + stats.shutdownCount;
            if (totalTyped > 0) {
                html += bilanRow('Meltdown / Shutdown',
                    '<strong>' + stats.meltdownPct + '%</strong> / <strong>' + stats.shutdownPct + '%</strong>', '');
            }

            if (stats.avgEnergie !== null) {
                html += bilanRow('Énergie avant crise <span class="bilan-unit">(sur 10)</span>',
                    '<strong>' + stats.avgEnergie + '</strong>', '');
            }
            if (stats.avgChargeMentale !== null) {
                html += bilanRow('Charge mentale <span class="bilan-unit">(sur 10)</span>',
                    '<strong>' + stats.avgChargeMentale + '</strong>', '');
            }
            if (stats.avgChargeSociale !== null) {
                html += bilanRow('Charge sociale <span class="bilan-unit">(sur 10)</span>',
                    '<strong>' + stats.avgChargeSociale + '</strong>', '');
            }

            var prevProfile = stats.prev ? stats.prev.topProfile : null;
            if (stats.topProfile) {
                var ctxDelta = '';
                if (prevProfile && prevProfile.name !== stats.topProfile.name) {
                    ctxDelta = 'avant : ' + prevProfile.name;
                } else if (prevProfile) {
                    ctxDelta = '=';
                }
                html += bilanRow('Contexte principal',
                    stats.topProfile.icon + ' ' + stats.topProfile.name + ' <span class="bilan-prev-val">(' + stats.topProfile.count + '×)</span>',
                    ctxDelta);
            }

            if (stats.origineCounts.length) {
                html += bilanRow('Type principal', '<strong>' + stats.origineCounts[0].name + '</strong>' +
                    ' <span class="bilan-prev-val">(' + stats.origineCounts[0].count + '×)</span>', '');
            }

            html += '</div>';

            /* ========== MOMENTS DE LA JOURNÉE ========== */
            html += '<div class="section-tag">Quand</div>';

            var maxDayCount = 0;
            for (var di = 0; di < stats.dayOfWeek.length; di++) {
                if (stats.dayOfWeek[di].count > maxDayCount) maxDayCount = stats.dayOfWeek[di].count;
            }
            if (maxDayCount === 0) maxDayCount = 1;

            var maxMoment = 0;
            for (var mi = 0; mi < stats.hourSlots.length; mi++) {
                if (stats.hourSlots[mi].count > maxMoment) maxMoment = stats.hourSlots[mi].count;
            }

            html += '<div class="stat-card"><div style="padding:10px 16px 4px;font-size:13px;font-weight:700;color:var(--dark);opacity:0.55;text-transform:uppercase">Jour de la semaine</div>';
            html += '<div class="day-grid">';
            for (var dg = 0; dg < stats.dayOfWeek.length; dg++) {
                var day = stats.dayOfWeek[dg];
                var isTop = day.count === maxDayCount && day.count > 0;
                html += '<div class="day-cell' + (isTop ? ' top-day' : '') + '">' +
                    '<div class="day-name">' + day.name + '</div>' +
                    '<div class="day-count">' + day.count + '</div></div>';
            }
            html += '</div></div>';

            var maxHourCount = 0;
            for (var mh = 0; mh < stats.hourSlots.length; mh++) {
                if (stats.hourSlots[mh].count > maxHourCount) maxHourCount = stats.hourSlots[mh].count;
            }

            html += '<div class="moment-grid">';
            for (var hg = 0; hg < stats.hourSlots.length; hg++) {
                var slot = stats.hourSlots[hg];
                var isHighlight = slot.count === maxHourCount && slot.count > 0;
                html += '<div class="moment-cell' + (isHighlight ? ' highlight' : '') + '">' +
                    '<div class="moment-name">' + slot.name + '</div>' +
                    '<div class="moment-range">' + slot.range + '</div>' +
                    '<div class="moment-count">' + slot.count + '</div>';
                if (slot.avgIntensity !== null) {
                    html += '<div style="font-size:11px;opacity:0.6;margin-top:2px">' + slot.avgIntensity + '/10</div>';
                }
                html += '</div>';
            }
            html += '</div>';

            /* ========== CONTEXTES ========== */
            if (stats.profileCounts.length > 1) {
                html += '<div class="section-tag">Contextes</div>';
                html += '<div class="stat-card">';
                for (var pc = 0; pc < stats.profileCounts.length; pc++) {
                    var prof = stats.profileCounts[pc];
                    var pInfo = getProfileName(prof.name);
                    var pBarPct = Math.round((prof.count / stats.total) * 100);
                    var pAvgInt = stats.avgIntensityByContexte[pInfo.name];
                    var pType = stats.percentTypeByContexte[pInfo.name];
                    html += '<div class="rank-item"><div class="rank-header">' +
                        '<div class="rank-name">' + pInfo.icon + ' ' + pInfo.name + '</div>' +
                        '<div class="rank-meta">' + prof.count + '×' +
                        (pAvgInt !== null ? ' · ' + pAvgInt + '/10' : '') +
                        (pType && pType.meltdown > 0 ? ' · ' + pType.meltdown + '% meltdown' : '') +
                        '</div></div>' +
                        '<div class="rank-bar-bg"><div class="rank-bar-fill" style="width:' + pBarPct + '%"></div></div></div>';
                }
                html += '</div>';
            }

            /* ========== ORIGINE ========== */
            if (stats.origineCounts.length) {
                html += '<div class="section-tag">Origine</div>';
                html += '<div class="stat-card">';
                var maxOrig = stats.origineCounts[0].count;
                for (var oi = 0; oi < stats.origineCounts.length; oi++) {
                    var orig = stats.origineCounts[oi];
                    var oIntArr = stats.avgIntensityByType[orig.name];
                    var oDurArr = stats.avgDurationByType[orig.name];
                    html += '<div class="rank-item"><div class="rank-header">' +
                        '<div class="rank-name">' + orig.name + '</div>' +
                        '<div class="rank-meta">' + orig.count + '×' +
                        (oIntArr ? ' · ' + oIntArr + '/10' : '') +
                        (oDurArr ? ' · ~' + formatMins(oDurArr) : '') +
                        '</div></div>' +
                        '<div class="rank-bar-bg"><div class="rank-bar-fill" style="width:' + pct(orig.count, maxOrig) + '%"></div></div></div>';
                }
                html += '</div>';
            }

            /* ========== TYPE MELTDOWN/SHUTDOWN ========== */
            if (totalTyped > 0) {
                html += '<div class="section-tag">Types de crise</div>';
                html += '<div class="stat-card">';
                var typeData = [
                    { name: 'Meltdown', count: stats.meltdownCount },
                    { name: 'Shutdown', count: stats.shutdownCount }
                ];
                for (var ti = 0; ti < typeData.length; ti++) {
                    if (typeData[ti].count === 0) continue;
                    var tAvgI = stats.avgIntensityByType[typeData[ti].name];
                    var tAvgD = stats.avgDurationByType[typeData[ti].name];
                    html += '<div class="rank-item"><div class="rank-header">' +
                        '<div class="rank-name">' + typeData[ti].name + '</div>' +
                        '<div class="rank-meta">' + typeData[ti].count + '× (' + pct(typeData[ti].count, totalTyped) + '%)' +
                        (tAvgI ? ' · ' + tAvgI + '/10' : '') +
                        (tAvgD ? ' · ~' + formatMins(tAvgD) : '') +
                        '</div></div>' +
                        '<div class="rank-bar-bg"><div class="rank-bar-fill" style="width:' + pct(typeData[ti].count, totalTyped) + '%"></div></div></div>';
                }
                html += '</div>';
            }

            /* ========== DÉCLENCHEURS ========== */
            html += renderToggleSection('triggers', 'Déclencheurs', stats.triggerStats, viewModes.triggers);

            /* ========== BESOINS ========== */
            html += renderToggleSection('besoins', 'Besoins exprimés', stats.besoinCounts, viewModes.besoins);

            /* ========== ÉTATS ========== */
            if (stats.etatCounts.length) {
                html += '<div class="section-tag">États ressentis</div>';
                html += '<div class="stat-card">';
                var maxEtat = stats.etatCounts[0].count;
                var topEtats = stats.etatCounts.slice(0, 5);
                for (var ei = 0; ei < topEtats.length; ei++) {
                    var et = topEtats[ei];
                    var eAvgI = stats.avgIntensityByEtat[et.name];
                    html += '<div class="rank-item"><div class="rank-header">' +
                        '<div class="rank-name">' + et.name + '</div>' +
                        '<div class="rank-meta">' + et.count + '×' +
                        (eAvgI !== null ? ' · ' + eAvgI + '/10' : '') +
                        '</div></div>' +
                        '<div class="rank-bar-bg"><div class="rank-bar-fill" style="width:' + pct(et.count, maxEtat) + '%"></div></div></div>';
                }
                if (stats.etatCounts.length > 5) {
                    html += '<div class="no-data">+ ' + (stats.etatCounts.length - 5) + ' autres</div>';
                }
                html += '</div>';
            }

            /* ========== CAPACITÉS ========== */
            if (stats.capImpCounts.length || stats.capDifCounts.length) {
                html += '<div class="section-tag">Capacités impactées</div>';
                html += '<div class="stat-card">';
                if (stats.capImpCounts.length) {
                    html += '<div class="cap-category">Impossible</div>';
                    var topImp = stats.capImpCounts.slice(0, 5);
                    for (var ci = 0; ci < topImp.length; ci++) {
                        var cap = topImp[ci];
                        var cType = stats.capaciteByType[cap.name];
                        html += '<div class="rank-item"><div class="rank-header">' +
                            '<div class="rank-name">' + cap.name + '</div>' +
                            '<div class="rank-meta">' + cap.count + '×' +
                            (cType ? ' · ' + cType.meltdown + '% melt.' : '') +
                            '</div></div></div>';
                    }
                }
                if (stats.capDifCounts.length) {
                    html += '<div class="cap-category cap-sep">Souvent difficile</div>';
                    var topDif = stats.capDifCounts.slice(0, 5);
                    for (var cdi = 0; cdi < topDif.length; cdi++) {
                        var capD = topDif[cdi];
                        html += '<div class="rank-item"><div class="rank-header">' +
                            '<div class="rank-name">' + capD.name + '</div>' +
                            '<div class="rank-meta">' + capD.count + '×</div></div></div>';
                    }
                }
                html += '</div>';
            }

            /* ========== ÉVOLUTION TEMPORELLE ========== */
            var timelineHtml = buildTimelineSVG(stats.timelineEntries, days || 30);
            if (timelineHtml) {
                html += '<div class="section-tag">Évolution temporelle</div>';
                html += timelineHtml;
            }

            /* ========== SEUILS CRITIQUES ========== */
            var thresholdsHtml = buildThresholdsSVG(stats.thresholds);
            if (thresholdsHtml) {
                html += '<div class="section-tag">Seuils critiques</div>';
                html += '<div style="font-size:12px;color:var(--light);opacity:0.5;padding:0 2px 6px">Intensité moyenne de crise selon le niveau avant la crise</div>';
                html += thresholdsHtml;
            }

            /* ========== ANALYSE APPROFONDIE ========== */
            html += '<div class="section-tag">Analyse approfondie</div>';
            html += buildAnalysis(stats);

            /* ========== EXPORT ========== */
            html += '<button class="export-stats-btn" onclick="exportStats()">📋 Copier le résumé</button>';

            main.innerHTML = html;
        }

        /* ---------- EXPORT ---------- */

        function getPeriodLabel() {
            return currentDays === 7 ? '7 derniers jours'
                : currentDays === 30 ? '30 derniers jours'
                : currentDays === 365 ? 'dernière année'
                : 'du ' + customFrom + ' au ' + customTo;
        }

        function buildSummaryText(stats) {
            var periodLabel = getPeriodLabel();
            var text = '== Statistiques Nora — ' + periodLabel + ' ==\n\n';
            text += 'Crises : ' + stats.total;
            if (stats.prev && stats.prev.count > 0) {
                var d = stats.total - stats.prev.count;
                text += ' (' + (d >= 0 ? '+' : '') + d + ' vs période préc.)';
            }
            text += '\n';
            if (stats.avgIntensity !== null) text += 'Intensité moyenne : ' + stats.avgIntensity + '/10\n';
            if (stats.avgDuration !== null) {
                text += 'Durée moyenne : ' + formatMins(stats.avgDuration);
                if (stats.minDuration !== null && stats.maxDuration !== null) text += ' (min ' + formatMins(stats.minDuration) + ' / max ' + formatMins(stats.maxDuration) + ')';
                text += '\n';
            }
            if (stats.topProfile) text += 'Contexte principal : ' + stats.topProfile.name + '\n';
            if (stats.origineCounts && stats.origineCounts.length) text += 'Type le plus fréquent : ' + stats.origineCounts[0].name + ' (' + stats.origineCounts[0].count + ' fois)\n';
            if (stats.meltdownPct > 0 || stats.shutdownPct > 0) text += 'Meltdown / Shutdown : ' + stats.meltdownPct + '% / ' + stats.shutdownPct + '%\n';
            if (stats.avgEnergie !== null) text += 'Énergie moy. avant crise : ' + stats.avgEnergie + '/10\n';
            if (stats.avgChargeMentale !== null) text += 'Charge mentale moy. : ' + stats.avgChargeMentale + '/10\n';
            if (stats.avgChargeSociale !== null) text += 'Charge sociale moy. : ' + stats.avgChargeSociale + '/10\n';
            var last = sinceLastCrisis();
            if (last) text += 'Dernière crise : ' + last + '\n';
            if (stats.triggerStats.length) {
                text += '\nDéclencheurs :\n';
                var top5t = stats.triggerStats.slice(0, 5);
                for (var ti = 0; ti < top5t.length; ti++) text += '  ' + (ti + 1) + '. ' + top5t[ti].name + ' (' + top5t[ti].count + ' fois)\n';
            }
            if (stats.besoinCounts.length) {
                text += '\nBesoins :\n';
                var top5b = stats.besoinCounts.slice(0, 5);
                for (var bi = 0; bi < top5b.length; bi++) text += '  ' + (bi + 1) + '. ' + top5b[bi].name + ' (' + top5b[bi].count + ' fois)\n';
            }
            if (stats.etatCounts.length) {
                text += '\nÉtats :\n';
                var top5e = stats.etatCounts.slice(0, 5);
                for (var ei = 0; ei < top5e.length; ei++) text += '  ' + (ei + 1) + '. ' + top5e[ei].name + ' (' + top5e[ei].count + ' fois)\n';
            }
            if (stats.capImpCounts.length) {
                text += '\nImpossible :\n';
                var top5i = stats.capImpCounts.slice(0, 5);
                for (var ii = 0; ii < top5i.length; ii++) text += '  ' + (ii + 1) + '. ' + top5i[ii].name + ' (' + top5i[ii].count + ' fois)\n';
            }
            if (stats.capDifCounts.length) {
                text += '\nSouvent difficile :\n';
                var top5d = stats.capDifCounts.slice(0, 5);
                for (var di2 = 0; di2 < top5d.length; di2++) text += '  ' + (di2 + 1) + '. ' + top5d[di2].name + ' (' + top5d[di2].count + ' fois)\n';
            }
            text += '\nExport du ' + new Date().toLocaleDateString('fr-FR') + ' — Nora.';
            return text;
        }

        function exportStats() {
            var stats = computeStats(currentDays, customFrom, customTo);
            if (!stats) { alert('Aucune donnée à exporter sur cette période.'); return; }
            var text = buildSummaryText(stats);
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(function() { alert('Résumé copié !'); })
                    .catch(function() { downloadText(text); });
            } else { downloadText(text); }
        }

        function shareStats() {
            var stats = computeStats(currentDays, customFrom, customTo);
            if (!stats) { alert('Aucune donnée à partager sur cette période.'); return; }
            var text = buildSummaryText(stats);
            if (navigator.share) {
                navigator.share({ title: 'Statistiques Nora — ' + getPeriodLabel(), text: text })
                    .catch(function() {});
            } else if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() { alert('Résumé copié dans le presse-papier.'); });
            } else { downloadText(text); }
        }

        function exportPDF() {
            var stats = computeStats(currentDays, customFrom, customTo);
            if (!stats) { alert('Aucune donnée à exporter sur cette période.'); return; }
            var prenom = localStorage.getItem('userPrenom') || '';
            var nom = localStorage.getItem('userNom') || '';
            var nomComplet = [prenom, nom].filter(Boolean).join(' ');
            var titre = 'Statistiques Nora' + (nomComplet ? ' — ' + nomComplet : '');
            titre += ' — ' + getPeriodLabel() + ' — ' + new Date().toLocaleDateString('fr-FR');
            document.getElementById('printHeader').textContent = titre;
            window.print();
        }

        function downloadText(text) {
            var blob = new Blob([text], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'stats-nora-' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        /* ---------- FILTRES AVANCÉS ---------- */

        function initFilterContextes() {
            var journal = getJournal();
            var profils = {};
            for (var i = 0; i < journal.length; i++) {
                var p = journal[i].profil || 'commun';
                profils[p] = true;
            }
            var container = document.getElementById('filterContexte');
            container.innerHTML = '';
            for (var key in profils) {
                var info = getProfileName(key);
                var btn = document.createElement('button');
                btn.className = 'filter-chip';
                btn.setAttribute('data-val', key);
                btn.textContent = info.icon + ' ' + info.name;
                btn.onclick = function() { toggleFilterChip(this); };
                container.appendChild(btn);
            }
        }

        function toggleFilterChip(el) {
            el.classList.toggle('selected');
        }

        function toggleFilterPanel() {
            var overlay = document.getElementById('filterOverlay');
            var panel = document.getElementById('filterPanel');
            overlay.classList.add('visible');
            setTimeout(function() { panel.classList.add('visible'); }, 10);
        }

        function closeFilterPanel() {
            var overlay = document.getElementById('filterOverlay');
            var panel = document.getElementById('filterPanel');
            panel.classList.remove('visible');
            setTimeout(function() { overlay.classList.remove('visible'); }, 300);
        }

        function getSelectedChips(containerId) {
            var chips = document.querySelectorAll('#' + containerId + ' .filter-chip.selected');
            var vals = [];
            for (var i = 0; i < chips.length; i++) vals.push(chips[i].getAttribute('data-val'));
            return vals;
        }

        function applyFilters() {
            activeFilters.contexte = getSelectedChips('filterContexte');
            activeFilters.origine = getSelectedChips('filterOrigine');
            activeFilters.type = getSelectedChips('filterType');
            activeFilters.moment = getSelectedChips('filterMoment');
            activeFilters.intMin = parseInt(document.getElementById('filterIntMin').value, 10);
            activeFilters.intMax = parseInt(document.getElementById('filterIntMax').value, 10);
            updateFilterBadge();
            closeFilterPanel();
            renderCurrent();
        }

        function resetFilters() {
            var chips = document.querySelectorAll('.filter-chip.selected');
            for (var i = 0; i < chips.length; i++) chips[i].classList.remove('selected');
            document.getElementById('filterIntMin').value = 1;
            document.getElementById('filterIntMax').value = 10;
            document.getElementById('filterIntMinLabel').textContent = '1';
            document.getElementById('filterIntMaxLabel').textContent = '10';
            activeFilters = { contexte: [], origine: [], type: [], moment: [], intMin: 1, intMax: 10 };
            updateFilterBadge();
            closeFilterPanel();
            renderCurrent();
        }

        function updateFilterBadge() {
            var count = activeFilters.contexte.length + activeFilters.origine.length +
                activeFilters.type.length + activeFilters.moment.length +
                (activeFilters.intMin > 1 || activeFilters.intMax < 10 ? 1 : 0);
            var badge = document.getElementById('filterBadge');
            var btn = document.getElementById('filterBtn');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
                btn.classList.add('has-filters');
            } else {
                badge.style.display = 'none';
                btn.classList.remove('has-filters');
            }
        }

        function matchesFilters(entry) {
            if (activeFilters.contexte.length && activeFilters.contexte.indexOf(entry.profil || 'commun') === -1) return false;
            if (activeFilters.origine.length && activeFilters.origine.indexOf(entry.typeCrise) === -1) return false;
            var int = parseFloat(entry.intensite);
            if (!isNaN(int) && (int < activeFilters.intMin || int > activeFilters.intMax)) return false;
            if (activeFilters.moment.length) {
                var h = new Date(entry.horodatage).getHours();
                var slot = h < 6 ? 'nuit' : h < 12 ? 'matin' : h < 18 ? 'aprem' : 'soir';
                if (activeFilters.moment.indexOf(slot) === -1) return false;
            }
            return true;
        }

        /* ---------- PÉRIODE ---------- */

        function selectPeriod(days) {
            currentDays = days;
            var btns = document.querySelectorAll('.period-btn');
            for (var i = 0; i < btns.length; i++) {
                btns[i].classList.toggle('active', parseInt(btns[i].getAttribute('data-days'), 10) === days);
            }
            var panel = document.getElementById('dateRangePanel');
            if (days === 0) panel.classList.add('visible');
            else { panel.classList.remove('visible'); renderCurrent(); }
        }

        function applyCustomRange() {
            var from = document.getElementById('dateFrom').value;
            var to = document.getElementById('dateTo').value;
            if (!from || !to) { alert('Choisis une date de début et une date de fin.'); return; }
            if (from > to) { alert('La date de début doit être avant la date de fin.'); return; }
            customFrom = from; customTo = to;
            renderCurrent();
        }

        /* ---------- TOOLTIP DÉFINITION ---------- */

        var _defTimer = null;

        function showDefTooltip(event, name, itemEl) {
            var def = TYPE_DEFS[name] || TRIGGER_DEFS[name];
            if (!def) return;
            var tooltip = document.getElementById('defTooltip');
            tooltip.innerHTML = '<strong>' + name + '</strong><br>' + def;
            tooltip.style.display = 'block';
            var rect = itemEl.getBoundingClientRect();
            var left = rect.left + 8;
            var top = rect.bottom + 6;
            if (left + 244 > window.innerWidth - 6) left = window.innerWidth - 250;
            if (left < 6) left = 6;
            if (top + tooltip.offsetHeight > window.innerHeight - 6) top = rect.top - tooltip.offsetHeight - 6;
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            clearTimeout(_defTimer);
            _defTimer = setTimeout(function() { tooltip.style.display = 'none'; }, 5000);
        }

        document.addEventListener('click', function(e) {
            var item = e.target.closest('.rank-item.has-def');
            if (item) {
                showDefTooltip(e, item.getAttribute('data-def'), item);
            } else if (!e.target.closest('#defTooltip')) {
                document.getElementById('defTooltip').style.display = 'none';
            }
        });

        /* ---------- FILTRES AVANCÉS ---------- */

        function getContextesFromJournal() {
            var journal = getJournal();
            var seen = {}, result = [];
            for (var i = 0; i < journal.length; i++) {
                var p = journal[i].profil || 'commun';
                if (!seen[p]) { seen[p] = true; result.push(p); }
            }
            return result;
        }

        function filterEntries(entries) {
            if (!activeFilters.contexte.length && !activeFilters.origine.length && !activeFilters.type.length) return entries;
            var result = [];
            for (var i = 0; i < entries.length; i++) {
                var e = entries[i];
                var pass = true;
                if (activeFilters.contexte.length && activeFilters.contexte.indexOf(e.profil || 'commun') === -1) pass = false;
                if (pass && activeFilters.origine.length && activeFilters.origine.indexOf(e.typeCrise || '') === -1) pass = false;
                if (pass && activeFilters.type.length && activeFilters.type.indexOf(e.typeManifestation || '') === -1) pass = false;
                if (pass) result.push(e);
            }
            return result;
        }

        function openFilterSheet() {
            pendingFilters = { contexte: activeFilters.contexte.slice(), origine: activeFilters.origine.slice(), type: activeFilters.type.slice() };
            var ctxDiv = document.getElementById('filterContexteChips');
            var contextes = getContextesFromJournal();
            ctxDiv.innerHTML = '';
            if (contextes.length) {
                for (var i = 0; i < contextes.length; i++) {
                    var id = contextes[i];
                    var btn = document.createElement('button');
                    btn.className = 'filter-chip' + (pendingFilters.contexte.indexOf(id) !== -1 ? ' active' : '');
                    btn.setAttribute('data-group', 'contexte');
                    btn.setAttribute('data-value', id);
                    btn.textContent = getProfileName(id);
                    btn.onclick = function() { toggleChip(this); };
                    ctxDiv.appendChild(btn);
                }
            } else {
                ctxDiv.innerHTML = '<span class="filter-empty">Aucun contexte enregistré</span>';
            }
            var fixed = document.querySelectorAll('#filterOrigineChips .filter-chip, #filterTypeChips .filter-chip');
            for (var j = 0; j < fixed.length; j++) {
                var grp = fixed[j].getAttribute('data-group');
                var val = fixed[j].getAttribute('data-value');
                fixed[j].classList.toggle('active', pendingFilters[grp].indexOf(val) !== -1);
            }
            document.getElementById('filterOverlay').classList.add('visible');
            document.getElementById('filterSheet').classList.add('visible');
        }

        function closeFilterSheet() {
            document.getElementById('filterOverlay').classList.remove('visible');
            document.getElementById('filterSheet').classList.remove('visible');
        }

        function toggleChip(btn) {
            var grp = btn.getAttribute('data-group');
            var val = btn.getAttribute('data-value');
            var idx = pendingFilters[grp].indexOf(val);
            if (idx === -1) { pendingFilters[grp].push(val); btn.classList.add('active'); }
            else { pendingFilters[grp].splice(idx, 1); btn.classList.remove('active'); }
        }

        function resetFilters() {
            pendingFilters = { contexte: [], origine: [], type: [] };
            activeFilters = { contexte: [], origine: [], type: [] };
            closeFilterSheet();
            updateFilterBtn();
            renderCurrent();
        }

        function applyFilters() {
            activeFilters = { contexte: pendingFilters.contexte.slice(), origine: pendingFilters.origine.slice(), type: pendingFilters.type.slice() };
            closeFilterSheet();
            updateFilterBtn();
            renderCurrent();
        }

        function updateFilterBtn() {
            var total = activeFilters.contexte.length + activeFilters.origine.length + activeFilters.type.length;
            var btn = document.getElementById('filterBtn');
            if (total > 0) {
                btn.classList.add('has-filters');
                btn.innerHTML = '⚙️ Filtres <span class="filter-badge">' + total + '</span>';
            } else {
                btn.classList.remove('has-filters');
                btn.textContent = '⚙️ Filtres';
            }
        }

        function renderCurrent() {
            try {
                render(currentDays, customFrom, customTo);
            } catch (err) {
                console.error('Stats render error:', err);
                document.getElementById('mainContent').innerHTML =
                    '<div class="empty-state"><div class="empty-icon">⚠️</div><div class="empty-text">Erreur de chargement.<br>Réessaie.</div></div>';
            }
        }

        initFilterContextes();
        renderCurrent();
    </script>
    <script src="nora-scroll.js"></script>
</body>
</html>
