<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="assets/images/favicone.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
    <link rel="stylesheet" href="nora-common.css">
    <title>Nora ‚Äì Journal de crises</title>
    <style>
        body {
            padding-bottom: calc(var(--footer-height) + 20px);
        }

        .footer-action {
            flex: 1;
            height: 46px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            background: rgba(245, 228, 204, 0.15);
            color: var(--light);
            cursor: pointer;
        }

        .footer-action:active { opacity: 0.7; transform: scale(0.98); }

        .header {
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .export-button {
            background: rgba(245, 228, 204, 0.1);
            border: none;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 16px;
            color: var(--light);
            font-weight: 500;
        }

        .export-button:active {
            background-color: rgba(245, 228, 204, 0.2);
            transform: scale(0.95);
        }

        .main-content {
            padding: 20px;
        }

        .add-button {
            background-color: var(--accent);
            color: var(--dark);
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-button:active {
            transform: scale(0.98);
        }

        .table-container {
            background-color: var(--light);
            border-radius: 12px;
            overflow-x: auto;
            overflow-y: visible;
            overscroll-behavior-x: contain;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        thead {
            background-color: #2E3A59;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            color: var(--light);
            font-size: 18px;
            font-weight: 600;
            text-align: left;
            padding: 12px 10px;
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 1px solid rgba(46, 58, 89, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background-color: rgba(247, 184, 156, 0.1);
        }

        tbody tr:active {
            background-color: rgba(247, 184, 156, 0.2);
        }

        td {
            color: var(--dark);
            font-size: 17px;
            padding: 10px 8px;
            vertical-align: top;
            max-width: 200px;
            word-wrap: break-word;
        }

        .date-cell {
            font-weight: normal;
            white-space: nowrap;
        }

        .profile-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .count-badge {
            background-color: var(--accent);
            color: var(--dark);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ---------- BADGE MODAL ---------- */
        .badge-modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .badge-modal-list li {
            padding: 8px 0;
            color: var(--dark);
            border-bottom: 1px solid rgba(46, 58, 89, 0.1);
            font-size: 16px;
        }

        .badge-modal-list li:last-child {
            border-bottom: none;
        }

        /* ---------- BADGE TOOLTIP ---------- */
        #badgeTooltip {
            position: fixed;
            background: var(--dark);
            color: var(--light);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 0.82rem;
            line-height: 1.6;
            box-shadow: 0 4px 16px rgba(0,0,0,0.45);
            max-width: 210px;
            z-index: 500;
            display: none;
            border: 1px solid rgba(245,228,204,0.15);
        }

        .badge-modal-empty {
            color: var(--dark);
            opacity: 0.5;
            font-style: italic;
            margin: 0;
        }

        .actions-cell {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            transition: transform 0.2s;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--light);
            opacity: 0.6;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.visible {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--light);
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            margin: 20px auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-top: 4px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
            padding-top: 8px;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 32px;
            color: var(--dark);
            cursor: pointer;
            line-height: 1;
            padding: 0;
            margin: -8px -8px 0 0;
        }

        .modal-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(46, 58, 89, 0.1);
        }

        .modal-section:last-of-type {
            border-bottom: none;
        }

        .modal-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-text {
            color: var(--dark);
            font-size: 16px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 6px;
            display: block;
        }

        .form-required {
            color: var(--accent);
            font-weight: bold;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(46, 58, 89, 0.2);
            border-radius: 8px;
            padding: 10px;
            font-family: inherit;
            font-size: 16px;
            color: var(--dark);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .duration-picker {
            display: flex;
            gap: 8px;
        }

        .duration-picker .form-select {
            flex: 1;
        }

        .intensity-slider {
            width: 100%;
            margin-top: 8px;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: #384657;
            outline: none;
        }

        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #F7B89C;
            cursor: pointer;
            border-radius: 50%;
            margin-top: -8px;
        }

        .intensity-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #F7B89C;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .intensity-slider::-webkit-slider-runnable-track {
            background: #384657;
            height: 8px;
            border-radius: 4px;
        }

        .intensity-slider::-moz-range-track {
            background: #384657;
            height: 8px;
            border-radius: 4px;
        }

        .intensity-display {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: var(--dark);
            margin: 10px 0;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-button {
            flex: 1;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .modal-button.primary {
            background-color: var(--accent);
            color: var(--dark);
        }

        .modal-button.secondary {
            background-color: rgba(46, 58, 89, 0.1);
            color: var(--dark);
        }

        .modal-button.danger {
            background-color: rgba(255, 70, 70, 0.8);
            color: var(--light);
        }

        .modal-button:active {
            transform: scale(0.98);
        }

        .triggers-button {
            background-color: #2E3A59;
            border: 2px solid #384657;
            color: var(--light);
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .triggers-button:hover {
            background-color: #485A70;
        }

        .triggers-button:active {
            background-color: #384657;
        }

        .triggers-preview {
            background-color: rgba(46, 58, 89, 0.05);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            font-size: 15px;
            color: var(--dark);
            min-height: 30px;
        }

        .triggers-modal {
            z-index: 300;
        }

        .triggers-modal .modal-content {
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .triggers-modal .modal-actions {
            position: sticky;
            bottom: 0;
            background-color: var(--light);
            padding: 16px 0 0 0;
            margin-top: 20px;
            border-top: 2px solid rgba(46, 58, 89, 0.1);
        }

        .triggers-info {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 15px;
            background-color: rgba(46, 58, 89, 0.05);
            padding: 10px;
            border-radius: 6px;
            font-style: italic;
        }

        .trigger-category {
            margin-bottom: 20px;
        }

        .trigger-category-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid #F7B89C;
        }

        .trigger-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .trigger-item:hover {
            background-color: rgba(247, 184, 156, 0.1);
        }

        .trigger-checkbox {
            margin-top: 2px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #2E3A59;
        }

        .trigger-label {
            flex: 1;
            cursor: pointer;
            line-height: 1.4;
            font-size: 15px;
        }

        .trigger-name {
            font-weight: 600;
            color: var(--dark);
        }

        .trigger-description {
            font-weight: 400;
            color: var(--dark);
            opacity: 0.8;
            font-size: 15px;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 20px;
        }

        .export-option {
            background-color: #2E3A59;
            border: 2px solid #384657;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-option:hover {
            border-color: var(--accent);
            background-color: #485A70;
        }

        .export-option:active {
            transform: scale(0.98);
        }

        .export-option-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--light);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-option-desc {
            font-size: 15px;
            color: var(--light);
            opacity: 0.8;
            line-height: 1.4;
        }

        /* ---------- PR√â-CRISE ---------- */
        .precrisis-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 90px;
        }

        .precrisis-row {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: var(--dark);
        }

        .precrisis-bar-wrap {
            flex: 1;
            height: 5px;
            background: rgba(46, 58, 89, 0.12);
            border-radius: 3px;
            overflow: hidden;
        }

        .precrisis-bar {
            height: 100%;
            border-radius: 3px;
        }

        .precrisis-num {
            font-size: 12px;
            font-weight: 600;
            min-width: 24px;
            text-align: right;
        }

        /* ---------- PR√â-CRISE dans vue d√©tail ---------- */
        .precrisis-detail-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .precrisis-detail-icon {
            font-size: 18px;
            width: 24px;
            flex-shrink: 0;
        }

        .precrisis-detail-info {
            flex: 1;
        }

        .precrisis-detail-label {
            font-size: 14px;
            color: var(--dark);
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .precrisis-detail-bar-wrap {
            height: 8px;
            background: rgba(46, 58, 89, 0.12);
            border-radius: 4px;
            overflow: hidden;
        }

        .precrisis-detail-bar {
            height: 100%;
            border-radius: 4px;
        }

        .precrisis-detail-val {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            min-width: 36px;
            text-align: right;
        }

        /* ---------- PR√â-CRISE dans formulaire ---------- */
        .precrisis-form-group {
            margin-bottom: 16px;
        }

        .precrisis-form-slider {
            width: 100%;
            margin-top: 8px;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: #384657;
            outline: none;
        }

        .precrisis-form-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #F7B89C;
            cursor: pointer;
            border-radius: 50%;
        }

        .precrisis-form-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #F7B89C;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .precrisis-form-display {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--dark);
            margin: 6px 0 2px;
        }

        .precrisis-form-hint {
            font-size: 12px;
            color: var(--dark);
            opacity: 0.5;
            text-align: center;
        }

        @media (max-width: 600px) {
            .table-container {
                border-radius: 0;
            }
            th, td {
                font-size: 15px;
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left" style="flex:1">
            <button class="back-button" onclick="goHome()" aria-label="Retour">‚¨ÖÔ∏è</button>
            <h1 class="page-title">Journal de crises</h1>
        </div>
        <button class="back-button" onclick="window.location.href='index.html'">üè†</button>
    </header>

    <main class="main-content">
        <button class="add-button" onclick="openFormModal('create')">
            ‚ûï Ajouter une crise manuellement
        </button>

        <div class="table-container" id="tableContainer">
            <table id="crisisTable">
                <thead>
                    <tr>
                        <th style="width: 80px;">Date<br>Heure</th>
                        <th style="width: 90px;">Contexte</th>
                        <th style="width: 110px;">Origine</th>
                        <th style="width: 110px;">Type</th>
                        <th style="width: 70px;">Intensit√©</th>
                        <th style="width: 80px;">Dur√©e</th>
                        <th style="min-width: 220px;">D√©clencheurs</th>
                        <th style="width: 80px;">Cap.</th>
                        <th style="width: 80px;">Bes.</th>
                        <th style="width: 80px;">√âtats</th>
                        <th style="width: 100px;">√âtat avant</th>
                        <th>Remarques</th>
                        <th style="text-align: center; width: 60px;">üîß</th>
                    </tr>
                </thead>
                <tbody id="journalTableBody">
                </tbody>
            </table>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üìî</div>
            <div>Aucune crise enregistr√©e</div>
        </div>
    </main>

    <div class="modal" id="detailModal" onclick="closeModal(event, 'detailModal')" role="dialog" aria-modal="true" aria-label="D√©tail de la crise">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">D√©tail de la crise</h2>
                <button class="close-button" onclick="closeModal(null, 'detailModal')" aria-label="Fermer">√ó</button>
            </div>
            <div id="detailContent"></div>
            <div class="modal-actions">
                <button class="modal-button secondary" onclick="editFromDetail()">‚úèÔ∏è Modifier</button>
                <button class="modal-button danger" onclick="confirmDelete()">üóëÔ∏è Supprimer</button>
                <button class="modal-button primary" onclick="closeModal(null, 'detailModal')">Fermer</button>
            </div>
        </div>
    </div>

    <div class="modal" id="formModal" onclick="closeModal(event, 'formModal')" role="dialog" aria-modal="true" aria-label="Nouvelle entr√©e">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="formModalTitle">Ajouter une crise</h2>
                <button class="close-button" onclick="closeModal(null, 'formModal')" aria-label="Fermer">√ó</button>
            </div>
            
            <div class="form-group" id="dateGroup">
                <label class="form-label">Date <span class="form-required">*</span></label>
                <input type="date" class="form-input" id="formDate" required>
            </div>

            <div class="form-group">
                <label class="form-label">Heure (optionnel)</label>
                <input type="time" class="form-input" id="formTime">
            </div>

            <div class="form-group">
                <label class="form-label">Origine</label>
                <select class="form-select" id="formType">
                    <option value="">Non pr√©cis√©</option>
                    <option value="Anticipatoire">Anticipatoire</option>
                    <option value="R√©actionnelle">R√©actionnelle</option>
                    <option value="Mixte">Mixte</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Type de crise</label>
                <select class="form-select" id="formTypeManifestation">
                    <option value="">Non pr√©cis√©</option>
                    <option value="Meltdown">Meltdown (explosion externe, perte de contr√¥le)</option>
                    <option value="Shutdown">Shutdown (repli int√©rieur, effacement)</option>
                    <option value="Mixte">Mixte (meltdown et shutdown combin√©s)</option>
                    <option value="Inconnu">Je ne sais pas</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Intensit√© (1 = l√©g√®re, 10 = tr√®s intense)</label>
                <input type="range" class="intensity-slider" id="formIntensity" min="1" max="10" value="5" oninput="updateFormIntensityDisplay()">
                <div class="intensity-display" id="formIntensityDisplay">5/10</div>
            </div>

            <div class="form-group">
                <label class="form-label">Dur√©e estim√©e</label>
                <input type="text" class="form-input" id="formDuration" placeholder="Ex: 30 min, 1h30...">
            </div>

            <div class="form-group">
                <label class="form-label">√ânergie avant la crise (1 = √©puis√©, 10 = en forme)</label>
                <input type="range" class="intensity-slider" id="formEnergie" min="1" max="10" value="5" oninput="document.getElementById('formEnergieDisplay').textContent=this.value+'/10'">
                <div class="intensity-display" id="formEnergieDisplay">5/10</div>
            </div>

            <div class="form-group">
                <label class="form-label">Charge mentale (1 = l√©g√®re, 10 = satur√©e)</label>
                <input type="range" class="intensity-slider" id="formChargeMentale" min="1" max="10" value="5" oninput="document.getElementById('formChargeMentaleDisplay').textContent=this.value+'/10'">
                <div class="intensity-display" id="formChargeMentaleDisplay">5/10</div>
            </div>

            <div class="form-group">
                <label class="form-label">Charge sociale (1 = l√©g√®re, 10 = satur√©e)</label>
                <input type="range" class="intensity-slider" id="formChargeSociale" min="1" max="10" value="5" oninput="document.getElementById('formChargeSocialeDisplay').textContent=this.value+'/10'">
                <div class="intensity-display" id="formChargeSocialeDisplay">5/10</div>
            </div>

            <div class="form-group">
                <label class="form-label">D√©clencheurs identifi√©s</label>
                <button type="button" class="triggers-button" onclick="openTriggersModal()">
                    <span>üéØ</span>
                    <span>S√©lectionner les d√©clencheurs</span>
                </button>
                <div class="triggers-preview" id="triggersPreview">Aucun d√©clencheur s√©lectionn√©</div>
            </div>

            <div class="form-group">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                    <input type="checkbox" id="formPrecrisisEnabled" style="width:18px;height:18px;accent-color:#2E3A59;cursor:pointer;" onchange="togglePrecrisisForm()">
                    <label for="formPrecrisisEnabled" class="form-label" style="margin:0;cursor:pointer;">Renseigner l'√©tat avant la crise</label>
                </div>

                <div id="precrisisFormFields" style="display:none;">
                    <div class="precrisis-form-group">
                        <label class="form-label" style="font-size:14px; font-weight:500;">‚ö° √ânergie <span style="font-weight:400; opacity:0.6;">(0 = √©puis√© ¬∑ 100 = plein d'√©nergie)</span></label>
                        <input type="range" class="precrisis-form-slider" id="formEnergie" min="0" max="100" value="50" oninput="updateFormPrecrisis('Energie')">
                        <div class="precrisis-form-display" id="formEnergieDisplay">50 ‚Äî Mod√©r√©e</div>
                    </div>

                    <div class="precrisis-form-group">
                        <label class="form-label" style="font-size:14px; font-weight:500;">üß† Charge mentale <span style="font-weight:400; opacity:0.6;">(0 = l√©g√®re ¬∑ 100 = satur√©)</span></label>
                        <input type="range" class="precrisis-form-slider" id="formMentale" min="0" max="100" value="50" oninput="updateFormPrecrisis('Mentale')">
                        <div class="precrisis-form-display" id="formMentaleDisplay">50 ‚Äî Mod√©r√©e</div>
                    </div>

                    <div class="precrisis-form-group">
                        <label class="form-label" style="font-size:14px; font-weight:500;">üë• Charge sociale <span style="font-weight:400; opacity:0.6;">(0 = l√©g√®re ¬∑ 100 = satur√©e)</span></label>
                        <input type="range" class="precrisis-form-slider" id="formSociale" min="0" max="100" value="50" oninput="updateFormPrecrisis('Sociale')">
                        <div class="precrisis-form-display" id="formSocialeDisplay">50 ‚Äî Mod√©r√©e</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Remarques (optionnel)</label>
                <textarea class="form-textarea" id="formRemarks" placeholder="Contexte, sensations, ce qui a aid√©..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="modal-button secondary" onclick="closeModal(null, 'formModal')">Annuler</button>
                <button class="modal-button primary" onclick="saveForm()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <div class="modal triggers-modal" id="triggersModal" onclick="closeModal(event, 'triggersModal')" role="dialog" aria-modal="true" aria-label="D√©clencheurs">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">S√©lectionner les d√©clencheurs</h2>
                <button class="close-button" onclick="closeModal(null, 'triggersModal')" aria-label="Fermer">√ó</button>
            </div>
            <p class="triggers-info">üí° Tu peux s√©lectionner plusieurs d√©clencheurs</p>

            <div id="triggersContent"></div>

            <div class="modal-actions">
                <button class="modal-button primary" onclick="validateTriggers()">‚úÖ Valider</button>
            </div>
        </div>
    </div>

    <div class="modal" id="exportModal" onclick="closeModal(event, 'exportModal')" role="dialog" aria-modal="true" aria-label="Exporter">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">Exporter le journal</h2>
                <button class="close-button" onclick="closeModal(null, 'exportModal')" aria-label="Fermer">√ó</button>
            </div>

            <div class="export-options">
                <div class="export-option" onclick="exportPDF()">
                    <div class="export-option-title">üìÑ Export PDF / Impression</div>
                    <div class="export-option-desc">
                        Ouvre une vue lisible de toutes tes crises. Utilise le bouton "Imprimer" ou "Enregistrer en PDF" de ton navigateur. Id√©al pour partager avec un professionnel de sant√©.
                    </div>
                </div>

                <div class="export-option" onclick="exportJSON()">
                    <div class="export-option-title">üíæ Export JSON</div>
                    <div class="export-option-desc">
                        Format de sauvegarde technique. Permet de r√©importer tes donn√©es ou de les transf√©rer sur un autre appareil en conservant toutes les informations.
                    </div>
                </div>

                <div class="export-option" onclick="shareJournal()">
                    <div class="export-option-title">‚ÜóÔ∏è Partager le journal</div>
                    <div class="export-option-desc">
                        Partage un r√©sum√© textuel de tes crises via l'application de ton choix (messagerie, e-mail‚Ä¶). Id√©al pour un envoi rapide √† un professionnel.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="badgeTooltip"></div>

    <div class="modal" id="badgeModal" onclick="closeModal(event, 'badgeModal')" role="dialog" aria-modal="true" aria-label="D√©tail">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 360px;">
            <div class="modal-header">
                <h2 class="modal-title" id="badgeModalTitle"></h2>
                <button class="close-button" onclick="closeModal(null, 'badgeModal')" aria-label="Fermer">√ó</button>
            </div>
            <div id="badgeModalList"></div>
        </div>
    </div>

    <script>
        // Profils statiques par d√©faut + dynamiques depuis localStorage
        function getProfiles() {
            const profiles = {
                commun: { icon: 'üåê', name: 'Profil commun' },
                maison: { icon: 'üè†', name: 'Maison' },
                exterieur: { icon: 'üåç', name: 'Ext√©rieur' },
                travail: { icon: 'üíº', name: 'Travail' },
                secours: { icon: 'üöë', name: 'Secours' }
            };
            // Ajouter les contextes personnalis√©s
            const contextes = JSON.parse(localStorage.getItem('contextes') || '[]');
            contextes.forEach(ctx => {
                if (ctx.id && !profiles[ctx.id]) {
                    profiles[ctx.id] = { icon: ctx.emoji || 'üìç', name: ctx.nom || ctx.id };
                }
            });
            return profiles;
        }
        const PROFILES = getProfiles();

        const TRIGGERS = {
            "Hypersensibilit√© et Surcharges Sensorielles": [
                { name: "Auditif", desc: "Pr√©sence de bruits latents (bourdonnements, bruits de fond subtils) ou survenue de bruits soudains" },
                { name: "Visuel", desc: "Variations brusques de luminosit√© ou exposition √† des lumi√®res trop fortes" },
                { name: "Olfactif", desc: "Perception d'odeurs d√©rangeantes" },
                { name: "Tactile", desc: "Contact physique (quelqu'un qui nous touche) ou confrontation √† certaines textures alimentaires" },
                { name: "Proprioceptive", desc: "Difficult√©s √† se repr√©senter dans l'espace ou ressenti d'un inconfort spatio-temporel" },
                { name: "Surcharge √©motionnelle", desc: "Accumulation d'√©motions intenses" }
            ],
            "Pr√©visibilit√© et Contr√¥le de l'Environnement": [
                { name: "Instabilit√©", desc: "Arriv√©e d'un changement, d'un impr√©vu ou d'une interaction impr√©visible" },
                { name: "Zone Secure", desc: "Modification de la zone secure ou obligation de s'en √©loigner" },
                { name: "Perturbation de l'organisation ou des routines personnelles", desc: "Rupture de structure habituelle" },
                { name: "Non-respect des r√®gles", desc: "Cadre : non respect√©, r√®gle enfreinte" },
                { name: "Injustice", desc: "Confrontation √† une situation ou un v√©cu injuste / non √©thique" },
                { name: "Intrusion", desc: "dans la zone secure / ton espace personnel" }
            ],
            "Contacts sociaux": [
                { name: "Situations sociales", desc: "Participation √† des occasions sociales ou √† des conversations superficielles (small talk)" },
                { name: "Traitement social", desc: "Difficult√© √† lire les visages ou probl√®mes de compr√©hension dans les √©changes. difficult√© d'expression ou de compr√©hension ou de traduction des sous-entendus ou des messages de l'autre)" },
                { name: "Barri√®re de communication", desc: "Difficult√© √† s'exprimer ou √† traduire la pens√©e de l'autre" }
            ],
            "Fonctions Ex√©cutives": [
                { name: "Gestion du temps", desc: "Difficult√© de planification et de projection (dans le temps ou dans des sc√©narios abstraits)" },
                { name: "Surcharge cognitive", desc: "Trop d'informations ou de t√¢ches √† traiter simultan√©ment ou non" },
                { name: "Pression de r√©sultat", desc: "Exigence de pr√©cision, de perfection et de performance" },
                { name: "Besoin imp√©rieux de corriger les erreurs", desc: "R√©action cognitive : face √† une erreur avec un besoin presque incontr√¥lable de corriger cette erreur. Peut parfois entra√Æner des ruminations" }
            ]
        };

        function precrisisColor(val, isEnergie) {
            // √ânergie : haut = bon (vert) ; Charges : haut = mauvais (rouge)
            var ratio = isEnergie ? val / 100 : 1 - val / 100;
            if (ratio >= 0.67) return '#4caf80';
            if (ratio >= 0.34) return '#f5a623';
            return '#e05c5c';
        }

        function precrisisLabel(val) {
            if (val <= 33) return 'Faible';
            if (val <= 66) return 'Mod√©r√©e';
            return '√âlev√©e';
        }

        let currentEntryIndex = null;
        let formMode = 'create';
        let selectedTriggers = [];

        function togglePrecrisisForm() {
            var enabled = document.getElementById('formPrecrisisEnabled').checked;
            document.getElementById('precrisisFormFields').style.display = enabled ? 'block' : 'none';
        }

        function updateFormPrecrisis(key) {
            var val = parseInt(document.getElementById('form' + key).value);
            var label = val <= 33 ? 'Faible' : val <= 66 ? 'Mod√©r√©e' : '√âlev√©e';
            document.getElementById('form' + key + 'Display').textContent = val + ' ‚Äî ' + label;
        }

        function loadJournal() {
            const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
            const tbody = document.getElementById('journalTableBody');
            const tableContainer = document.getElementById('tableContainer');
            const emptyState = document.getElementById('emptyState');

            if (journal.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            tbody.innerHTML = '';

            journal.sort((a, b) => new Date(b.horodatage) - new Date(a.horodatage));

            journal.forEach((entry, index) => {
                const row = createTableRow(entry, index);
                tbody.appendChild(row);
            });
        }

        function formatDuration(h, m) {
            if (h === 0 && m === 0) return '';
            if (h === 0) return m + ' min';
            if (m === 0) return h + 'h';
            return h + 'h' + String(m).padStart(2, '0');
        }

        function parseDurationString(str) {
            if (!str) return { h: 0, m: 0 };
            str = str.trim();
            var hMatch = str.match(/^(\d+)h(\d+)?$/);
            if (hMatch) {
                return { h: parseInt(hMatch[1]), m: hMatch[2] ? parseInt(hMatch[2]) : 0 };
            }
            var minMatch = str.match(/^(\d+)\s*min/);
            if (minMatch) {
                var total = parseInt(minMatch[1]);
                return { h: Math.floor(total / 60), m: total % 60 };
            }
            return { h: 0, m: 0 };
        }

        function snapToFive(m) {
            return Math.min(55, Math.round(m / 5) * 5);
        }

        function createTableRow(entry, index) {
            const date = new Date(entry.horodatage);
            const dateStr = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' });
            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            const profile = PROFILES[entry.profil] || { icon: entry.profilEmoji || 'üìç', name: entry.profilNom || '?' };

            const capsCount = (entry.capacites?.impossible?.length || 0) +
                            (entry.capacites?.difficile?.length || 0) + 
                            (entry.capacites?.possible?.length || 0) + 
                            (entry.capacites?.incertain?.length || 0);
            const needsCount = entry.besoins?.length || 0;
            const statesCount = entry.etats?.length || 0;

            const row = document.createElement('tr');
            row.onclick = () => showDetail(index);
            
            let intensityDisplay = '-';
            if (entry.intensite !== undefined && entry.intensite !== '') {
                intensityDisplay = `${entry.intensite}/10`;
            }

            const triggersDisplay = entry.declencheurs && entry.declencheurs.length > 0 
                ? entry.declencheurs.join(', ') 
                : '-';
            
            let precrisisCell = '<td>-</td>';
            if (entry.precrisis) {
                const pc = entry.precrisis;
                precrisisCell = `<td>
                    <div class="precrisis-cell">
                        <div class="precrisis-row">
                            <span>‚ö°</span>
                            <div class="precrisis-bar-wrap"><div class="precrisis-bar" style="width:${pc.energie}%;background:${precrisisColor(pc.energie, true)}"></div></div>
                            <span class="precrisis-num" style="color:${precrisisColor(pc.energie, true)}">${pc.energie}</span>
                        </div>
                        <div class="precrisis-row">
                            <span>üß†</span>
                            <div class="precrisis-bar-wrap"><div class="precrisis-bar" style="width:${pc.chargeMentale}%;background:${precrisisColor(pc.chargeMentale, false)}"></div></div>
                            <span class="precrisis-num" style="color:${precrisisColor(pc.chargeMentale, false)}">${pc.chargeMentale}</span>
                        </div>
                        <div class="precrisis-row">
                            <span>üë•</span>
                            <div class="precrisis-bar-wrap"><div class="precrisis-bar" style="width:${pc.chargeSociale}%;background:${precrisisColor(pc.chargeSociale, false)}"></div></div>
                            <span class="precrisis-num" style="color:${precrisisColor(pc.chargeSociale, false)}">${pc.chargeSociale}</span>
                        </div>
                    </div>
                </td>`;
            }

            row.innerHTML = `
                <td class="date-cell">${dateStr}<br>${timeStr}</td>
                <td style="white-space: nowrap;"><div class="profile-cell">${profile.icon} ${profile.name}</div></td>
                <td>${entry.typeCrise || '-'}</td>
                <td>${entry.typeManifestation || '-'}</td>
                <td>${intensityDisplay}</td>
                <td>${entry.duree || '-'}</td>
                <td style="min-width: 220px; max-width: 260px;">${triggersDisplay}</td>
                <td><span class="count-badge" onclick="event.stopPropagation(); openBadgeModal(this, ${index}, 'caps')">${capsCount}</span></td>
                <td><span class="count-badge" onclick="event.stopPropagation(); openBadgeModal(this, ${index}, 'besoins')">${needsCount}</span></td>
                <td><span class="count-badge" onclick="event.stopPropagation(); openBadgeModal(this, ${index}, 'etats')">${statesCount}</span></td>
                ${precrisisCell}
                <td style="max-width: 200px;">${entry.remarques || '-'}</td>
                <td class="actions-cell" style="white-space: nowrap;">
                    <button class="action-btn" onclick="event.stopPropagation(); openFormModal('edit', ${index})" title="Modifier">‚úèÔ∏è</button>
                    <button class="action-btn" onclick="event.stopPropagation(); deleteEntry(${index})" title="Supprimer">üóëÔ∏è</button>
                </td>
            `;
            
            return row;
        }

        function showDetail(index) {
            currentEntryIndex = index;
            const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
            journal.sort((a, b) => new Date(b.horodatage) - new Date(a.horodatage));
            const entry = journal[index];
            
            const date = new Date(entry.horodatage);
            const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            const profile = PROFILES[entry.profil] || { icon: entry.profilEmoji || 'üìç', name: entry.profilNom || '?' };
            
            let intensityText = '-';
            if (entry.intensite !== undefined && entry.intensite !== '') {
                intensityText = `${entry.intensite}/10`;
            }
            
            let html = `
                <div class="modal-section">
                    <div class="modal-section-title">üìÖ Informations g√©n√©rales</div>
                    <div class="modal-text"><strong>Date :</strong> ${dateStr} √† ${timeStr}</div>
                    <div class="modal-text"><strong>Contexte :</strong> ${profile.name}</div>
                    ${entry.typeCrise ? `<div class="modal-text"><strong>Origine :</strong> ${entry.typeCrise}</div>` : ''}
                    ${entry.typeManifestation ? `<div class="modal-text"><strong>Type de crise :</strong> ${entry.typeManifestation}</div>` : ''}
                    ${entry.intensite !== undefined && entry.intensite !== '' ? `<div class="modal-text"><strong>Intensit√© :</strong> ${intensityText}</div>` : ''}
                    ${entry.duree ? `<div class="modal-text"><strong>Dur√©e :</strong> ${entry.duree}</div>` : ''}
                </div>
            `;
            
            if (entry.declencheurs && entry.declencheurs.length > 0) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">üéØ D√©clencheurs identifi√©s</div>
                        <div class="modal-text">${entry.declencheurs.join(', ')}</div>
                    </div>
                `;
            }
            
            if (entry.precrisis) {
                const pc = entry.precrisis;
                const rows = [
                    { icon: '‚ö°', label: '√ânergie', val: pc.energie, isEnergie: true },
                    { icon: 'üß†', label: 'Charge mentale', val: pc.chargeMentale, isEnergie: false },
                    { icon: 'üë•', label: 'Charge sociale', val: pc.chargeSociale, isEnergie: false }
                ];
                html += `<div class="modal-section"><div class="modal-section-title">üîã √âtat avant la crise</div>`;
                rows.forEach(r => {
                    if (r.val !== undefined && r.val !== null) {
                        const color = precrisisColor(r.val, r.isEnergie);
                        html += `
                            <div class="precrisis-detail-row">
                                <div class="precrisis-detail-icon">${r.icon}</div>
                                <div class="precrisis-detail-info">
                                    <div class="precrisis-detail-label">${r.label} ‚Äî ${precrisisLabel(r.val)}</div>
                                    <div class="precrisis-detail-bar-wrap">
                                        <div class="precrisis-detail-bar" style="width:${r.val}%;background:${color}"></div>
                                    </div>
                                </div>
                                <div class="precrisis-detail-val" style="color:${color}">${r.val}/100</div>
                            </div>`;
                    }
                });
                html += `</div>`;
            }

            if (entry.remarques) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">üìù Remarques</div>
                        <div class="modal-text">${entry.remarques}</div>
                    </div>
                `;
            }

            document.getElementById('detailContent').innerHTML = html;
            document.getElementById('detailModal').classList.add('visible');
        }

        function openFormModal(mode, index = null) {
            formMode = mode;
            currentEntryIndex = index;
            
            const modalTitle = document.getElementById('formModalTitle');
            const dateGroup = document.getElementById('dateGroup');
            
            if (mode === 'create') {
                modalTitle.textContent = 'Ajouter une crise manuellement';
                dateGroup.style.display = 'block';
                
                const now = new Date();
                const ty = now.getFullYear();
                const tm = String(now.getMonth() + 1).padStart(2, '0');
                const td = String(now.getDate()).padStart(2, '0');
                document.getElementById('formDate').value = `${ty}-${tm}-${td}`;
                document.getElementById('formTime').value = '';
                document.getElementById('formType').value = '';
                document.getElementById('formTypeManifestation').value = '';
                document.getElementById('formIntensity').value = '5';
                updateFormIntensityDisplay();
                document.getElementById('formDuration').value = '';
                document.getElementById('formEnergie').value = '5';
                document.getElementById('formEnergieDisplay').textContent = '5/10';
                document.getElementById('formChargeMentale').value = '5';
                document.getElementById('formChargeMentaleDisplay').textContent = '5/10';
                document.getElementById('formChargeSociale').value = '5';
                document.getElementById('formChargeSocialeDisplay').textContent = '5/10';
                document.getElementById('formRemarks').value = '';
                selectedTriggers = [];
                updateTriggersPreview();
                document.getElementById('formPrecrisisEnabled').checked = false;
                document.getElementById('precrisisFormFields').style.display = 'none';
                ['Energie', 'Mentale', 'Sociale'].forEach(function(k) {
                    document.getElementById('form' + k).value = 50;
                    updateFormPrecrisis(k);
                });
            } else {
                modalTitle.textContent = 'Modifier la crise';
                dateGroup.style.display = 'block';

                const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
                journal.sort((a, b) => new Date(b.horodatage) - new Date(a.horodatage));
                const entry = journal[index];

                // Pr√©-remplir date et heure depuis l'horodatage
                const d = new Date(entry.horodatage);
                const yr = d.getFullYear();
                const mo = String(d.getMonth() + 1).padStart(2, '0');
                const dy = String(d.getDate()).padStart(2, '0');
                document.getElementById('formDate').value = `${yr}-${mo}-${dy}`;
                const fh = String(d.getHours()).padStart(2, '0');
                const fm = String(d.getMinutes()).padStart(2, '0');
                document.getElementById('formTime').value = `${fh}:${fm}`;

                document.getElementById('formType').value = entry.typeCrise || '';
                document.getElementById('formTypeManifestation').value = entry.typeManifestation || '';
                document.getElementById('formIntensity').value = entry.intensite || '5';
                updateFormIntensityDisplay();
                document.getElementById('formDuration').value = entry.duree || '';
                document.getElementById('formEnergie').value = entry.energie || '5';
                document.getElementById('formEnergieDisplay').textContent = (entry.energie || '5') + '/10';
                document.getElementById('formChargeMentale').value = entry.chargeMentale || '5';
                document.getElementById('formChargeMentaleDisplay').textContent = (entry.chargeMentale || '5') + '/10';
                document.getElementById('formChargeSociale').value = entry.chargeSociale || '5';
                document.getElementById('formChargeSocialeDisplay').textContent = (entry.chargeSociale || '5') + '/10';
                document.getElementById('formRemarks').value = entry.remarques || '';
                selectedTriggers = Array.isArray(entry.declencheurs) ? [...entry.declencheurs] : [];
                updateTriggersPreview();
                const pc = entry.precrisis;
                if (pc) {
                    document.getElementById('formPrecrisisEnabled').checked = true;
                    document.getElementById('precrisisFormFields').style.display = 'block';
                    document.getElementById('formEnergie').value = pc.energie !== undefined ? pc.energie : 50;
                    document.getElementById('formMentale').value = pc.chargeMentale !== undefined ? pc.chargeMentale : 50;
                    document.getElementById('formSociale').value = pc.chargeSociale !== undefined ? pc.chargeSociale : 50;
                } else {
                    document.getElementById('formPrecrisisEnabled').checked = false;
                    document.getElementById('precrisisFormFields').style.display = 'none';
                    ['Energie', 'Mentale', 'Sociale'].forEach(function(k) {
                        document.getElementById('form' + k).value = 50;
                    });
                }
                ['Energie', 'Mentale', 'Sociale'].forEach(updateFormPrecrisis);
            }
            
            document.getElementById('formModal').classList.add('visible');
        }

        function updateFormIntensityDisplay() {
            const value = document.getElementById('formIntensity').value;
            document.getElementById('formIntensityDisplay').textContent = `${value}/10`;
        }

        function openTriggersModal() {
            const content = document.getElementById('triggersContent');
            let html = '';
            
            Object.keys(TRIGGERS).forEach(category => {
                html += `<div class="trigger-category">`;
                html += `<div class="trigger-category-title">${category}</div>`;
                
                TRIGGERS[category].forEach((trigger, idx) => {
                    const isChecked = selectedTriggers.includes(trigger.name);
                    const uniqueId = 'trigger_' + category.replace(/[^a-z0-9]/gi, '_') + '_' + idx;
                    html += `
                        <div class="trigger-item">
                            <input type="checkbox" 
                                   class="trigger-checkbox" 
                                   ${isChecked ? 'checked' : ''} 
                                   id="${uniqueId}" 
                                   data-trigger-name="${trigger.name.replace(/"/g, '&quot;')}"
                                   onchange="handleTriggerChange(this)">
                            <label class="trigger-label" for="${uniqueId}">
                                <span class="trigger-name">${trigger.name}</span> : 
                                <span class="trigger-description">${trigger.desc}</span>
                            </label>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            content.innerHTML = html;
            document.getElementById('triggersModal').classList.add('visible');
        }

        function handleTriggerChange(checkbox) {
            const triggerName = checkbox.getAttribute('data-trigger-name');
            
            if (checkbox.checked) {
                if (!selectedTriggers.includes(triggerName)) {
                    selectedTriggers.push(triggerName);
                }
            } else {
                selectedTriggers = selectedTriggers.filter(t => t !== triggerName);
            }
        }

        function validateTriggers() {
            updateTriggersPreview();
            closeModal(null, 'triggersModal');
        }

        function updateTriggersPreview() {
            const preview = document.getElementById('triggersPreview');
            if (selectedTriggers.length === 0) {
                preview.textContent = 'Aucun d√©clencheur s√©lectionn√©';
            } else {
                preview.innerHTML = selectedTriggers.map(t => `‚Ä¢ ${t}`).join('<br>');
            }
        }

        function saveForm() {
            if (formMode === 'create') {
                const dateInput = document.getElementById('formDate').value;
                if (!dateInput) {
                    alert('La date est obligatoire');
                    return;
                }
                
                const timeInput = document.getElementById('formTime').value;
                let horodatage;
                
                if (timeInput) {
                    horodatage = new Date(`${dateInput}T${timeInput}:00`).toISOString();
                } else {
                    // Si pas d'heure, on met l'heure actuelle
                    const now = new Date();
                    const dateOnly = new Date(dateInput);
                    dateOnly.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
                    horodatage = dateOnly.toISOString();
                }
                
                // V√©rifier que la date n'est pas dans le futur (avec une marge d'1 jour)
                const now = new Date();
                const crisisDate = new Date(horodatage);
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                if (crisisDate.getTime() > tomorrow.getTime()) {
                    alert('Tu ne peux pas cr√©er une crise dans le futur.');
                    return;
                }
                
                const precrisisEnabled = document.getElementById('formPrecrisisEnabled').checked;
                const precrisisData = precrisisEnabled ? {
                    energie: parseInt(document.getElementById('formEnergie').value),
                    chargeMentale: parseInt(document.getElementById('formMentale').value),
                    chargeSociale: parseInt(document.getElementById('formSociale').value)
                } : null;

                const entry = {
                    horodatage: horodatage,
                    profil: localStorage.getItem('currentProfil') || 'maison',
                    capacites: JSON.parse(localStorage.getItem('currentCapacites') || '{}'),
                    besoins: JSON.parse(localStorage.getItem('currentBesoins') || '[]'),
                    etats: JSON.parse(localStorage.getItem('currentEtats') || '[]'),
                    typeCrise: document.getElementById('formType').value,
                    typeManifestation: document.getElementById('formTypeManifestation').value,
                    intensite: document.getElementById('formIntensity').value,
                    duree: formatDuration(
                        parseInt(document.getElementById('formDurationH').value) || 0,
                        parseInt(document.getElementById('formDurationM').value) || 0
                    ),
                    declencheurs: [...selectedTriggers],
                    remarques: document.getElementById('formRemarks').value,
                    energie: document.getElementById('formEnergie').value || '',
                    chargeMentale: document.getElementById('formChargeMentale').value || '',
                    chargeSociale: document.getElementById('formChargeSociale').value || '',
                    manual: true
                };
                
                const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
                journal.push(entry);
                localStorage.setItem('journalCrises', JSON.stringify(journal));
                
                closeModal(null, 'formModal');
                loadJournal();
                alert('Crise ajout√©e !');
            } else {
                const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
                const sorted = journal.sort((a, b) => new Date(b.horodatage) - new Date(a.horodatage));
                
                // Mettre √† jour l'horodatage si la date/heure a √©t√© modifi√©e
                const editDate = document.getElementById('formDate').value;
                const editTime = document.getElementById('formTime').value;
                if (editDate) {
                    let newHorodatage;
                    if (editTime) {
                        newHorodatage = new Date(`${editDate}T${editTime}:00`).toISOString();
                    } else {
                        const existing = new Date(sorted[currentEntryIndex].horodatage);
                        const base = new Date(editDate);
                        base.setHours(existing.getHours(), existing.getMinutes(), existing.getSeconds());
                        newHorodatage = base.toISOString();
                    }
                    sorted[currentEntryIndex].horodatage = newHorodatage;
                }

                sorted[currentEntryIndex].typeCrise = document.getElementById('formType').value;
                sorted[currentEntryIndex].typeManifestation = document.getElementById('formTypeManifestation').value;
                sorted[currentEntryIndex].intensite = document.getElementById('formIntensity').value;
                sorted[currentEntryIndex].duree = formatDuration(
                    parseInt(document.getElementById('formDurationH').value) || 0,
                    parseInt(document.getElementById('formDurationM').value) || 0
                );
                sorted[currentEntryIndex].declencheurs = [...selectedTriggers];
                sorted[currentEntryIndex].remarques = document.getElementById('formRemarks').value;
                sorted[currentEntryIndex].energie = document.getElementById('formEnergie').value || '';
                sorted[currentEntryIndex].chargeMentale = document.getElementById('formChargeMentale').value || '';
                sorted[currentEntryIndex].chargeSociale = document.getElementById('formChargeSociale').value || '';
                
                localStorage.setItem('journalCrises', JSON.stringify(sorted));
                closeModal(null, 'formModal');
                loadJournal();
                alert('Modifications enregistr√©es !');
            }
        }

        function editFromDetail() {
            closeModal(null, 'detailModal');
            openFormModal('edit', currentEntryIndex);
        }

        function confirmDelete() {
            if (confirm('Supprimer cette entr√©e d√©finitivement ?')) {
                deleteEntry(currentEntryIndex);
                closeModal(null, 'detailModal');
            }
        }

        function deleteEntry(index) {
            if (!confirm('Supprimer cette entr√©e d√©finitivement ?')) return;
            
            const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
            const sorted = journal.sort((a, b) => new Date(b.horodatage) - new Date(a.horodatage));
            sorted.splice(index, 1);
            localStorage.setItem('journalCrises', JSON.stringify(sorted));
            loadJournal();
        }

        function showExportOptions() {
            document.getElementById('exportModal').classList.add('visible');
        }

        function exportJSON() {
            const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
            if (journal.length === 0) {
                alert('Aucune crise √† exporter');
                return;
            }

            const data = JSON.stringify(journal, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `journal-crises-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeModal(null, 'exportModal');
        }

        function exportPDF() {
            const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
            if (journal.length === 0) {
                alert('Aucune crise √† exporter');
                return;
            }

            const prenom = localStorage.getItem('userPrenom') || '';
            const nom = localStorage.getItem('userNom') || '';
            const nomComplet = [prenom, nom].filter(Boolean).join(' ');
            const exportDate = new Date().toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });

            journal.sort((a, b) => new Date(b.horodatage) - new Date(a.horodatage));

            let entriesHtml = '';
            journal.forEach(entry => {
                const date = new Date(entry.horodatage);
                const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                const profile = PROFILES[entry.profil] || { icon: 'üìç', name: entry.profil || '‚Äî' };

                const lines = [];
                if (entry.typeCrise) lines.push(`<strong>Type :</strong> ${entry.typeCrise}`);
                const hasIntensity = entry.intensite !== undefined && entry.intensite !== '';
                if (hasIntensity) lines.push(`<strong>Intensit√© :</strong> ${entry.intensite}/10`);
                if (entry.duree) lines.push(`<strong>Dur√©e :</strong> ${entry.duree}`);
                if (entry.declencheurs && entry.declencheurs.length > 0) {
                    lines.push(`<strong>D√©clencheurs :</strong> ${entry.declencheurs.join(', ')}`);
                }
                if (entry.etats && entry.etats.length > 0) {
                    lines.push(`<strong>√âtats :</strong> ${entry.etats.map(e => e.label || e).join(', ')}`);
                }
                if (entry.besoins && entry.besoins.length > 0) {
                    lines.push(`<strong>Besoins :</strong> ${entry.besoins.map(b => b.label || b).join(', ')}`);
                }
                if (entry.capacites) {
                    const caps = [];
                    if (entry.capacites.impossible && entry.capacites.impossible.length) caps.push(`impossible : ${entry.capacites.impossible.join(', ')}`);
                    if (entry.capacites.difficile && entry.capacites.difficile.length) caps.push(`difficile : ${entry.capacites.difficile.join(', ')}`);
                    if (entry.capacites.possible && entry.capacites.possible.length) caps.push(`possible : ${entry.capacites.possible.join(', ')}`);
                    if (caps.length) lines.push(`<strong>Capacit√©s :</strong> ${caps.join(' ¬∑ ')}`);
                }
                if (entry.remarques) lines.push(`<strong>Remarques :</strong> ${entry.remarques}`);

                entriesHtml += `<div class="entry">
                    <div class="entry-header">
                        <span class="entry-date">${dateStr} √† ${timeStr}</span>
                        <span class="entry-context">${profile.name}</span>
                    </div>
                    ${lines.map(l => `<div class="entry-line">${l}</div>`).join('')}
                </div>`;
            });

            const html = `<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Journal de crises${nomComplet ? ' ‚Äî ' + nomComplet : ''}</title>
<style>
  body { font-family: Georgia, serif; max-width: 800px; margin: 0 auto; padding: 32px 24px; color: #111; font-size: 14px; }
  h1 { font-size: 20px; margin: 0 0 4px; }
  .meta { color: #666; font-size: 13px; margin-bottom: 28px; }
  .entry { border: 1px solid #ccc; border-radius: 6px; padding: 12px 14px; margin-bottom: 12px; page-break-inside: avoid; }
  .entry-header { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e8e8e8; }
  .entry-date { font-weight: 700; font-size: 14px; }
  .entry-context { font-size: 13px; color: #555; }
  .entry-line { margin-bottom: 4px; line-height: 1.5; }
  .print-btn { background: #384657; color: #F5E4CC; border: none; padding: 12px 24px; border-radius: 8px; font-size: 15px; cursor: pointer; margin-bottom: 24px; }
  @media print { .print-btn { display: none; } }
</style>
</head>
<body>
<button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimer / Enregistrer en PDF</button>
<h1>Journal de crises${nomComplet ? ' de ' + nomComplet : ''}</h1>
<div class="meta">Export du ${exportDate} ‚Äî ${journal.length} entr√©e${journal.length > 1 ? 's' : ''}</div>
${entriesHtml}
</body>
</html>`;

            const win = window.open('', '_blank');
            if (win) {
                win.document.write(html);
                win.document.close();
            } else {
                alert('Le navigateur a bloqu√© l\'ouverture de la fen√™tre. Autorise les popups pour ce site.');
            }
            closeModal(null, 'exportModal');
        }

        function shareJournal() {
            const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
            if (!journal.length) { alert('Aucune crise √† partager.'); return; }

            const prenom = localStorage.getItem('userPrenom') || '';
            const nom = localStorage.getItem('userNom') || '';
            const nomComplet = [prenom, nom].filter(Boolean).join(' ');
            const exportDate = new Date().toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });

            journal.sort((a, b) => new Date(b.horodatage) - new Date(a.horodatage));

            let text = 'Journal de crises' + (nomComplet ? ' ‚Äî ' + nomComplet : '') + '\n';
            text += 'Export du ' + exportDate + ' ‚Äî ' + journal.length + ' entr√©e' + (journal.length > 1 ? 's' : '') + '\n\n';

            journal.forEach(entry => {
                const date = new Date(entry.horodatage);
                const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                const profile = PROFILES[entry.profil] || { name: entry.profil || '‚Äî' };

                text += dateStr + ' √† ' + timeStr + ' ‚Äî ' + profile.name + '\n';
                if (entry.typeCrise) text += '  Type : ' + entry.typeCrise + '\n';
                const hasIntensity = entry.intensite !== undefined && entry.intensite !== '';
                const hasDuree = !!entry.duree;
                if (hasIntensity || hasDuree) {
                    let line = '';
                    if (hasIntensity) line += 'Intensit√© : ' + entry.intensite + '/10';
                    if (hasDuree) line += (line ? ' ¬∑ ' : '') + 'Dur√©e : ' + entry.duree;
                    text += '  ' + line + '\n';
                }
                if (entry.declencheurs && entry.declencheurs.length > 0) {
                    text += '  D√©clencheurs : ' + entry.declencheurs.join(', ') + '\n';
                }
                if (entry.remarques) text += '  Remarques : ' + entry.remarques + '\n';
                text += '\n';
            });

            text += '‚Äî Nora';

            if (navigator.share) {
                navigator.share({
                    title: 'Journal de crises' + (nomComplet ? ' ‚Äî ' + nomComplet : ''),
                    text: text
                }).catch(function() {});
            } else if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() { alert('Journal copi√© dans le presse-papier.'); });
            } else {
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'journal-nora-' + new Date().toISOString().split('T')[0] + '.txt';
                a.click();
                URL.revokeObjectURL(url);
            }
            closeModal(null, 'exportModal');
        }

        let _tooltipTimer = null;

        function openBadgeModal(el, index, type) {
            const journal = JSON.parse(localStorage.getItem('journalCrises') || '[]');
            journal.sort((a, b) => new Date(b.horodatage) - new Date(a.horodatage));
            const entry = journal[index];
            let title = '';
            let items = [];
            if (type === 'caps') {
                title = 'Capacit√©s';
                items = [
                    ...(entry.capacites?.impossible || []),
                    ...(entry.capacites?.difficile || []),
                    ...(entry.capacites?.possible || []),
                    ...(entry.capacites?.incertain || [])
                ];
            } else if (type === 'besoins') {
                title = 'Besoins';
                items = (entry.besoins || []).map(b => b.label || b);
            } else if (type === 'etats') {
                title = '√âtats';
                items = (entry.etats || []).map(e => e.label || e);
            }
            const tooltip = document.getElementById('badgeTooltip');
            tooltip.innerHTML = items.length === 0
                ? `<strong>${title}</strong><br><span style="opacity:0.5">Aucun √©l√©ment</span>`
                : `<strong>${title}</strong><br>` + items.map(i => `‚Ä¢ ${i}`).join('<br>');
            tooltip.style.display = 'block';
            const rect = el.getBoundingClientRect();
            let left = rect.left;
            let top = rect.bottom + 6;
            if (left + 214 > window.innerWidth - 6) left = window.innerWidth - 220;
            if (left < 6) left = 6;
            if (top + tooltip.offsetHeight > window.innerHeight - 6) top = rect.top - tooltip.offsetHeight - 6;
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            clearTimeout(_tooltipTimer);
            _tooltipTimer = setTimeout(() => { tooltip.style.display = 'none'; }, 4500);
        }

        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('count-badge')) {
                document.getElementById('badgeTooltip').style.display = 'none';
            }
        });

        function closeModal(event, modalId) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById(modalId).classList.remove('visible');
        }

        function goHome() {
            if (history.length > 1) {
                history.back();
            } else {
                location.href = 'index.html';
            }
        }

        loadJournal();
    </script>
    <footer class="footer">
        <button class="footer-action" onclick="window.location.href='stats.html'">üìä Statistiques</button>
        <button class="footer-action" onclick="showExportOptions()">üì§ Exporter</button>
    </footer>

    <script>document.addEventListener("keydown", e => { if (e.key === "Escape") { closeModal(null, "detailModal"); closeModal(null, "formModal"); closeModal(null, "triggersModal"); closeModal(null, "exportModal"); closeModal(null, "badgeModal"); } });</script>
    <script src="nora-scroll.js"></script>
</body>
</html>