<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="only light">
    <meta name="theme-color" content="#384657">
<link rel="stylesheet" href="nora-common.css">
<script src="nora-data.js"></script>
<title>TSA App - Comment je me sens</title>
<style>
body{
padding-bottom:80px;
}

.header-context-name{font-size:18px;font-weight:600}

.main-content{padding:10px 20px}

.page-title{
font-size:22px;
margin-bottom:2px;
}

.instruction-text{
  color:var(--accent);
  font-size:14px;
  margin-bottom:8px;
  margin-top:2px;
}

.title-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

.reset-btn{
  background:rgba(245,228,204,.15);
  border:1px solid rgba(245,228,204,.2);
  color:var(--accent);
  border-radius:10px;
  padding:6px 10px;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
  line-height:1;
}
.reset-btn .reset-icon{font-size:18px}
.reset-btn .reset-label{font-size:10px;opacity:0.8}
.reset-btn:active{background:rgba(245,228,204,.3)}

.state-item{
padding:14px 16px;
border-radius:12px;
margin-bottom:10px;
cursor:pointer;
transition: all 0.2s;
user-select:none;

border:2px solid var(--bg);
background:var(--light);
color:var(--dark);

display:flex;
align-items:center;
gap:14px;
}

.state-item:active{transform:scale(.97)}

.state-item.active{
background:var(--accent);
color:var(--dark);
border:2px solid var(--bg);
box-shadow:0 4px 8px rgba(0,0,0,0.2);
}

.state-icon{font-size:24px}
.state-text{flex:1;font-size:16px}

.confirm-overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,.7);
display:none;
align-items:center;
justify-content:center;
z-index:100;
}

.confirm-overlay.show{display:flex}

.confirm-dialog{
background:var(--light);
padding:24px;
border-radius:16px;
width:300px;
color:var(--dark);
}

.confirm-buttons{
display:flex;
gap:12px;
margin-top:20px;
}

.confirm-btn{
flex:1;
padding:12px;
border-radius:8px;
border:none;
font-weight:600;
cursor:pointer;
}

.confirm{background:var(--accent)}
.cancel{background:#ddd}
</style>
</head>

<body>

<header class="header">
<h1 class="header-context-name" id="headerContextName" style="flex:1">Contexte</h1>
<button onclick="window.location.href='index.html'" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px;">üè†</button>
</header>

<main class="main-content">

<div class="title-row">
  <div>
    <h2 class="page-title">Comment je me sens</h2>
    <p class="instruction-text">Appuyez pour s√©lectionner.<br>Plusieurs s√©lections possibles.</p>
  </div>
  <button class="reset-btn" onclick="resetAllStates()">
    <span class="reset-icon">‚Üª</span>
    <span class="reset-label">R√©init.</span>
  </button>
</div>

<div id="statesContainer">
<!-- G√©n√©r√© dynamiquement -->
</div>

</main>

<footer class="footer">
<button class="footer-button icon" onclick="goBack()">‚¨ÖÔ∏è</button>
<button class="footer-button center" onclick="finish()">Voir le r√©capitulatif</button>
<button class="footer-button icon" onclick="goNext()">‚û°Ô∏è</button>
</footer>

<div class="confirm-overlay" id="confirmOverlay">
<div class="confirm-dialog">
<h3>R√©initialiser ?</h3>
<p>Tous les √©tats seront remis √† z√©ro.</p>
<div class="confirm-buttons">
<button class="confirm-btn cancel" onclick="hideConfirm()">Annuler</button>
<button class="confirm-btn confirm" onclick="confirmReset()">OK</button>
</div>
</div>
</div>

<script>
let longPressTimer, isLongPress = false;
let profileConfig = null;

function toggleState(el){
  if(isLongPress){ isLongPress = false; return; }
  el.classList.toggle('active');
  saveEtats();
}

function attachLongPress(items){
  items.forEach(i => {
    i.addEventListener('mousedown', () => startLong(i));
    i.addEventListener('mouseup', clear);
    i.addEventListener('mouseleave', clear);
    i.addEventListener('touchstart', () => startLong(i));
    i.addEventListener('touchend', clear);
  });
}

function startLong(i){
  isLongPress = false;
  longPressTimer = setTimeout(() => {
    isLongPress = true;
    i.classList.remove('active');
    saveEtats();
  }, 600);
}

function clear(){ clearTimeout(longPressTimer); }

function buildStateItems(){
  const container = document.getElementById('statesContainer');
  const config = profileConfig;
  const visibles = config.etats.visibles || [];
  const personnalisees = config.etats.personnalisees || [];
  const allItems = [...ETATS, ...personnalisees];
  const visibleItems = allItems.filter(item => visibles.includes(item.id));

  container.innerHTML = visibleItems.map(item =>
    `<div class="state-item" data-state="${item.nom}" data-icon="${item.emoji}" onclick="toggleState(this)">
      <div class="state-icon">${item.emoji}</div>
      <div class="state-text">${item.nom}</div>
    </div>`
  ).join('');

  attachLongPress(container.querySelectorAll('.state-item'));
}

function resetAllStates(){
  document.getElementById('confirmOverlay').classList.add('show');
}

function hideConfirm(){
  document.getElementById('confirmOverlay').classList.remove('show');
}

function confirmReset(){
  document.querySelectorAll('.state-item').forEach(i => i.classList.remove('active'));
  saveEtats();
  hideConfirm();
}

function saveEtats(){
  const etats = [];
  document.querySelectorAll('.state-item.active').forEach(item => {
    etats.push({
      label: item.dataset.state || item.querySelector('.state-text').textContent,
      icon: item.dataset.icon || item.querySelector('.state-icon').textContent
    });
  });
  localStorage.setItem('currentEtats', JSON.stringify(etats));
}

function loadEtats(){
  try {
    const saved = localStorage.getItem('currentEtats');
    if(!saved) return;
    const etats = JSON.parse(saved);
    document.querySelectorAll('.state-item').forEach(item => {
      const label = item.dataset.state || item.querySelector('.state-text').textContent;
      if(etats.some(e => e.label === label)) item.classList.add('active');
    });
  } catch(e) {
    console.error('Erreur chargement √©tats:', e);
  }
}

function goBack(){
  saveEtats();
  location.href = getPrevPage('etats.html', profileConfig);
}

function goNext(){
  saveEtats();
  location.href = getNextPage('etats.html', profileConfig);
}

function finish(){
  saveEtats();
  location.href = 'recap.html';
}

document.addEventListener('DOMContentLoaded', function() {
  const profilId = localStorage.getItem('profilActuel') || 'maison';
  profileConfig = getProfileConfig(profilId);

  const info = getContexteInfo(profilId);
  document.getElementById('headerContextName').textContent = info.emoji + ' ' + info.nom;

  buildStateItems();
  loadEtats();
});
</script>

</body>
</html>
